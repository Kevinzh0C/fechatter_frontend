/**
 * ğŸ”§ ç»Ÿä¸€æ–‡ä»¶URLå¤„ç†ç³»ç»Ÿ
 * è‡ªåŠ¨å¤„ç†æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶URLæ ¼å¼ï¼Œé¿å…404é”™è¯¯
 */

import { useAuthStore } from '@/stores/auth';

/**
 * è·å–å·¥ä½œåŒºIDçš„è¾…åŠ©å‡½æ•°
 */
function getWorkspaceId(fileInput, options) {
  const authStore = useAuthStore();
  return options.workspaceId ||
    authStore.user?.workspace_id ||
    fileInput?.workspace_id ||
    2;
}

/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºå“ˆå¸Œè·¯å¾„æ ¼å¼
 */
function isHashPath(str) {
  const parts = str.split('/');
  return parts.length >= 3 &&
    parts[0].length === 3 &&
    parts[1].length === 3 &&
    parts[2].includes('.');
}

/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºç®€å•æ–‡ä»¶å
 */
function isSimpleFilename(str) {
  return !str.includes('/') && str.includes('.');
}

/**
 * æ„é€ å“ˆå¸ŒURL
 */
function constructHashUrl(filename, workspaceId) {
  if (isHashPath(filename)) {
    return `/files/${workspaceId}/${filename}`;
  }

  const cleanFilename = filename.replace(/^.*\//, '');

  if (cleanFilename.length >= 10) {
    const hash1 = cleanFilename.substring(0, 3);
    const hash2 = cleanFilename.substring(3, 6);
    return `/files/${workspaceId}/${hash1}/${hash2}/${cleanFilename}`;
  }

  return `/files/${workspaceId}/${cleanFilename}`;
}

/**
 * æ ‡å‡†åŒ–URLå­—ç¬¦ä¸²
 */
function normalizeUrlString(url, workspaceId) {
  // 1. å·²ç»æ˜¯æ­£ç¡®çš„filesæ ¼å¼
  if (url.startsWith('/files/') && url.includes(`/${workspaceId}/`)) {
    return url;
  }

  // 2. é”™è¯¯çš„APIæ ¼å¼: /api/files/...
  if (url.startsWith('/api/files/')) {
    const pathPart = url.substring(11); // Remove '/api/files/'
    return `/files/${workspaceId}/${pathPart}`;
  }

  // 3. é”™è¯¯çš„downloadæ ¼å¼: /api/files/download/filename
  if (url.includes('/api/files/download/')) {
    const filename = url.split('/download/')[1];
    return constructHashUrl(filename, workspaceId);
  }

  // 4. ç®€å•çš„/files/æ ¼å¼ä½†workspaceå¯èƒ½é”™è¯¯
  if (url.startsWith('/files/')) {
    const parts = url.split('/');
    if (parts.length >= 3) {
      const filename = parts.slice(3).join('/');
      return constructHashUrl(filename, workspaceId);
    }
  }

  // 5. hashè·¯å¾„æ ¼å¼
  if (isHashPath(url)) {
    return `/files/${workspaceId}/${url}`;
  }

  // 6. å®Œæ•´è·¯å¾„æ ¼å¼
  if (url.includes('/app/data/')) {
    const cleanPath = url.replace(/^.*\/app\/data\//, '');
    return `/files/${workspaceId}/${cleanPath}`;
  }

  // 7. ç®€å•æ–‡ä»¶å
  if (isSimpleFilename(url)) {
    return constructHashUrl(url, workspaceId);
  }

  // 8. å¤–éƒ¨URL
  if (url.startsWith('http') || url.startsWith('blob:')) {
    return url;
  }

  console.warn('âš ï¸ [FileUrlHandler] Unknown URL format:', url);
  return constructHashUrl(url, workspaceId);
}

/**
 * æ ‡å‡†åŒ–æ–‡ä»¶å¯¹è±¡
 */
function normalizeFileObject(file, workspaceId) {
  const candidates = [
    file.file_url,
    file.url,
    file.path,
    file.filename,
    file.file_name,
    file.name
  ].filter(Boolean);

  for (const candidate of candidates) {
    const result = normalizeUrlString(candidate, workspaceId);
    if (result) {
      return result;
    }
  }

  console.error('âŒ [FileUrlHandler] No valid URL found in file object:', file);
  return null;
}

/**
 * ä¸»è¦æ–¹æ³•ï¼šç»Ÿä¸€æ–‡ä»¶URLå¤„ç†å™¨
 * æ™ºèƒ½å¤„ç†ä»»ä½•æ–‡ä»¶URLæ ¼å¼
 */
export function getStandardFileUrl(fileInput, options = {}) {
  try {
    const workspaceId = getWorkspaceId(fileInput, options);

    if (typeof fileInput === 'string') {
      return normalizeUrlString(fileInput, workspaceId);
    }

    if (typeof fileInput === 'object' && fileInput !== null) {
      return normalizeFileObject(fileInput, workspaceId);
    }

    console.error('âŒ [FileUrlHandler] Invalid file input:', fileInput);
    return null;

  } catch (error) {
    console.error('âŒ [FileUrlHandler] Error processing file URL:', error);
    return null;
  }
}

/**
 * è°ƒè¯•URLè½¬æ¢
 */
export function debugFileUrl(fileInput, options = {}) {
  console.group('ğŸ” [FileUrlHandler] URL Debug');
  console.log('Input:', fileInput);
  const result = getStandardFileUrl(fileInput, options);
  console.log('Output:', result);
  console.groupEnd();
  return result;
}

// å‘åå…¼å®¹ï¼šä¿æŒåŸæœ‰çš„classå¯¼å‡º
export class FileUrlHandler {
  getStandardUrl(fileInput, options = {}) {
    return getStandardFileUrl(fileInput, options);
  }

  debugUrlConversion(fileInput, options = {}) {
    return debugFileUrl(fileInput, options);
  }
}

// å‘åå…¼å®¹ï¼šå®ä¾‹å¯¼å‡º
export const fileUrlHandler = new FileUrlHandler();

