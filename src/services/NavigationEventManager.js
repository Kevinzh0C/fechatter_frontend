/**
 * NavigationEventManager - Á≥ªÁªüÊÄßÂØºËà™‰∫ã‰ª∂ÁÆ°ÁêÜÂô®
 * Á°Æ‰øù‰ªésidebarÂä†ËΩΩÊï∞ÊçÆÂà∞ÂØºËà™ÊàêÂäüÁöÑÂÖ®ÊµÅÁ®ã‰∫ã‰ª∂ÁÆ°ÁêÜ
 */

import { ref, computed } from 'vue';
import { useChatStore } from '@/stores/chat';
import { useWorkspaceStore } from '@/stores/workspace';
import { useAuthStore } from '@/stores/auth';
import { createDataLoadingMonitor } from './DataLoadingMonitor.js';

class NavigationEventManager {
  constructor() {
    this.isInitialized = false;
    this.router = null;
    this.stores = {
      chat: null,
      workspace: null,
      auth: null
    };
    
    // Êï∞ÊçÆÂä†ËΩΩÁõëÊéßÂô®
    this.dataMonitor = null;
    
    // ÂØºËà™Áä∂ÊÄÅÁÆ°ÁêÜ
    this.navigationState = ref({
      isNavigating: false,
      currentStep: null,
      targetChatId: null,
      startTime: null,
      errors: [],
      completedSteps: []
    });
    
    // Êï∞ÊçÆÂä†ËΩΩÁä∂ÊÄÅ
    this.dataLoadingState = ref({
      chatsLoaded: false,
      workspaceLoaded: false,
      usersLoaded: false,
      lastLoadTime: null
    });
    
    // ÂØºËà™Ê≠•È™§ÂÆö‰πâ
    this.navigationSteps = [
      'validate_target',
      'ensure_data_loaded', 
      'prepare_navigation',
      'execute_router_push',
      'verify_route_change',
      'load_chat_context',
      'setup_sse_connection',
      'complete_navigation'
    ];
    
    // ‰∫ã‰ª∂ÁõëÂê¨Âô®
    this.eventListeners = new Map();
    this.setupEventListeners();
    
    console.log('üéØ [NavigationEventManager] Initialized');
  }
  
  /**
   * ÂàùÂßãÂåñÂØºËà™‰∫ã‰ª∂ÁÆ°ÁêÜÂô®
   */
  initialize(router) {
    if (this.isInitialized) return;
    
    this.router = router;
    this.stores.chat = useChatStore();
    this.stores.workspace = useWorkspaceStore();
    this.stores.auth = useAuthStore();
    
    // ÂàùÂßãÂåñÊï∞ÊçÆÂä†ËΩΩÁõëÊéßÂô®
    this.dataMonitor = createDataLoadingMonitor(this.stores);
    
    this.isInitialized = true;
    console.log('‚úÖ [NavigationEventManager] Fully initialized with stores, router, and data monitor');
  }
  
  /**
   * ËÆæÁΩÆÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®
   */
  setupEventListeners() {
    // ÁõëÂê¨Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê‰∫ã‰ª∂
    this.addEventListener('chats-loaded', (data) => {
      this.dataLoadingState.value.chatsLoaded = true;
      this.dataLoadingState.value.lastLoadTime = Date.now();
      console.log('üìä [NavigationEventManager] Chats data loaded:', data.length, 'items');
    });
    
    // ÁõëÂê¨ÂØºËà™ÈîôËØØ
    this.addEventListener('navigation-error', (error) => {
      this.navigationState.value.errors.push({
        error: error.message,
        step: this.navigationState.value.currentStep,
        timestamp: Date.now()
      });
      console.error('‚ùå [NavigationEventManager] Navigation error:', error);
    });
    
    // ÁõëÂê¨ÂØºËà™ÂÆåÊàê
    this.addEventListener('navigation-complete', (result) => {
      this.navigationState.value.isNavigating = false;
      this.navigationState.value.currentStep = null;
      console.log('‚úÖ [NavigationEventManager] Navigation completed:', result);
    });
  }
  
  /**
   * Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
   */
  addEventListener(eventName, handler) {
    if (!this.eventListeners.has(eventName)) {
      this.eventListeners.set(eventName, []);
    }
    this.eventListeners.get(eventName).push(handler);
  }
  
  /**
   * Ëß¶Âèë‰∫ã‰ª∂
   */
  emitEvent(eventName, data) {
    const handlers = this.eventListeners.get(eventName) || [];
    handlers.forEach(handler => {
      try {
        handler(data);
      } catch (error) {
        console.error(`‚ùå [NavigationEventManager] Event handler error for ${eventName}:`, error);
      }
    });
  }
  
  /**
   * Á°Æ‰øùÊï∞ÊçÆÂ∑≤Âä†ËΩΩ - ‰ΩøÁî®DataLoadingMonitor
   */
  async ensureDataLoaded() {
    console.log('üîÑ [NavigationEventManager] Ensuring data is loaded using DataLoadingMonitor...');
    
    try {
      // Ê£ÄÊü•ÂΩìÂâçÊï∞ÊçÆÁä∂ÊÄÅ
      const currentState = this.dataMonitor.getLoadingStateSummary();
      console.log('üìä [NavigationEventManager] Current data state:', currentState);
      
      // Â¶ÇÊûúÊâÄÊúâÊï∞ÊçÆÂ∑≤Âä†ËΩΩÔºåÁõ¥Êé•ËøîÂõû
      if (currentState.allLoaded) {
        console.log('‚ÑπÔ∏è [NavigationEventManager] All data already loaded');
        return true;
      }
      
      // Â¶ÇÊûúÊúâÊï∞ÊçÆÊ≠£Âú®Âä†ËΩΩÔºåÁ≠âÂæÖÂÆåÊàê
      if (currentState.anyLoading) {
        console.log('‚è≥ [NavigationEventManager] Data loading in progress, waiting...');
        try {
          await this.dataMonitor.waitForDataLoaded(15000); // 15ÁßíË∂ÖÊó∂
          console.log('‚úÖ [NavigationEventManager] Data loading completed via wait');
          return true;
        } catch (waitError) {
          console.warn('‚ö†Ô∏è [NavigationEventManager] Wait for data loading timed out:', waitError.message);
          // ÁªßÁª≠Â∞ùËØïÂº∫Âà∂Âà∑Êñ∞
        }
      }
      
      // Âº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ
      console.log('üîÑ [NavigationEventManager] Force refreshing all data...');
      const refreshResult = await this.dataMonitor.forceRefreshAllData();
      
      console.log('‚úÖ [NavigationEventManager] Data refresh completed:', refreshResult);
      
      // È™åËØÅÊï∞ÊçÆÊòØÂê¶ÁúüÊ≠£ÂèØÁî®
      const finalState = this.dataMonitor.getLoadingStateSummary();
      if (!finalState.allLoaded) {
        console.warn('‚ö†Ô∏è [NavigationEventManager] Some data still not loaded after refresh:', finalState);
        
        // Ê£ÄÊü•ÂÖ≥ÈîÆÊï∞ÊçÆ
        if (finalState.chats.count === 0 && !finalState.chats.error) {
          console.warn('‚ö†Ô∏è [NavigationEventManager] No chats loaded, but proceeding anyway');
        }
      }
      
      // ÂèëÈÄÅÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê‰∫ã‰ª∂
      this.emitEvent('chats-loaded', this.stores.chat.chats || []);
      
      return true;
      
    } catch (error) {
      console.error('‚ùå [NavigationEventManager] Data loading failed:', error);
      this.emitEvent('navigation-error', error);
      
      // Âç≥‰ΩøÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•Ôºå‰πüÂÖÅËÆ∏ÂØºËà™ÁªßÁª≠ÔºàÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÔºâ
      console.log('‚ö†Ô∏è [NavigationEventManager] Proceeding with navigation despite data loading issues');
      return true;
    }
  }
  
  /**
   * Á≥ªÁªüÊÄßÂØºËà™Âà∞ËÅäÂ§©
   */
  async navigateToChat(chatId, options = {}) {
    console.log('üéØ [NavigationEventManager] Starting systematic navigation to chat:', chatId);
    
    // ÈáçÁΩÆÂØºËà™Áä∂ÊÄÅ
    this.navigationState.value = {
      isNavigating: true,
      currentStep: null,
      targetChatId: parseInt(chatId),
      startTime: Date.now(),
      errors: [],
      completedSteps: []
    };
    
    try {
      // Step 1: È™åËØÅÁõÆÊ†á
      await this.executeStep('validate_target', async () => {
        if (!chatId || isNaN(parseInt(chatId))) {
          throw new Error(`Invalid chat ID: ${chatId}`);
        }
        
        if (!this.router) {
          throw new Error('Router not initialized');
        }
        
        console.log('‚úÖ [NavigationEventManager] Target validated:', chatId);
      });
      
      // Step 2: Á°Æ‰øùÊï∞ÊçÆÂ∑≤Âä†ËΩΩ - ‰ΩøÁî®DataLoadingMonitor
      await this.executeStep('ensure_data_loaded', async () => {
        const dataLoaded = await this.ensureDataLoaded();
        if (!dataLoaded) {
          throw new Error('Failed to load required data');
        }
        
        // È™åËØÅÁõÆÊ†áËÅäÂ§©ÊòØÂê¶Â≠òÂú®
        const targetChat = this.stores.chat.chats.find(chat => chat.id === parseInt(chatId));
        if (!targetChat) {
          console.warn('‚ö†Ô∏è [NavigationEventManager] Target chat not found in loaded data, proceeding anyway');
          
          // ËÆ∞ÂΩïÊï∞ÊçÆÁä∂ÊÄÅÁî®‰∫éË∞ÉËØï
          const dataState = this.dataMonitor.getLoadingStateSummary();
          console.log('üìä [NavigationEventManager] Data state when target chat not found:', dataState);
        } else {
          console.log('‚úÖ [NavigationEventManager] Target chat found:', targetChat.name);
        }
      });
      
      // Step 3: ÂáÜÂ§áÂØºËà™
      await this.executeStep('prepare_navigation', async () => {
        // Ê∏ÖÁêÜÂΩìÂâçÁä∂ÊÄÅ
        this.stores.chat.currentChatId = null;
        
        // ÂÖ≥Èó≠ÁßªÂä®Á´Ø‰æßËæπÊ†è
        if (window.mobileSwipeManager?.isMobile?.value && window.mobileSwipeManager?.sidebarVisible?.value) {
          console.log('üì± [NavigationEventManager] Closing mobile sidebar');
          window.mobileSwipeManager.closeSidebar();
        }
        
        console.log('‚úÖ [NavigationEventManager] Navigation prepared');
      });
      
      // Step 4: ÊâßË°åË∑ØÁî±Ë∑≥ËΩ¨
      await this.executeStep('execute_router_push', async () => {
        const targetRoute = `/chat/${chatId}`;
        console.log('üîÑ [NavigationEventManager] Executing router.push to:', targetRoute);
        
        try {
          await this.router.push(targetRoute);
        } catch (routerError) {
          // Â§ÑÁêÜË∑ØÁî±ÈáçÂ§çÂØºËà™ÈîôËØØ
          if (routerError.name === 'NavigationDuplicated' || 
              routerError.message?.includes('redundant')) {
            console.log('‚ÑπÔ∏è [NavigationEventManager] Redundant navigation detected, continuing');
          } else {
            throw routerError;
          }
        }
        
        console.log('‚úÖ [NavigationEventManager] Router push completed');
      });
      
      // Step 5: È™åËØÅË∑ØÁî±ÂèòÂåñ
      await this.executeStep('verify_route_change', async () => {
        // Á≠âÂæÖË∑ØÁî±ÂèòÂåñÁîüÊïà
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const currentRoute = this.router.currentRoute.value;
        const expectedChatId = parseInt(chatId);
        const actualChatId = parseInt(currentRoute.params.id);
        
        if (actualChatId !== expectedChatId) {
          throw new Error(`Route verification failed: expected ${expectedChatId}, got ${actualChatId}`);
        }
        
        console.log('‚úÖ [NavigationEventManager] Route change verified');
      });
      
      // Step 6: Âä†ËΩΩËÅäÂ§©‰∏ä‰∏ãÊñá
      await this.executeStep('load_chat_context', async () => {
        console.log('üîÑ [NavigationEventManager] Loading chat context...');
        
        // ËÆæÁΩÆÂΩìÂâçËÅäÂ§©ID
        this.stores.chat.currentChatId = parseInt(chatId);
        
        // ‰ΩøÁî®chatStoreÁöÑnavigateToChatÊñπÊ≥ïÂä†ËΩΩÊ∂àÊÅØ
        await this.stores.chat.navigateToChat(parseInt(chatId));
        
        console.log('‚úÖ [NavigationEventManager] Chat context loaded');
      });
      
      // Step 7: ËÆæÁΩÆSSEËøûÊé•
      await this.executeStep('setup_sse_connection', async () => {
        // Á°Æ‰øùSSEËøûÊé•Â∑≤Âª∫Á´ã
        if (window.minimalSSE && !window.minimalSSE.isConnected) {
          try {
            const token = this.stores.auth.token;
            if (token) {
              await window.minimalSSE.connect(token);
              console.log('‚úÖ [NavigationEventManager] SSE connection established');
            }
          } catch (sseError) {
            console.warn('‚ö†Ô∏è [NavigationEventManager] SSE connection failed:', sseError);
            // SSEÂ§±Ë¥•‰∏çÂ∫îËØ•ÈòªÊ≠¢ÂØºËà™ÂÆåÊàê
          }
        }
      });
      
      // Step 8: ÂÆåÊàêÂØºËà™
      await this.executeStep('complete_navigation', async () => {
        // ÂèëÈÄÅÂØºËà™ÂÆåÊàê‰∫ã‰ª∂
        const navigationResult = {
          chatId: parseInt(chatId),
          duration: Date.now() - this.navigationState.value.startTime,
          completedSteps: this.navigationState.value.completedSteps,
          dataState: this.dataMonitor.getLoadingStateSummary(),
          timestamp: Date.now()
        };
        
        this.emitEvent('navigation-complete', navigationResult);
        
        // ÂèëÈÄÅÂÖ®Â±ÄÂØºËà™ÂÆåÊàê‰∫ã‰ª∂
        window.dispatchEvent(new CustomEvent('fechatter:navigation-complete', {
          detail: navigationResult
        }));
        
        console.log('üéâ [NavigationEventManager] Navigation completed successfully:', navigationResult);
      });
      
      return true;
      
    } catch (error) {
      console.error('‚ùå [NavigationEventManager] Navigation failed:', error);
      
      this.navigationState.value.isNavigating = false;
      this.emitEvent('navigation-error', error);
      
      // ÂèëÈÄÅÂÖ®Â±ÄÂØºËà™ÈîôËØØ‰∫ã‰ª∂
      window.dispatchEvent(new CustomEvent('fechatter:navigation-error', {
        detail: {
          chatId: parseInt(chatId),
          error: error.message,
          step: this.navigationState.value.currentStep,
          dataState: this.dataMonitor?.getLoadingStateSummary(),
          timestamp: Date.now()
        }
      }));
      
      // Â∞ùËØïÂ§áÁî®ÂØºËà™
      if (options.allowFallback !== false) {
        console.log('üîÑ [NavigationEventManager] Attempting fallback navigation');
        window.location.href = `/chat/${chatId}`;
      }
      
      throw error;
    }
  }
  
  /**
   * ÊâßË°åÂçï‰∏™ÂØºËà™Ê≠•È™§
   */
  async executeStep(stepName, stepFunction) {
    this.navigationState.value.currentStep = stepName;
    console.log(`üîÑ [NavigationEventManager] Executing step: ${stepName}`);
    
    try {
      await stepFunction();
      this.navigationState.value.completedSteps.push({
        name: stepName,
        timestamp: Date.now(),
        success: true
      });
      console.log(`‚úÖ [NavigationEventManager] Step completed: ${stepName}`);
    } catch (error) {
      this.navigationState.value.completedSteps.push({
        name: stepName,
        timestamp: Date.now(),
        success: false,
        error: error.message
      });
      console.error(`‚ùå [NavigationEventManager] Step failed: ${stepName}`, error);
      throw error;
    }
  }
  
  /**
   * Ëé∑ÂèñÂØºËà™Áä∂ÊÄÅ
   */
  getNavigationState() {
    return {
      ...this.navigationState.value,
      dataLoadingState: this.dataLoadingState.value,
      dataMonitorState: this.dataMonitor?.getLoadingStateSummary()
    };
  }
  
  /**
   * ÈáçÁΩÆÂØºËà™Áä∂ÊÄÅ
   */
  resetNavigationState() {
    this.navigationState.value = {
      isNavigating: false,
      currentStep: null,
      targetChatId: null,
      startTime: null,
      errors: [],
      completedSteps: []
    };
    
    console.log('üîÑ [NavigationEventManager] Navigation state reset');
  }
  
  /**
   * Ëé∑ÂèñÂØºËà™ÊåáÊ†á
   */
  getNavigationMetrics() {
    const state = this.navigationState.value;
    const completedSteps = state.completedSteps.filter(step => step.success);
    const failedSteps = state.completedSteps.filter(step => !step.success);
    
    return {
      totalSteps: this.navigationSteps.length,
      completedSteps: completedSteps.length,
      failedSteps: failedSteps.length,
      successRate: completedSteps.length / this.navigationSteps.length,
      totalDuration: state.startTime ? Date.now() - state.startTime : 0,
      errors: state.errors,
      isNavigating: state.isNavigating,
      dataState: this.dataMonitor?.getLoadingStateSummary()
    };
  }
}

// ÂàõÂª∫Âçï‰æãÂÆû‰æã
const navigationEventManager = new NavigationEventManager();

// ÂØºÂá∫Âçï‰æãÂíåÂ∑•ÂéÇÂáΩÊï∞
export default navigationEventManager;

export function createNavigationEventHelper(router) {
  navigationEventManager.initialize(router);
  
  return {
    navigateToChat: (chatId, options) => navigationEventManager.navigateToChat(chatId, options),
    getNavigationState: () => navigationEventManager.getNavigationState(),
    resetNavigationState: () => navigationEventManager.resetNavigationState(),
    getNavigationMetrics: () => navigationEventManager.getNavigationMetrics(),
    addEventListener: (eventName, handler) => navigationEventManager.addEventListener(eventName, handler),
    isNavigating: computed(() => navigationEventManager.navigationState.value.isNavigating)
  };
}
