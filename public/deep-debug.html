<!DOCTYPE html>
<html>

<head>
  <title>ï¿½ï¿½ æ·±åº¦DOMæ‹†è§£åˆ†æ</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }

    .panel {
      background: white;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .item {
      margin: 5px 0;
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }

    .warning {
      background: #fff3cd;
      color: #856404;
    }

    .info {
      background: #d1ecf1;
      color: #0c5460;
    }

    button {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #5b21b6;
    }

    .highlight {
      background: #ffeb3b;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .indent {
      margin-left: 20px;
    }
  </style>
</head>

<body>
  <div class="panel">
    <div class="title">ğŸ” æ·±åº¦DOMæ‹†è§£åˆ†æå·¥å…·</div>
    <p>ä¸“æ³¨äºå®šä½"åˆ†å‰²çº¿æ˜¾ç¤ºä½†æ¶ˆæ¯å†…å®¹ä¸å¯è§"çš„æ ¹å› </p>
    <button onclick="analyzeMessageContent()">ğŸ” æ¶ˆæ¯å†…å®¹åˆ†æ</button>
    <button onclick="analyzeDOMStructure()">ğŸ“Š DOMç»“æ„åˆ†æ</button>
    <button onclick="analyzeVueData()">âš¡ Vueæ•°æ®æ£€æŸ¥</button>
    <button onclick="rootCauseAnalysis()">ï¿½ï¿½ æ ¹å› å®šä½</button>
  </div>

  <div class="panel">
    <div class="title">ğŸ“Š åˆ†æç»“æœ</div>
    <div id="results"></div>
  </div>

  <script>
    function log(msg, type = 'info', indent = false) {
      const div = document.createElement('div');
      div.className = `item ${type} ${indent ? 'indent' : ''}`;
      div.innerHTML = msg;
      document.getElementById('results').appendChild(div);
    }

    function clear() {
      document.getElementById('results').innerHTML = '';
    }

    function analyzeMessageContent() {
      clear();
      log('ğŸ” å¼€å§‹æ¶ˆæ¯å†…å®¹æ·±åº¦åˆ†æ...', 'info');

      const messageWrappers = document.querySelectorAll('.message-wrapper');
      const debugNoContent = document.querySelectorAll('.debug-no-content');

      log(`ğŸ“Š åŸºç¡€ç»Ÿè®¡:`, 'info');
      log(`æ¶ˆæ¯å®¹å™¨æ€»æ•°: ${messageWrappers.length}`, messageWrappers.length > 0 ? 'success' : 'error', true);
      log(`è°ƒè¯•æ— å†…å®¹æç¤º: ${debugNoContent.length}`, debugNoContent.length > 0 ? 'warning' : 'success', true);

      if (debugNoContent.length > 0) {
        log(`âŒ <span class="highlight">å‘ç°${debugNoContent.length}ä¸ªæ¶ˆæ¯ç¼ºå°‘contentå­—æ®µï¼</span>`, 'error');
        debugNoContent.forEach((debug, i) => {
          const wrapper = debug.closest('.message-wrapper');
          const messageId = wrapper ? wrapper.dataset.messageId : 'æœªçŸ¥';
          log(`æ— å†…å®¹æ¶ˆæ¯ ${i + 1}: ID=${messageId}`, 'error', true);
        });
      }

      // è¯¦ç»†åˆ†æå‰5ä¸ªæ¶ˆæ¯
      log(`ğŸ” è¯¦ç»†å†…å®¹åˆ†æ (å‰5ä¸ª):`, 'info');
      messageWrappers.forEach((wrapper, i) => {
        if (i < 5) {
          const messageId = wrapper.dataset.messageId;
          const messageItem = wrapper.querySelector('.message-item');
          const messageText = wrapper.querySelector('.message-text');
          const debugDiv = wrapper.querySelector('.debug-no-content');
          const messageContent = wrapper.querySelector('.message-content');

          log(`æ¶ˆæ¯ ${i + 1} (ID: ${messageId}):`, 'info', true);

          if (messageItem) {
            const rect = messageItem.getBoundingClientRect();
            log(`MessageItem: å­˜åœ¨ï¼Œå°ºå¯¸=${rect.width.toFixed(1)}Ã—${rect.height.toFixed(1)}px`, rect.height > 0 ? 'success' : 'error', true);
          } else {
            log(`MessageItem: ç¼ºå¤±`, 'error', true);
          }

          if (messageContent) {
            const contentRect = messageContent.getBoundingClientRect();
            log(`MessageContent: å­˜åœ¨ï¼Œå°ºå¯¸=${contentRect.width.toFixed(1)}Ã—${contentRect.height.toFixed(1)}px`, 'info', true);
          }

          if (messageText) {
            const textContent = messageText.textContent.trim();
            log(`æ–‡æœ¬å†…å®¹: "${textContent.substring(0, 50)}${textContent.length > 50 ? '...' : ''}"`, 'success', true);
            log(`æ–‡æœ¬é•¿åº¦: ${textContent.length}å­—ç¬¦`, 'info', true);
          } else if (debugDiv) {
            log(`çŠ¶æ€: æ˜¾ç¤ºè°ƒè¯•æç¤º (æ— contentå­—æ®µ)`, 'warning', true);
          } else {
            log(`çŠ¶æ€: æ—¢æ— æ–‡æœ¬ä¹Ÿæ— è°ƒè¯•æç¤º`, 'error', true);
          }
        }
      });
    }

    function analyzeDOMStructure() {
      log('ğŸ“Š å¼€å§‹DOMç»“æ„åˆ†æ...', 'info');

      const messageList = document.querySelector('.simple-message-list');
      const messagesWrapper = document.querySelector('.messages-wrapper');
      const messageWrappers = document.querySelectorAll('.message-wrapper');
      const dividers = document.querySelectorAll('time-session-divider, [class*="divider"]');

      log(`ğŸ—ï¸ ä¸»è¦å®¹å™¨çŠ¶æ€:`, 'info');
      log(`SimpleMessageList: ${messageList ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}`, messageList ? 'success' : 'error', true);
      log(`MessagesWrapper: ${messagesWrapper ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}`, messagesWrapper ? 'success' : 'error', true);

      if (messagesWrapper) {
        const wrapperRect = messagesWrapper.getBoundingClientRect();
        log(`MessagesWrapperå°ºå¯¸: ${wrapperRect.width.toFixed(1)}Ã—${wrapperRect.height.toFixed(1)}px`, 'info', true);
        log(`å­å…ƒç´ æ•°é‡: ${messagesWrapper.children.length}`, 'info', true);
      }

      log(`ğŸ“‹ æ¸²æŸ“å…ƒç´ ç»Ÿè®¡:`, 'info');
      log(`æ¶ˆæ¯å®¹å™¨(.message-wrapper): ${messageWrappers.length}`, messageWrappers.length > 0 ? 'success' : 'error', true);
      log(`åˆ†å‰²çº¿: ${dividers.length}`, dividers.length > 0 ? 'success' : 'info', true);

      if (messagesWrapper) {
        const children = Array.from(messagesWrapper.children);
        const elementTypes = {};
        children.forEach(child => {
          if (child.className.includes('message-wrapper')) {
            elementTypes.messages = (elementTypes.messages || 0) + 1;
          } else if (child.tagName.toLowerCase().includes('divider') || child.className.includes('divider')) {
            elementTypes.dividers = (elementTypes.dividers || 0) + 1;
          } else {
            elementTypes.other = (elementTypes.other || 0) + 1;
          }
        });

        log(`å…ƒç´ ç±»å‹åˆ†å¸ƒ: æ¶ˆæ¯=${elementTypes.messages || 0}, åˆ†å‰²çº¿=${elementTypes.dividers || 0}, å…¶ä»–=${elementTypes.other || 0}`, 'info', true);
      }

      // æ£€æŸ¥æ¶ˆæ¯æ¸²æŸ“è´¨é‡
      log(`ğŸ” æ¶ˆæ¯æ¸²æŸ“è´¨é‡æ£€æŸ¥:`, 'info');
      let visibleCount = 0;
      let withContentCount = 0;

      messageWrappers.forEach((wrapper, i) => {
        const rect = wrapper.getBoundingClientRect();
        const hasContent = wrapper.querySelector('.message-text') || wrapper.querySelector('.debug-no-content');

        if (rect.height > 0) visibleCount++;
        if (hasContent) withContentCount++;

        if (i < 3) {
          log(`æ¶ˆæ¯${i + 1}: å°ºå¯¸=${rect.width.toFixed(1)}Ã—${rect.height.toFixed(1)}px, æœ‰å†…å®¹=${!!hasContent}`,
            rect.height > 0 && hasContent ? 'success' : 'warning', true);
        }
      });

      log(`å¯è§æ¶ˆæ¯: ${visibleCount}/${messageWrappers.length}`, visibleCount === messageWrappers.length ? 'success' : 'warning', true);
      log(`æœ‰å†…å®¹æ¶ˆæ¯: ${withContentCount}/${messageWrappers.length}`, withContentCount > 0 ? 'success' : 'error', true);
    }

    function analyzeVueData() {
      log('âš¡ å¼€å§‹Vueæ•°æ®åˆ†æ...', 'info');

      const messageList = document.querySelector('.simple-message-list');

      if (messageList && messageList.__vueParentComponent) {
        const component = messageList.__vueParentComponent;
        const state = component.setupState || {};
        const props = component.props || {};

        log(`ğŸ”§ Vueç»„ä»¶æ•°æ®çŠ¶æ€:`, 'info');

        // æ£€æŸ¥enhancedMessages
        if (state.enhancedMessages) {
          const enhanced = state.enhancedMessages;
          log(`enhancedMessagesæ€»æ•°: ${enhanced.length}`, enhanced.length > 0 ? 'success' : 'warning', true);

          const messages = enhanced.filter(item => !item.type || (item.type !== 'date-divider' && item.type !== 'session-divider'));
          const dividers = enhanced.filter(item => item.type === 'date-divider' || item.type === 'session-divider');

          log(`å®é™…æ¶ˆæ¯: ${messages.length}, åˆ†å‰²çº¿: ${dividers.length}`, 'info', true);

          // è¯¦ç»†æ£€æŸ¥æ¶ˆæ¯contentå­—æ®µ
          if (messages.length > 0) {
            log(`ï¿½ï¿½ æ¶ˆæ¯contentå­—æ®µæ£€æŸ¥:`, 'info');
            let hasContentCount = 0;
            let noContentCount = 0;

            messages.slice(0, 5).forEach((msg, i) => {
              const hasContent = !!msg.content;
              if (hasContent) hasContentCount++;
              else noContentCount++;

              log(`æ¶ˆæ¯${i + 1} (ID: ${msg.id}):`, 'info', true);
              log(`  contentå­—æ®µ: ${hasContent ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}`, hasContent ? 'success' : 'error', true);
              if (hasContent) {
                log(`  å†…å®¹é•¿åº¦: ${msg.content.length}å­—ç¬¦`, 'info', true);
                log(`  å†…å®¹é¢„è§ˆ: "${msg.content.substring(0, 40)}${msg.content.length > 40 ? '...' : ''}"`, 'success', true);
              }
              log(`  æ‰€æœ‰å­—æ®µ: ${Object.keys(msg).join(', ')}`, 'info', true);
            });

            log(`<span class="highlight">contentå­—æ®µç»Ÿè®¡: æœ‰=${hasContentCount}, æ— =${noContentCount}</span>`,
              noContentCount > 0 ? 'error' : 'success', true);
          }
        }

        // æ£€æŸ¥åŸå§‹props
        if (props.messages) {
          log(`ğŸ“¥ åŸå§‹props.messages: ${props.messages.length}æ¡`, 'info', true);

          if (props.messages.length > 0) {
            const firstMsg = props.messages[0];
            log(`åŸå§‹æ¶ˆæ¯ç»“æ„ç¤ºä¾‹:`, 'info', true);
            log(`  å­—æ®µ: ${Object.keys(firstMsg).join(', ')}`, 'info', true);
            log(`  content: ${firstMsg.content ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, firstMsg.content ? 'success' : 'error', true);
            if (firstMsg.content) {
              log(`  contentå†…å®¹: "${firstMsg.content.substring(0, 50)}..."`, 'success', true);
            }
          }
        }

      } else {
        log('âŒ æ— æ³•è®¿é—®Vueç»„ä»¶å®ä¾‹', 'error', true);
      }
    }

    function rootCauseAnalysis() {
      log('ğŸ¯ å¼€å§‹æ ¹å› å®šä½åˆ†æ...', 'info');

      const messageWrappers = document.querySelectorAll('.message-wrapper');
      const debugNoContent = document.querySelectorAll('.debug-no-content');
      const visibleMessages = Array.from(messageWrappers).filter(w => {
        const messageText = w.querySelector('.message-text');
        return messageText && messageText.textContent.trim().length > 0;
      });
      const dividers = document.querySelectorAll('time-session-divider, [class*="divider"]');

      log(`ğŸ” ç—‡çŠ¶åˆ†æ:`, 'info');
      log(`åˆ†å‰²çº¿æ˜¾ç¤º: ${dividers.length > 0 ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`, dividers.length > 0 ? 'success' : 'error', true);
      log(`æ¶ˆæ¯å®¹å™¨: ${messageWrappers.length}ä¸ª`, messageWrappers.length > 0 ? 'success' : 'error', true);
      log(`å¯è§æ¶ˆæ¯å†…å®¹: ${visibleMessages.length}ä¸ª`, visibleMessages.length > 0 ? 'success' : 'error', true);
      log(`æ— å†…å®¹è°ƒè¯•æç¤º: ${debugNoContent.length}ä¸ª`, debugNoContent.length > 0 ? 'warning' : 'success', true);

      log(`ğŸ¯ æ ¹å› æ¨ç†:`, 'info');

      if (messageWrappers.length === 0) {
        log(`âŒ <span class="highlight">æ ¹å› ï¼šVueç»„ä»¶æœªæ­£ç¡®æ¸²æŸ“æ¶ˆæ¯å®¹å™¨</span>`, 'error', true);
        log(`å»ºè®®ï¼šæ£€æŸ¥enhancedMessages computedå±æ€§`, 'warning', true);
      } else if (debugNoContent.length > 0) {
        log(`âŒ <span class="highlight">æ ¹å› ï¼šæ¶ˆæ¯å¯¹è±¡ç¼ºå°‘contentå­—æ®µ</span>`, 'error', true);
        log(`å½±å“èŒƒå›´ï¼š${debugNoContent.length}/${messageWrappers.length}æ¡æ¶ˆæ¯`, 'error', true);
        log(`å»ºè®®ï¼šæ£€æŸ¥APIè¿”å›æ•°æ®æ ¼å¼æˆ–MessageSessionGrouperå¤„ç†é€»è¾‘`, 'warning', true);
      } else if (visibleMessages.length === 0 && messageWrappers.length > 0) {
        log(`âŒ <span class="highlight">æ ¹å› ï¼šCSSæ ·å¼æˆ–Vueæ¡ä»¶æ¸²æŸ“é—®é¢˜</span>`, 'error', true);
        log(`å»ºè®®ï¼šæ£€æŸ¥MessageItemç»„ä»¶çš„v-ifæ¡ä»¶å’ŒCSSæ ·å¼`, 'warning', true);
      } else if (visibleMessages.length < messageWrappers.length) {
        log(`âš ï¸ <span class="highlight">éƒ¨åˆ†æ ¹å› ï¼šæ··åˆé—®é¢˜</span>`, 'warning', true);
        log(`æ­£å¸¸æ˜¾ç¤ºï¼š${visibleMessages.length}/${messageWrappers.length}`, 'warning', true);
        log(`å»ºè®®ï¼šé€ä¸ªæ£€æŸ¥å¼‚å¸¸æ¶ˆæ¯çš„æ•°æ®ç»“æ„`, 'warning', true);
      } else {
        log(`âœ… <span class="highlight">æ¶ˆæ¯æ˜¾ç¤ºæ­£å¸¸</span>`, 'success', true);
      }

      log(`ğŸ”§ ä¸‹ä¸€æ­¥ä¿®å¤å»ºè®®:`, 'info');
      if (debugNoContent.length > 0) {
        log(`1. æ£€æŸ¥åç«¯APIè¿”å›çš„æ¶ˆæ¯å¯¹è±¡æ˜¯å¦åŒ…å«contentå­—æ®µ`, 'warning', true);
        log(`2. ç¡®è®¤MessageSessionGrouper.enhanceMessageWithSession()æ˜¯å¦æ­£ç¡®ä¼ é€’content`, 'warning', true);
        log(`3. éªŒè¯APIå“åº”æ ¼å¼æ˜¯å¦ä¸å‰ç«¯æœŸæœ›ä¸€è‡´`, 'warning', true);
      } else if (visibleMessages.length === 0) {
        log(`1. æ£€æŸ¥MessageItem.vueä¸­çš„v-if="message.content"æ¡ä»¶`, 'warning', true);
        log(`2. éªŒè¯CSSæ ·å¼æ˜¯å¦éšè—äº†æ¶ˆæ¯å†…å®¹`, 'warning', true);
        log(`3. æ£€æŸ¥Vueç»„ä»¶propsä¼ é€’æ˜¯å¦æ­£ç¡®`, 'warning', true);
      }
    }

    // è‡ªåŠ¨è¿è¡Œå®Œæ•´åˆ†æ
    window.addEventListener('load', () => {
      setTimeout(() => {
        analyzeMessageContent();
        setTimeout(() => {
          analyzeDOMStructure();
          setTimeout(() => {
            analyzeVueData();
            setTimeout(() => {
              rootCauseAnalysis();
            }, 500);
          }, 500);
        }, 500);
      }, 1000);
    });
  </script>
</body>

</html>