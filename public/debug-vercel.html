<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel API Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Vercel API Debug Tool</h1>
    <p>Current URL: <span id="currentUrl"></span></p>
    
    <div class="test-section">
        <h3>1. Configuration Test</h3>
        <button onclick="testConfig()">Load Configuration</button>
        <div id="configResult"></div>
    </div>
    
    <div class="test-section">
        <h3>2. API Connectivity Test</h3>
        <button onclick="testAPI()">Test API Connection</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Login Test</h3>
        <button onclick="testLogin()">Test Login (super@test.com)</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="test-section">
        <h3>4. Environment Info</h3>
        <button onclick="showEnvironment()">Show Environment</button>
        <div id="envResult"></div>
    </div>

    <script>
        document.getElementById('currentUrl').textContent = window.location.href;
        
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }
        
        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }
        
        async function testConfig() {
            clearResults('configResult');
            addResult('configResult', 'üîÑ Loading configuration...', 'info');
            
            try {
                const response = await fetch('/config/production.yml');
                if (response.ok) {
                    const text = await response.text();
                    addResult('configResult', '‚úÖ Configuration loaded successfully', 'success');
                    addResult('configResult', `<pre>${text.substring(0, 500)}...</pre>`, 'info');
                } else {
                    addResult('configResult', `‚ùå Failed to load config: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                addResult('configResult', `‚ùå Error loading config: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            clearResults('apiResult');
            addResult('apiResult', 'üîÑ Testing API connectivity...', 'info');
            
            try {
                // First load config to get API URL
                const configResponse = await fetch('/config/production.yml');
                const configText = await configResponse.text();
                
                // Simple YAML parsing to get base_url
                const baseUrlMatch = configText.match(/base_url:\s*"([^"]+)"/);
                if (!baseUrlMatch) {
                    addResult('apiResult', '‚ùå Could not find base_url in config', 'error');
                    return;
                }
                
                const baseUrl = baseUrlMatch[1];
                addResult('apiResult', `üîó API URL: ${baseUrl}`, 'info');
                
                // Test API health
                const healthResponse = await fetch(`${baseUrl}/health`);
                addResult('apiResult', `üè• Health check: ${healthResponse.status} ${healthResponse.statusText}`, 
                    healthResponse.ok ? 'success' : 'error');
                
                // Test signin endpoint
                const signinResponse = await fetch(`${baseUrl}/signin`, { method: 'HEAD' });
                addResult('apiResult', `üîê Signin endpoint: ${signinResponse.status} ${signinResponse.statusText}`, 
                    signinResponse.status === 405 ? 'success' : 'error');
                    
            } catch (error) {
                addResult('apiResult', `‚ùå API test error: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            clearResults('loginResult');
            addResult('loginResult', 'üîÑ Testing login...', 'info');
            
            try {
                // Load config to get API URL
                const configResponse = await fetch('/config/production.yml');
                const configText = await configResponse.text();
                const baseUrlMatch = configText.match(/base_url:\s*"([^"]+)"/);
                
                if (!baseUrlMatch) {
                    addResult('loginResult', '‚ùå Could not find base_url in config', 'error');
                    return;
                }
                
                const baseUrl = baseUrlMatch[1];
                
                // Test login
                const loginResponse = await fetch(`${baseUrl}/signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'super@test.com',
                        password: 'password'
                    })
                });
                
                addResult('loginResult', `üì° Login response: ${loginResponse.status} ${loginResponse.statusText}`, 
                    loginResponse.ok ? 'success' : 'error');
                
                if (loginResponse.ok) {
                    const data = await loginResponse.json();
                    addResult('loginResult', `‚úÖ Login successful! User: ${data.data?.user?.fullname}`, 'success');
                    addResult('loginResult', `üé´ Token received: ${data.data?.access_token ? 'Yes' : 'No'}`, 'info');
                } else {
                    const errorText = await loginResponse.text();
                    addResult('loginResult', `‚ùå Login failed: ${errorText}`, 'error');
                }
                
            } catch (error) {
                addResult('loginResult', `‚ùå Login test error: ${error.message}`, 'error');
            }
        }
        
        function showEnvironment() {
            clearResults('envResult');
            
            const info = {
                'User Agent': navigator.userAgent,
                'URL': window.location.href,
                'Protocol': window.location.protocol,
                'Host': window.location.host,
                'Origin': window.location.origin,
                'Referrer': document.referrer,
                'Cookies Enabled': navigator.cookieEnabled,
                'Local Storage': typeof(Storage) !== "undefined",
                'Fetch Support': typeof(fetch) !== "undefined"
            };
            
            for (const [key, value] of Object.entries(info)) {
                addResult('envResult', `${key}: ${value}`, 'info');
            }
        }
    </script>
</body>
</html> 