<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidebar State Debug Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .status-true { background: #d4edda; color: #155724; }
        .status-false { background: #f8d7da; color: #721c24; }
        .status-unknown { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log-panel {
            background: #2d3748;
            color: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="debug-panel">
        <h1>ğŸ” Sidebar Debug Tool</h1>
        <p>æ£€æŸ¥ChatBar/ä¾§è¾¹æ ä¸æ˜¾ç¤ºçš„åŸå› </p>
        
        <div id="status-display">
            <div class="status-item status-unknown">
                <span>è®¤è¯çŠ¶æ€ (authStore.isAuthenticated)</span>
                <span id="auth-status">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item status-unknown">
                <span>å½“å‰è·¯å¾„ (route.path)</span>
                <span id="current-path">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item status-unknown">
                <span>åº”è¯¥æ˜¾ç¤ºä¾§è¾¹æ  (shouldShowSidebar)</span>
                <span id="should-show-sidebar">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item status-unknown">
                <span>localStorage auth_token</span>
                <span id="local-token">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item status-unknown">
                <span>è®¤è¯ç”¨æˆ·ä¿¡æ¯ (authStore.user)</span>
                <span id="user-info">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item status-unknown">
                <span>èŠå¤©æ•°æ® (chatStore.chats)</span>
                <span id="chats-info">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>

        <div>
            <button onclick="checkStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            <button onclick="forceRefresh()">ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡µé¢</button>
            <button onclick="clearAuth()">ğŸ§¹ æ¸…é™¤è®¤è¯</button>
            <button onclick="checkConsole()">ğŸ“Š æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—</button>
        </div>

        <div class="log-panel" id="log-output">
            ç‚¹å‡» "ğŸ”„ åˆ·æ–°çŠ¶æ€" å¼€å§‹æ£€æŸ¥...
        </div>
    </div>

    <script>
        function log(message) {
            const logPanel = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logPanel.innerHTML += `[${timestamp}] ${message}\n`;
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        function updateStatus(id, value, isGood = null) {
            const element = document.getElementById(id);
            element.textContent = value;
            
            if (isGood === null) {
                element.parentElement.className = 'status-item status-unknown';
            } else if (isGood) {
                element.parentElement.className = 'status-item status-true';
            } else {
                element.parentElement.className = 'status-item status-false';
            }
        }

        function checkStatus() {
            log('ğŸ” å¼€å§‹æ£€æŸ¥ä¾§è¾¹æ çŠ¶æ€...');
            
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            const authToken = localStorage.getItem('auth_token');
            const authUser = localStorage.getItem('auth_user');
            updateStatus('local-token', authToken ? `å­˜åœ¨ (${authToken.substring(0, 20)}...)` : 'ä¸å­˜åœ¨', !!authToken);
            log(`ğŸ“¦ localStorage auth_token: ${authToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            
            try {
                const user = authUser ? JSON.parse(authUser) : null;
                updateStatus('user-info', user ? `${user.email || user.fullname || 'Unknown'}` : 'æ— ç”¨æˆ·ä¿¡æ¯', !!user);
                log(`ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${user ? user.email || 'å­˜åœ¨' : 'æ— '}`);
            } catch (e) {
                updateStatus('user-info', 'è§£æé”™è¯¯', false);
                log(`âŒ ç”¨æˆ·ä¿¡æ¯è§£æé”™è¯¯: ${e.message}`);
            }

            // æ£€æŸ¥å½“å‰è·¯å¾„
            const currentPath = window.location.pathname;
            updateStatus('current-path', currentPath, true);
            log(`ğŸ“ å½“å‰è·¯å¾„: ${currentPath}`);
            
            // æ£€æŸ¥ä¾§è¾¹æ æ˜¾ç¤ºé€»è¾‘
            const noSidebarRoutes = ['/login', '/register', '/error', '/demo', '/test', '/debug'];
            const shouldHideSidebar = noSidebarRoutes.some(route => 
                currentPath === route || currentPath.startsWith(route + '/')
            );
            const isAuthenticated = !!(authToken && authUser);
            const shouldShowSidebar = isAuthenticated && !shouldHideSidebar;
            
            updateStatus('should-show-sidebar', shouldShowSidebar ? 'æ˜¯' : 'å¦', shouldShowSidebar);
            log(`ğŸ¯ ä¾§è¾¹æ æ˜¾ç¤ºé€»è¾‘:`);
            log(`   - å·²è®¤è¯: ${isAuthenticated}`);
            log(`   - åº”è¯¥éšè—: ${shouldHideSidebar}`);
            log(`   - æœ€ç»ˆç»“æœ: ${shouldShowSidebar ? 'æ˜¾ç¤º' : 'ä¸æ˜¾ç¤º'}`);
            
            updateStatus('auth-status', isAuthenticated ? 'å·²è®¤è¯' : 'æœªè®¤è¯', isAuthenticated);

            // æ£€æŸ¥èŠå¤©æ•°æ®
            try {
                const chatsData = localStorage.getItem('chats') || '[]';
                const chats = JSON.parse(chatsData);
                updateStatus('chats-info', `${chats.length} ä¸ªèŠå¤©`, chats.length > 0);
                log(`ğŸ’¬ èŠå¤©æ•°æ®: ${chats.length} ä¸ª`);
            } catch (e) {
                updateStatus('chats-info', 'æ— æ•°æ®', false);
                log(`âŒ èŠå¤©æ•°æ®è§£æé”™è¯¯: ${e.message}`);
            }

            log('âœ… çŠ¶æ€æ£€æŸ¥å®Œæˆ');
            
            // è¯Šæ–­ç»“è®º
            if (!isAuthenticated) {
                log('ğŸš¨ é—®é¢˜è¯Šæ–­: ç”¨æˆ·æœªè®¤è¯ï¼Œéœ€è¦é‡æ–°ç™»å½•');
            } else if (shouldHideSidebar) {
                log('ğŸš¨ é—®é¢˜è¯Šæ–­: å½“å‰è·¯å¾„ä¸åº”æ˜¾ç¤ºä¾§è¾¹æ ');
            } else if (shouldShowSidebar) {
                log('ğŸš¨ é—®é¢˜è¯Šæ–­: åº”è¯¥æ˜¾ç¤ºä¾§è¾¹æ ä½†å®é™…æœªæ˜¾ç¤ºï¼Œå¯èƒ½æ˜¯Vueç»„ä»¶æ¸²æŸ“é—®é¢˜');
            }
        }

        function forceRefresh() {
            window.location.reload();
        }

        function clearAuth() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®¤è¯æ•°æ®å—ï¼Ÿ')) {
                ['auth_token', 'auth_user', 'fechatter_access_token', 'fechatter_refresh_token', 'remember_me'].forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                log('ğŸ§¹ è®¤è¯æ•°æ®å·²æ¸…é™¤');
                setTimeout(() => window.location.href = '/login', 1000);
            }
        }

        function checkConsole() {
            log('ğŸ“Š è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12) æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º');
            log('ğŸ” æŸ¥æ‰¾ä»¥ä¸‹å…³é”®å­—çš„æ—¥å¿—:');
            log('   - [App.vue] Sidebar visibility check');
            log('   - shouldShowSidebar');
            log('   - isAuthenticated');
            console.log('ğŸ” Sidebar Debug - å½“å‰çŠ¶æ€æ£€æŸ¥');
            console.log('è®¤è¯token:', localStorage.getItem('auth_token'));
            console.log('å½“å‰è·¯å¾„:', window.location.pathname);
        }

        // è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
        setTimeout(checkStatus, 500);
    </script>
</body>
</html> 