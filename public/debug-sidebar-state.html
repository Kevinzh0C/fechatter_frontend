<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidebar State Debug Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .status-true { background: #d4edda; color: #155724; }
        .status-false { background: #f8d7da; color: #721c24; }
        .status-unknown { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log-panel {
            background: #2d3748;
            color: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="debug-panel">
        <h1>🔍 Sidebar Debug Tool</h1>
        <p>检查ChatBar/侧边栏不显示的原因</p>
        
        <div id="status-display">
            <div class="status-item status-unknown">
                <span>认证状态 (authStore.isAuthenticated)</span>
                <span id="auth-status">检查中...</span>
            </div>
            <div class="status-item status-unknown">
                <span>当前路径 (route.path)</span>
                <span id="current-path">检查中...</span>
            </div>
            <div class="status-item status-unknown">
                <span>应该显示侧边栏 (shouldShowSidebar)</span>
                <span id="should-show-sidebar">检查中...</span>
            </div>
            <div class="status-item status-unknown">
                <span>localStorage auth_token</span>
                <span id="local-token">检查中...</span>
            </div>
            <div class="status-item status-unknown">
                <span>认证用户信息 (authStore.user)</span>
                <span id="user-info">检查中...</span>
            </div>
            <div class="status-item status-unknown">
                <span>聊天数据 (chatStore.chats)</span>
                <span id="chats-info">检查中...</span>
            </div>
        </div>

        <div>
            <button onclick="checkStatus()">🔄 刷新状态</button>
            <button onclick="forceRefresh()">🔄 强制刷新页面</button>
            <button onclick="clearAuth()">🧹 清除认证</button>
            <button onclick="checkConsole()">📊 检查控制台日志</button>
        </div>

        <div class="log-panel" id="log-output">
            点击 "🔄 刷新状态" 开始检查...
        </div>
    </div>

    <script>
        function log(message) {
            const logPanel = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logPanel.innerHTML += `[${timestamp}] ${message}\n`;
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        function updateStatus(id, value, isGood = null) {
            const element = document.getElementById(id);
            element.textContent = value;
            
            if (isGood === null) {
                element.parentElement.className = 'status-item status-unknown';
            } else if (isGood) {
                element.parentElement.className = 'status-item status-true';
            } else {
                element.parentElement.className = 'status-item status-false';
            }
        }

        function checkStatus() {
            log('🔍 开始检查侧边栏状态...');
            
            // 检查认证状态
            const authToken = localStorage.getItem('auth_token');
            const authUser = localStorage.getItem('auth_user');
            updateStatus('local-token', authToken ? `存在 (${authToken.substring(0, 20)}...)` : '不存在', !!authToken);
            log(`📦 localStorage auth_token: ${authToken ? '存在' : '不存在'}`);
            
            try {
                const user = authUser ? JSON.parse(authUser) : null;
                updateStatus('user-info', user ? `${user.email || user.fullname || 'Unknown'}` : '无用户信息', !!user);
                log(`👤 用户信息: ${user ? user.email || '存在' : '无'}`);
            } catch (e) {
                updateStatus('user-info', '解析错误', false);
                log(`❌ 用户信息解析错误: ${e.message}`);
            }

            // 检查当前路径
            const currentPath = window.location.pathname;
            updateStatus('current-path', currentPath, true);
            log(`📍 当前路径: ${currentPath}`);
            
            // 检查侧边栏显示逻辑
            const noSidebarRoutes = ['/login', '/register', '/error', '/demo', '/test', '/debug'];
            const shouldHideSidebar = noSidebarRoutes.some(route => 
                currentPath === route || currentPath.startsWith(route + '/')
            );
            const isAuthenticated = !!(authToken && authUser);
            const shouldShowSidebar = isAuthenticated && !shouldHideSidebar;
            
            updateStatus('should-show-sidebar', shouldShowSidebar ? '是' : '否', shouldShowSidebar);
            log(`🎯 侧边栏显示逻辑:`);
            log(`   - 已认证: ${isAuthenticated}`);
            log(`   - 应该隐藏: ${shouldHideSidebar}`);
            log(`   - 最终结果: ${shouldShowSidebar ? '显示' : '不显示'}`);
            
            updateStatus('auth-status', isAuthenticated ? '已认证' : '未认证', isAuthenticated);

            // 检查聊天数据
            try {
                const chatsData = localStorage.getItem('chats') || '[]';
                const chats = JSON.parse(chatsData);
                updateStatus('chats-info', `${chats.length} 个聊天`, chats.length > 0);
                log(`💬 聊天数据: ${chats.length} 个`);
            } catch (e) {
                updateStatus('chats-info', '无数据', false);
                log(`❌ 聊天数据解析错误: ${e.message}`);
            }

            log('✅ 状态检查完成');
            
            // 诊断结论
            if (!isAuthenticated) {
                log('🚨 问题诊断: 用户未认证，需要重新登录');
            } else if (shouldHideSidebar) {
                log('🚨 问题诊断: 当前路径不应显示侧边栏');
            } else if (shouldShowSidebar) {
                log('🚨 问题诊断: 应该显示侧边栏但实际未显示，可能是Vue组件渲染问题');
            }
        }

        function forceRefresh() {
            window.location.reload();
        }

        function clearAuth() {
            if (confirm('确定要清除所有认证数据吗？')) {
                ['auth_token', 'auth_user', 'fechatter_access_token', 'fechatter_refresh_token', 'remember_me'].forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                log('🧹 认证数据已清除');
                setTimeout(() => window.location.href = '/login', 1000);
            }
        }

        function checkConsole() {
            log('📊 请打开浏览器开发者工具 (F12) 查看控制台输出');
            log('🔍 查找以下关键字的日志:');
            log('   - [App.vue] Sidebar visibility check');
            log('   - shouldShowSidebar');
            log('   - isAuthenticated');
            console.log('🔍 Sidebar Debug - 当前状态检查');
            console.log('认证token:', localStorage.getItem('auth_token'));
            console.log('当前路径:', window.location.pathname);
        }

        // 自动检查一次
        setTimeout(checkStatus, 500);
    </script>
</body>
</html> 