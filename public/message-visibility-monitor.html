<!DOCTYPE html>
<html>

<head>
  <title>ğŸ” æ¶ˆæ¯å¯è§æ€§å®æ—¶ç›‘æ§</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f7fa;
    }

    .monitor-panel {
      background: white;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 20px;
      right: 20px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 10000;
    }

    .status-good {
      color: #10b981;
      font-weight: bold;
    }

    .status-error {
      color: #ef4444;
      font-weight: bold;
    }

    .status-warning {
      color: #f59e0b;
      font-weight: bold;
    }

    .log-entry {
      padding: 5px;
      margin: 2px 0;
      border-left: 3px solid #e5e7eb;
      font-size: 12px;
      font-family: monospace;
    }

    .timestamp {
      color: #6b7280;
    }

    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin: 2px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="monitor-panel">
    <h3>ğŸ” æ¶ˆæ¯å¯è§æ€§ç›‘æ§å™¨</h3>
    <p>ç›‘æ§æ¶ˆæ¯æ˜¾ç¤ºçŠ¶æ€å˜åŒ–</p>

    <div>
      <button onclick="startMonitoring()">ğŸš€ å¼€å§‹ç›‘æ§</button>
      <button onclick="stopMonitoring()">â¹ï¸ åœæ­¢ç›‘æ§</button>
      <button onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
      <button onclick="forceReveal()">ğŸ”§ å¼ºåˆ¶æ˜¾ç¤º</button>
    </div>

    <div style="margin: 10px 0;">
      <label>ç›‘æ§é—´éš”: <select id="interval">
          <option value="500">500ms</option>
          <option value="1000" selected>1s</option>
          <option value="2000">2s</option>
        </select></label>
    </div>

    <div id="status" style="padding: 10px; background: #f8f9fa; border-radius: 4px; margin: 10px 0;">
      çŠ¶æ€: æœªå¼€å§‹
    </div>

    <div id="log" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
      <div class="log-entry">ç›‘æ§æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    </div>
  </div>

  <script>
    let monitoringInterval = null;
    let previousState = {};
    let logCount = 0;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'status-good' : type === 'error' ? 'status-error' : type === 'warning' ? 'status-warning' : '';

      logCount++;
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="${className}">${message}</span>`;

      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;

      // Keep only last 50 entries
      if (logCount > 50) {
        logDiv.removeChild(logDiv.firstChild);
      }
    }

    function updateStatus(text, type = 'info') {
      const statusDiv = document.getElementById('status');
      const className = type === 'success' ? 'status-good' : type === 'error' ? 'status-error' : type === 'warning' ? 'status-warning' : '';
      statusDiv.innerHTML = `<span class="${className}">çŠ¶æ€: ${text}</span>`;
    }

    function checkMessageVisibility() {
      const messageItems = document.querySelectorAll('[data-message-id]');
      const textElements = document.querySelectorAll('.message-text');

      const currentState = {
        messageCount: messageItems.length,
        textCount: textElements.length,
        visibleMessages: 0,
        visibleTexts: 0,
        cssIssues: []
      };

      // æ£€æŸ¥æ¯ä¸ªæ¶ˆæ¯çš„å¯è§æ€§
      messageItems.forEach((item, index) => {
        const rect = item.getBoundingClientRect();
        if (rect.width > 0 && rect.height > 0) {
          currentState.visibleMessages++;
        }

        // æ£€æŸ¥CSSå±æ€§
        const styles = getComputedStyle(item);
        if (styles.display === 'none') currentState.cssIssues.push(`Message ${index}: display none`);
        if (styles.visibility === 'hidden') currentState.cssIssues.push(`Message ${index}: visibility hidden`);
        if (parseFloat(styles.opacity) < 0.1) currentState.cssIssues.push(`Message ${index}: opacity low`);
      });

      // æ£€æŸ¥æ–‡æœ¬å…ƒç´ 
      textElements.forEach((text, index) => {
        const rect = text.getBoundingClientRect();
        if (rect.width > 0 && rect.height > 0) {
          currentState.visibleTexts++;
        }

        const styles = getComputedStyle(text);
        if (styles.display === 'none') currentState.cssIssues.push(`Text ${index}: display none`);
        if (styles.color === 'rgba(0, 0, 0, 0)' || styles.color === 'transparent') {
          currentState.cssIssues.push(`Text ${index}: transparent color`);
        }
      });

      // æ£€æµ‹å˜åŒ–
      if (JSON.stringify(previousState) !== JSON.stringify(currentState)) {
        // çŠ¶æ€å‘ç”Ÿå˜åŒ–
        if (currentState.messageCount !== previousState.messageCount) {
          log(`ğŸ“Š æ¶ˆæ¯æ•°é‡å˜åŒ–: ${previousState.messageCount || 0} â†’ ${currentState.messageCount}`, 'info');
        }

        if (currentState.visibleMessages !== previousState.visibleMessages) {
          const type = currentState.visibleMessages > (previousState.visibleMessages || 0) ? 'success' : 'error';
          log(`ğŸ‘ï¸ å¯è§æ¶ˆæ¯å˜åŒ–: ${previousState.visibleMessages || 0} â†’ ${currentState.visibleMessages}`, type);
        }

        if (currentState.visibleTexts !== previousState.visibleTexts) {
          const type = currentState.visibleTexts > (previousState.visibleTexts || 0) ? 'success' : 'error';
          log(`ğŸ“ å¯è§æ–‡æœ¬å˜åŒ–: ${previousState.visibleTexts || 0} â†’ ${currentState.visibleTexts}`, type);
        }

        if (currentState.cssIssues.length > 0) {
          currentState.cssIssues.forEach(issue => {
            log(`âš ï¸ CSSé—®é¢˜: ${issue}`, 'warning');
          });
        }

        previousState = { ...currentState };
      }

      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      const successRate = currentState.messageCount > 0 ?
        Math.round((currentState.visibleMessages / currentState.messageCount) * 100) : 0;

      const statusType = successRate >= 80 ? 'success' : successRate >= 50 ? 'warning' : 'error';
      updateStatus(`${currentState.visibleMessages}/${currentState.messageCount} æ¶ˆæ¯å¯è§ (${successRate}%)`, statusType);
    }

    function startMonitoring() {
      if (monitoringInterval) return;

      const interval = parseInt(document.getElementById('interval').value);
      log('ğŸš€ å¼€å§‹ç›‘æ§æ¶ˆæ¯å¯è§æ€§...', 'info');

      // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
      checkMessageVisibility();

      // è®¾ç½®å®šæœŸæ£€æŸ¥
      monitoringInterval = setInterval(checkMessageVisibility, interval);
      updateStatus('ç›‘æ§ä¸­...', 'success');
    }

    function stopMonitoring() {
      if (!monitoringInterval) return;

      clearInterval(monitoringInterval);
      monitoringInterval = null;
      log('â¹ï¸ ç›‘æ§å·²åœæ­¢', 'warning');
      updateStatus('å·²åœæ­¢', 'warning');
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…ç©º</div>';
      logCount = 0;
    }

    function forceReveal() {
      log('ğŸ”§ åº”ç”¨å¼ºåˆ¶æ˜¾ç¤ºCSS...', 'info');

      const style = document.createElement('style');
      style.id = 'force-reveal-style';
      style.textContent = `
                [data-message-id] {
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    background: #ffffff !important;
                    border: 2px solid #ef4444 !important;
                    min-height: 80px !important;
                    margin: 10px 0 !important;
                    padding: 15px !important;
                }
                [data-message-id] .message-text {
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    color: #000000 !important;
                    background: rgba(255, 255, 0, 0.3) !important;
                    font-size: 16px !important;
                    font-weight: bold !important;
                    min-height: 2em !important;
                    line-height: 1.4 !important;
                }
            `;

      // ç§»é™¤ä¹‹å‰çš„å¼ºåˆ¶æ ·å¼
      const existingStyle = document.getElementById('force-reveal-style');
      if (existingStyle) existingStyle.remove();

      document.head.appendChild(style);
      log('âœ… å¼ºåˆ¶æ˜¾ç¤ºCSSå·²åº”ç”¨ (çº¢è‰²è¾¹æ¡† + é»„è‰²èƒŒæ™¯)', 'success');

      // ç«‹å³æ£€æŸ¥æ•ˆæœ
      setTimeout(() => {
        checkMessageVisibility();
      }, 100);
    }

    // è‡ªåŠ¨å¼€å§‹ç›‘æ§
    window.addEventListener('load', () => {
      setTimeout(() => {
        log('ğŸ¯ é¡µé¢åŠ è½½å®Œæˆï¼Œè‡ªåŠ¨å¼€å§‹ç›‘æ§...', 'info');
        startMonitoring();
      }, 2000);
    });

    // ç›‘å¬é¡µé¢å˜åŒ–
    const observer = new MutationObserver(() => {
      if (monitoringInterval) {
        checkMessageVisibility();
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['style', 'class']
    });
  </script>
</body>

</html>