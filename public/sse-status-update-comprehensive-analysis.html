<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”¬ SSEæ¶ˆæ¯çŠ¶æ€æ›´æ–°ç³»ç»Ÿåˆ†æ - æœ¬è´¨åŸå› æ¢æŸ¥</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .dag-analysis {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .dag-section {
      margin-bottom: 25px;
    }

    .dag-title {
      font-size: 1.4rem;
      color: #2d3748;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .issue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .issue-card {
      background: #f8fafc;
      border-left: 4px solid #ef4444;
      border-radius: 8px;
      padding: 20px;
    }

    .issue-card.critical {
      border-left-color: #dc2626;
      background: #fef2f2;
    }

    .issue-card.warning {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }

    .issue-card.info {
      border-left-color: #3b82f6;
      background: #eff6ff;
    }

    .fix-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .fix-card {
      background: white;
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s ease;
    }

    .fix-card:hover {
      transform: translateY(-2px);
    }

    .analysis-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 5px;
    }

    .analysis-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .analysis-btn.critical {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .analysis-btn.success {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .log-panel {
      background: #1a202c;
      color: #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      font-family: 'Consolas', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      margin: 20px 0;
    }

    .flow-diagram {
      background: #f7fafc;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      overflow-x: auto;
    }

    .flow-step {
      display: inline-block;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px 15px;
      margin: 5px;
      position: relative;
    }

    .flow-step.active {
      border-color: #3b82f6;
      background: #dbeafe;
    }

    .flow-step.error {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .flow-step.success {
      border-color: #10b981;
      background: #ecfdf5;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator.connected {
      background: #10b981;
    }

    .status-indicator.disconnected {
      background: #ef4444;
    }

    .status-indicator.pending {
      background: #f59e0b;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”¬ SSEæ¶ˆæ¯çŠ¶æ€æ›´æ–°ç³»ç»Ÿåˆ†æ</h1>
      <p>æ·±å…¥æ¢æŸ¥SSEä¸èƒ½é¡ºåˆ©æ›´æ–°æ¶ˆæ¯çŠ¶æ€çš„æœ¬è´¨åŸå› </p>
    </div>

    <div class="dag-analysis">
      <div class="dag-section">
        <h2 class="dag-title">
          ğŸ¯ æ ¹æœ¬é—®é¢˜è¯Šæ–­
        </h2>
        <div class="issue-grid">
          <div class="issue-card critical">
            <h3>ğŸš¨ Critical: SSEäº‹ä»¶ç›‘å¬å™¨ä¸¢å¤±</h3>
            <p>MinimalSSEæœåŠ¡å¯èƒ½æ²¡æœ‰æ­£ç¡®è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨ï¼Œå¯¼è‡´SSEäº‹ä»¶æ— æ³•è§¦å‘çŠ¶æ€æ›´æ–°</p>
            <code>minimalSSE.on('message', handler)</code>
          </div>

          <div class="issue-card critical">
            <h3>âš¡ Critical: Vueå“åº”å¼ç³»ç»Ÿå¤±æ•ˆ</h3>
            <p>unifiedMessageService.messagesByChatçš„Mapæ›´æ–°å¯èƒ½æ²¡æœ‰è§¦å‘Vueçš„å“åº”å¼ç³»ç»Ÿ</p>
            <code>Map.set() ä¸ä¼šè‡ªåŠ¨è§¦å‘Vueæ›´æ–°</code>
          </div>

          <div class="issue-card warning">
            <h3>ğŸ”„ Warning: æ¶ˆæ¯IDåŒ¹é…ç­–ç•¥å¤±è´¥</h3>
            <p>updateRealtimeMessageå¯èƒ½å› ä¸ºIDä¸åŒ¹é…è€Œæ— æ³•æ‰¾åˆ°å¯¹åº”æ¶ˆæ¯è¿›è¡ŒçŠ¶æ€æ›´æ–°</p>
            <code>ID vs temp_id vs server_id åŒ¹é…é—®é¢˜</code>
          </div>

          <div class="issue-card warning">
            <h3>â° Warning: SSEè¶…æ—¶æ¸…ç†æœºåˆ¶</h3>
            <p>SSEç¡®è®¤è¶…æ—¶åå¯èƒ½è¿‡æ—©æ¸…ç†äº†æ¶ˆæ¯è¿½è¸ªï¼Œå¯¼è‡´åç»­SSEäº‹ä»¶æ— æ³•å¤„ç†</p>
            <code>15ç§’è¶…æ—¶åçŠ¶æ€å˜ä¸ºtimeout</code>
          </div>

          <div class="issue-card info">
            <h3>ğŸ“¡ Info: DOMå…ƒç´ æ›´æ–°å»¶è¿Ÿ</h3>
            <p>nextTickå’ŒDOMæ“ä½œå¯èƒ½å­˜åœ¨æ—¶åºé—®é¢˜ï¼Œå¯¼è‡´UIæ›´æ–°ä¸åŠæ—¶</p>
            <code>Vueç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸DOMæ›´æ–°ä¸åŒæ­¥</code>
          </div>

          <div class="issue-card info">
            <h3>ğŸ”€ Info: å†…å®¹åŒ¹é…å†²çª</h3>
            <p>å¤šæ¡ç›¸ä¼¼å†…å®¹çš„æ¶ˆæ¯å¯èƒ½å¯¼è‡´å†…å®¹åŒ¹é…ç­–ç•¥é€‰æ‹©é”™è¯¯çš„æ¶ˆæ¯è¿›è¡Œæ›´æ–°</p>
            <code>content + sender_id + chat_id åŒ¹é…å†²çª</code>
          </div>
        </div>
      </div>

      <div class="dag-section">
        <h2 class="dag-title">
          ğŸ”§ ç³»ç»Ÿä¿®å¤ç­–ç•¥
        </h2>
        <div class="fix-grid">
          <div class="fix-card">
            <h3>1. ğŸ”— SSEè¿æ¥è¯Šæ–­ä¿®å¤</h3>
            <p>æ£€æŸ¥å¹¶é‡å»ºSSEè¿æ¥ï¼Œç¡®ä¿äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®æ³¨å†Œ</p>
            <button class="analysis-btn critical" onclick="diagnosSSEConnection()">
              è¯Šæ–­SSEè¿æ¥
            </button>
          </div>

          <div class="fix-card">
            <h3>2. âš¡ Vueå“åº”å¼å¼ºåŒ–</h3>
            <p>å¼ºåˆ¶è§¦å‘Vueå“åº”å¼æ›´æ–°é“¾ï¼Œç¡®ä¿çŠ¶æ€å˜åŒ–ç«‹å³åæ˜ åˆ°UI</p>
            <button class="analysis-btn" onclick="forceVueReactivity()">
              å¼ºåŒ–å“åº”å¼
            </button>
          </div>

          <div class="fix-card">
            <h3>3. ğŸ¯ æ¶ˆæ¯åŒ¹é…ä¼˜åŒ–</h3>
            <p>æ”¹è¿›æ¶ˆæ¯IDåŒ¹é…ç­–ç•¥ï¼Œå¢åŠ å¤šé‡åŒ¹é…æœºåˆ¶</p>
            <button class="analysis-btn" onclick="optimizeMessageMatching()">
              ä¼˜åŒ–åŒ¹é…
            </button>
          </div>

          <div class="fix-card">
            <h3>4. ğŸ“Š å®æ—¶çŠ¶æ€ç›‘æ§</h3>
            <p>å»ºç«‹æ¶ˆæ¯çŠ¶æ€å˜åŒ–çš„å®æ—¶ç›‘æ§ç³»ç»Ÿ</p>
            <button class="analysis-btn success" onclick="startRealtimeMonitoring()">
              å¯åŠ¨ç›‘æ§
            </button>
          </div>
        </div>
      </div>

      <div class="dag-section">
        <h2 class="dag-title">
          ğŸ“Š ç³»ç»ŸçŠ¶æ€ä»ªè¡¨æ¿
        </h2>
        <div id="systemStatus">
          <p>ğŸ”„ æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿè¯Šæ–­...</p>
        </div>
      </div>

      <div class="dag-section">
        <h2 class="dag-title">
          ğŸ”„ SSEæ¶ˆæ¯æµç¨‹è¿½è¸ª
        </h2>
        <div class="flow-diagram" id="sseFlow">
          <div class="flow-step" id="step1">1. ç”¨æˆ·å‘é€æ¶ˆæ¯</div>
          <div class="flow-step" id="step2">2. APIå“åº”æˆåŠŸ</div>
          <div class="flow-step" id="step3">3. æ¶ˆæ¯çŠ¶æ€: sent</div>
          <div class="flow-step" id="step4">4. SSEäº‹ä»¶æ¥æ”¶</div>
          <div class="flow-step" id="step5">5. æ¶ˆæ¯IDåŒ¹é…</div>
          <div class="flow-step" id="step6">6. çŠ¶æ€æ›´æ–°</div>
          <div class="flow-step" id="step7">7. Vueå“åº”å¼</div>
          <div class="flow-step" id="step8">8. UIæ›´æ–°</div>
          <div class="flow-step" id="step9">9. ç»¿è‰²å¯¹å·æ˜¾ç¤º</div>
        </div>
      </div>

      <div class="log-panel" id="analysisLog">
        <strong>ğŸ” ç³»ç»Ÿåˆ†ææ—¥å¿—</strong><br>
        <span style="color: #68d391;">[ç³»ç»Ÿ] SSEçŠ¶æ€æ›´æ–°åˆ†æå·¥å…·å·²åŠ è½½</span>
      </div>
    </div>

    <div style="text-align: center; margin: 30px 0;">
      <button class="analysis-btn critical" onclick="runCompleteAnalysis()">
        ğŸš€ è¿è¡Œå®Œæ•´ç³»ç»Ÿåˆ†æ
      </button>
      <button class="analysis-btn" onclick="simulateSSEFix()">
        ğŸ› ï¸ æ¨¡æ‹ŸSSEä¿®å¤
      </button>
      <button class="analysis-btn success" onclick="window.open('http://localhost:5173/chat/2', '_blank')">
        ğŸ§ª æ‰“å¼€æµ‹è¯•ç¯å¢ƒ
      </button>
    </div>
  </div>

  <script>
    let monitoringInterval = null;
    let sseConnectionState = 'unknown';
    let messageUpdateCount = 0;

    function addLog(message, type = 'info') {
      const logPanel = document.getElementById('analysisLog');
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: '#68d391',
        success: '#48bb78',
        warning: '#ed8936',
        error: '#f56565',
        debug: '#63b3ed'
      };

      logPanel.innerHTML += `<br><span style="color: ${colors[type]};">[${timestamp}] ${message}</span>`;
      logPanel.scrollTop = logPanel.scrollHeight;
    }

    function updateFlowStep(stepId, status) {
      const step = document.getElementById(stepId);
      if (step) {
        step.className = `flow-step ${status}`;
      }
    }

    function diagnosSSEConnection() {
      addLog('ğŸ”— å¼€å§‹SSEè¿æ¥è¯Šæ–­...', 'info');

      // æ£€æŸ¥MinimalSSEæœåŠ¡
      if (window.minimalSSE) {
        addLog('âœ… MinimalSSEæœåŠ¡å·²åŠ è½½', 'success');

        const status = window.minimalSSE.getStatus ? window.minimalSSE.getStatus() : { connected: false };
        sseConnectionState = status.connected ? 'connected' : 'disconnected';

        addLog(`ğŸ“¡ SSEè¿æ¥çŠ¶æ€: ${sseConnectionState}`, status.connected ? 'success' : 'error');

        if (status.connected) {
          addLog('ğŸ¯ æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨...', 'info');

          // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ•°é‡
          const listeners = window.minimalSSE.listeners;
          if (listeners && listeners.has) {
            const messageListeners = listeners.get('message') || [];
            addLog(`ğŸ“¨ æ¶ˆæ¯ç›‘å¬å™¨æ•°é‡: ${messageListeners.length}`, messageListeners.length > 0 ? 'success' : 'warning');

            if (messageListeners.length === 0) {
              addLog('âš ï¸ è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯ç›‘å¬å™¨ï¼è¿™æ˜¯SSEçŠ¶æ€æ›´æ–°å¤±è´¥çš„å…³é”®åŸå› ', 'error');
              addLog('ğŸ”§ å»ºè®®: é‡æ–°åˆå§‹åŒ–chat storeçš„setupSSEMessageListeners()', 'warning');
            }
          }
        } else {
          addLog('âŒ SSEè¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿...', 'error');

          // å°è¯•é‡è¿
          if (window.minimalSSE.connect && window.tokenManager) {
            const token = window.tokenManager.getAccessToken();
            if (token) {
              window.minimalSSE.connect(token);
              addLog('ğŸ”„ å·²è§¦å‘SSEé‡è¿', 'info');
            } else {
              addLog('âŒ æ— æ³•è·å–è®¿é—®ä»¤ç‰Œï¼Œé‡è¿å¤±è´¥', 'error');
            }
          }
        }
      } else {
        addLog('âŒ MinimalSSEæœåŠ¡æœªåŠ è½½ï¼è¿™æ˜¯è‡´å‘½é—®é¢˜', 'error');
        addLog('ğŸ”§ æ£€æŸ¥: import minimalSSE from "@/services/sse-minimal"', 'warning');
      }

      updateSystemStatus();
    }

    function forceVueReactivity() {
      addLog('âš¡ å¼€å§‹Vueå“åº”å¼ç³»ç»Ÿå¼ºåŒ–...', 'info');

      // æ£€æŸ¥Chat Store
      if (window.app && window.app._context && window.app._context.provides) {
        const pinia = window.app._context.provides[Symbol.for('pinia')];
        if (pinia) {
          addLog('âœ… PiniaçŠ¶æ€ç®¡ç†å·²æ‰¾åˆ°', 'success');

          // å°è¯•è·å–chat store
          const chatStore = pinia._s.get('chat');
          if (chatStore) {
            addLog('âœ… ChatStoreå®ä¾‹å·²æ‰¾åˆ°', 'success');

            // å¼ºåˆ¶å“åº”å¼æ›´æ–°
            try {
              chatStore.$patch({ _forceUpdate: Date.now() });
              addLog('ğŸ”„ å·²å¼ºåˆ¶è§¦å‘storeæ›´æ–°', 'success');

              // æ£€æŸ¥UnifiedMessageService
              if (window.unifiedMessageService) {
                addLog('âœ… UnifiedMessageServiceå·²æ‰¾åˆ°', 'success');

                // è·å–å½“å‰èŠå¤©æ¶ˆæ¯
                const currentChatId = chatStore.currentChatId;
                if (currentChatId) {
                  const messages = window.unifiedMessageService.getMessagesForChat(currentChatId);
                  addLog(`ğŸ“Š å½“å‰èŠå¤©å®¤${currentChatId}æœ‰${messages ? messages.length : 0}æ¡æ¶ˆæ¯`, 'info');

                  // å¼ºåˆ¶é‡æ–°è®¾ç½®æ¶ˆæ¯æ•°ç»„ä»¥è§¦å‘å“åº”å¼
                  if (messages && messages.length > 0) {
                    const newMessages = [...messages];
                    window.unifiedMessageService.messagesByChat.set(currentChatId, newMessages);
                    addLog('ğŸ”„ å·²å¼ºåˆ¶è§¦å‘æ¶ˆæ¯æ•°ç»„å“åº”å¼æ›´æ–°', 'success');
                  }
                }
              } else {
                addLog('âš ï¸ UnifiedMessageServiceæœªæ‰¾åˆ°', 'warning');
              }

            } catch (error) {
              addLog(`âŒ Vueå“åº”å¼å¼ºåŒ–å¤±è´¥: ${error.message}`, 'error');
            }
          } else {
            addLog('âŒ ChatStoreå®ä¾‹æœªæ‰¾åˆ°', 'error');
          }
        } else {
          addLog('âŒ PiniaçŠ¶æ€ç®¡ç†æœªæ‰¾åˆ°', 'error');
        }
      } else {
        addLog('âŒ Vueåº”ç”¨å®ä¾‹æœªæ‰¾åˆ°', 'error');
      }
    }

    function optimizeMessageMatching() {
      addLog('ğŸ¯ å¼€å§‹æ¶ˆæ¯åŒ¹é…ç­–ç•¥ä¼˜åŒ–...', 'info');

      if (window.unifiedMessageService) {
        const chatStores = window.app?._context?.provides?.[Symbol.for('pinia')]?._s?.get('chat');
        if (chatStores) {
          addLog('ğŸ” åˆ†æå½“å‰æ¶ˆæ¯åŒ¹é…æƒ…å†µ...', 'info');

          const currentChatId = chatStores.currentChatId;
          if (currentChatId) {
            const messages = window.unifiedMessageService.getMessagesForChat(currentChatId);

            if (messages) {
              const sentMessages = messages.filter(m => m.status === 'sent');
              const deliveredMessages = messages.filter(m => m.status === 'delivered');
              const sseConfirmedMessages = messages.filter(m => m.confirmed_via_sse);

              addLog(`ğŸ“Š æ¶ˆæ¯çŠ¶æ€ç»Ÿè®¡:`, 'info');
              addLog(`  - å·²å‘é€: ${sentMessages.length}`, sentMessages.length > 0 ? 'warning' : 'success');
              addLog(`  - å·²é€è¾¾: ${deliveredMessages.length}`, 'success');
              addLog(`  - SSEç¡®è®¤: ${sseConfirmedMessages.length}`, 'success');

              if (sentMessages.length > 0) {
                addLog('âš ï¸ å‘ç°æœªç¡®è®¤çš„sentçŠ¶æ€æ¶ˆæ¯ï¼Œè¿™å¯èƒ½æ˜¯SSEçŠ¶æ€æ›´æ–°å¤±è´¥çš„è¯æ®', 'warning');

                // åˆ†æè¿™äº›æ¶ˆæ¯çš„ç‰¹å¾
                sentMessages.forEach((msg, index) => {
                  addLog(`ğŸ“ æ¶ˆæ¯${index + 1}: ID=${msg.id}, temp_id=${msg.temp_id}, å‘é€æ—¶é—´=${msg.created_at}`, 'debug');
                });
              }
            }
          }
        }
      }

      addLog('ğŸ”§ æ¶ˆæ¯åŒ¹é…ä¼˜åŒ–å»ºè®®:', 'info');
      addLog('1. ä½¿ç”¨å¤šé‡IDåŒ¹é…ç­–ç•¥ (id, temp_id, server_id)', 'info');
      addLog('2. å¢åŠ æ—¶é—´çª—å£å†…å®¹åŒ¹é… (60ç§’å†…)', 'info');
      addLog('3. å®ç°SSEäº‹ä»¶å»é‡æœºåˆ¶', 'info');
      addLog('4. æ·»åŠ æ¶ˆæ¯çŠ¶æ€å˜åŒ–æ—¥å¿—', 'info');
    }

    function startRealtimeMonitoring() {
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
        addLog('â¹ï¸ åœæ­¢å®æ—¶ç›‘æ§', 'info');
        monitoringInterval = null;
        return;
      }

      addLog('ğŸ“Š å¯åŠ¨å®æ—¶çŠ¶æ€ç›‘æ§...', 'success');

      monitoringInterval = setInterval(() => {
        // ç›‘æ§SSEè¿æ¥çŠ¶æ€
        if (window.minimalSSE) {
          const currentStatus = window.minimalSSE.getStatus?.();
          const newState = currentStatus?.connected ? 'connected' : 'disconnected';

          if (newState !== sseConnectionState) {
            sseConnectionState = newState;
            addLog(`ğŸ”„ SSEè¿æ¥çŠ¶æ€å˜åŒ–: ${newState}`, newState === 'connected' ? 'success' : 'error');
          }
        }

        // ç›‘æ§æ¶ˆæ¯çŠ¶æ€å˜åŒ–
        if (window.unifiedMessageService) {
          const chatStore = window.app?._context?.provides?.[Symbol.for('pinia')]?._s?.get('chat');
          if (chatStore && chatStore.currentChatId) {
            const messages = window.unifiedMessageService.getMessagesForChat(chatStore.currentChatId);
            if (messages) {
              const currentUpdateCount = messages.filter(m => m.confirmed_via_sse || m.status === 'delivered').length;

              if (currentUpdateCount !== messageUpdateCount) {
                const diff = currentUpdateCount - messageUpdateCount;
                messageUpdateCount = currentUpdateCount;
                addLog(`âœ… æ£€æµ‹åˆ°${diff}æ¡æ¶ˆæ¯çŠ¶æ€æ›´æ–°`, 'success');
              }
            }
          }
        }

        updateSystemStatus();
      }, 2000);

      addLog('ğŸ”„ ç›‘æ§æ¯2ç§’æ›´æ–°ä¸€æ¬¡', 'info');
    }

    function updateSystemStatus() {
      const statusDiv = document.getElementById('systemStatus');
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';

      // SSEè¿æ¥çŠ¶æ€
      html += `
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
          <h4><span class="status-indicator ${sseConnectionState}"></span>SSEè¿æ¥</h4>
          <p>çŠ¶æ€: ${sseConnectionState}</p>
        </div>
      `;

      // Vueå“åº”å¼çŠ¶æ€
      const vueStatus = window.app ? 'active' : 'inactive';
      html += `
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
          <h4><span class="status-indicator ${vueStatus === 'active' ? 'connected' : 'disconnected'}"></span>Vueç³»ç»Ÿ</h4>
          <p>çŠ¶æ€: ${vueStatus}</p>
        </div>
      `;

      // æ¶ˆæ¯æœåŠ¡çŠ¶æ€
      const messageServiceStatus = window.unifiedMessageService ? 'active' : 'inactive';
      html += `
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
          <h4><span class="status-indicator ${messageServiceStatus === 'active' ? 'connected' : 'disconnected'}"></span>æ¶ˆæ¯æœåŠ¡</h4>
          <p>çŠ¶æ€: ${messageServiceStatus}</p>
        </div>
      `;

      // ç›‘æ§çŠ¶æ€
      html += `
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
          <h4><span class="status-indicator ${monitoringInterval ? 'connected' : 'disconnected'}"></span>å®æ—¶ç›‘æ§</h4>
          <p>çŠ¶æ€: ${monitoringInterval ? 'running' : 'stopped'}</p>
        </div>
      `;

      html += '</div>';
      statusDiv.innerHTML = html;
    }

    function runCompleteAnalysis() {
      addLog('ğŸš€ å¼€å§‹å®Œæ•´ç³»ç»Ÿåˆ†æ...', 'success');

      // é‡ç½®æµç¨‹å›¾
      for (let i = 1; i <= 9; i++) {
        updateFlowStep(`step${i}`, '');
      }

      setTimeout(() => {
        updateFlowStep('step1', 'active');
        diagnosSSEConnection();
      }, 500);

      setTimeout(() => {
        updateFlowStep('step2', 'active');
        forceVueReactivity();
      }, 1500);

      setTimeout(() => {
        updateFlowStep('step3', 'active');
        optimizeMessageMatching();
      }, 2500);

      setTimeout(() => {
        updateFlowStep('step4', sseConnectionState === 'connected' ? 'success' : 'error');
        addLog('ğŸ“‹ åˆ†æå®Œæˆï¼æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—äº†è§£å…·ä½“é—®é¢˜å’Œä¿®å¤å»ºè®®', 'success');

        // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
        generateDiagnosticReport();
      }, 3500);
    }

    function generateDiagnosticReport() {
      addLog('ğŸ“Š ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š...', 'info');

      const issues = [];
      const fixes = [];

      if (sseConnectionState !== 'connected') {
        issues.push('SSEè¿æ¥æ–­å¼€');
        fixes.push('é‡æ–°å»ºç«‹SSEè¿æ¥å¹¶æ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨');
      }

      if (!window.minimalSSE) {
        issues.push('MinimalSSEæœåŠ¡æœªåŠ è½½');
        fixes.push('æ£€æŸ¥SSEæœåŠ¡å¯¼å…¥å’Œåˆå§‹åŒ–');
      }

      if (!window.unifiedMessageService) {
        issues.push('UnifiedMessageServiceæœªåŠ è½½');
        fixes.push('ç¡®ä¿æ¶ˆæ¯æœåŠ¡æ­£ç¡®åˆå§‹åŒ–');
      }

      addLog('ğŸ¯ è¯Šæ–­æ€»ç»“:', 'success');
      addLog(`âŒ å‘ç°é—®é¢˜: ${issues.length}ä¸ª`, issues.length > 0 ? 'error' : 'success');
      addLog(`ğŸ”§ ä¿®å¤å»ºè®®: ${fixes.length}ä¸ª`, 'info');

      if (issues.length === 0) {
        addLog('âœ… ç³»ç»ŸçŠ¶æ€è‰¯å¥½ï¼Œå¦‚æœä»æœ‰SSEçŠ¶æ€æ›´æ–°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä¸šåŠ¡é€»è¾‘å±‚', 'success');
      }
    }

    function simulateSSEFix() {
      addLog('ğŸ› ï¸ æ¨¡æ‹ŸSSEä¿®å¤æµç¨‹...', 'info');

      // æ¨¡æ‹Ÿä¿®å¤æ­¥éª¤
      setTimeout(() => {
        addLog('1. é‡æ–°å»ºç«‹SSEè¿æ¥', 'info');
        updateFlowStep('step4', 'active');
      }, 500);

      setTimeout(() => {
        addLog('2. é‡æ–°æ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨', 'info');
        updateFlowStep('step5', 'active');
      }, 1000);

      setTimeout(() => {
        addLog('3. å¼ºåŒ–Vueå“åº”å¼æ›´æ–°é“¾', 'info');
        updateFlowStep('step6', 'active');
      }, 1500);

      setTimeout(() => {
        addLog('4. éªŒè¯æ¶ˆæ¯çŠ¶æ€æ›´æ–°', 'info');
        updateFlowStep('step7', 'success');
        updateFlowStep('step8', 'success');
        updateFlowStep('step9', 'success');
      }, 2000);

      setTimeout(() => {
        addLog('âœ… SSEä¿®å¤æ¨¡æ‹Ÿå®Œæˆï¼è¯·åœ¨å®é™…èŠå¤©ç•Œé¢æµ‹è¯•æ¶ˆæ¯å‘é€', 'success');
      }, 2500);
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      addLog('ğŸ”¬ SSEæ¶ˆæ¯çŠ¶æ€æ›´æ–°ç³»ç»Ÿåˆ†æå·¥å…·å·²åŠ è½½', 'success');
      addLog('ç‚¹å‡»"è¿è¡Œå®Œæ•´ç³»ç»Ÿåˆ†æ"å¼€å§‹è¯Šæ–­', 'info');

      setTimeout(updateSystemStatus, 1000);
    });

    // ç›‘æ§é¡µé¢ä¸Šçš„æ¶ˆæ¯çŠ¶æ€å˜åŒ–
    if (typeof MutationObserver !== 'undefined') {
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === 'attributes' &&
            (mutation.attributeName === 'data-status' || mutation.attributeName === 'data-confirmed-via-sse')) {
            const element = mutation.target;
            const messageId = element.getAttribute('data-message-id');
            const status = element.getAttribute('data-status');
            const confirmedViaSSE = element.getAttribute('data-confirmed-via-sse');

            if (status === 'delivered' || confirmedViaSSE === 'true') {
              addLog(`ğŸ‰ å®æ—¶æ£€æµ‹åˆ°æ¶ˆæ¯${messageId}çŠ¶æ€æ›´æ–°ä¸ºdelivered`, 'success');
              updateFlowStep('step9', 'success');
            }
          }
        });
      });

      // å»¶è¿Ÿå¯åŠ¨è§‚å¯Ÿå™¨ä»¥é¿å…åˆå§‹åŒ–å™ªéŸ³
      setTimeout(() => {
        const chatContainer = document.querySelector('.message-list, .chat-container, [data-message-id]');
        if (chatContainer) {
          observer.observe(chatContainer, {
            attributes: true,
            attributeFilter: ['data-status', 'data-confirmed-via-sse'],
            subtree: true
          });
          addLog('ğŸ‘ï¸ DOMçŠ¶æ€ç›‘æ§å·²æ¿€æ´»', 'debug');
        }
      }, 3000);
    }
  </script>
</body>

</html>