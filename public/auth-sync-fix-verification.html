<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ è®¤è¯çŠ¶æ€åŒæ­¥ä¿®å¤éªŒè¯</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.2rem; margin-bottom: 10px; font-weight: 700; }
        .content { padding: 30px; }
        .fix-summary { background: #f0f9ff; border-radius: 12px; padding: 20px; margin-bottom: 30px; border-left: 4px solid #0ea5e9; }
        .fix-item { background: #f8f9fa; margin: 15px 0; padding: 20px; border-radius: 8px; border-left: 4px solid #e9ecef; }
        .fix-item.success { border-left-color: #22c55e; background: #f0fdf4; }
        .fix-item.error { border-left-color: #ef4444; background: #fef2f2; }
        .fix-item.testing { border-left-color: #f59e0b; background: #fffbeb; }
        .fix-title { font-weight: 600; margin-bottom: 8px; color: #1f2937; }
        .fix-description { color: #6b7280; margin-bottom: 12px; line-height: 1.5; }
        .fix-result { font-family: monospace; font-size: 14px; padding: 10px; background: white; border-radius: 6px; }
        .controls { display: flex; gap: 15px; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; transform: translateY(-2px); }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .results { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .log-entry { background: white; border-radius: 6px; padding: 8px 12px; margin-bottom: 6px; border-left: 4px solid #e9ecef; font-family: monospace; font-size: 13px; }
        .log-entry.success { border-left-color: #10b981; }
        .log-entry.error { border-left-color: #f56565; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .log-entry.info { border-left-color: #3b82f6; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
        .status-success { background: #10b981; }
        .status-error { background: #f56565; }
        .status-warning { background: #f59e0b; }
        .status-testing { background: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ è®¤è¯çŠ¶æ€åŒæ­¥ä¿®å¤éªŒè¯</h1>
            <p>éªŒè¯ç™»å½•åé‡å®šå‘åˆ°ç™»å½•é¡µçš„é—®é¢˜ä¿®å¤</p>
        </div>

        <div class="content">
            <div class="fix-summary">
                <h3>ğŸ¯ ä¿®å¤æ¦‚è¦</h3>
                <p><strong>é—®é¢˜</strong>: ç”¨æˆ·æˆåŠŸç™»å½•åç«‹å³è¢«é‡å®šå‘å›ç™»å½•é¡µé¢</p>
                <p><strong>æ ¹å› </strong>: è·¯ç”±å®ˆå«åœ¨è®¤è¯çŠ¶æ€å®Œå…¨åŒæ­¥ä¹‹å‰å°±æ‰§è¡Œäº†æ£€æŸ¥</p>
                <p><strong>è§£å†³æ–¹æ¡ˆ</strong>: å¢åŠ è®¤è¯çŠ¶æ€åŒæ­¥ç­‰å¾…æœºåˆ¶ + å¢å¼ºå®¹é”™æ€§</p>
            </div>

            <div class="fix-item" id="fix-1">
                <div class="fix-title">
                    <span class="status-indicator" id="status-1"></span>
                    AuthStateManager å¸ƒå°”å€¼ä¿®å¤
                </div>
                <div class="fix-description">éªŒè¯ isAuthenticated è¿”å›æ­£ç¡®çš„å¸ƒå°”å€¼è€Œä¸æ˜¯æ•°å­—</div>
                <div class="fix-result" id="result-1">ç­‰å¾…æ£€æµ‹...</div>
            </div>

            <div class="fix-item" id="fix-2">
                <div class="fix-title">
                    <span class="status-indicator" id="status-2"></span>
                    è·¯ç”±å®ˆå«æ—¶åºä¿®å¤
                </div>
                <div class="fix-description">éªŒè¯è·¯ç”±å®ˆå«ç­‰å¾…è®¤è¯çŠ¶æ€åŒæ­¥å®Œæˆ</div>
                <div class="fix-result" id="result-2">ç­‰å¾…æ£€æµ‹...</div>
            </div>

            <div class="fix-item" id="fix-3">
                <div class="fix-title">
                    <span class="status-indicator" id="status-3"></span>
                    ç›´æ¥å­˜å‚¨å›é€€æœºåˆ¶
                </div>
                <div class="fix-description">éªŒè¯å½“ä¸»è¦è®¤è¯æ£€æŸ¥å¤±è´¥æ—¶çš„localStorageç›´æ¥æ£€æŸ¥æœºåˆ¶</div>
                <div class="fix-result" id="result-3">ç­‰å¾…æ£€æµ‹...</div>
            </div>

            <div class="fix-item" id="fix-4">
                <div class="fix-title">
                    <span class="status-indicator" id="status-4"></span>
                    ç™»å½•å¯¼èˆªæµ‹è¯•
                </div>
                <div class="fix-description">æ¨¡æ‹Ÿç™»å½•åçš„å¯¼èˆªæµç¨‹ï¼ŒéªŒè¯ä¸ä¼šé‡å®šå‘åˆ°ç™»å½•é¡µ</div>
                <div class="fix-result" id="result-4">ç­‰å¾…æ£€æµ‹...</div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="runFullVerification()">ğŸ” å®Œæ•´éªŒè¯</button>
                <button class="btn btn-success" onclick="testLoginFlow()">ğŸš€ æµ‹è¯•ç™»å½•æµç¨‹</button>
                <button class="btn btn-danger" onclick="clearAuthState()">ğŸ§¹ æ¸…é™¤è®¤è¯çŠ¶æ€</button>
            </div>

            <div class="results">
                <h3>ğŸ” æµ‹è¯•æ—¥å¿—</h3>
                <div id="log-container">
                    <div class="log-entry info">âœ… è®¤è¯çŠ¶æ€åŒæ­¥ä¿®å¤éªŒè¯ç³»ç»Ÿå°±ç»ª</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateFixStatus(fixId, status, result) {
            const fixItem = document.getElementById(`fix-${fixId}`);
            const statusIndicator = document.getElementById(`status-${fixId}`);
            const resultDiv = document.getElementById(`result-${fixId}`);
            
            fixItem.className = `fix-item ${status}`;
            statusIndicator.className = `status-indicator status-${status}`;
            resultDiv.innerHTML = result;
        }

        async function checkAuthStateManagerBooleanFix() {
            updateFixStatus(1, 'testing', 'æ­£åœ¨æ£€æŸ¥AuthStateManager...');
            log('ğŸ” æ£€æŸ¥ AuthStateManager å¸ƒå°”å€¼ä¿®å¤...', 'info');

            try {
                localStorage.setItem('auth_token', 'test-token-12345');
                localStorage.setItem('auth_user', JSON.stringify({ id: 1, email: 'test@test.com' }));

                if (window.authStateManager) {
                    const authState = window.authStateManager.getAuthState();
                    const isBoolean = typeof authState.isAuthenticated === 'boolean';
                    
                    if (isBoolean) {
                        updateFixStatus(1, 'success', `âœ… isAuthenticated è¿”å›å¸ƒå°”å€¼: ${authState.isAuthenticated}`);
                        log('âœ… AuthStateManager å¸ƒå°”å€¼ä¿®å¤éªŒè¯é€šè¿‡', 'success');
                        return true;
                    } else {
                        updateFixStatus(1, 'error', `âŒ isAuthenticated è¿”å›éå¸ƒå°”å€¼: ${typeof authState.isAuthenticated} (${authState.isAuthenticated})`);
                        log('âŒ AuthStateManager ä»è¿”å›éå¸ƒå°”å€¼', 'error');
                        return false;
                    }
                } else {
                    updateFixStatus(1, 'warning', 'âš ï¸ AuthStateManager æœªåœ¨å…¨å±€èŒƒå›´å†…å¯ç”¨');
                    log('âš ï¸ AuthStateManager éœ€è¦åœ¨å®é™…åº”ç”¨ä¸­æµ‹è¯•', 'warning');
                    return false;
                }
            } catch (error) {
                updateFixStatus(1, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                log(`âŒ AuthStateManager æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            } finally {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('auth_user');
            }
        }

        async function checkRouterGuardTimingFix() {
            updateFixStatus(2, 'testing', 'æ­£åœ¨æ£€æŸ¥è·¯ç”±å®ˆå«æ—¶åºä¿®å¤...');
            log('ğŸ” æ£€æŸ¥è·¯ç”±å®ˆå«æ—¶åºä¿®å¤...', 'info');

            try {
                const startTime = performance.now();
                
                localStorage.setItem('auth_token', 'timing-test-token');
                localStorage.setItem('auth_user', JSON.stringify({ id: 1, email: 'timing@test.com' }));
                
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            setTimeout(resolve, 50);
                        });
                    });
                });
                
                const endTime = performance.now();
                const waitTime = endTime - startTime;
                
                if (waitTime >= 40) {
                    updateFixStatus(2, 'success', `âœ… åŒæ­¥ç­‰å¾…æ—¶é—´: ${waitTime.toFixed(1)}ms (å……è¶³)`);
                    log('âœ… è·¯ç”±å®ˆå«æ—¶åºä¿®å¤éªŒè¯é€šè¿‡', 'success');
                    return true;
                } else {
                    updateFixStatus(2, 'warning', `âš ï¸ åŒæ­¥ç­‰å¾…æ—¶é—´: ${waitTime.toFixed(1)}ms (å¯èƒ½ä¸è¶³)`);
                    log('âš ï¸ è·¯ç”±å®ˆå«åŒæ­¥ç­‰å¾…æ—¶é—´è¾ƒçŸ­', 'warning');
                    return false;
                }
            } catch (error) {
                updateFixStatus(2, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                log(`âŒ è·¯ç”±å®ˆå«æ—¶åºæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            } finally {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('auth_user');
            }
        }

        async function checkDirectStorageFallback() {
            updateFixStatus(3, 'testing', 'æ­£åœ¨æ£€æŸ¥ç›´æ¥å­˜å‚¨å›é€€æœºåˆ¶...');
            log('ğŸ” æ£€æŸ¥ç›´æ¥å­˜å‚¨å›é€€æœºåˆ¶...', 'info');

            try {
                localStorage.setItem('auth_token', 'fallback-test-token');
                localStorage.setItem('auth_user', JSON.stringify({ id: 1, email: 'fallback@test.com' }));
                
                const directUser = localStorage.getItem('auth_user');
                const directToken = localStorage.getItem('auth_token');
                
                const fallbackWorks = !!(directUser && directToken);
                
                if (fallbackWorks) {
                    try {
                        const userObj = JSON.parse(directUser);
                        const hasValidData = userObj && userObj.id;
                        
                        if (hasValidData) {
                            updateFixStatus(3, 'success', 'âœ… ç›´æ¥å­˜å‚¨å›é€€æœºåˆ¶å·¥ä½œæ­£å¸¸');
                            log('âœ… ç›´æ¥å­˜å‚¨å›é€€æœºåˆ¶éªŒè¯é€šè¿‡', 'success');
                            return true;
                        } else {
                            updateFixStatus(3, 'error', 'âŒ ç”¨æˆ·æ•°æ®æ ¼å¼æ— æ•ˆ');
                            log('âŒ ç›´æ¥å­˜å‚¨ç”¨æˆ·æ•°æ®æ ¼å¼é”™è¯¯', 'error');
                            return false;
                        }
                    } catch (parseError) {
                        updateFixStatus(3, 'error', `âŒ JSONè§£æå¤±è´¥: ${parseError.message}`);
                        log('âŒ ç›´æ¥å­˜å‚¨JSONè§£æå¤±è´¥', 'error');
                        return false;
                    }
                } else {
                    updateFixStatus(3, 'error', 'âŒ ç›´æ¥å­˜å‚¨å›é€€æœºåˆ¶å¤±è´¥');
                    log('âŒ ç›´æ¥å­˜å‚¨å›é€€æœºåˆ¶ä¸å·¥ä½œ', 'error');
                    return false;
                }
            } catch (error) {
                updateFixStatus(3, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                log(`âŒ ç›´æ¥å­˜å‚¨å›é€€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            } finally {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('auth_user');
            }
        }

        async function checkLoginNavigation() {
            updateFixStatus(4, 'testing', 'æ­£åœ¨æ¨¡æ‹Ÿç™»å½•å¯¼èˆªæµ‹è¯•...');
            log('ğŸ” æ¨¡æ‹Ÿç™»å½•å¯¼èˆªæµ‹è¯•...', 'info');

            try {
                localStorage.clear();
                sessionStorage.clear();
                
                const mockUser = { id: 1, email: 'nav-test@test.com', username: 'navtest' };
                const mockToken = 'navigation-test-token-12345';
                
                localStorage.setItem('auth_token', mockToken);
                localStorage.setItem('auth_user', JSON.stringify(mockUser));
                
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            setTimeout(resolve, 100);
                        });
                    });
                });
                
                const hasToken = !!localStorage.getItem('auth_token');
                const hasUser = !!localStorage.getItem('auth_user');
                const hasValidAuth = hasToken && hasUser;
                
                if (hasValidAuth) {
                    updateFixStatus(4, 'success', 'âœ… æ¨¡æ‹Ÿç™»å½•å¯¼èˆªçŠ¶æ€æ­£å¸¸ï¼Œä¸åº”é‡å®šå‘åˆ°ç™»å½•é¡µ');
                    log('âœ… ç™»å½•å¯¼èˆªæµ‹è¯•é€šè¿‡ - åº”è¯¥å¯ä»¥æ­£å¸¸è®¿é—®å—ä¿æŠ¤é¡µé¢', 'success');
                    log('ğŸ“ å®é™…æµ‹è¯•: ç°åœ¨å¯ä»¥å°è¯•è®¿é—® /home é¡µé¢éªŒè¯ä¿®å¤æ•ˆæœ', 'info');
                    return true;
                } else {
                    updateFixStatus(4, 'error', 'âŒ æ¨¡æ‹Ÿç™»å½•çŠ¶æ€è®¾ç½®å¤±è´¥');
                    log('âŒ ç™»å½•å¯¼èˆªæµ‹è¯•å¤±è´¥', 'error');
                    return false;
                }
            } catch (error) {
                updateFixStatus(4, 'error', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                log(`âŒ ç™»å½•å¯¼èˆªæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        async function runFullVerification() {
            log('ğŸš€ å¼€å§‹å®Œæ•´éªŒè¯æµç¨‹...', 'info');
            
            const results = [];
            results.push(await checkAuthStateManagerBooleanFix());
            results.push(await checkRouterGuardTimingFix());
            results.push(await checkDirectStorageFallback());
            results.push(await checkLoginNavigation());
            
            const passedCount = results.filter(Boolean).length;
            const totalCount = results.length;
            const successRate = Math.round((passedCount / totalCount) * 100);
            
            if (successRate >= 75) {
                log(`ğŸ‰ éªŒè¯å®Œæˆï¼é€šè¿‡ç‡: ${successRate}% (${passedCount}/${totalCount})`, 'success');
                log('âœ… è®¤è¯çŠ¶æ€åŒæ­¥ä¿®å¤éªŒè¯é€šè¿‡ï¼Œç™»å½•é‡å®šå‘é—®é¢˜åº”è¯¥å·²è§£å†³', 'success');
            } else {
                log(`âš ï¸ éªŒè¯å®Œæˆï¼Œé€šè¿‡ç‡: ${successRate}% (${passedCount}/${totalCount})`, 'warning');
                log('âŒ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡ï¼Œå»ºè®®è¿›ä¸€æ­¥è°ƒè¯•', 'warning');
            }
        }

        function testLoginFlow() {
            log('ğŸ”„ é‡å®šå‘åˆ°ç™»å½•é¡µé¢è¿›è¡Œå®é™…æµ‹è¯•...', 'info');
            const loginUrl = window.location.origin + '/login';
            window.open(loginUrl, '_blank');
            log('ğŸ“ è¯·åœ¨æ–°çª—å£ä¸­ç™»å½•ï¼Œç„¶åè§‚å¯Ÿæ˜¯å¦ä¼šé‡å®šå‘å›ç™»å½•é¡µé¢', 'info');
        }

        function clearAuthState() {
            localStorage.clear();
            sessionStorage.clear();
            log('ğŸ§¹ æ‰€æœ‰è®¤è¯çŠ¶æ€å·²æ¸…é™¤', 'info');
            
            for (let i = 1; i <= 4; i++) {
                updateFixStatus(i, '', 'ç­‰å¾…æ£€æµ‹...');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ”§ è®¤è¯çŠ¶æ€åŒæ­¥ä¿®å¤éªŒè¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
            setTimeout(() => {
                log('ğŸ” è‡ªåŠ¨å¼€å§‹éªŒè¯æµç¨‹...', 'info');
                runFullVerification();
            }, 1000);
        });
    </script>
</body>
</html>
