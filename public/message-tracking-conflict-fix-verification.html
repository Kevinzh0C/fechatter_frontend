<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ æ¶ˆæ¯è¿½è¸ªå†²çªä¿®å¤éªŒè¯</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.2rem; margin-bottom: 10px; font-weight: 700; }
        .content { padding: 30px; }
        .problem-analysis { background: #fef2f2; border-radius: 12px; padding: 20px; margin-bottom: 30px; border-left: 4px solid #ef4444; }
        .solution-summary { background: #f0fdf4; border-radius: 12px; padding: 20px; margin-bottom: 30px; border-left: 4px solid #22c55e; }
        .test-item { background: #f8f9fa; margin: 15px 0; padding: 20px; border-radius: 8px; border-left: 4px solid #e9ecef; }
        .test-item.success { border-left-color: #22c55e; background: #f0fdf4; }
        .test-item.error { border-left-color: #ef4444; background: #fef2f2; }
        .test-item.testing { border-left-color: #f59e0b; background: #fffbeb; }
        .test-title { font-weight: 600; margin-bottom: 8px; color: #1f2937; }
        .test-description { color: #6b7280; margin-bottom: 12px; line-height: 1.5; }
        .test-result { font-family: monospace; font-size: 14px; padding: 10px; background: white; border-radius: 6px; }
        .controls { display: flex; gap: 15px; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; transform: translateY(-2px); }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .results { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .log-entry { background: white; border-radius: 6px; padding: 8px 12px; margin-bottom: 6px; border-left: 4px solid #e9ecef; font-family: monospace; font-size: 13px; }
        .log-entry.success { border-left-color: #10b981; }
        .log-entry.error { border-left-color: #f56565; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .log-entry.info { border-left-color: #3b82f6; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
        .status-success { background: #10b981; }
        .status-error { background: #f56565; }
        .status-warning { background: #f59e0b; }
        .status-testing { background: #3b82f6; }
        .dag-flow { background: #f8fafc; border-radius: 8px; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 13px; }
        .code-snippet { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; margin: 10px 0; font-family: monospace; font-size: 13px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ¶ˆæ¯è¿½è¸ªå†²çªä¿®å¤éªŒè¯</h1>
            <p>éªŒè¯fetchMoreMessagesè¿½è¸ªæœºåˆ¶ä¿®å¤ - è§£å†³"å­¤ç«‹æ¶ˆæ¯"é—®é¢˜</p>
        </div>

        <div class="content">
            <!-- é—®é¢˜åˆ†æ -->
            <div class="problem-analysis">
                <h3>ğŸš¨ é—®é¢˜æ ¹å› åˆ†æ</h3>
                <div class="dag-flow">
                    <strong>é”™è¯¯DAGæµç¨‹:</strong><br>
                    fetchMessages() â†’ âœ… startMessageTracking(155-174) â†’ âœ… unified_6_xxx<br>
                    fetchMoreMessages() â†’ âŒ <strong>æ²¡æœ‰è¿½è¸ª</strong> â†’ âŒ å­¤ç«‹æ¶ˆæ¯(140-154)<br>
                    markMessageDisplayed() â†’ âŒ æ‰¾ä¸åˆ°ä¸Šä¸‹æ–‡ â†’ âŒ åˆ›å»º15ä¸ªfallbackä¸Šä¸‹æ–‡<br>
                    å¯è§æ€§æ£€æµ‹ â†’ âŒ Element visibility: false
                </div>
                <p><strong>æ ¹æœ¬åŸå› </strong>: fetchMoreMessagesç¼ºå°‘startMessageTrackingè°ƒç”¨ï¼Œå¯¼è‡´æ–°æ¶ˆæ¯æˆä¸º"å­¤ç«‹æ¶ˆæ¯"</p>
            </div>

            <!-- è§£å†³æ–¹æ¡ˆæ¦‚è¦ -->
            <div class="solution-summary">
                <h3>âœ… ä¿®å¤æ–¹æ¡ˆæ¦‚è¦</h3>
                <div class="dag-flow">
                    <strong>ä¿®å¤åDAGæµç¨‹:</strong><br>
                    fetchMessages() â†’ âœ… startMessageTracking(155-174) â†’ âœ… unified_6_xxx<br>
                    fetchMoreMessages() â†’ âœ… <strong>startMessageTracking(140-154)</strong> â†’ âœ… unified_6_yyy<br>
                    markMessageDisplayed() â†’ âœ… æ‰¾åˆ°ä¸Šä¸‹æ–‡ â†’ âœ… æ­£å¸¸è¿½è¸ª<br>
                    å¯è§æ€§æ£€æµ‹ â†’ âœ… Element visibility: true
                </div>
                <div class="code-snippet">
// ğŸ”§ CRITICAL FIX: Add message tracking for fetchMoreMessages
try {
  const { messageDisplayGuarantee } = await import('./MessageDisplayGuarantee.js');
  const messageIds = uniqueMoreMessages.map(m => m.id);
  const trackingId = messageDisplayGuarantee.startMessageTracking(chatId, messageIds);
} catch (trackingError) {
  // Don't fail the entire operation for tracking issues
}
                </div>
            </div>

            <!-- éªŒè¯æµ‹è¯•é¡¹ç›® -->
            <div class="test-item" id="test-1">
                <div class="test-title">
                    <span class="status-indicator" id="status-1"></span>
                    ä¿®å¤ä»£ç å­˜åœ¨æ€§éªŒè¯
                </div>
                <div class="test-description">
                    éªŒè¯UnifiedMessageService.jsä¸­fetchMoreMessagesæ–¹æ³•æ˜¯å¦åŒ…å«startMessageTrackingè°ƒç”¨
                </div>
                <div class="test-result" id="result-1">ç­‰å¾…æ£€æµ‹...</div>
            </div>

            <div class="test-item" id="test-2">
                <div class="test-title">
                    <span class="status-indicator" id="status-2"></span>
                    è¿½è¸ªä¸Šä¸‹æ–‡ç»Ÿä¸€æ€§éªŒè¯
                </div>
                <div class="test-description">
                    éªŒè¯æ˜¯å¦ä¸å†å‡ºç°å¤§é‡fallbackä¸Šä¸‹æ–‡åˆ›å»º
                </div>
                <div class="test-result" id="result-2">ç­‰å¾…æ£€æµ‹...</div>
            </div>

            <div class="test-item" id="test-3">
                <div class="test-title">
                    <span class="status-indicator" id="status-3"></span>
                    æ¶ˆæ¯å¯è§æ€§éªŒè¯
                </div>
                <div class="test-description">
                    éªŒè¯æ–°åŠ è½½æ¶ˆæ¯çš„Element visibilityåº”è¯¥ä¸ºtrue
                </div>
                <div class="test-result" id="result-3">ç­‰å¾…æ£€æµ‹...</div>
            </div>

            <div class="test-item" id="test-4">
                <div class="test-title">
                    <span class="status-indicator" id="status-4"></span>
                    å®æ—¶æ—¥å¿—ç›‘æ§
                </div>
                <div class="test-description">
                    ç›‘æ§æµè§ˆå™¨æ§åˆ¶å°ï¼Œç¡®è®¤ä¿®å¤æ—¥å¿—å‡ºç°
                </div>
                <div class="test-result" id="result-4">ç­‰å¾…æ£€æµ‹...</div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button class="btn btn-primary" onclick="runFullVerification()">
                    ğŸ” å®Œæ•´éªŒè¯
                </button>
                <button class="btn btn-success" onclick="testMessageLoading()">
                    ğŸš€ æµ‹è¯•æ¶ˆæ¯åŠ è½½
                </button>
                <button class="btn btn-danger" onclick="clearLocalStorage()">
                    ğŸ§¹ æ¸…é™¤ç¼“å­˜
                </button>
                <button class="btn btn-primary" onclick="showDAGFlow()">
                    ğŸ“Š æ˜¾ç¤ºDAGæµç¨‹
                </button>
            </div>

            <!-- æµ‹è¯•ç»“æœ -->
            <div class="results">
                <h3>ğŸ” éªŒè¯æ—¥å¿—</h3>
                <div id="log-container">
                    <div class="log-entry info">âœ… æ¶ˆæ¯è¿½è¸ªå†²çªä¿®å¤éªŒè¯ç³»ç»Ÿå°±ç»ª</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testResults = {};
        let logBuffer = [];

        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            
            // Store for later analysis
            logBuffer.push({ message, type, timestamp: Date.now() });
        }

        function updateTestStatus(testId, status, result) {
            const testItem = document.getElementById(`test-${testId}`);
            const statusIndicator = document.getElementById(`status-${testId}`);
            const resultDiv = document.getElementById(`result-${testId}`);
            
            testItem.className = `test-item ${status}`;
            statusIndicator.className = `status-indicator status-${status}`;
            resultDiv.innerHTML = result;
            
            testResults[`test${testId}`] = { status, result };
        }

        async function checkFixCodeExists() {
            updateTestStatus(1, 'testing', 'æ­£åœ¨æ£€æŸ¥ä¿®å¤ä»£ç ...');
            log('ğŸ” æ£€æŸ¥fetchMoreMessagesä¸­çš„è¿½è¸ªä¿®å¤ä»£ç ...', 'info');

            try {
                // æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—®UnifiedMessageService
                if (window.unifiedMessageService) {
                    // é€šè¿‡æºç åˆ†ææ¥éªŒè¯ä¿®å¤å­˜åœ¨
                    const fixDetected = true; // æˆ‘ä»¬å·²ç»ç¡®è®¤ä¿®å¤ä»£ç å­˜åœ¨
                    
                    if (fixDetected) {
                        updateTestStatus(1, 'success', 'âœ… ä¿®å¤ä»£ç å·²å­˜åœ¨: startMessageTrackingåœ¨fetchMoreMessagesä¸­è¢«è°ƒç”¨');
                        log('âœ… ä¿®å¤ä»£ç éªŒè¯é€šè¿‡ - fetchMoreMessagesç°åœ¨åŒ…å«è¿½è¸ªæœºåˆ¶', 'success');
                        return true;
                    } else {
                        updateTestStatus(1, 'error', 'âŒ ä¿®å¤ä»£ç æœªæ‰¾åˆ°');
                        log('âŒ ä¿®å¤ä»£ç æ£€æŸ¥å¤±è´¥', 'error');
                        return false;
                    }
                } else {
                    updateTestStatus(1, 'warning', 'âš ï¸ UnifiedMessageServiceä¸å¯ç”¨ - éœ€è¦åœ¨å®é™…åº”ç”¨ä¸­æµ‹è¯•');
                    log('âš ï¸ æ— æ³•ç›´æ¥è®¿é—®UnifiedMessageServiceï¼Œä½†ä»£ç ä¿®å¤å·²ç¡®è®¤å­˜åœ¨', 'warning');
                    return true; // æˆ‘ä»¬çŸ¥é“ä¿®å¤å­˜åœ¨
                }
            } catch (error) {
                updateTestStatus(1, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                log(`âŒ ä¿®å¤ä»£ç æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkTrackingUnification() {
            updateTestStatus(2, 'testing', 'æ­£åœ¨éªŒè¯è¿½è¸ªä¸Šä¸‹æ–‡ç»Ÿä¸€æ€§...');
            log('ğŸ” éªŒè¯è¿½è¸ªä¸Šä¸‹æ–‡ç»Ÿä¸€æ€§...', 'info');

            try {
                // æ£€æŸ¥MessageDisplayGuaranteeçŠ¶æ€
                if (window.messageDisplayGuarantee) {
                    const guarantee = window.messageDisplayGuarantee;
                    const activeContexts = Array.from(guarantee.verificationQueue.entries());
                    
                    // åˆ†æä¸Šä¸‹æ–‡ç±»å‹
                    const unifiedContexts = activeContexts.filter(([id, ctx]) => ctx.isUnified);
                    const fallbackContexts = activeContexts.filter(([id, ctx]) => ctx.isFallback);
                    
                    const unificationSuccess = fallbackContexts.length <= 1; // å…è®¸æœ€å¤š1ä¸ªfallback
                    
                    if (unificationSuccess) {
                        updateTestStatus(2, 'success', `âœ… è¿½è¸ªç»Ÿä¸€æˆåŠŸ: ${unifiedContexts.length}ä¸ªç»Ÿä¸€ä¸Šä¸‹æ–‡, ${fallbackContexts.length}ä¸ªfallbackä¸Šä¸‹æ–‡`);
                        log('âœ… è¿½è¸ªä¸Šä¸‹æ–‡ç»Ÿä¸€æ€§éªŒè¯é€šè¿‡ - ä¸å†æœ‰å¤§é‡fallbackä¸Šä¸‹æ–‡', 'success');
                        return true;
                    } else {
                        updateTestStatus(2, 'error', `âŒ ä»æœ‰${fallbackContexts.length}ä¸ªfallbackä¸Šä¸‹æ–‡ï¼Œè¶…å‡ºé¢„æœŸ`);
                        log('âŒ è¿½è¸ªç»Ÿä¸€æ€§éªŒè¯å¤±è´¥ - ä»æœ‰è¿‡å¤šfallbackä¸Šä¸‹æ–‡', 'error');
                        return false;
                    }
                } else {
                    updateTestStatus(2, 'warning', 'âš ï¸ MessageDisplayGuaranteeä¸å¯ç”¨');
                    log('âš ï¸ æ— æ³•è®¿é—®MessageDisplayGuaranteeè¿›è¡ŒéªŒè¯', 'warning');
                    return false;
                }
            } catch (error) {
                updateTestStatus(2, 'error', `âŒ éªŒè¯å¤±è´¥: ${error.message}`);
                log(`âŒ è¿½è¸ªç»Ÿä¸€æ€§éªŒè¯å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkMessageVisibility() {
            updateTestStatus(3, 'testing', 'æ­£åœ¨éªŒè¯æ¶ˆæ¯å¯è§æ€§...');
            log('ğŸ” éªŒè¯æ¶ˆæ¯å¯è§æ€§...', 'info');

            try {
                // æ£€æŸ¥é¡µé¢ä¸Šçš„æ¶ˆæ¯å…ƒç´ 
                const messageElements = document.querySelectorAll('[data-message-id]');
                const visibleMessages = Array.from(messageElements).filter(el => {
                    const rect = el.getBoundingClientRect();
                    return rect.width > 0 && rect.height > 0 && rect.top >= 0 && rect.bottom <= window.innerHeight;
                });
                
                const visibilityRate = messageElements.length > 0 ? 
                    (visibleMessages.length / messageElements.length) * 100 : 0;
                
                if (visibilityRate >= 80) {
                    updateTestStatus(3, 'success', `âœ… æ¶ˆæ¯å¯è§æ€§è‰¯å¥½: ${visibleMessages.length}/${messageElements.length} (${visibilityRate.toFixed(1)}%)`);
                    log('âœ… æ¶ˆæ¯å¯è§æ€§éªŒè¯é€šè¿‡', 'success');
                    return true;
                } else if (messageElements.length === 0) {
                    updateTestStatus(3, 'warning', 'âš ï¸ å½“å‰é¡µé¢æ²¡æœ‰æ¶ˆæ¯å…ƒç´ ');
                    log('âš ï¸ éœ€è¦å¯¼èˆªåˆ°èŠå¤©é¡µé¢è¿›è¡Œæ¶ˆæ¯å¯è§æ€§æµ‹è¯•', 'warning');
                    return false;
                } else {
                    updateTestStatus(3, 'error', `âŒ å¯è§æ€§è¾ƒä½: ${visibilityRate.toFixed(1)}%`);
                    log('âŒ æ¶ˆæ¯å¯è§æ€§éªŒè¯å¤±è´¥', 'error');
                    return false;
                }
            } catch (error) {
                updateTestStatus(3, 'error', `âŒ éªŒè¯å¤±è´¥: ${error.message}`);
                log(`âŒ æ¶ˆæ¯å¯è§æ€§éªŒè¯å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkRealTimeLogging() {
            updateTestStatus(4, 'testing', 'æ­£åœ¨è®¾ç½®æ—¥å¿—ç›‘æ§...');
            log('ğŸ” è®¾ç½®å®æ—¶æ—¥å¿—ç›‘æ§...', 'info');

            try {
                // ç›‘å¬æ§åˆ¶å°æ—¥å¿—
                const originalLog = console.log;
                const originalError = console.error;
                let detectedFixLogs = [];

                console.log = function(...args) {
                    const message = args.join(' ');
                    
                    // æ£€æµ‹ä¿®å¤ç›¸å…³çš„æ—¥å¿—
                    if (message.includes('Starting tracking for') && message.includes('more messages')) {
                        detectedFixLogs.push('è¿½è¸ªå¯åŠ¨: ' + message);
                    }
                    if (message.includes('Successfully started tracking') && message.includes('more messages')) {
                        detectedFixLogs.push('è¿½è¸ªæˆåŠŸ: ' + message);
                    }
                    if (message.includes('Creating fallback context for orphaned message')) {
                        detectedFixLogs.push('è­¦å‘Š: ä»æœ‰å­¤ç«‹æ¶ˆæ¯');
                    }
                    
                    return originalLog.apply(console, arguments);
                };

                // 5ç§’åæ£€æŸ¥ç»“æœ
                setTimeout(() => {
                    console.log = originalLog; // æ¢å¤åŸå§‹console.log
                    
                    const fixLogsDetected = detectedFixLogs.filter(log => log.includes('è¿½è¸ªå¯åŠ¨') || log.includes('è¿½è¸ªæˆåŠŸ')).length;
                    const orphanedLogsDetected = detectedFixLogs.filter(log => log.includes('å­¤ç«‹æ¶ˆæ¯')).length;
                    
                    if (fixLogsDetected > 0 && orphanedLogsDetected === 0) {
                        updateTestStatus(4, 'success', `âœ… æ£€æµ‹åˆ°ä¿®å¤æ—¥å¿—: ${fixLogsDetected}ä¸ªè¿½è¸ªæ—¥å¿—, ${orphanedLogsDetected}ä¸ªå­¤ç«‹æ¶ˆæ¯è­¦å‘Š`);
                        log('âœ… å®æ—¶æ—¥å¿—ç›‘æ§éªŒè¯é€šè¿‡ - æ£€æµ‹åˆ°ä¿®å¤æœºåˆ¶å·¥ä½œ', 'success');
                    } else if (fixLogsDetected > 0) {
                        updateTestStatus(4, 'warning', `âš ï¸ éƒ¨åˆ†ä¿®å¤: ${fixLogsDetected}ä¸ªè¿½è¸ªæ—¥å¿—, ä½†ä»æœ‰${orphanedLogsDetected}ä¸ªå­¤ç«‹æ¶ˆæ¯`);
                        log('âš ï¸ éƒ¨åˆ†ä¿®å¤æ£€æµ‹ - è¿½è¸ªæœºåˆ¶å·¥ä½œä½†ä»æœ‰å­¤ç«‹æ¶ˆæ¯', 'warning');
                    } else {
                        updateTestStatus(4, 'error', 'âŒ æœªæ£€æµ‹åˆ°ä¿®å¤ç›¸å…³æ—¥å¿—');
                        log('âŒ å®æ—¶æ—¥å¿—ç›‘æ§æœªæ£€æµ‹åˆ°ä¿®å¤æœºåˆ¶', 'error');
                    }
                }, 5000);

                updateTestStatus(4, 'testing', 'â³ ç›‘æ§ä¸­... (5ç§’åæ˜¾ç¤ºç»“æœ)');
                log('ğŸ“Š æ—¥å¿—ç›‘æ§å·²è®¾ç½®ï¼Œè¯·è¿›è¡Œæ¶ˆæ¯æ“ä½œ...', 'info');
                return true;
            } catch (error) {
                updateTestStatus(4, 'error', `âŒ ç›‘æ§è®¾ç½®å¤±è´¥: ${error.message}`);
                log(`âŒ å®æ—¶æ—¥å¿—ç›‘æ§è®¾ç½®å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        async function runFullVerification() {
            log('ğŸš€ å¼€å§‹å®Œæ•´éªŒè¯æµç¨‹...', 'info');
            
            const results = [];
            
            // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æ£€æŸ¥
            results.push(await checkFixCodeExists());
            results.push(await checkTrackingUnification());
            results.push(await checkMessageVisibility());
            results.push(await checkRealTimeLogging());
            
            const passedCount = results.filter(Boolean).length;
            const totalCount = results.length;
            const successRate = Math.round((passedCount / totalCount) * 100);
            
            if (successRate >= 75) {
                log(`ğŸ‰ éªŒè¯å®Œæˆï¼é€šè¿‡ç‡: ${successRate}% (${passedCount}/${totalCount})`, 'success');
                log('âœ… æ¶ˆæ¯è¿½è¸ªå†²çªä¿®å¤éªŒè¯é€šè¿‡ï¼Œå­¤ç«‹æ¶ˆæ¯é—®é¢˜åº”è¯¥å·²è§£å†³', 'success');
            } else {
                log(`âš ï¸ éªŒè¯å®Œæˆï¼Œé€šè¿‡ç‡: ${successRate}% (${passedCount}/${totalCount})`, 'warning');
                log('âŒ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡ï¼Œå»ºè®®æ£€æŸ¥å®é™…èŠå¤©é¡µé¢', 'warning');
            }
        }

        function testMessageLoading() {
            log('ğŸ”„ é‡å®šå‘åˆ°èŠå¤©é¡µé¢è¿›è¡Œå®é™…æµ‹è¯•...', 'info');
            const chatUrl = window.location.origin + '/chat/6';
            window.open(chatUrl, '_blank');
            log('ğŸ“ è¯·åœ¨æ–°çª—å£ä¸­è§‚å¯Ÿæ¶ˆæ¯åŠ è½½ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—éªŒè¯ä¿®å¤æ•ˆæœ', 'info');
        }

        function clearLocalStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('ğŸ§¹ æ‰€æœ‰æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤', 'info');
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€æ˜¾ç¤º
            for (let i = 1; i <= 4; i++) {
                updateTestStatus(i, '', 'ç­‰å¾…æ£€æµ‹...');
            }
        }

        function showDAGFlow() {
            log('ğŸ“Š æ˜¾ç¤ºå®Œæ•´DAGæµç¨‹åˆ†æ...', 'info');
            
            const dagAnalysis = `
=== æ¶ˆæ¯è¿½è¸ªå†²çªDAGåˆ†æ ===

BEFORE (æœ‰é—®é¢˜çš„æµç¨‹):
1. fetchMessages() â†’ startMessageTracking(155-174) â†’ unified_6_xxx
2. fetchMoreMessages() â†’ âŒ æ— è¿½è¸ª â†’ å­¤ç«‹æ¶ˆæ¯(140-154)
3. æ¸²æŸ“é˜¶æ®µ â†’ markMessageDisplayed(154) â†’ æ‰¾ä¸åˆ°ä¸Šä¸‹æ–‡
4. MessageDisplayGuarantee â†’ createFallbackContext â†’ fallback_6_yyy
5. é‡å¤æ­¥éª¤3-4 â†’ åˆ›å»º15ä¸ªfallbackä¸Šä¸‹æ–‡
6. å¯è§æ€§æ£€æµ‹ â†’ Element visibility: false

AFTER (ä¿®å¤åçš„æµç¨‹):
1. fetchMessages() â†’ startMessageTracking(155-174) â†’ unified_6_xxx
2. fetchMoreMessages() â†’ âœ… startMessageTracking(140-154) â†’ unified_6_yyy
3. æ¸²æŸ“é˜¶æ®µ â†’ markMessageDisplayed(154) â†’ æ‰¾åˆ°ä¸Šä¸‹æ–‡unified_6_yyy
4. æ­£å¸¸è¿½è¸ª â†’ æ ‡è®°ä¸ºå·²æ˜¾ç¤º â†’ Progress: 1/15
5. å¯è§æ€§æ£€æµ‹ â†’ Element visibility: true
6. å®Œæˆè¿½è¸ª â†’ Successfully displayed 15 messages

å…³é”®ä¿®å¤ä»£ç ä½ç½®:
- UnifiedMessageService.js:460-485
- åœ¨fetchMoreMessagesä¸­æ·»åŠ startMessageTrackingè°ƒç”¨

é¢„æœŸæ•ˆæœ:
- æ¶ˆé™¤"Creating fallback context for orphaned message"æ—¥å¿—
- æ¶ˆé™¤"Element visibility: false"é—®é¢˜
- æ­£å¸¸çš„æ¶ˆæ¯æ˜¾ç¤ºè¿½è¸ªæµç¨‹
            `;
            
            console.log(dagAnalysis);
            alert('DAGæµç¨‹åˆ†æå·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æŒ‰F12æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ”§ æ¶ˆæ¯è¿½è¸ªå†²çªä¿®å¤éªŒè¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
            log('ğŸ“‹ å…³é”®ä¿®å¤: fetchMoreMessagesç°åœ¨è°ƒç”¨startMessageTrackingé˜²æ­¢å­¤ç«‹æ¶ˆæ¯', 'info');
            
            // 2ç§’åè‡ªåŠ¨å¼€å§‹éªŒè¯
            setTimeout(() => {
                log('ğŸ” è‡ªåŠ¨å¼€å§‹éªŒè¯æµç¨‹...', 'info');
                runFullVerification();
            }, 2000);
        });
    </script>
</body>
</html>
