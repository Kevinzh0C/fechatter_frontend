<!DOCTYPE html>
<html>

<head>
  <title>æ·±åº¦DOMæ‹†è§£åˆ†æ</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }

    .panel {
      background: white;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .item {
      margin: 5px 0;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }

    .warning {
      background: #fff3cd;
      color: #856404;
    }

    .info {
      background: #d1ecf1;
      color: #0c5460;
    }

    button {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #5b21b6;
    }

    .code {
      background: #1a1a1a;
      color: #00ff00;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
    }

    .structure {
      border-left: 3px solid #ccc;
      padding-left: 10px;
      margin-left: 10px;
    }

    .level-0 {
      border-color: #e74c3c;
    }

    .level-1 {
      border-color: #f39c12;
    }

    .level-2 {
      border-color: #2ecc71;
    }

    .level-3 {
      border-color: #3498db;
    }

    .highlight {
      background: #ffeb3b;
      padding: 2px 4px;
      border-radius: 2px;
    }
  </style>
</head>

<body>
  <div class="panel">
    <div class="title">ğŸ” æ·±åº¦DOMæ‹†è§£åˆ†æå·¥å…·</div>
    <button onclick="analyzeMessageDOM()">DOMç»“æ„åˆ†æ</button>
    <button onclick="analyzeMessageContent()">æ¶ˆæ¯å†…å®¹åˆ†æ</button>
    <button onclick="analyzeVisibility()">å¯è§æ€§åˆ†æ</button>
    <button onclick="analyzeCSSIssues()">CSSé—®é¢˜åˆ†æ</button>
    <button onclick="analyzeVueReactivity()">Vueå“åº”æ€§åˆ†æ</button>
    <button onclick="fullDeepAnalysis()">å®Œæ•´æ·±åº¦åˆ†æ</button>
  </div>

  <div class="panel">
    <div class="title">ğŸ“Š åˆ†æç»“æœ</div>
    <div id="results"></div>
  </div>

  <script>
    function log(message, type = 'info', level = 0) {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `item ${type} structure level-${level}`;
      div.innerHTML = message;
      results.appendChild(div);
    }

    function clear() {
      document.getElementById('results').innerHTML = '';
    }

    function analyzeMessageDOM() {
      clear();
      log('ğŸ” å¼€å§‹DOMç»“æ„æ·±åº¦åˆ†æ...', 'info', 0);

      // 1. ä¸»å®¹å™¨åˆ†æ
      const messageList = document.querySelector('.simple-message-list');
      const messagesWrapper = document.querySelector('.messages-wrapper');

      log('ğŸ“¦ ä¸»å®¹å™¨å±‚çº§:', 'info', 0);
      log(`SimpleMessageList: ${messageList ? 'âœ…' : 'âŒ'} ${messageList ? messageList.offsetWidth + 'Ã—' + messageList.offsetHeight + 'px' : ''}`, messageList ? 'success' : 'error', 1);
      log(`MessagesWrapper: ${messagesWrapper ? 'âœ…' : 'âŒ'} ${messagesWrapper ? messagesWrapper.offsetWidth + 'Ã—' + messagesWrapper.offsetHeight + 'px' : ''}`, messagesWrapper ? 'success' : 'error', 1);

      if (!messagesWrapper) {
        log('âŒ å…³é”®å®¹å™¨ç¼ºå¤±ï¼Œæ— æ³•ç»§ç»­åˆ†æ', 'error', 1);
        return;
      }

      // 2. å­å…ƒç´ åˆ†æ
      const children = Array.from(messagesWrapper.children);
      log(`ğŸ“‹ å­å…ƒç´ æ€»æ•°: ${children.length}`, 'info', 1);

      let dividerCount = 0;
      let messageWrapperCount = 0;
      let otherCount = 0;

      children.forEach((child, index) => {
        const tagName = child.tagName.toLowerCase();
        const className = child.className || '';

        if (className.includes('message-wrapper')) {
          messageWrapperCount++;
          if (index < 5) { // åªåˆ†æå‰5ä¸ª
            analyzeMessageWrapper(child, messageWrapperCount, 2);
          }
        } else if (tagName.includes('time-session-divider') || className.includes('divider')) {
          dividerCount++;
        } else {
          otherCount++;
        }
      });

      log(`ğŸ“Š å…ƒç´ ç±»å‹ç»Ÿè®¡:`, 'info', 1);
      log(`  æ¶ˆæ¯å®¹å™¨: ${messageWrapperCount}`, messageWrapperCount > 0 ? 'success' : 'warning', 2);
      log(`  åˆ†å‰²çº¿: ${dividerCount}`, 'info', 2);
      log(`  å…¶ä»–: ${otherCount}`, otherCount === 0 ? 'success' : 'warning', 2);
    }

    function analyzeMessageWrapper(wrapper, index, level) {
      const messageId = wrapper.dataset.messageId || 'æœªçŸ¥';
      const rect = wrapper.getBoundingClientRect();

      log(`ğŸ” æ¶ˆæ¯å®¹å™¨ #${index} (ID: ${messageId}):`, 'info', level);
      log(`  å°ºå¯¸: ${rect.width.toFixed(1)}Ã—${rect.height.toFixed(1)}px`, rect.width > 0 && rect.height > 0 ? 'success' : 'error', level + 1);
      log(`  ä½ç½®: top=${rect.top.toFixed(1)}, left=${rect.left.toFixed(1)}`, 'info', level + 1);
      log(`  å¯è§æ€§: ${wrapper.offsetParent !== null ? 'å¯è§' : 'ä¸å¯è§'}`, wrapper.offsetParent !== null ? 'success' : 'error', level + 1);

      // åˆ†æMessageItem
      const messageItem = wrapper.querySelector('.message-item');
      if (messageItem) {
        analyzeMessageItem(messageItem, messageId, level + 1);
      } else {
        log(`  âŒ ç¼ºå°‘MessageItemç»„ä»¶`, 'error', level + 1);
      }
    }

    function analyzeMessageItem(messageItem, messageId, level) {
      const rect = messageItem.getBoundingClientRect();

      log(`ğŸ’¬ MessageItemç»„ä»¶:`, 'info', level);
      log(`  å°ºå¯¸: ${rect.width.toFixed(1)}Ã—${rect.height.toFixed(1)}px`, rect.width > 0 && rect.height > 0 ? 'success' : 'error', level + 1);

      // æ£€æŸ¥å…³é”®å­å…ƒç´ 
      const messageHeader = messageItem.querySelector('.message-header');
      const messageContent = messageItem.querySelector('.message-content');
      const messageText = messageItem.querySelector('.message-text');
      const debugNoContent = messageItem.querySelector('.debug-no-content');

      log(`  Header: ${messageHeader ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, messageHeader ? 'success' : 'warning', level + 1);
      log(`  Contentå®¹å™¨: ${messageContent ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, messageContent ? 'success' : 'error', level + 1);
      log(`  Textå†…å®¹: ${messageText ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, messageText ? 'success' : 'warning', level + 1);
      log(`  è°ƒè¯•ä¿¡æ¯: ${debugNoContent ? 'æ˜¾ç¤º' : 'æ— '}`, debugNoContent ? 'warning' : 'info', level + 1);

      if (messageContent) {
        analyzeMessageContent(messageContent, messageId, level + 1);
      }
    }

    function analyzeMessageContent(contentEl, messageId, level) {
      const rect = contentEl.getBoundingClientRect();
      const styles = getComputedStyle(contentEl);

      log(`ğŸ“ æ¶ˆæ¯å†…å®¹åˆ†æ:`, 'info', level);
      log(`  å†…å®¹å°ºå¯¸: ${rect.width.toFixed(1)}Ã—${rect.height.toFixed(1)}px`, rect.height > 0 ? 'success' : 'error', level + 1);
      log(`  æ˜¾ç¤ºçŠ¶æ€: ${styles.display}`, styles.display !== 'none' ? 'success' : 'error', level + 1);
      log(`  å¯è§æ€§: ${styles.visibility}`, styles.visibility !== 'hidden' ? 'success' : 'error', level + 1);
      log(`  é€æ˜åº¦: ${styles.opacity}`, parseFloat(styles.opacity) > 0 ? 'success' : 'error', level + 1);

      // æ£€æŸ¥æ–‡æœ¬å†…å®¹
      const textContent = contentEl.textContent.trim();
      const innerHTML = contentEl.innerHTML.trim();

      log(`  æ–‡æœ¬é•¿åº¦: ${textContent.length}`, textContent.length > 0 ? 'success' : 'warning', level + 1);
      if (textContent.length === 0 && innerHTML.length > 0) {
        log(`  HTMLå†…å®¹: ${innerHTML.substring(0, 100)}...`, 'warning', level + 1);
      }
      if (textContent.length > 0) {
        log(`  æ–‡æœ¬é¢„è§ˆ: "${textContent.substring(0, 50)}${textContent.length > 50 ? '...' : ''}"`, 'success', level + 1);
      }
    }

    function analyzeVisibility() {
      clear();
      log('ğŸ‘ï¸ å¼€å§‹å¯è§æ€§æ·±åº¦åˆ†æ...', 'info', 0);

      const messageWrappers = document.querySelectorAll('.message-wrapper');

      if (messageWrappers.length === 0) {
        log('âŒ æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨', 'error', 1);
        return;
      }

      let stats = {
        total: messageWrappers.length,
        visible: 0,
        hidden: 0,
        zeroSize: 0,
        withContent: 0,
        withoutContent: 0
      };

      messageWrappers.forEach((wrapper, index) => {
        const rect = wrapper.getBoundingClientRect();
        const isVisible = rect.width > 0 && rect.height > 0;
        const messageItem = wrapper.querySelector('.message-item');
        const hasTextContent = messageItem ? messageItem.textContent.trim().length > 0 : false;

        if (rect.width === 0 || rect.height === 0) {
          stats.zeroSize++;
        } else if (isVisible) {
          stats.visible++;
        } else {
          stats.hidden++;
        }

        if (hasTextContent) {
          stats.withContent++;
        } else {
          stats.withoutContent++;
        }

        // è¯¦ç»†åˆ†æå‰3ä¸ª
        if (index < 3) {
          const messageId = wrapper.dataset.messageId || 'æœªçŸ¥';
          log(`æ¶ˆæ¯ ${index + 1} (ID: ${messageId}):`, 'info', 1);
          log(`  å¯è§æ€§: ${isVisible ? 'å¯è§' : 'ä¸å¯è§'}`, isVisible ? 'success' : 'error', 2);
          log(`  æœ‰å†…å®¹: ${hasTextContent ? 'æ˜¯' : 'å¦'}`, hasTextContent ? 'success' : 'warning', 2);

          if (!isVisible && messageItem) {
            const itemStyles = getComputedStyle(messageItem);
            log(`  CSSé—®é¢˜æ£€æŸ¥:`, 'warning', 2);
            log(`    display: ${itemStyles.display}`, itemStyles.display !== 'none' ? 'success' : 'error', 3);
            log(`    visibility: ${itemStyles.visibility}`, itemStyles.visibility !== 'hidden' ? 'success' : 'error', 3);
            log(`    opacity: ${itemStyles.opacity}`, parseFloat(itemStyles.opacity) > 0 ? 'success' : 'error', 3);
          }
        }
      });

      log(`ğŸ“Š å¯è§æ€§ç»Ÿè®¡:`, 'info', 1);
      log(`  æ€»è®¡: ${stats.total}`, 'info', 2);
      log(`  å¯è§: ${stats.visible} (${(stats.visible / stats.total * 100).toFixed(1)}%)`, stats.visible > 0 ? 'success' : 'error', 2);
      log(`  éšè—: ${stats.hidden}`, stats.hidden === 0 ? 'success' : 'warning', 2);
      log(`  é›¶å°ºå¯¸: ${stats.zeroSize}`, stats.zeroSize === 0 ? 'success' : 'error', 2);
      log(`  æœ‰å†…å®¹: ${stats.withContent}`, stats.withContent > 0 ? 'success' : 'warning', 2);
      log(`  æ— å†…å®¹: ${stats.withoutContent}`, stats.withoutContent === 0 ? 'success' : 'warning', 2);
    }

    function analyzeCSSIssues() {
      clear();
      log('ğŸ¨ å¼€å§‹CSSé—®é¢˜åˆ†æ...', 'info', 0);

      const messagesWrapper = document.querySelector('.messages-wrapper');
      const messageWrappers = document.querySelectorAll('.message-wrapper');

      // æ£€æŸ¥ä¸»å®¹å™¨CSS
      if (messagesWrapper) {
        const styles = getComputedStyle(messagesWrapper);
        log('ğŸ“¦ MessagesWrapper CSSçŠ¶æ€:', 'info', 1);
        log(`  display: ${styles.display}`, styles.display === 'block' || styles.display === 'flex' ? 'success' : 'error', 2);
        log(`  height: ${styles.height}`, 'info', 2);
        log(`  min-height: ${styles.minHeight}`, styles.minHeight.includes('vh') ? 'warning' : 'success', 2);
        log(`  overflow: ${styles.overflow}`, 'info', 2);
        log(`  position: ${styles.position}`, 'info', 2);
      }

      // æ£€æŸ¥æ¶ˆæ¯å®¹å™¨CSS
      if (messageWrappers.length > 0) {
        const firstWrapper = messageWrappers[0];
        const messageItem = firstWrapper.querySelector('.message-item');

        if (messageItem) {
          const wrapperStyles = getComputedStyle(firstWrapper);
          const itemStyles = getComputedStyle(messageItem);

          log('ğŸ“ MessageWrapper CSSçŠ¶æ€:', 'info', 1);
          log(`  display: ${wrapperStyles.display}`, wrapperStyles.display !== 'none' ? 'success' : 'error', 2);
          log(`  height: ${wrapperStyles.height}`, 'info', 2);
          log(`  margin: ${wrapperStyles.margin}`, 'info', 2);

          log('ğŸ’¬ MessageItem CSSçŠ¶æ€:', 'info', 1);
          log(`  display: ${itemStyles.display}`, itemStyles.display !== 'none' ? 'success' : 'error', 2);
          log(`  visibility: ${itemStyles.visibility}`, itemStyles.visibility !== 'hidden' ? 'success' : 'error', 2);
          log(`  opacity: ${itemStyles.opacity}`, parseFloat(itemStyles.opacity) > 0 ? 'success' : 'error', 2);
          log(`  height: ${itemStyles.height}`, 'info', 2);
          log(`  background: ${itemStyles.backgroundColor}`, 'info', 2);

          // æ£€æŸ¥å†…å®¹å®¹å™¨
          const messageContent = messageItem.querySelector('.message-content');
          if (messageContent) {
            const contentStyles = getComputedStyle(messageContent);
            log('ğŸ“„ MessageContent CSSçŠ¶æ€:', 'info', 1);
            log(`  display: ${contentStyles.display}`, contentStyles.display !== 'none' ? 'success' : 'error', 2);
            log(`  height: ${contentStyles.height}`, 'info', 2);
            log(`  margin-left: ${contentStyles.marginLeft}`, 'info', 2);
          }
        }
      }
    }

    function analyzeVueReactivity() {
      clear();
      log('âš¡ å¼€å§‹Vueå“åº”æ€§åˆ†æ...', 'info', 0);

      const messageList = document.querySelector('.simple-message-list');

      if (messageList && messageList.__vueParentComponent) {
        const component = messageList.__vueParentComponent;
        const setupState = component.setupState || {};

        log('ğŸ”§ Vueç»„ä»¶çŠ¶æ€è¯¦ç»†åˆ†æ:', 'info', 1);

        // åˆ†æenhancedMessages
        if (setupState.enhancedMessages) {
          const enhanced = setupState.enhancedMessages;
          log(`ğŸ“‹ enhancedMessages: ${enhanced.length} é¡¹`, enhanced.length > 0 ? 'success' : 'warning', 2);

          const messages = enhanced.filter(item => !item.type || (item.type !== 'date-divider' && item.type !== 'session-divider'));
          const dividers = enhanced.filter(item => item.type === 'date-divider' || item.type === 'session-divider');

          log(`  æ¶ˆæ¯æ•°é‡: ${messages.length}`, messages.length > 0 ? 'success' : 'warning', 3);
          log(`  åˆ†å‰²çº¿æ•°é‡: ${dividers.length}`, 'info', 3);

          // è¯¦ç»†æ£€æŸ¥å‰3ä¸ªæ¶ˆæ¯å¯¹è±¡
          messages.slice(0, 3).forEach((msg, index) => {
            log(`  æ¶ˆæ¯ ${index + 1} (ID: ${msg.id}):`, 'info', 3);
            log(`    content: ${msg.content ? 'å­˜åœ¨' : 'ç¼ºå¤±'} ${msg.content ? '(' + msg.content.length + 'å­—ç¬¦)' : ''}`, msg.content ? 'success' : 'error', 4);
            log(`    sender_id: ${msg.sender_id || 'ç¼ºå¤±'}`, msg.sender_id ? 'success' : 'warning', 4);
            log(`    created_at: ${msg.created_at || 'ç¼ºå¤±'}`, msg.created_at ? 'success' : 'warning', 4);
            log(`    å…³é”®å­—æ®µ: ${Object.keys(msg).join(', ')}`, 'info', 4);
          });
        }

        // åˆ†æprops
        if (component.props) {
          log(`ğŸ“¥ PropsçŠ¶æ€:`, 'info', 2);
          log(`  messages: ${component.props.messages?.length || 0} æ¡`, 'info', 3);
          log(`  chatId: ${component.props.chatId}`, 'info', 3);
          log(`  currentUserId: ${component.props.currentUserId}`, 'info', 3);
        }

      } else {
        log('âŒ æ— æ³•è®¿é—®Vueç»„ä»¶å®ä¾‹', 'error', 1);
      }
    }

    function fullDeepAnalysis() {
      clear();
      log('ğŸ” å¼€å§‹å®Œæ•´æ·±åº¦åˆ†æ...', 'info', 0);

      setTimeout(() => {
        analyzeMessageDOM();
        setTimeout(() => {
          analyzeVisibility();
          setTimeout(() => {
            analyzeCSSIssues();
            setTimeout(() => {
              analyzeVueReactivity();

              // æœ€ç»ˆæ ¹å› æ¨ç†
              setTimeout(() => {
                log('ğŸ¯ æ ¹å› æ¨ç†åˆ†æ:', 'info', 0);

                const messageWrappers = document.querySelectorAll('.message-wrapper');
                const visibleMessages = Array.from(messageWrappers).filter(w => {
                  const item = w.querySelector('.message-item');
                  return item && item.textContent.trim().length > 0;
                });
                const debugNoContent = document.querySelectorAll('.debug-no-content');

                if (messageWrappers.length === 0) {
                  log('ğŸš¨ æ ¹å› ï¼šVueç»„ä»¶æœªæ¸²æŸ“ä»»ä½•æ¶ˆæ¯å®¹å™¨', 'error', 1);
                } else if (debugNoContent.length > 0) {
                  log('ğŸš¨ æ ¹å› ï¼šæ¶ˆæ¯å¯¹è±¡ç¼ºå°‘contentå­—æ®µ', 'error', 1);
                  log(`  å‘ç° ${debugNoContent.length} ä¸ªæ— å†…å®¹æ¶ˆæ¯`, 'error', 2);
                } else if (visibleMessages.length === 0) {
                  log('ğŸš¨ æ ¹å› ï¼šCSSæ ·å¼å¯¼è‡´æ¶ˆæ¯å†…å®¹éšè—', 'error', 1);
                } else {
                  log('âœ… æ¶ˆæ¯æ˜¾ç¤ºæ­£å¸¸', 'success', 1);
                }

                log('ğŸ”§ å»ºè®®ä¿®å¤ç­–ç•¥:', 'info', 1);
                if (debugNoContent.length > 0) {
                  log('  1. æ£€æŸ¥APIè¿”å›çš„æ¶ˆæ¯å¯¹è±¡ç»“æ„', 'warning', 2);
                  log('  2. ç¡®ä¿contentå­—æ®µæ­£ç¡®æ˜ å°„', 'warning', 2);
                } else {
                  log('  1. æ£€æŸ¥CSSæ ·å¼ç»§æ‰¿é—®é¢˜', 'warning', 2);
                  log('  2. éªŒè¯Vueæ¡ä»¶æ¸²æŸ“é€»è¾‘', 'warning', 2);
                }
              }, 200);
            }, 200);
          }, 200);
        }, 200);
      }, 100);
    }

    // è‡ªåŠ¨è¿è¡Œæ·±åº¦åˆ†æ
    window.addEventListener('load', () => {
      setTimeout(fullDeepAnalysis, 1500);
    });
  </script>
</body>

</html>