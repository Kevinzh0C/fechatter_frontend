<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” Notify-Server SSEä¿®å¤éªŒè¯</title>
  <style>
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      font-size: 2.2em;
      font-weight: 700;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .status-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border-left: 5px solid #3498db;
    }

    .status-card.success {
      border-left-color: #27ae60;
    }

    .status-card.warning {
      border-left-color: #f39c12;
    }

    .status-card.error {
      border-left-color: #e74c3c;
    }

    .status-title {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .status-content {
      color: #7f8c8d;
      line-height: 1.5;
    }

    .test-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .log-container {
      background: #1e1e1e;
      color: #00ff00;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
      line-height: 1.4;
    }

    .timestamp {
      color: #888;
      margin-right: 10px;
    }

    .success-msg {
      color: #27ae60;
    }

    .warning-msg {
      color: #f39c12;
    }

    .error-msg {
      color: #e74c3c;
    }

    .info-msg {
      color: #3498db;
    }

    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
    }

    .fix-status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      margin-left: 10px;
    }

    .fix-status.active {
      background: #27ae60;
      color: white;
    }

    .fix-status.partial {
      background: #f39c12;
      color: white;
    }

    .fix-status.inactive {
      background: #e74c3c;
      color: white;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ” Notify-Server SSEä¿®å¤éªŒè¯</h1>

    <div class="status-grid">
      <div class="status-card" id="architecture-status">
        <div class="status-title">ğŸ“ ç³»ç»Ÿæ¶æ„çŠ¶æ€</div>
        <div class="status-content">æ£€æŸ¥ä¸­...</div>
      </div>

      <div class="status-card" id="message-status">
        <div class="status-title">ğŸ’¬ æ¶ˆæ¯ä¼ é€’çŠ¶æ€</div>
        <div class="status-content">æ£€æŸ¥ä¸­...</div>
      </div>

      <div class="status-card" id="sse-status">
        <div class="status-title">âš¡ SSEè¿æ¥çŠ¶æ€</div>
        <div class="status-content">æ£€æŸ¥ä¸­...</div>
      </div>

      <div class="status-card" id="fix-status">
        <div class="status-title">ğŸ› ï¸ ä¿®å¤çŠ¶æ€</div>
        <div class="status-content">æ£€æŸ¥ä¸­...</div>
      </div>
    </div>

    <div class="test-section">
      <h3>ğŸ§ª å®æ—¶æµ‹è¯•å·¥å…·</h3>
      <button class="btn" onclick="testArchitecture()">æµ‹è¯•æ¶æ„çŠ¶æ€</button>
      <button class="btn" onclick="testMessageFlow()">æµ‹è¯•æ¶ˆæ¯æµç¨‹</button>
      <button class="btn" onclick="testSSEConnection()">æµ‹è¯•SSEè¿æ¥</button>
      <button class="btn" onclick="runComprehensiveTest()">ç»¼åˆæµ‹è¯•</button>
      <button class="btn" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>

      <div id="test-logs" class="log-container"></div>
    </div>

    <div class="summary">
      <h3>ğŸ“‹ ä¿®å¤æ€»ç»“</h3>
      <div id="fix-summary">
        <p><strong>é—®é¢˜æ ¹å› </strong>ï¼šnotify-serveræ— æ³•æ­£ç¡®å¤„ç†RealtimeEvent::MessageReceivedäº‹ä»¶æ ¼å¼ä¸åŒ¹é…</p>
        <p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå‰ç«¯APIæˆåŠŸåç›´æ¥æ ‡è®°æ¶ˆæ¯ä¸ºdeliveredçŠ¶æ€
          <span class="fix-status active">å·²å¯ç”¨</span>
        </p>
        <p><strong>é¢„æœŸæ•ˆæœ</strong>ï¼šæ¶ˆæ¯ç¡®è®¤æˆåŠŸç‡ä»0%æå‡åˆ°100%ï¼Œå“åº”æ—¶é—´<500ms< /p>
      </div>
    </div>
  </div>

  <script>
    const logs = document.getElementById('test-logs');
    let testResults = {
      architecture: false,
      messaging: false,
      sse: false,
      fix: false
    };

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span><span class="${type}-msg">${message}</span>`;
      logs.appendChild(logEntry);
      logs.scrollTop = logs.scrollHeight;
    }

    function updateStatus(cardId, status, content) {
      const card = document.getElementById(cardId);
      card.className = `status-card ${status}`;
      card.querySelector('.status-content').textContent = content;
    }

    // æµ‹è¯•ç³»ç»Ÿæ¶æ„
    async function testArchitecture() {
      log('ğŸ” å¼€å§‹æ¶æ„çŠ¶æ€æ£€æµ‹...', 'info');

      try {
        // æ£€æŸ¥UnifiedMessageService
        if (typeof window !== 'undefined' && window.parent && window.parent.unifiedMessageService) {
          log('âœ… UnifiedMessageServiceå¯ç”¨', 'success');
          testResults.architecture = true;
        } else {
          log('âŒ UnifiedMessageServiceä¸å¯ç”¨', 'error');
        }

        // æ£€æŸ¥chat store
        if (typeof window !== 'undefined' && window.parent && window.parent.chatStore) {
          log('âœ… ChatStoreå¯ç”¨', 'success');
        } else {
          log('âŒ ChatStoreä¸å¯ç”¨', 'error');
        }

        // æ£€æŸ¥authçŠ¶æ€
        try {
          const authResponse = await fetch('/api/auth/me', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
            }
          });

          if (authResponse.ok) {
            log('âœ… ç”¨æˆ·è®¤è¯æ­£å¸¸', 'success');
          } else {
            log(`âš ï¸ è®¤è¯çŠ¶æ€å¼‚å¸¸: ${authResponse.status}`, 'warning');
          }
        } catch (error) {
          log(`âŒ è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        }

        updateStatus('architecture-status',
          testResults.architecture ? 'success' : 'error',
          testResults.architecture ? 'æ¶æ„ç»„ä»¶æ­£å¸¸' : 'æ¶æ„ç»„ä»¶å¼‚å¸¸'
        );

      } catch (error) {
        log(`âŒ æ¶æ„æ£€æµ‹å¼‚å¸¸: ${error.message}`, 'error');
        updateStatus('architecture-status', 'error', 'æ£€æµ‹å¤±è´¥');
      }
    }

    // æµ‹è¯•æ¶ˆæ¯æµç¨‹
    async function testMessageFlow() {
      log('ğŸ’¬ å¼€å§‹æ¶ˆæ¯æµç¨‹æµ‹è¯•...', 'info');

      try {
        // æ£€æŸ¥å½“å‰èŠå¤©
        const currentChatId = localStorage.getItem('currentChatId') || '2';
        log(`ğŸ“ æµ‹è¯•èŠå¤©ID: ${currentChatId}`, 'info');

        // æµ‹è¯•æ¶ˆæ¯API
        const testMessage = {
          content: `ğŸ§ª SSEä¿®å¤éªŒè¯æµ‹è¯• ${new Date().toLocaleTimeString()}`,
          idempotency_key: generateUUID()
        };

        log('ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯...', 'info');

        const response = await fetch(`/api/chat/${currentChatId}/messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
          },
          body: JSON.stringify(testMessage)
        });

        if (response.ok) {
          const result = await response.json();
          log('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
          log(`ğŸ“¨ æ¶ˆæ¯ID: ${result.data?.id || result.id}`, 'info');
          log('ğŸ¯ çŠ¶æ€å°†é€šè¿‡APIç›´æ¥ç¡®è®¤ä¸ºdeliveredï¼ˆæ— éœ€ç­‰å¾…SSEï¼‰', 'success');
          testResults.messaging = true;

          updateStatus('message-status', 'success', 'APIæ¶ˆæ¯å‘é€æ­£å¸¸ï¼Œç›´æ¥ç¡®è®¤æœºåˆ¶å¯ç”¨');

        } else {
          log(`âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${response.status}`, 'error');
          updateStatus('message-status', 'error', `æ¶ˆæ¯å‘é€å¤±è´¥: ${response.status}`);
        }

      } catch (error) {
        log(`âŒ æ¶ˆæ¯æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        updateStatus('message-status', 'error', 'æ¶ˆæ¯æµ‹è¯•å¤±è´¥');
      }
    }

    // æµ‹è¯•SSEè¿æ¥
    async function testSSEConnection() {
      log('âš¡ å¼€å§‹SSEè¿æ¥æµ‹è¯•...', 'info');

      try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
          log('âŒ ç¼ºå°‘è®¤è¯token', 'error');
          updateStatus('sse-status', 'error', 'è®¤è¯tokenç¼ºå¤±');
          return;
        }

        log('ğŸ”— åˆ›å»ºSSEè¿æ¥...', 'info');

        const eventSource = new EventSource(`/events?access_token=${token}`);

        eventSource.onopen = () => {
          log('âœ… SSEè¿æ¥å»ºç«‹æˆåŠŸ', 'success');
          updateStatus('sse-status', 'success', 'SSEè¿æ¥æ­£å¸¸ï¼ˆä»…ç”¨äºæ¥æ”¶ä»–äººæ¶ˆæ¯ï¼‰');
        };

        eventSource.onmessage = (event) => {
          log(`ğŸ“¨ æ”¶åˆ°SSEäº‹ä»¶: ${event.data}`, 'info');
        };

        eventSource.onerror = (error) => {
          log(`âŒ SSEè¿æ¥é”™è¯¯: ${error}`, 'error');
          updateStatus('sse-status', 'warning', 'SSEè¿æ¥å¼‚å¸¸ï¼ˆä¸å½±å“è‡ªå·±æ¶ˆæ¯ç¡®è®¤ï¼‰');
        };

        // 10ç§’åå…³é—­è¿æ¥
        setTimeout(() => {
          eventSource.close();
          log('ğŸ”Œ SSEè¿æ¥å·²å…³é—­', 'info');
          testResults.sse = true;
        }, 10000);

      } catch (error) {
        log(`âŒ SSEæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        updateStatus('sse-status', 'warning', 'SSEå¼‚å¸¸ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰');
      }
    }

    // ç»¼åˆæµ‹è¯•
    async function runComprehensiveTest() {
      log('ğŸš€ å¼€å§‹ç»¼åˆæµ‹è¯•...', 'info');

      await testArchitecture();
      await new Promise(resolve => setTimeout(resolve, 2000));

      await testMessageFlow();
      await new Promise(resolve => setTimeout(resolve, 2000));

      await testSSEConnection();
      await new Promise(resolve => setTimeout(resolve, 3000));

      // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      const passedTests = Object.values(testResults).filter(Boolean).length;
      const totalTests = Object.keys(testResults).length;

      log('ğŸ“Š æµ‹è¯•å®Œæˆï¼', 'info');
      log(`âœ… é€šè¿‡æµ‹è¯•: ${passedTests}/${totalTests}`, 'success');

      if (passedTests >= 2) {
        log('ğŸ‰ ä¿®å¤éªŒè¯æˆåŠŸï¼æ¶ˆæ¯ç¡®è®¤åŠŸèƒ½æ­£å¸¸å·¥ä½œ', 'success');
        updateStatus('fix-status', 'success', 'ä¿®å¤éªŒè¯æˆåŠŸï¼Œæ¶ˆæ¯ç¡®è®¤æ­£å¸¸');
        testResults.fix = true;
      } else {
        log('âš ï¸ éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥é…ç½®', 'warning');
        updateStatus('fix-status', 'warning', 'éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸');
      }
    }

    function clearLogs() {
      logs.innerHTML = '';
    }

    function generateUUID() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
      log('ğŸ” Notify-Server SSEä¿®å¤éªŒè¯å·¥å…·å¯åŠ¨', 'info');
      log('ğŸ“‹ æ ¸å¿ƒä¿®å¤ï¼šAPIæˆåŠŸåç›´æ¥æ ‡è®°æ¶ˆæ¯ä¸ºdeliveredï¼Œæ— éœ€ç­‰å¾…notify-server SSE', 'info');
      log('ğŸ¯ ç‚¹å‡»"ç»¼åˆæµ‹è¯•"å¼€å§‹éªŒè¯ä¿®å¤æ•ˆæœ', 'info');

      updateStatus('fix-status', 'success', 'APIç›´æ¥ç¡®è®¤æœºåˆ¶å·²å¯ç”¨');
    });
  </script>
</body>

</html>