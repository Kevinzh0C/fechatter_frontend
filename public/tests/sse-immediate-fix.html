<!DOCTYPE html>
<html>

<head>
  <title>ğŸš¨ SSE Immediate Fix</title>
  <style>
    body {
      font-family: monospace;
      background: #1a1a1a;
      color: #00ff00;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }

    .error {
      background: #330000;
      border: 1px solid #ff0000;
    }

    .success {
      background: #003300;
      border: 1px solid #00ff00;
    }

    .warning {
      background: #333300;
      border: 1px solid #ffff00;
    }

    .info {
      background: #000033;
      border: 1px solid #0099ff;
    }

    button {
      background: #333;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #555;
    }

    .log {
      background: #000;
      border: 1px solid #333;
      padding: 10px;
      margin: 10px 0;
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸš¨ SSE Immediate Fix Tool</h1>
    <p>Emergency diagnostic for EventSource error</p>

    <div class="status info">
      <strong>STATUS:</strong> EventSource error detected - No /events requests in proxy logs
    </div>

    <button onclick="emergencyDiagnosis()">ğŸ” Emergency Diagnosis</button>
    <button onclick="testDirectSSE()">ğŸ§ª Test Direct SSE</button>
    <button onclick="fixTokenIssue()">ğŸ”§ Fix Token Issue</button>
    <button onclick="testURLConstruction()">ğŸ”— Test URL Construction</button>

    <div class="log" id="logOutput"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = `[${timestamp}] ${message}`;

      const logDiv = document.getElementById('logOutput');
      const p = document.createElement('p');
      p.style.color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : type === 'warning' ? '#ffff00' : '#0099ff';
      p.textContent = entry;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;

      console.log(`[SSE-Fix] ${entry}`);
    }

    function emergencyDiagnosis() {
      log('ğŸš¨ EMERGENCY DIAGNOSIS STARTING...', 'error');

      // Check 1: SSE Service
      const minimalSSE = window.minimalSSE || window.realtimeCommunicationService;
      if (!minimalSSE) {
        log('âŒ CRITICAL: SSE service not found', 'error');
        return;
      }
      log('âœ… SSE service found', 'success');

      // Check 2: Auth Store
      const authStore = window.__pinia_stores__?.auth?.() ||
        window.pinia?.stores?.auth ||
        window.authStore;

      if (!authStore) {
        log('âŒ CRITICAL: Auth store not accessible', 'error');
        return;
      }
      log('âœ… Auth store found', 'success');

      // Check 3: Authentication & Token
      log(`ğŸ” Authenticated: ${authStore.isAuthenticated}`, authStore.isAuthenticated ? 'success' : 'error');
      log(`ğŸ« Token exists: ${!!authStore.token}`, authStore.token ? 'success' : 'error');

      if (authStore.token) {
        log(`ğŸ” Token type: ${typeof authStore.token}`, 'info');
        log(`ğŸ” Token length: ${authStore.token.length}`, 'info');
        log(`ğŸ” Token preview: ${authStore.token.substring(0, 30)}...`, 'info');

        // Validate token format
        if (typeof authStore.token !== 'string' || authStore.token.length < 10) {
          log('âŒ INVALID TOKEN FORMAT!', 'error');
          return;
        }
      } else {
        log('âŒ NO TOKEN - Cannot proceed with SSE', 'error');
        return;
      }

      // Check 4: Current SSE State
      log(`ğŸ“¡ SSE connected: ${minimalSSE.connected}`, 'info');
      log(`ğŸ”— EventSource exists: ${!!minimalSSE.eventSource}`, minimalSSE.eventSource ? 'success' : 'error');

      if (minimalSSE.eventSource) {
        log(`ğŸ“Š EventSource readyState: ${minimalSSE.eventSource.readyState}`, 'info');
        log(`ğŸŒ EventSource URL: ${minimalSSE.eventSource.url}`, 'info');

        const states = ['CONNECTING', 'OPEN', 'CLOSED'];
        log(`ğŸ“Š ReadyState meaning: ${states[minimalSSE.eventSource.readyState]}`, 'info');

        if (minimalSSE.eventSource.readyState === 2) {
          log('ğŸš¨ EventSource is CLOSED - this is the problem!', 'error');
        } else if (minimalSSE.eventSource.readyState === 0) {
          log('âš ï¸ EventSource stuck in CONNECTING state', 'warning');
        }
      } else {
        log('âŒ EventSource object not created!', 'error');
      }

      log('ğŸ” Diagnosis complete - check findings above', 'info');
    }

    function testDirectSSE() {
      log('ğŸ§ª Testing direct EventSource creation...', 'info');

      const authStore = window.__pinia_stores__?.auth?.() ||
        window.pinia?.stores?.auth ||
        window.authStore;

      if (!authStore || !authStore.token) {
        log('âŒ Cannot test: No auth token available', 'error');
        return;
      }

      const token = authStore.token;
      const url = `/events?access_token=${encodeURIComponent(token)}`;

      log(`ğŸ”— Creating direct EventSource to: ${url}`, 'info');
      log(`ğŸ” URL length: ${url.length}`, 'info');

      try {
        const testES = new EventSource(url);
        log('âœ… EventSource object created successfully', 'success');

        testES.onopen = function () {
          log('ğŸ‰ DIRECT TEST SUCCESS: EventSource OPENED!', 'success');
          log('ğŸŒ This proves the URL and token work!', 'success');
          log('ğŸ”§ Problem is in the SSE service logic', 'warning');
        };

        testES.onmessage = function (event) {
          log(`ğŸ“¨ Direct message: ${event.data.substring(0, 50)}...`, 'success');
        };

        testES.onerror = function (error) {
          log(`âŒ Direct EventSource error: ${error}`, 'error');
          log(`ğŸ“Š ReadyState: ${testES.readyState}`, 'error');

          const states = ['CONNECTING', 'OPEN', 'CLOSED'];
          log(`ğŸ“Š ReadyState meaning: ${states[testES.readyState]}`, 'error');

          if (testES.readyState === 2) {
            log('ğŸš¨ Direct test also failed - server/network issue', 'error');
          }
        };

        // Auto-close after 10 seconds
        setTimeout(() => {
          testES.close();
          log('ğŸ”š Direct test completed and closed', 'info');
        }, 10000);

        window.directTestES = testES;

      } catch (error) {
        log(`âŒ Direct EventSource creation failed: ${error.message}`, 'error');
        log(`ğŸ” Error name: ${error.name}`, 'error');

        if (error.name === 'SecurityError') {
          log('ğŸš¨ SECURITY ERROR: CORS or origin issue', 'error');
        } else if (error.name === 'SyntaxError') {
          log('ğŸš¨ SYNTAX ERROR: Invalid URL format', 'error');
        }
      }
    }

    function fixTokenIssue() {
      log('ğŸ”§ Attempting to fix token issues...', 'warning');

      const authStore = window.__pinia_stores__?.auth?.() ||
        window.pinia?.stores?.auth ||
        window.authStore;

      if (!authStore) {
        log('âŒ Cannot fix: Auth store not accessible', 'error');
        return;
      }

      log(`ğŸ” Current token: ${authStore.token ? 'exists' : 'missing'}`, 'info');

      if (authStore.token) {
        // Try to refresh token
        if (typeof authStore.refreshToken === 'function') {
          log('ğŸ”„ Attempting token refresh...', 'info');
          authStore.refreshToken().then(() => {
            log('âœ… Token refresh successful', 'success');
            log('ğŸ”— Attempting SSE reconnection...', 'info');

            const minimalSSE = window.minimalSSE || window.realtimeCommunicationService;
            if (minimalSSE) {
              minimalSSE.disconnect();
              setTimeout(() => {
                minimalSSE.connect(authStore.token);
              }, 1000);
            }
          }).catch(error => {
            log(`âŒ Token refresh failed: ${error.message}`, 'error');
          });
        } else {
          log('âš ï¸ No refresh method available', 'warning');
        }
      } else {
        log('âŒ No token to fix', 'error');
      }
    }

    function testURLConstruction() {
      log('ğŸ”— Testing URL construction...', 'info');

      const authStore = window.__pinia_stores__?.auth?.() ||
        window.pinia?.stores?.auth ||
        window.authStore;

      if (!authStore || !authStore.token) {
        log('âŒ Cannot test: No token available', 'error');
        return;
      }

      const token = authStore.token;
      const baseUrl = '/events';

      log(`ğŸ” Base URL: ${baseUrl}`, 'info');
      log(`ğŸ” Token length: ${token.length}`, 'info');

      // Test different URL constructions
      const urls = [
        `${baseUrl}?access_token=${token}`,
        `${baseUrl}?access_token=${encodeURIComponent(token)}`,
        `/events?token=${token}`,
        `/events?auth=${token}`
      ];

      urls.forEach((url, index) => {
        log(`ğŸ§ª URL ${index + 1}: ${url.substring(0, 50)}...`, 'info');
        log(`ğŸ” URL ${index + 1} length: ${url.length}`, 'info');

        try {
          new URL(url, window.location.origin);
          log(`âœ… URL ${index + 1} format valid`, 'success');
        } catch (error) {
          log(`âŒ URL ${index + 1} format invalid: ${error.message}`, 'error');
        }
      });

      // Test recommended URL
      const recommendedUrl = `${baseUrl}?access_token=${encodeURIComponent(token)}`;
      log(`ğŸ¯ Recommended URL: ${recommendedUrl.substring(0, 80)}...`, 'success');
    }

    // Auto-run diagnosis on load
    window.addEventListener('load', function () {
      log('ğŸš¨ SSE Immediate Fix Tool Ready', 'info');
      log('ğŸ“‹ Click Emergency Diagnosis to start', 'info');
    });
  </script>
</body>

</html>