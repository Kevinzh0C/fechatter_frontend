<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”¬ SSEè¿æ¥è¯Šæ–­</title>
  <style>
    body {
      font-family: 'Monaco', 'Menlo', monospace;
      margin: 0;
      padding: 20px;
      background: #1a1a1a;
      color: #ffffff;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #2d3748;
      border-radius: 12px;
      padding: 30px;
    }

    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #3182ce;
      color: white;
    }

    .btn-success {
      background: #38a169;
      color: white;
    }

    .btn-warning {
      background: #d69e2e;
      color: white;
    }

    .btn-danger {
      background: #e53e3e;
      color: white;
    }

    .diagnosis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .diagnosis-card {
      background: #4a5568;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #3182ce;
    }

    .diagnosis-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #e2e8f0;
    }

    .check-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.2);
    }

    .check-status {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .status-success {
      background: #38a169;
      color: white;
    }

    .status-error {
      background: #e53e3e;
      color: white;
    }

    .status-warning {
      background: #d69e2e;
      color: white;
    }

    .status-info {
      background: #3182ce;
      color: white;
    }

    .log-container {
      background: #1a202c;
      border-radius: 8px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 14px;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
    }

    .log-info {
      color: #63b3ed;
    }

    .log-success {
      color: #68d391;
    }

    .log-warning {
      color: #fbb03b;
    }

    .log-error {
      color: #f687b3;
    }

    .log-critical {
      color: #f687b3;
      background: rgba(246, 135, 179, 0.1);
      border-left: 3px solid #f687b3;
      padding-left: 12px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”¬ SSEè¿æ¥è¯Šæ–­å·¥å…·</h1>
    <p>ç²¾ç¡®è¯Šæ–­ä¸ºä»€ä¹ˆå‰ç«¯æ²¡æœ‰å»ºç«‹SSEè¿æ¥</p>

    <div class="control-panel">
      <button class="btn btn-primary" onclick="runFullDiagnosis()">ğŸ”¬ å®Œæ•´è¯Šæ–­</button>
      <button class="btn btn-success" onclick="checkAuthTokens()">ğŸ” æ£€æŸ¥Token</button>
      <button class="btn btn-warning" onclick="testSSEManually()">ğŸ”— æ‰‹åŠ¨æµ‹è¯•SSE</button>
      <button class="btn btn-danger" onclick="forceSSEConnection()">ğŸš€ å¼ºåˆ¶å»ºç«‹è¿æ¥</button>
    </div>

    <div class="diagnosis-grid">
      <div class="diagnosis-card">
        <div class="diagnosis-title">ğŸ” è®¤è¯çŠ¶æ€æ£€æŸ¥</div>
        <div id="authChecks"></div>
      </div>

      <div class="diagnosis-card">
        <div class="diagnosis-title">ğŸ“¡ SSEæœåŠ¡æ£€æŸ¥</div>
        <div id="sseServiceChecks"></div>
      </div>

      <div class="diagnosis-card">
        <div class="diagnosis-title">ğŸŒ ç½‘ç»œè¿æ¥æ£€æŸ¥</div>
        <div id="networkChecks"></div>
      </div>

      <div class="diagnosis-card">
        <div class="diagnosis-title">âš™ï¸ é…ç½®æ£€æŸ¥</div>
        <div id="configChecks"></div>
      </div>
    </div>

    <div class="diagnosis-card">
      <div class="diagnosis-title">ğŸ“ è¯Šæ–­æ—¥å¿—</div>
      <div class="log-container" id="diagnosisLog"></div>
    </div>
  </div>

  <script>
    // æ—¥å¿—è®°å½•
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logContainer = document.getElementById('diagnosisLog');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `[${timestamp}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(`[SSEè¯Šæ–­] ${message}`);
    }

    // æ·»åŠ æ£€æŸ¥é¡¹
    function addCheck(containerId, text, status, details = '') {
      const container = document.getElementById(containerId);
      const item = document.createElement('div');
      item.className = 'check-item';

      const statusIcon = document.createElement('div');
      statusIcon.className = `check-status status-${status}`;
      statusIcon.textContent = {
        'success': 'âœ“',
        'error': 'âœ—',
        'warning': '!',
        'info': '?'
      }[status];

      const textSpan = document.createElement('span');
      textSpan.innerHTML = `${text}${details ? `<br><small style="color: #a0aec0;">${details}</small>` : ''}`;

      item.appendChild(statusIcon);
      item.appendChild(textSpan);
      container.appendChild(item);
    }

    // æ¸…ç©ºæ£€æŸ¥ç»“æœ
    function clearChecks() {
      ['authChecks', 'sseServiceChecks', 'networkChecks', 'configChecks'].forEach(id => {
        document.getElementById(id).innerHTML = '';
      });
    }

    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    async function checkAuthTokens() {
      log('ğŸ” å¼€å§‹æ£€æŸ¥è®¤è¯çŠ¶æ€...', 'info');
      clearChecks();

      // æ£€æŸ¥localStorageä¸­çš„token
      const tokenKeys = ['auth_token', 'fechatter_auth_token', 'access_token'];
      let foundToken = null;

      for (const key of tokenKeys) {
        const token = localStorage.getItem(key);
        if (token) {
          foundToken = token;
          addCheck('authChecks', `Tokenå­˜åœ¨ (${key})`, 'success', `é•¿åº¦: ${token.length} å­—ç¬¦`);
          log(`âœ… æ‰¾åˆ°Token: ${key} (${token.length}å­—ç¬¦)`, 'success');
          break;
        } else {
          addCheck('authChecks', `Tokenç¼ºå¤± (${key})`, 'error');
        }
      }

      // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
      try {
        const authUser = localStorage.getItem('auth_user');
        if (authUser) {
          const userInfo = JSON.parse(authUser);
          addCheck('authChecks', 'ç”¨æˆ·ä¿¡æ¯å­˜åœ¨', 'success', `ID: ${userInfo.id}, å·¥ä½œåŒº: ${userInfo.workspace_id}`);
          log(`âœ… ç”¨æˆ·ä¿¡æ¯: ID=${userInfo.id}, å·¥ä½œåŒº=${userInfo.workspace_id}`, 'success');
        } else {
          addCheck('authChecks', 'ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±', 'error');
          log('âŒ ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±', 'error');
        }
      } catch (error) {
        addCheck('authChecks', 'ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥', 'error');
        log(`âŒ ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥: ${error.message}`, 'error');
      }

      // æ£€æŸ¥authStoreçŠ¶æ€
      if (window.authStore || (window.__pinia_stores__ && window.__pinia_stores__.auth)) {
        const authStore = window.authStore || window.__pinia_stores__.auth();
        addCheck('authChecks', 'AuthStoreå¯ç”¨', 'success');

        if (authStore.tokens && authStore.tokens.accessToken) {
          addCheck('authChecks', 'AuthStoreä¸­æœ‰Token', 'success');
          log('âœ… AuthStoreä¸­æ‰¾åˆ°Token', 'success');
        } else {
          addCheck('authChecks', 'AuthStoreä¸­æ— Token', 'error');
          log('âŒ AuthStoreä¸­æ²¡æœ‰Token', 'error');
        }
      } else {
        addCheck('authChecks', 'AuthStoreä¸å¯ç”¨', 'error');
        log('âŒ AuthStoreä¸å¯ç”¨', 'error');
      }

      return foundToken;
    }

    // æ£€æŸ¥SSEæœåŠ¡
    function checkSSEService() {
      log('ğŸ“¡ å¼€å§‹æ£€æŸ¥SSEæœåŠ¡...', 'info');

      // æ£€æŸ¥minimalSSEæ˜¯å¦å­˜åœ¨
      if (window.minimalSSE) {
        addCheck('sseServiceChecks', 'MinimalSSEæœåŠ¡å­˜åœ¨', 'success');
        log('âœ… MinimalSSEæœåŠ¡æ‰¾åˆ°', 'success');

        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        try {
          const status = window.minimalSSE.getStatus();
          if (status.connected) {
            addCheck('sseServiceChecks', 'SSEå·²è¿æ¥', 'success', `é‡è¯•æ¬¡æ•°: ${status.retries}`);
            log(`âœ… SSEå·²è¿æ¥ï¼Œé‡è¯•æ¬¡æ•°: ${status.retries}`, 'success');
          } else {
            addCheck('sseServiceChecks', 'SSEæœªè¿æ¥', 'error', `é‡è¯•æ¬¡æ•°: ${status.retries}`);
            log(`âŒ SSEæœªè¿æ¥ï¼Œé‡è¯•æ¬¡æ•°: ${status.retries}`, 'error');
          }
        } catch (error) {
          addCheck('sseServiceChecks', 'SSEçŠ¶æ€æ£€æŸ¥å¤±è´¥', 'error');
          log(`âŒ SSEçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        }

        // æ£€æŸ¥ç›‘å¬å™¨
        try {
          const listeners = window.minimalSSE.listeners;
          if (listeners && listeners.size > 0) {
            let totalListeners = 0;
            for (const [eventType, callbacks] of listeners.entries()) {
              totalListeners += callbacks.length;
            }
            addCheck('sseServiceChecks', 'SSEç›‘å¬å™¨å­˜åœ¨', 'success', `${totalListeners}ä¸ªç›‘å¬å™¨`);
            log(`âœ… SSEç›‘å¬å™¨: ${totalListeners}ä¸ª`, 'success');
          } else {
            addCheck('sseServiceChecks', 'SSEç›‘å¬å™¨ç¼ºå¤±', 'warning');
            log('âš ï¸ æ²¡æœ‰SSEç›‘å¬å™¨', 'warning');
          }
        } catch (error) {
          addCheck('sseServiceChecks', 'ç›‘å¬å™¨æ£€æŸ¥å¤±è´¥', 'error');
          log(`âŒ ç›‘å¬å™¨æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        }
      } else {
        addCheck('sseServiceChecks', 'MinimalSSEæœåŠ¡ä¸å­˜åœ¨', 'error');
        log('âŒ MinimalSSEæœåŠ¡ä¸å­˜åœ¨', 'error');
      }

      // æ£€æŸ¥å…¶ä»–SSEå¯¹è±¡
      if (window.realtimeCommunicationService) {
        addCheck('sseServiceChecks', 'å…¼å®¹SSEæœåŠ¡å­˜åœ¨', 'info');
      }

      if (window.eventSource) {
        addCheck('sseServiceChecks', 'EventSourceå¯¹è±¡å­˜åœ¨', 'info', `çŠ¶æ€: ${window.eventSource.readyState}`);
      }
    }

    // æ£€æŸ¥ç½‘ç»œè¿æ¥
    async function checkNetworkConnection() {
      log('ğŸŒ å¼€å§‹æ£€æŸ¥ç½‘ç»œè¿æ¥...', 'info');

      // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
      if (navigator.onLine) {
        addCheck('networkChecks', 'æµè§ˆå™¨åœ¨çº¿çŠ¶æ€', 'success');
        log('âœ… æµè§ˆå™¨æ˜¾ç¤ºåœ¨çº¿', 'success');
      } else {
        addCheck('networkChecks', 'æµè§ˆå™¨ç¦»çº¿çŠ¶æ€', 'error');
        log('âŒ æµè§ˆå™¨æ˜¾ç¤ºç¦»çº¿', 'error');
      }

      // æ£€æŸ¥/eventsç«¯ç‚¹
      try {
        const response = await fetch('/events', {
          method: 'GET',
          headers: { 'Accept': 'text/event-stream' }
        });

        if (response.ok) {
          addCheck('networkChecks', '/eventsç«¯ç‚¹å¯è¾¾', 'success', `çŠ¶æ€ç : ${response.status}`);
          log(`âœ… /eventsç«¯ç‚¹å“åº”: ${response.status}`, 'success');
        } else {
          addCheck('networkChecks', '/eventsç«¯ç‚¹é”™è¯¯', 'error', `çŠ¶æ€ç : ${response.status}`);
          log(`âŒ /eventsç«¯ç‚¹é”™è¯¯: ${response.status}`, 'error');
        }
      } catch (error) {
        addCheck('networkChecks', '/eventsç«¯ç‚¹è¿æ¥å¤±è´¥', 'error', error.message);
        log(`âŒ /eventsç«¯ç‚¹è¿æ¥å¤±è´¥: ${error.message}`, 'error');
      }

      // æ£€æŸ¥APIç«¯ç‚¹
      try {
        const response = await fetch('/api/health');
        if (response.ok) {
          addCheck('networkChecks', 'APIç«¯ç‚¹å¯è¾¾', 'success');
          log('âœ… APIç«¯ç‚¹å¯è¾¾', 'success');
        } else {
          addCheck('networkChecks', 'APIç«¯ç‚¹é”™è¯¯', 'warning');
          log('âš ï¸ APIç«¯ç‚¹æœ‰é—®é¢˜', 'warning');
        }
      } catch (error) {
        addCheck('networkChecks', 'APIç«¯ç‚¹è¿æ¥å¤±è´¥', 'error');
        log(`âŒ APIç«¯ç‚¹è¿æ¥å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ£€æŸ¥é…ç½®
    function checkConfiguration() {
      log('âš™ï¸ å¼€å§‹æ£€æŸ¥é…ç½®...', 'info');

      // æ£€æŸ¥ç¯å¢ƒå˜é‡
      if (typeof import !== 'undefined' && import.meta && import.meta.env) {
        addCheck('configChecks', 'ç¯å¢ƒå˜é‡å¯ç”¨', 'success');

        const sseUrl = import.meta.env.VITE_SSE_URL;
        if (sseUrl) {
          addCheck('configChecks', 'SSE URLé…ç½®', 'success', sseUrl);
        } else {
          addCheck('configChecks', 'SSE URLæœªé…ç½®', 'info', 'ä½¿ç”¨é»˜è®¤ /events');
        }
      } else {
        addCheck('configChecks', 'ç¯å¢ƒå˜é‡ä¸å¯ç”¨', 'warning');
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºå¼€å‘æ¨¡å¼
      const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      if (isDev) {
        addCheck('configChecks', 'å¼€å‘æ¨¡å¼', 'info', 'Viteä»£ç†åº”è¯¥å¤„ç†/events');
        log('â„¹ï¸ è¿è¡Œåœ¨å¼€å‘æ¨¡å¼ï¼Œä½¿ç”¨Viteä»£ç†', 'info');
      } else {
        addCheck('configChecks', 'ç”Ÿäº§æ¨¡å¼', 'info');
        log('â„¹ï¸ è¿è¡Œåœ¨ç”Ÿäº§æ¨¡å¼', 'info');
      }

      // æ£€æŸ¥é¡µé¢åè®®
      if (window.location.protocol === 'https:') {
        addCheck('configChecks', 'HTTPSåè®®', 'success');
      } else {
        addCheck('configChecks', 'HTTPåè®®', 'info', 'å¼€å‘ç¯å¢ƒæ­£å¸¸');
      }
    }

    // æ‰‹åŠ¨æµ‹è¯•SSEè¿æ¥
    async function testSSEManually() {
      log('ğŸ”— å¼€å§‹æ‰‹åŠ¨æµ‹è¯•SSEè¿æ¥...', 'info');

      const token = await checkAuthTokens();
      if (!token) {
        log('âŒ æ— æ³•æµ‹è¯•SSEï¼šç¼ºå°‘Token', 'error');
        return;
      }

      try {
        const sseUrl = `/events?access_token=${token}`;
        log(`ğŸ”— å°è¯•è¿æ¥: ${sseUrl.substring(0, 50)}...`, 'info');

        const eventSource = new EventSource(sseUrl);

        eventSource.onopen = function (event) {
          log('âœ… æ‰‹åŠ¨SSEè¿æ¥æˆåŠŸï¼', 'success');
          addCheck('networkChecks', 'æ‰‹åŠ¨SSEè¿æ¥', 'success', 'è¿æ¥æˆåŠŸ');
        };

        eventSource.onmessage = function (event) {
          log(`ğŸ“¨ æ”¶åˆ°SSEæ¶ˆæ¯: ${event.data}`, 'success');
        };

        eventSource.onerror = function (event) {
          log(`âŒ SSEè¿æ¥é”™è¯¯: ReadyState=${eventSource.readyState}`, 'error');
          addCheck('networkChecks', 'æ‰‹åŠ¨SSEè¿æ¥', 'error', `ReadyState=${eventSource.readyState}`);
        };

        // 10ç§’åå…³é—­æµ‹è¯•è¿æ¥
        setTimeout(() => {
          eventSource.close();
          log('ğŸ”— æ‰‹åŠ¨SSEæµ‹è¯•è¿æ¥å·²å…³é—­', 'info');
        }, 10000);

      } catch (error) {
        log(`âŒ æ‰‹åŠ¨SSEæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        addCheck('networkChecks', 'æ‰‹åŠ¨SSEè¿æ¥', 'error', error.message);
      }
    }

    // å¼ºåˆ¶å»ºç«‹SSEè¿æ¥
    async function forceSSEConnection() {
      log('ğŸš€ å¼€å§‹å¼ºåˆ¶å»ºç«‹SSEè¿æ¥...', 'critical');

      const token = await checkAuthTokens();
      if (!token) {
        log('âŒ æ— æ³•å¼ºåˆ¶è¿æ¥ï¼šç¼ºå°‘Token', 'error');
        return;
      }

      if (window.minimalSSE) {
        try {
          log('ğŸ”„ è°ƒç”¨minimalSSE.connect()...', 'info');
          window.minimalSSE.connect(token);

          // ç­‰å¾…è¿æ¥å»ºç«‹
          setTimeout(() => {
            const status = window.minimalSSE.getStatus();
            if (status.connected) {
              log('âœ… å¼ºåˆ¶SSEè¿æ¥æˆåŠŸï¼', 'success');
              addCheck('sseServiceChecks', 'å¼ºåˆ¶è¿æ¥', 'success', 'è¿æ¥å·²å»ºç«‹');
            } else {
              log('âŒ å¼ºåˆ¶SSEè¿æ¥å¤±è´¥', 'error');
              addCheck('sseServiceChecks', 'å¼ºåˆ¶è¿æ¥', 'error', 'è¿æ¥æœªå»ºç«‹');
            }
          }, 2000);

        } catch (error) {
          log(`âŒ å¼ºåˆ¶è¿æ¥å‡ºé”™: ${error.message}`, 'error');
        }
      } else {
        log('âŒ MinimalSSEæœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•å¼ºåˆ¶è¿æ¥', 'error');
      }

      // åŒæ—¶å°è¯•setupSSEMessageListeners
      if (window.chatStore || (window.__pinia_stores__ && window.__pinia_stores__.chat)) {
        try {
          const chatStore = window.chatStore || window.__pinia_stores__.chat();
          if (chatStore.setupSSEMessageListeners) {
            log('ğŸ”„ é‡æ–°è®¾ç½®SSEæ¶ˆæ¯ç›‘å¬å™¨...', 'info');
            chatStore.setupSSEMessageListeners();
            log('âœ… SSEæ¶ˆæ¯ç›‘å¬å™¨å·²é‡æ–°è®¾ç½®', 'success');
          }
        } catch (error) {
          log(`âŒ è®¾ç½®ç›‘å¬å™¨å¤±è´¥: ${error.message}`, 'error');
        }
      }
    }

    // è¿è¡Œå®Œæ•´è¯Šæ–­
    async function runFullDiagnosis() {
      log('ğŸ”¬ å¼€å§‹å®Œæ•´SSEè¿æ¥è¯Šæ–­...', 'info');
      clearChecks();

      // æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
      await checkAuthTokens();
      checkSSEService();
      await checkNetworkConnection();
      checkConfiguration();

      log('âœ… å®Œæ•´è¯Šæ–­å®Œæˆï¼è¯·æŸ¥çœ‹å„é¡¹æ£€æŸ¥ç»“æœ', 'success');
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
    window.addEventListener('load', () => {
      log('ğŸ”¬ SSEè¿æ¥è¯Šæ–­å·¥å…·å·²åŠ è½½', 'info');
      log('ğŸ“‹ ç‚¹å‡»"å®Œæ•´è¯Šæ–­"å¼€å§‹åˆ†æSSEè¿æ¥é—®é¢˜', 'info');
    });
  </script>
</body>

</html>