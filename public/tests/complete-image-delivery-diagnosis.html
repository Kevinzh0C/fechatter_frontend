<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” å›¾ç‰‡æ˜¾ç¤º & SSEé€è¾¾çŠ¶æ€ - ç»¼åˆè¯Šæ–­</title>
  <style>
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .content {
      padding: 30px;
    }

    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #007bff;
    }

    .section h2 {
      margin-top: 0;
      color: #007bff;
      font-size: 1.5rem;
    }

    .diagnostic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .diagnostic-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e9ecef;
    }

    .diagnostic-card h3 {
      margin-top: 0;
      color: #495057;
      font-size: 1.2rem;
    }

    .status-indicator {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      margin-right: 8px;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .code-block {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.875rem;
      line-height: 1.4;
      overflow-x: auto;
      margin: 10px 0;
    }

    .results {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-family: monospace;
      font-size: 0.875rem;
      white-space: pre-wrap;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }

    .log-entry {
      margin: 5px 0;
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid;
    }

    .log-success {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    .log-warning {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    .log-error {
      background: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    .log-info {
      background: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }

    .file-preview {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      background: white;
    }

    .file-preview img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }

    .auto-refresh {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 25px;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-indicator {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="auto-refresh">
    <div class="refresh-indicator"></div>
    è‡ªåŠ¨åˆ·æ–°ä¸­...
  </div>

  <div class="container">
    <div class="header">
      <h1>ğŸ” å›¾ç‰‡æ˜¾ç¤º & SSEé€è¾¾çŠ¶æ€è¯Šæ–­</h1>
      <p>æ£€æŸ¥æ–‡ä»¶æ˜¾ç¤ºç³»ç»Ÿå’Œæ¶ˆæ¯é€è¾¾ç¡®è®¤æœºåˆ¶</p>
    </div>

    <div class="content">
      <!-- å¿«é€ŸçŠ¶æ€æ¦‚è§ˆ -->
      <div class="section">
        <h2>ğŸ“Š å¿«é€ŸçŠ¶æ€æ¦‚è§ˆ</h2>
        <div class="diagnostic-grid">
          <div class="diagnostic-card">
            <h3>ğŸ–¼ï¸ å›¾ç‰‡æ˜¾ç¤ºçŠ¶æ€</h3>
            <div id="imageDisplayStatus">æ£€æŸ¥ä¸­...</div>
          </div>
          <div class="diagnostic-card">
            <h3>ğŸ“¬ SSEé€è¾¾çŠ¶æ€</h3>
            <div id="sseDeliveryStatus">æ£€æŸ¥ä¸­...</div>
          </div>
          <div class="diagnostic-card">
            <h3>ğŸ”— APIè¿æ¥çŠ¶æ€</h3>
            <div id="apiConnectionStatus">æ£€æŸ¥ä¸­...</div>
          </div>
          <div class="diagnostic-card">
            <h3>ğŸ’¾ æ–‡ä»¶ä¸Šä¼ çŠ¶æ€</h3>
            <div id="fileUploadStatus">æ£€æŸ¥ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- è¯¦ç»†è¯Šæ–­ -->
      <div class="section">
        <h2>ğŸ” è¯¦ç»†è¯Šæ–­åˆ†æ</h2>

        <div class="diagnostic-card">
          <h3>1. æ¶ˆæ¯æ•°æ®ç»“æ„æ£€æŸ¥</h3>
          <button class="btn" onclick="checkMessageStructure()">æ£€æŸ¥æœ€æ–°æ¶ˆæ¯</button>
          <div id="messageStructureResults" class="results"></div>
        </div>

        <div class="diagnostic-card">
          <h3>2. æ–‡ä»¶URLå¯è¾¾æ€§æµ‹è¯•</h3>
          <button class="btn" onclick="testFileUrls()">æµ‹è¯•æ–‡ä»¶ä¸‹è½½</button>
          <div id="fileUrlResults" class="results"></div>
        </div>

        <div class="diagnostic-card">
          <h3>3. SSEäº‹ä»¶ç›‘å¬æ£€æŸ¥</h3>
          <button class="btn" onclick="checkSSEListeners()">æ£€æŸ¥SSEè¿æ¥</button>
          <div id="sseListenerResults" class="results"></div>
        </div>

        <div class="diagnostic-card">
          <h3>4. CSSæ ·å¼åº”ç”¨æ£€æŸ¥</h3>
          <button class="btn" onclick="checkCSSStyles()">æ£€æŸ¥æ ·å¼</button>
          <div id="cssStyleResults" class="results"></div>
        </div>
      </div>

      <!-- å®æ—¶ä¿®å¤å·¥å…· -->
      <div class="section">
        <h2>ğŸ”§ å®æ—¶ä¿®å¤å·¥å…·</h2>

        <div class="diagnostic-grid">
          <div class="diagnostic-card">
            <h3>å¼ºåˆ¶åˆ·æ–°æ¶ˆæ¯</h3>
            <button class="btn" onclick="forceRefreshMessages()">é‡æ–°åŠ è½½æ¶ˆæ¯</button>
            <div id="refreshResults" class="results"></div>
          </div>

          <div class="diagnostic-card">
            <h3>é‡ç½®SSEè¿æ¥</h3>
            <button class="btn" onclick="resetSSEConnection()">é‡è¿SSE</button>
            <div id="sseResetResults" class="results"></div>
          </div>

          <div class="diagnostic-card">
            <h3>ä¿®å¤é€è¾¾çŠ¶æ€</h3>
            <button class="btn" onclick="fixDeliveryStatus()">ä¿®å¤çŠ¶æ€</button>
            <div id="deliveryFixResults" class="results"></div>
          </div>

          <div class="diagnostic-card">
            <h3>å¼ºåˆ¶æ˜¾ç¤ºæ–‡ä»¶</h3>
            <button class="btn" onclick="forceShowFiles()">æ˜¾ç¤ºæ–‡ä»¶</button>
            <div id="fileShowResults" class="results"></div>
          </div>
        </div>
      </div>

      <!-- å®æ—¶æ—¥å¿— -->
      <div class="section">
        <h2>ğŸ“ å®æ—¶ç³»ç»Ÿæ—¥å¿—</h2>
        <button class="btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <button class="btn" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
        <div id="systemLogs" class="results"></div>
      </div>
    </div>
  </div>

  <script>
    let logs = [];
    let isMonitoring = true;

    // æ—¥å¿—è®°å½•å‡½æ•°
    function addLog(level, message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${level.toUpperCase()}: ${message}`;
      logs.push({ timestamp, level, message });

      const logElement = document.getElementById('systemLogs');
      const logDiv = document.createElement('div');
      logDiv.className = `log-entry log-${level}`;
      logDiv.textContent = logEntry;

      logElement.appendChild(logDiv);
      logElement.scrollTop = logElement.scrollHeight;

      // ä¿æŒæœ€å¤š100æ¡æ—¥å¿—
      if (logElement.children.length > 100) {
        logElement.removeChild(logElement.firstChild);
      }
    }

    // åˆå§‹åŒ–è¯Šæ–­
    async function initializeDiagnosis() {
      addLog('info', 'å¼€å§‹ç»¼åˆè¯Šæ–­...');

      // å¿«é€ŸçŠ¶æ€æ£€æŸ¥
      await Promise.all([
        checkImageDisplayQuick(),
        checkSSEDeliveryQuick(),
        checkAPIConnectionQuick(),
        checkFileUploadQuick()
      ]);

      addLog('success', 'å¿«é€Ÿè¯Šæ–­å®Œæˆ');
    }

    // 1. å›¾ç‰‡æ˜¾ç¤ºå¿«é€Ÿæ£€æŸ¥
    async function checkImageDisplayQuick() {
      try {
        // æ£€æŸ¥DOMä¸­çš„æ¶ˆæ¯
        const messageElements = document.querySelectorAll('[data-message-id]');
        const imageElements = document.querySelectorAll('.attachment-image, .file-attachment img');

        let status = '';
        if (imageElements.length === 0) {
          status = '<span class="status-warning">âš ï¸ æ— å›¾ç‰‡å…ƒç´ </span> - æ£€æŸ¥æ¶ˆæ¯æ•°æ®';
        } else {
          const loadedImages = Array.from(imageElements).filter(img => img.complete && img.naturalHeight > 0);
          status = `<span class="status-success">âœ… å‘ç° ${imageElements.length} ä¸ªå›¾ç‰‡</span> - ${loadedImages.length} ä¸ªå·²åŠ è½½`;
        }

        document.getElementById('imageDisplayStatus').innerHTML = status;
        addLog('info', `å›¾ç‰‡æ£€æŸ¥: å‘ç° ${imageElements.length} ä¸ªå›¾ç‰‡å…ƒç´ `);
      } catch (error) {
        document.getElementById('imageDisplayStatus').innerHTML = '<span class="status-error">âŒ æ£€æŸ¥å¤±è´¥</span>';
        addLog('error', `å›¾ç‰‡æ£€æŸ¥å¤±è´¥: ${error.message}`);
      }
    }

    // 2. SSEé€è¾¾çŠ¶æ€å¿«é€Ÿæ£€æŸ¥
    async function checkSSEDeliveryQuick() {
      try {
        // æ£€æŸ¥SSEè¿æ¥
        const hasSSE = window.minimalSSE || window.eventSource || false;
        const deliveredMessages = document.querySelectorAll('.message-item[data-status="delivered"]');

        let status = '';
        if (!hasSSE) {
          status = '<span class="status-warning">âš ï¸ SSEæœªè¿æ¥</span>';
        } else {
          status = `<span class="status-success">âœ… SSEå·²è¿æ¥</span> - ${deliveredMessages.length} æ¡å·²é€è¾¾`;
        }

        document.getElementById('sseDeliveryStatus').innerHTML = status;
        addLog('info', `SSEæ£€æŸ¥: è¿æ¥çŠ¶æ€ ${hasSSE ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`);
      } catch (error) {
        document.getElementById('sseDeliveryStatus').innerHTML = '<span class="status-error">âŒ æ£€æŸ¥å¤±è´¥</span>';
        addLog('error', `SSEæ£€æŸ¥å¤±è´¥: ${error.message}`);
      }
    }

    // 3. APIè¿æ¥å¿«é€Ÿæ£€æŸ¥
    async function checkAPIConnectionQuick() {
      try {
        const response = await fetch('/api/health', {
          method: 'GET',
          timeout: 5000
        });

        let status = '';
        if (response.ok) {
          status = '<span class="status-success">âœ… APIè¿æ¥æ­£å¸¸</span>';
        } else {
          status = `<span class="status-warning">âš ï¸ APIå“åº” ${response.status}</span>`;
        }

        document.getElementById('apiConnectionStatus').innerHTML = status;
        addLog('info', `APIæ£€æŸ¥: çŠ¶æ€ ${response.status}`);
      } catch (error) {
        document.getElementById('apiConnectionStatus').innerHTML = '<span class="status-error">âŒ APIè¿æ¥å¤±è´¥</span>';
        addLog('error', `APIæ£€æŸ¥å¤±è´¥: ${error.message}`);
      }
    }

    // 4. æ–‡ä»¶ä¸Šä¼ å¿«é€Ÿæ£€æŸ¥
    async function checkFileUploadQuick() {
      try {
        // æ£€æŸ¥æœ€è¿‘çš„ä¸Šä¼ è®°å½•
        const uploadElements = document.querySelectorAll('.file-attachment, .message-files');
        const fileInputs = document.querySelectorAll('input[type="file"]');

        let status = '';
        if (uploadElements.length === 0) {
          status = '<span class="status-warning">âš ï¸ æ— æ–‡ä»¶é™„ä»¶</span>';
        } else {
          status = `<span class="status-success">âœ… å‘ç° ${uploadElements.length} ä¸ªæ–‡ä»¶</span>`;
        }

        document.getElementById('fileUploadStatus').innerHTML = status;
        addLog('info', `æ–‡ä»¶æ£€æŸ¥: å‘ç° ${uploadElements.length} ä¸ªæ–‡ä»¶é™„ä»¶`);
      } catch (error) {
        document.getElementById('fileUploadStatus').innerHTML = '<span class="status-error">âŒ æ£€æŸ¥å¤±è´¥</span>';
        addLog('error', `æ–‡ä»¶æ£€æŸ¥å¤±è´¥: ${error.message}`);
      }
    }

    // è¯¦ç»†è¯Šæ–­å‡½æ•°
    async function checkMessageStructure() {
      const results = document.getElementById('messageStructureResults');
      results.textContent = 'æ­£åœ¨æ£€æŸ¥æ¶ˆæ¯æ•°æ®ç»“æ„...\n';

      try {
        // ä»localStorageæˆ–å…¨å±€å˜é‡è·å–æ¶ˆæ¯æ•°æ®
        const chatStore = window.chatStore || {};
        const messages = chatStore.messages || [];

        if (messages.length === 0) {
          results.textContent += 'âŒ æœªæ‰¾åˆ°æ¶ˆæ¯æ•°æ®\n';
          return;
        }

        // æ£€æŸ¥æœ€æ–°çš„å‡ æ¡æ¶ˆæ¯
        const recentMessages = messages.slice(-5);

        results.textContent += `âœ… æ‰¾åˆ° ${messages.length} æ¡æ¶ˆæ¯\n\n`;

        recentMessages.forEach((msg, index) => {
          results.textContent += `æ¶ˆæ¯ ${msg.id || msg.temp_id}:\n`;
          results.textContent += `  - å‘é€è€…: ${msg.sender_name || 'æœªçŸ¥'}\n`;
          results.textContent += `  - å†…å®¹: ${(msg.content || '').substring(0, 50)}...\n`;
          results.textContent += `  - æ–‡ä»¶æ•°é‡: ${(msg.files || []).length}\n`;
          results.textContent += `  - çŠ¶æ€: ${msg.status || 'æœªçŸ¥'}\n`;

          if (msg.files && msg.files.length > 0) {
            msg.files.forEach((file, fileIndex) => {
              results.textContent += `    æ–‡ä»¶ ${fileIndex + 1}: ${file.file_name || file.filename || 'æœªçŸ¥'}\n`;
              results.textContent += `      URL: ${file.file_url || file.url || 'æ— '}\n`;
              results.textContent += `      ç±»å‹: ${file.mime_type || file.type || 'æœªçŸ¥'}\n`;
            });
          }
          results.textContent += '\n';
        });

      } catch (error) {
        results.textContent += `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
        addLog('error', `æ¶ˆæ¯ç»“æ„æ£€æŸ¥å¤±è´¥: ${error.message}`);
      }
    }

    async function testFileUrls() {
      const results = document.getElementById('fileUrlResults');
      results.textContent = 'æ­£åœ¨æµ‹è¯•æ–‡ä»¶URLå¯è¾¾æ€§...\n';

      try {
        // è·å–æ‰€æœ‰æ–‡ä»¶URL
        const fileElements = document.querySelectorAll('.attachment-image, .file-attachment');
        const urls = [];

        fileElements.forEach(element => {
          const src = element.src || element.querySelector('img')?.src;
          if (src) urls.push(src);
        });

        if (urls.length === 0) {
          results.textContent += 'âŒ æœªæ‰¾åˆ°æ–‡ä»¶URL\n';
          return;
        }

        results.textContent += `æ‰¾åˆ° ${urls.length} ä¸ªæ–‡ä»¶URL\n\n`;

        for (const url of urls) {
          try {
            const response = await fetch(url, { method: 'HEAD' });
            const status = response.ok ? 'âœ… å¯è®¿é—®' : `âŒ é”™è¯¯ ${response.status}`;
            results.textContent += `${status}: ${url}\n`;
          } catch (error) {
            results.textContent += `âŒ ç½‘ç»œé”™è¯¯: ${url}\n`;
          }
        }

      } catch (error) {
        results.textContent += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n`;
        addLog('error', `æ–‡ä»¶URLæµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function checkSSEListeners() {
      const results = document.getElementById('sseListenerResults');
      results.textContent = 'æ­£åœ¨æ£€æŸ¥SSEç›‘å¬å™¨...\n';

      try {
        // æ£€æŸ¥å…¨å±€SSEå¯¹è±¡
        const sseObjects = [];

        if (window.minimalSSE) sseObjects.push('minimalSSE');
        if (window.eventSource) sseObjects.push('eventSource');
        if (window.sseConnection) sseObjects.push('sseConnection');

        results.textContent += `å‘ç°SSEå¯¹è±¡: ${sseObjects.join(', ') || 'æ— '}\n\n`;

        // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
        if (window.minimalSSE) {
          const listeners = window.minimalSSE._events || {};
          results.textContent += `minimalSSEç›‘å¬å™¨:\n`;
          Object.keys(listeners).forEach(event => {
            results.textContent += `  - ${event}: ${listeners[event].length || 0} ä¸ªç›‘å¬å™¨\n`;
          });
        }

        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        if (window.eventSource) {
          results.textContent += `\nEventSourceçŠ¶æ€: ${window.eventSource.readyState}\n`;
          results.textContent += `URL: ${window.eventSource.url}\n`;
        }

      } catch (error) {
        results.textContent += `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
        addLog('error', `SSEç›‘å¬å™¨æ£€æŸ¥å¤±è´¥: ${error.message}`);
      }
    }

    async function checkCSSStyles() {
      const results = document.getElementById('cssStyleResults');
      results.textContent = 'æ­£åœ¨æ£€æŸ¥CSSæ ·å¼åº”ç”¨...\n';

      try {
        // æ£€æŸ¥å…³é”®CSSç±»
        const testClasses = [
          '.message-files',
          '.file-attachment',
          '.attachment-image',
          '.image-attachment',
          '.generic-file-attachment'
        ];

        testClasses.forEach(className => {
          const elements = document.querySelectorAll(className);
          const computed = elements.length > 0 ?
            window.getComputedStyle(elements[0]) : null;

          results.textContent += `${className}: ${elements.length} ä¸ªå…ƒç´ `;
          if (computed) {
            results.textContent += ` (display: ${computed.display})`;
          }
          results.textContent += '\n';
        });

        // æ£€æŸ¥æ ·å¼å†²çª
        const imageElements = document.querySelectorAll('.attachment-image');
        if (imageElements.length > 0) {
          const style = window.getComputedStyle(imageElements[0]);
          results.textContent += `\nå›¾ç‰‡æ ·å¼æ£€æŸ¥:\n`;
          results.textContent += `  - æ˜¾ç¤º: ${style.display}\n`;
          results.textContent += `  - å¯è§æ€§: ${style.visibility}\n`;
          results.textContent += `  - é€æ˜åº¦: ${style.opacity}\n`;
          results.textContent += `  - æœ€å¤§å®½åº¦: ${style.maxWidth}\n`;
          results.textContent += `  - æœ€å¤§é«˜åº¦: ${style.maxHeight}\n`;
        }

      } catch (error) {
        results.textContent += `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
        addLog('error', `CSSæ ·å¼æ£€æŸ¥å¤±è´¥: ${error.message}`);
      }
    }

    // ä¿®å¤å·¥å…·å‡½æ•°
    async function forceRefreshMessages() {
      const results = document.getElementById('refreshResults');
      results.textContent = 'æ­£åœ¨å¼ºåˆ¶åˆ·æ–°æ¶ˆæ¯...\n';

      try {
        // å°è¯•è°ƒç”¨Vueåº”ç”¨çš„åˆ·æ–°æ–¹æ³•
        if (window.app && window.app.$forceUpdate) {
          window.app.$forceUpdate();
          results.textContent += 'âœ… Vueåº”ç”¨å¼ºåˆ¶æ›´æ–°å®Œæˆ\n';
        }

        // åˆ·æ–°é¡µé¢çš„æ¶ˆæ¯åŒºåŸŸ
        const messageContainers = document.querySelectorAll('.message-list, .messages-container, .chat-messages');
        messageContainers.forEach(container => {
          container.style.display = 'none';
          setTimeout(() => {
            container.style.display = '';
          }, 100);
        });

        results.textContent += 'âœ… æ¶ˆæ¯å®¹å™¨é‡æ–°æ˜¾ç¤ºå®Œæˆ\n';
        addLog('success', 'å¼ºåˆ¶åˆ·æ–°æ¶ˆæ¯å®Œæˆ');

      } catch (error) {
        results.textContent += `âŒ åˆ·æ–°å¤±è´¥: ${error.message}\n`;
        addLog('error', `å¼ºåˆ¶åˆ·æ–°å¤±è´¥: ${error.message}`);
      }
    }

    async function resetSSEConnection() {
      const results = document.getElementById('sseResetResults');
      results.textContent = 'æ­£åœ¨é‡ç½®SSEè¿æ¥...\n';

      try {
        // å…³é—­ç°æœ‰è¿æ¥
        if (window.eventSource) {
          window.eventSource.close();
          results.textContent += 'âœ… å…³é—­ç°æœ‰EventSource\n';
        }

        if (window.minimalSSE && window.minimalSSE.close) {
          window.minimalSSE.close();
          results.textContent += 'âœ… å…³é—­ç°æœ‰minimalSSE\n';
        }

        // ç­‰å¾…ä¸€ä¸‹å†é‡è¿
        setTimeout(() => {
          if (window.setupSSE) {
            window.setupSSE();
            results.textContent += 'âœ… é‡æ–°å»ºç«‹SSEè¿æ¥\n';
          } else {
            results.textContent += 'âš ï¸ æœªæ‰¾åˆ°SSEè®¾ç½®å‡½æ•°\n';
          }
        }, 1000);

        addLog('success', 'SSEè¿æ¥é‡ç½®å®Œæˆ');

      } catch (error) {
        results.textContent += `âŒ é‡ç½®å¤±è´¥: ${error.message}\n`;
        addLog('error', `SSEé‡ç½®å¤±è´¥: ${error.message}`);
      }
    }

    async function fixDeliveryStatus() {
      const results = document.getElementById('deliveryFixResults');
      results.textContent = 'æ­£åœ¨ä¿®å¤é€è¾¾çŠ¶æ€...\n';

      try {
        // æŸ¥æ‰¾æ‰€æœ‰ 'sent' çŠ¶æ€çš„æ¶ˆæ¯å¹¶æ ‡è®°ä¸º 'delivered'
        const sentMessages = document.querySelectorAll('[data-status="sent"], .message-item:has(.status-sent)');

        results.textContent += `æ‰¾åˆ° ${sentMessages.length} æ¡å¾…ç¡®è®¤æ¶ˆæ¯\n`;

        // æ¨¡æ‹ŸSSEé€è¾¾ç¡®è®¤
        sentMessages.forEach((element, index) => {
          const messageId = element.getAttribute('data-message-id');
          if (messageId) {
            // æ›´æ–°çŠ¶æ€
            element.setAttribute('data-status', 'delivered');

            // æ›´æ–°UIå…ƒç´ 
            const statusIcon = element.querySelector('.message-status-icon, .status-icon');
            if (statusIcon) {
              statusIcon.className = statusIcon.className.replace(/status-\w+/, 'status-delivered');
              statusIcon.innerHTML = 'âœ…';
              statusIcon.title = 'Delivered';
            }

            results.textContent += `âœ… æ¶ˆæ¯ ${messageId} çŠ¶æ€å·²æ›´æ–°\n`;
          }
        });

        addLog('success', `ä¿®å¤äº† ${sentMessages.length} æ¡æ¶ˆæ¯çš„é€è¾¾çŠ¶æ€`);

      } catch (error) {
        results.textContent += `âŒ ä¿®å¤å¤±è´¥: ${error.message}\n`;
        addLog('error', `é€è¾¾çŠ¶æ€ä¿®å¤å¤±è´¥: ${error.message}`);
      }
    }

    async function forceShowFiles() {
      const results = document.getElementById('fileShowResults');
      results.textContent = 'æ­£åœ¨å¼ºåˆ¶æ˜¾ç¤ºæ–‡ä»¶...\n';

      try {
        // æŸ¥æ‰¾éšè—çš„æ–‡ä»¶å®¹å™¨
        const hiddenFiles = document.querySelectorAll('.message-files[style*="display: none"], .file-attachment[style*="display: none"]');

        hiddenFiles.forEach(element => {
          element.style.display = '';
          element.style.visibility = 'visible';
          element.style.opacity = '1';
        });

        results.textContent += `âœ… æ˜¾ç¤ºäº† ${hiddenFiles.length} ä¸ªéšè—æ–‡ä»¶\n`;

        // å¼ºåˆ¶é‡æ–°åŠ è½½å¤±è´¥çš„å›¾ç‰‡
        const failedImages = document.querySelectorAll('.attachment-image[src=""], img[alt*="Failed"]');

        failedImages.forEach((img, index) => {
          const originalSrc = img.getAttribute('data-original-src') || img.src;
          if (originalSrc) {
            img.src = originalSrc + '?t=' + Date.now();
            results.textContent += `ğŸ”„ é‡æ–°åŠ è½½å›¾ç‰‡ ${index + 1}\n`;
          }
        });

        addLog('success', `å¼ºåˆ¶æ˜¾ç¤ºæ–‡ä»¶å®Œæˆ: ${hiddenFiles.length} ä¸ªæ–‡ä»¶å®¹å™¨ï¼Œ${failedImages.length} ä¸ªå›¾ç‰‡`);

      } catch (error) {
        results.textContent += `âŒ æ˜¾ç¤ºå¤±è´¥: ${error.message}\n`;
        addLog('error', `å¼ºåˆ¶æ˜¾ç¤ºæ–‡ä»¶å¤±è´¥: ${error.message}`);
      }
    }

    // æ—¥å¿—ç®¡ç†
    function clearLogs() {
      logs = [];
      document.getElementById('systemLogs').innerHTML = '';
      addLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
    }

    function exportLogs() {
      const logText = logs.map(log => `[${log.timestamp}] ${log.level.toUpperCase()}: ${log.message}`).join('\n');
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fechatter-diagnosis-${new Date().toISOString().slice(0, 19)}.log`;
      a.click();
      URL.revokeObjectURL(url);
      addLog('success', 'æ—¥å¿—å·²å¯¼å‡º');
    }

    // è‡ªåŠ¨åˆ·æ–°
    setInterval(async () => {
      if (isMonitoring) {
        await checkImageDisplayQuick();
        await checkSSEDeliveryQuick();
      }
    }, 5000);

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initializeDiagnosis();
      addLog('success', 'è¯Šæ–­å·¥å…·å·²å¯åŠ¨');
    });

    // ç›‘å¬å¼€å‘è€…å·¥å…·ä¸­çš„é”™è¯¯
    window.addEventListener('error', (event) => {
      addLog('error', `JavaScripté”™è¯¯: ${event.message} (${event.filename}:${event.lineno})`);
    });

    // ç›‘å¬fetché”™è¯¯
    const originalFetch = window.fetch;
    window.fetch = function (...args) {
      return originalFetch.apply(this, args)
        .then(response => {
          if (!response.ok) {
            addLog('warning', `APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.url}`);
          }
          return response;
        })
        .catch(error => {
          addLog('error', `ç½‘ç»œè¯·æ±‚é”™è¯¯: ${error.message}`);
          throw error;
        });
    };
  </script>
</body>

</html>