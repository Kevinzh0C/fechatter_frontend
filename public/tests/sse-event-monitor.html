<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSE Event Monitor - Fechatter</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      margin: 20px;
      line-height: 1.6;
    }

    .header {
      background: #0d7377;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      margin: 5px;
      font-weight: bold;
    }

    .connected {
      background: #4caf50;
      color: white;
    }

    .disconnected {
      background: #f44336;
      color: white;
    }

    .connecting {
      background: #ff9800;
      color: white;
    }

    .event-log {
      background: #0c0c0c;
      border: 1px solid #404040;
      border-radius: 8px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      font-size: 12px;
      margin-bottom: 20px;
    }

    .event {
      margin-bottom: 10px;
      padding: 8px;
      border-left: 3px solid #007acc;
      background: rgba(0, 122, 204, 0.1);
    }

    .event-time {
      color: #4caf50;
      font-weight: bold;
    }

    .event-type {
      color: #ff9800;
      font-weight: bold;
    }

    .event-data {
      color: #d4d4d4;
      white-space: pre-wrap;
    }

    .ping-event {
      border-left-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
    }

    .message-event {
      border-left-color: #ff5722;
      background: rgba(255, 87, 34, 0.1);
    }

    .controls {
      background: #2d2d30;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background: #005a9a;
    }

    .stats {
      background: #2d2d30;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .stat-item {
      display: inline-block;
      margin-right: 20px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>ğŸ” SSE Event Monitor</h1>
    <p>å®æ—¶ç›‘æ§æ‰€æœ‰SSEäº‹ä»¶ - ä¸“ç”¨äºæ’æŸ¥æ¶ˆæ¯ç¡®è®¤é—®é¢˜</p>
  </div>

  <div class="controls">
    <button onclick="startMonitoring()">ğŸš€ å¼€å§‹ç›‘æ§</button>
    <button onclick="stopMonitoring()">â¹ï¸ åœæ­¢ç›‘æ§</button>
    <button onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
    <button onclick="sendTestMessage()">ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯</button>
    <span id="status" class="status disconnected">æœªè¿æ¥</span>
  </div>

  <div class="stats">
    <div class="stat-item"><strong>æ€»äº‹ä»¶æ•°:</strong> <span id="totalEvents">0</span></div>
    <div class="stat-item"><strong>Pingäº‹ä»¶:</strong> <span id="pingEvents">0</span></div>
    <div class="stat-item"><strong>æ¶ˆæ¯äº‹ä»¶:</strong> <span id="messageEvents">0</span></div>
    <div class="stat-item"><strong>å…¶ä»–äº‹ä»¶:</strong> <span id="otherEvents">0</span></div>
    <div class="stat-item"><strong>è¿æ¥æ—¶é—´:</strong> <span id="connectionTime">-</span></div>
  </div>

  <div class="event-log" id="eventLog">
    <div style="color: #888;">ç­‰å¾…è¿æ¥å’Œäº‹ä»¶...</div>
  </div>

  <script>
    let eventSource = null;
    let eventCount = 0;
    let pingCount = 0;
    let messageCount = 0;
    let otherCount = 0;
    let connectionStartTime = null;

    function updateStats() {
      document.getElementById('totalEvents').textContent = eventCount;
      document.getElementById('pingEvents').textContent = pingCount;
      document.getElementById('messageEvents').textContent = messageCount;
      document.getElementById('otherEvents').textContent = otherCount;

      if (connectionStartTime) {
        const duration = Math.floor((Date.now() - connectionStartTime) / 1000);
        document.getElementById('connectionTime').textContent = duration + 's';
      }
    }

    function logEvent(type, data, eventType = null) {
      const timestamp = new Date().toLocaleTimeString();
      const eventLog = document.getElementById('eventLog');

      let eventClass = 'event';
      if (type === 'ping' || (eventType && eventType.includes('ping'))) {
        eventClass += ' ping-event';
        pingCount++;
      } else if (type === 'message' || (eventType && eventType.includes('message'))) {
        eventClass += ' message-event';
        messageCount++;
      } else {
        otherCount++;
      }

      eventCount++;

      const eventDiv = document.createElement('div');
      eventDiv.className = eventClass;
      eventDiv.innerHTML = `
                <div class="event-time">[${timestamp}] äº‹ä»¶ #${eventCount}</div>
                <div class="event-type">ç±»å‹: ${eventType || type || 'unknown'}</div>
                <div class="event-data">æ•°æ®: ${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</div>
            `;

      eventLog.appendChild(eventDiv);
      eventLog.scrollTop = eventLog.scrollHeight;

      updateStats();
    }

    function startMonitoring() {
      if (eventSource) {
        eventSource.close();
      }

      // è·å–token
      const token = localStorage.getItem('auth_token') ||
        localStorage.getItem('fechatter_auth') ||
        sessionStorage.getItem('auth_token');

      if (!token) {
        alert('æœªæ‰¾åˆ°è®¤è¯tokenï¼è¯·å…ˆç™»å½•ã€‚');
        return;
      }

      const url = `/events?access_token=${token}`;
      console.log('ğŸ”— è¿æ¥SSE:', url);

      connectionStartTime = Date.now();
      eventSource = new EventSource(url);

      document.getElementById('status').className = 'status connecting';
      document.getElementById('status').textContent = 'è¿æ¥ä¸­...';

      // ç›‘å¬è¿æ¥æ‰“å¼€
      eventSource.onopen = function (event) {
        console.log('âœ… SSEè¿æ¥å·²æ‰“å¼€:', event);
        document.getElementById('status').className = 'status connected';
        document.getElementById('status').textContent = 'å·²è¿æ¥';
        logEvent('connection', 'SSEè¿æ¥æˆåŠŸæ‰“å¼€', 'connection_open');
      };

      // ç›‘å¬é»˜è®¤æ¶ˆæ¯äº‹ä»¶
      eventSource.onmessage = function (event) {
        console.log('ğŸ“¨ æ”¶åˆ°é»˜è®¤æ¶ˆæ¯:', event);
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          data = event.data;
        }
        logEvent('message', data, 'default_message');
      };

      // ç›‘å¬ç‰¹å®šäº‹ä»¶ç±»å‹
      const eventTypes = ['NewMessage', 'MessageDelivered', 'ping', 'message', 'new_message', 'message_delivered'];
      eventTypes.forEach(eventType => {
        eventSource.addEventListener(eventType, function (event) {
          console.log(`ğŸ“¡ æ”¶åˆ°${eventType}äº‹ä»¶:`, event);
          let data;
          try {
            data = JSON.parse(event.data);
          } catch (e) {
            data = event.data;
          }
          logEvent(eventType.toLowerCase(), data, eventType);
        });
      });

      // ç›‘å¬é”™è¯¯
      eventSource.onerror = function (event) {
        console.error('âŒ SSEé”™è¯¯:', event);
        document.getElementById('status').className = 'status disconnected';
        document.getElementById('status').textContent = 'è¿æ¥é”™è¯¯';
        logEvent('error', `ReadyState: ${eventSource.readyState}`, 'connection_error');
      };
    }

    function stopMonitoring() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
        document.getElementById('status').className = 'status disconnected';
        document.getElementById('status').textContent = 'å·²æ–­å¼€';
        logEvent('connection', 'SSEè¿æ¥å·²å…³é—­', 'connection_close');
      }
    }

    function clearLog() {
      document.getElementById('eventLog').innerHTML = '<div style="color: #888;">æ—¥å¿—å·²æ¸…ç©º...</div>';
      eventCount = 0;
      pingCount = 0;
      messageCount = 0;
      otherCount = 0;
      updateStats();
    }

    async function sendTestMessage() {
      try {
        const token = localStorage.getItem('auth_token') ||
          localStorage.getItem('fechatter_auth') ||
          sessionStorage.getItem('auth_token');

        if (!token) {
          alert('æœªæ‰¾åˆ°è®¤è¯tokenï¼');
          return;
        }

        const response = await fetch('/api/chat/2/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            content: `ğŸ§ª SSE Monitor Test - ${new Date().toLocaleTimeString()}`,
            idempotency_key: `test-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
          })
        });

        if (response.ok) {
          const result = await response.json();
          logEvent('test', `æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ - ID: ${result.data?.id || result.id}`, 'test_message_sent');
        } else {
          logEvent('test', `æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥ - ${response.status}: ${response.statusText}`, 'test_message_failed');
        }
      } catch (error) {
        logEvent('test', `æµ‹è¯•æ¶ˆæ¯é”™è¯¯: ${error.message}`, 'test_message_error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹ç›‘æ§
    window.addEventListener('load', function () {
      setTimeout(startMonitoring, 1000);
    });

    // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
    window.addEventListener('beforeunload', function () {
      if (eventSource) {
        eventSource.close();
      }
    });

    // å®šæ—¶æ›´æ–°è¿æ¥æ—¶é—´
    setInterval(updateStats, 1000);
  </script>
</body>

</html>