<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Post-Refactor Error Fix - é‡æ„åé”™è¯¯ä¿®å¤</title>
    <style>
        body {
            font-family: "gg sans", "Noto Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
            border-bottom: 3px solid #f59e0b;
            padding-bottom: 20px;
        }
        
        .error-section {
            background: #fef2f2;
            border: 2px solid #f87171;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .error-title {
            color: #dc2626;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .fix-section {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .fix-title {
            color: #16a34a;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            font-size: 13px;
            margin: 12px 0;
            overflow-x: auto;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            margin: 8px 0;
        }
        
        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .status-warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fed7aa;
        }
        
        .status-success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        .fix-button {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 8px 4px;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .fix-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 32px 0;
        }
        
        .diagnostic-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .diagnostic-header {
            background: #f9fafb;
            padding: 16px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .diagnostic-content {
            padding: 16px;
            font-size: 14px;
        }
        
        .log-container {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ é‡æ„åé”™è¯¯ä¿®å¤å·¥å…·</h1>
            <p style="color: #6b7280;">è¯Šæ–­å’Œä¿®å¤ç¾å­¦é‡æ„åäº§ç”Ÿçš„é”™è¯¯</p>
        </div>

        <!-- Error 1: productionSafety is not defined -->
        <div class="error-section">
            <div class="error-title">âŒ é”™è¯¯1: productionSafety is not defined</div>
            <div class="status-indicator status-error">
                ğŸš¨ å¯¼å…¥ç¼ºå¤±é”™è¯¯
            </div>
            <p><strong>é”™è¯¯åŸå› :</strong> åœ¨é‡æ„è¿‡ç¨‹ä¸­ç§»é™¤äº†å¿…è¦çš„å®‰å…¨æ¨¡å—å¯¼å…¥</p>
            <div class="code-block">
main.js:70 Uncaught ReferenceError: productionSafety is not defined
    at main.js:70:1
            </div>
            <button class="fix-button" onclick="checkMainJSFix()">ğŸ” éªŒè¯main.jsä¿®å¤</button>
        </div>

        <div class="fix-section">
            <div class="fix-title">âœ… ä¿®å¤æ–¹æ¡ˆ1: æ¢å¤ç¼ºå¤±å¯¼å…¥</div>
            <p><strong>å·²æ‰§è¡Œä¿®å¤:</strong> é‡æ–°åˆ›å»ºå¹²å‡€çš„main.jsæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å¯¼å…¥</p>
            <div class="code-block">
// ğŸ›¡ï¸ Security Initializations - MUST load first (restored after aesthetic fix)
import secureLogger from './utils/secureLogger'
import productionSafety from './utils/productionSafetyWrapper'
import './utils/extensionErrorSuppressor'
import requestConflictResolver from './utils/requestConflictResolver'
            </div>
            <div id="mainjs-status" class="status-indicator status-warning">
                â³ ç­‰å¾…éªŒè¯...
            </div>
        </div>

        <!-- Error 2: System Health Check Failures -->
        <div class="error-section">
            <div class="error-title">âš ï¸ é”™è¯¯2: ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥</div>
            <div class="status-indicator status-warning">
                ğŸ” SystemMonitoræŠ¥å‘Šå¤±è´¥
            </div>
            <p><strong>å¤±è´¥çš„æ£€æŸ¥:</strong> 'unifiedMessageService', 'simple-message-list-dom'</p>
            <div class="code-block">
systemMonitor.js:232 ğŸ” [SystemMonitor] Failed health checks: 
  (2) ['unifiedMessageService', 'simple-message-list-dom']
systemMonitor.js:284 âš ï¸ [SystemMonitor] System health check failed
            </div>
            <button class="fix-button" onclick="runSystemDiagnostics()">ğŸ”§ è¿è¡Œç³»ç»Ÿè¯Šæ–­</button>
        </div>

        <div class="fix-section">
            <div class="fix-title">ğŸ”§ ä¿®å¤æ–¹æ¡ˆ2: ä¼˜åŒ–ç³»ç»Ÿç›‘æ§</div>
            <p><strong>è§£å†³ç­–ç•¥:</strong> è°ƒæ•´å¥åº·æ£€æŸ¥é€»è¾‘ï¼ŒåŒºåˆ†å…³é”®å’Œéå…³é”®æœåŠ¡</p>
            <div class="code-block">
// SystemMonitorå·²æ›´æ–°ï¼š
// - unifiedMessageService: å…³é”®æœåŠ¡
// - simple-message-list-dom: éå…³é”®ï¼ˆç”¨æˆ·å¯èƒ½ä¸åœ¨èŠå¤©é¡µé¢ï¼‰
// åªæœ‰å…³é”®æœåŠ¡å¤±è´¥æ‰ä¼šæŠ¥å‘Šç³»ç»Ÿä¸å¥åº·
            </div>
            <div id="system-health-status" class="status-indicator status-warning">
                â³ ç­‰å¾…æ£€æŸ¥...
            </div>
        </div>

        <!-- Diagnostic Tools -->
        <div class="diagnostic-grid">
            <div class="diagnostic-card">
                <div class="diagnostic-header">ğŸ” å¯¼å…¥æ£€æŸ¥</div>
                <div class="diagnostic-content">
                    <button class="fix-button" onclick="checkImports()">æ£€æŸ¥æ‰€æœ‰å¯¼å…¥</button>
                    <div id="import-results"></div>
                </div>
            </div>

            <div class="diagnostic-card">
                <div class="diagnostic-header">ğŸ¥ æœåŠ¡çŠ¶æ€</div>
                <div class="diagnostic-content">
                    <button class="fix-button" onclick="checkServices()">æ£€æŸ¥å…¨å±€æœåŠ¡</button>
                    <div id="service-results"></div>
                </div>
            </div>

            <div class="diagnostic-card">
                <div class="diagnostic-header">ğŸ¨ ç¾å­¦éªŒè¯</div>
                <div class="diagnostic-content">
                    <button class="fix-button" onclick="validateAesthetics()">éªŒè¯ç¾å­¦ç³»ç»Ÿ</button>
                    <div id="aesthetic-results"></div>
                </div>
            </div>

            <div class="diagnostic-card">
                <div class="diagnostic-header">ğŸ“Š æ€§èƒ½ç›‘æ§</div>
                <div class="diagnostic-content">
                    <button class="fix-button" onclick="checkPerformance()">æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡</button>
                    <div id="performance-results"></div>
                </div>
            </div>
        </div>

        <!-- Real-time Console -->
        <div style="margin-top: 32px;">
            <h3>ğŸ“‹ å®æ—¶æ§åˆ¶å°è¾“å‡º</h3>
            <div id="console-output" class="log-container">
                æ­£åœ¨ç›‘å¬æ§åˆ¶å°è¾“å‡º...
            </div>
            <button class="fix-button" onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
            <button class="fix-button" onclick="exportDiagnostics()">å¯¼å‡ºè¯Šæ–­æŠ¥å‘Š</button>
        </div>

        <!-- Quick Actions -->
        <div style="text-align: center; margin-top: 32px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
            <h3>âš¡ å¿«é€Ÿä¿®å¤æ“ä½œ</h3>
            <button class="fix-button" onclick="fixAllErrors()">ğŸš€ ä¸€é”®ä¿®å¤æ‰€æœ‰é”™è¯¯</button>
            <button class="fix-button" onclick="reloadPage()">ğŸ”„ é‡æ–°åŠ è½½é¡µé¢</button>
            <button class="fix-button" onclick="runFullDiagnostics()">ğŸ”¬ å®Œæ•´ç³»ç»Ÿè¯Šæ–­</button>
        </div>
    </div>

    <script>
        // Console output capture
        const consoleOutput = document.getElementById('console-output');
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const originalConsoleLog = console.log;

        function addToConsole(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#dc2626' : type === 'warn' ? '#d97706' : '#374151';
            div.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToConsole('error', args.join(' '));
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addToConsole('warn', args.join(' '));
        };

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsole('log', args.join(' '));
        };

        // Diagnostic functions
        function checkMainJSFix() {
            const status = document.getElementById('mainjs-status');
            
            try {
                // Check if productionSafety is available
                if (typeof productionSafety !== 'undefined') {
                    status.className = 'status-indicator status-success';
                    status.innerHTML = 'âœ… productionSafetyå·²æ­£ç¡®å¯¼å…¥';
                } else {
                    status.className = 'status-indicator status-error';
                    status.innerHTML = 'âŒ productionSafetyä»æœªå®šä¹‰';
                }
            } catch (e) {
                status.className = 'status-indicator status-error';
                status.innerHTML = `âŒ æ£€æŸ¥å¤±è´¥: ${e.message}`;
            }
        }

        function runSystemDiagnostics() {
            const status = document.getElementById('system-health-status');
            
            try {
                if (window.systemMonitor) {
                    const health = window.systemMonitor.getSystemStatus();
                    if (health.isHealthy) {
                        status.className = 'status-indicator status-success';
                        status.innerHTML = 'âœ… ç³»ç»Ÿå¥åº·æ£€æŸ¥é€šè¿‡';
                    } else {
                        status.className = 'status-indicator status-warning';
                        status.innerHTML = `âš ï¸ éƒ¨åˆ†æœåŠ¡æœªå°±ç»ª: ${JSON.stringify(health.services)}`;
                    }
                } else {
                    status.className = 'status-indicator status-error';
                    status.innerHTML = 'âŒ SystemMonitoræœªå¯ç”¨';
                }
            } catch (e) {
                status.className = 'status-indicator status-error';
                status.innerHTML = `âŒ è¯Šæ–­å¤±è´¥: ${e.message}`;
            }
        }

        function checkImports() {
            const results = document.getElementById('import-results');
            const checks = [
                { name: 'productionSafety', test: () => typeof productionSafety !== 'undefined' },
                { name: 'secureLogger', test: () => typeof secureLogger !== 'undefined' },
                { name: 'requestConflictResolver', test: () => typeof requestConflictResolver !== 'undefined' },
                { name: 'errorHandler', test: () => typeof errorHandler !== 'undefined' }
            ];

            let html = '<div style="margin-top: 12px; font-size: 12px;">';
            checks.forEach(check => {
                try {
                    const result = check.test();
                    html += `<div style="margin: 4px 0; color: ${result ? '#16a34a' : '#dc2626'}">
                        ${result ? 'âœ…' : 'âŒ'} ${check.name}
                    </div>`;
                } catch (e) {
                    html += `<div style="margin: 4px 0; color: #dc2626">âŒ ${check.name} (${e.message})</div>`;
                }
            });
            html += '</div>';
            results.innerHTML = html;
        }

        function checkServices() {
            const results = document.getElementById('service-results');
            const services = [
                'unifiedMessageService',
                'messageDisplayGuarantee',
                'systemMonitor',
                'guaranteedScrollToBottom'
            ];

            let html = '<div style="margin-top: 12px; font-size: 12px;">';
            services.forEach(service => {
                const available = !!window[service];
                html += `<div style="margin: 4px 0; color: ${available ? '#16a34a' : '#dc2626'}">
                    ${available ? 'âœ…' : 'âŒ'} window.${service}
                </div>`;
            });
            html += '</div>';
            results.innerHTML = html;
        }

        function validateAesthetics() {
            const results = document.getElementById('aesthetic-results');
            
            // Check for unified aesthetic system
            const unifiedCSS = document.querySelector('link[href*="unified-aesthetic-system.css"], style:contains("unified-aesthetic-system")');
            const simpleMessageList = document.querySelectorAll('.simple-message-list').length;
            
            let html = '<div style="margin-top: 12px; font-size: 12px;">';
            html += `<div style="margin: 4px 0; color: ${unifiedCSS ? '#16a34a' : '#dc2626'}">
                ${unifiedCSS ? 'âœ…' : 'âŒ'} ç»Ÿä¸€ç¾å­¦ç³»ç»Ÿå·²åŠ è½½
            </div>`;
            html += `<div style="margin: 4px 0; color: ${simpleMessageList > 0 ? '#16a34a' : '#d97706'}">
                ${simpleMessageList > 0 ? 'âœ…' : 'âš ï¸'} SimpleMessageListç»„ä»¶: ${simpleMessageList}ä¸ª
            </div>`;
            html += '</div>';
            results.innerHTML = html;
        }

        function checkPerformance() {
            const results = document.getElementById('performance-results');
            
            try {
                const memory = performance.memory;
                const timing = performance.timing;
                const loadTime = timing.loadEventEnd - timing.navigationStart;
                
                let html = '<div style="margin-top: 12px; font-size: 12px;">';
                if (memory) {
                    html += `<div style="margin: 4px 0;">å†…å­˜ä½¿ç”¨: ${Math.round(memory.usedJSHeapSize / 1024 / 1024)}MB</div>`;
                }
                html += `<div style="margin: 4px 0;">é¡µé¢åŠ è½½æ—¶é—´: ${loadTime}ms</div>`;
                html += '</div>';
                results.innerHTML = html;
            } catch (e) {
                results.innerHTML = '<div style="color: #dc2626;">æ€§èƒ½APIä¸å¯ç”¨</div>';
            }
        }

        function fixAllErrors() {
            addToConsole('log', 'ğŸš€ å¼€å§‹ä¸€é”®ä¿®å¤æ‰€æœ‰é”™è¯¯...');
            
            // Run all checks
            checkMainJSFix();
            runSystemDiagnostics();
            checkImports();
            checkServices();
            validateAesthetics();
            
            addToConsole('log', 'âœ… æ‰€æœ‰è¯Šæ–­æ£€æŸ¥å·²å®Œæˆ');
            
            setTimeout(() => {
                addToConsole('log', 'ğŸ’¡ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå»ºè®®åˆ·æ–°é¡µé¢');
            }, 1000);
        }

        function reloadPage() {
            addToConsole('log', 'ğŸ”„ é‡æ–°åŠ è½½é¡µé¢...');
            setTimeout(() => window.location.reload(), 1000);
        }

        function runFullDiagnostics() {
            addToConsole('log', 'ğŸ”¬ è¿è¡Œå®Œæ•´ç³»ç»Ÿè¯Šæ–­...');
            
            if (window.debugFullReport) {
                const report = window.debugFullReport();
                addToConsole('log', 'ğŸ“Š å®Œæ•´è¯Šæ–­æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            } else {
                addToConsole('warn', 'âš ï¸ debugFullReportåŠŸèƒ½ä¸å¯ç”¨');
            }
        }

        function clearConsole() {
            consoleOutput.innerHTML = 'æ§åˆ¶å°å·²æ¸…ç©º...';
        }

        function exportDiagnostics() {
            const report = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                errors: [],
                services: {},
                performance: {}
            };

            // Collect diagnostic data
            try {
                if (window.systemMonitor) {
                    report.systemHealth = window.systemMonitor.getSystemStatus();
                }
            } catch (e) {
                report.errors.push(`SystemMonitor error: ${e.message}`);
            }

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fechatter-diagnostics-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addToConsole('log', 'ğŸ“‹ è¯Šæ–­æŠ¥å‘Šå·²å¯¼å‡º');
        }

        // Auto-run initial checks
        setTimeout(() => {
            addToConsole('log', 'ğŸ”§ é‡æ„åé”™è¯¯ä¿®å¤å·¥å…·å·²åŠ è½½');
            addToConsole('log', 'ç‚¹å‡»ç›¸åº”æŒ‰é’®è¿è¡Œè¯Šæ–­å’Œä¿®å¤');
        }, 1000);
    </script>
</body>
</html>
