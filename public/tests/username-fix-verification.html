<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âœ… ç”¨æˆ·åä¿®å¤éªŒè¯å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

    .container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      color: white;
    }

    .check-item {
      background: #f8f9fa;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      display: flex;
      align-items: center;
    }

    .check-item.failed {
      border-left-color: #dc3545;
      background: #fff5f5;
    }

    .status-icon {
      font-size: 1.5em;
      margin-right: 15px;
    }

    .api-test {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .code-block {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
      margin: 10px 0;
    }

    button {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }

    button:hover {
      background: #218838;
    }

    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
    }

    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>âœ… ç”¨æˆ·åä¿®å¤éªŒè¯å·¥å…·</h1>
      <p>æ£€æŸ¥åç«¯æ˜¯å¦æ­£ç¡®è¿”å›ç”¨æˆ·ä¿¡æ¯</p>
    </div>

    <div class="check-item">
      <span class="status-icon">ğŸ”</span>
      <div>
        <strong>æ£€æŸ¥é¡¹ç›®1:</strong> å‰ç«¯æ˜¯å¦æ˜¾ç¤ºçœŸå®ç”¨æˆ·åï¼ˆè€Œä¸æ˜¯"User X"ï¼‰
      </div>
    </div>

    <div class="check-item">
      <span class="status-icon">ğŸ“¡</span>
      <div>
        <strong>æ£€æŸ¥é¡¹ç›®2:</strong> APIå“åº”æ˜¯å¦åŒ…å«sender.fullnameå­—æ®µ
      </div>
    </div>

    <div class="check-item">
      <span class="status-icon">ğŸ”—</span>
      <div>
        <strong>æ£€æŸ¥é¡¹ç›®3:</strong> åç«¯æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸(45.77.178.85)
      </div>
    </div>

    <div class="api-test">
      <h3>ğŸ§ª APIæµ‹è¯•å·¥å…·</h3>
      <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯•æ¶ˆæ¯APIå“åº”</p>

      <button onclick="testMessageAPI()">æµ‹è¯•æ¶ˆæ¯API</button>
      <button onclick="checkCurrentMessages()">æ£€æŸ¥å½“å‰é¡µé¢æ¶ˆæ¯</button>

      <div id="testResult" class="result" style="display: none;"></div>
    </div>

    <div class="api-test">
      <h3>ğŸ“‹ æ‰‹åŠ¨æ£€æŸ¥æ­¥éª¤</h3>
      <ol>
        <li><strong>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·</strong> (F12)</li>
        <li><strong>è½¬åˆ°Networkæ ‡ç­¾</strong></li>
        <li><strong>åˆ·æ–°èŠå¤©é¡µé¢</strong>ï¼ŒæŸ¥çœ‹æ¶ˆæ¯åŠ è½½è¯·æ±‚</li>
        <li><strong>æŸ¥æ‰¾APIå“åº”</strong>ï¼Œç¡®è®¤æ˜¯å¦åŒ…å«ä»¥ä¸‹ç»“æ„ï¼š</li>
      </ol>

      <div class="code-block">
        {
        "data": [
        {
        "id": 123,
        "content": "æµ‹è¯•æ¶ˆæ¯",
        "sender_id": 18,
        "sender": {
        "id": 18,
        "fullname": "å¼ ä¸‰", // â† åº”è¯¥æœ‰çœŸå®å§“å
        "username": "zhangsan",
        "email": "zhangsan@example.com"
        }
        }
        ]
        }
      </div>
    </div>

    <div class="api-test">
      <h3>âŒ ä¿®å¤å‰çš„å“åº” (é”™è¯¯ç¤ºä¾‹)</h3>
      <div class="code-block">
        {
        "sender": null, // â† è¿™æ˜¯é—®é¢˜ï¼
        "sender_id": 18
        }
      </div>
    </div>

    <div class="api-test">
      <h3>âœ… ä¿®å¤åçš„å“åº” (æ­£ç¡®ç¤ºä¾‹)</h3>
      <div class="code-block">
        {
        "sender": {
        "id": 18,
        "fullname": "å¼ ä¸‰", // â† çœŸå®ç”¨æˆ·å
        "username": "zhangsan",
        "email": "zhangsan@example.com"
        },
        "sender_id": 18
        }
      </div>
    </div>
  </div>

  <script>
    async function testMessageAPI() {
      const resultDiv = document.getElementById('testResult');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨æµ‹è¯•API...</p>';

      try {
        // å°è¯•è·å–å½“å‰èŠå¤©çš„æ¶ˆæ¯
        const chatId = getChatIdFromURL();
        if (!chatId) {
          throw new Error('æ— æ³•ä»URLè·å–èŠå¤©ID');
        }

        const response = await fetch(`/api/chat/${chatId}/messages`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        const messages = data.data || data;

        if (!Array.isArray(messages) || messages.length === 0) {
          resultDiv.innerHTML = '<p class="error">âŒ æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯æ•°æ®</p>';
          return;
        }

        // æ£€æŸ¥ç¬¬ä¸€æ¡æ¶ˆæ¯æ˜¯å¦æœ‰senderä¿¡æ¯
        const firstMessage = messages[0];
        let result = '<div class="success">';

        if (firstMessage.sender && firstMessage.sender.fullname) {
          result += `<p>âœ… <strong>ä¿®å¤æˆåŠŸï¼</strong></p>`;
          result += `<p>ğŸ“ æ¶ˆæ¯ID: ${firstMessage.id}</p>`;
          result += `<p>ğŸ‘¤ å‘é€è€…: ${firstMessage.sender.fullname}</p>`;
          result += `<p>ğŸ“§ é‚®ç®±: ${firstMessage.sender.email || 'æœªæä¾›'}</p>`;
        } else {
          result += `<p>âŒ <strong>ä»éœ€ä¿®å¤</strong></p>`;
          result += `<p>é—®é¢˜: senderå­—æ®µä¸ºç©ºæˆ–ç¼ºå°‘fullname</p>`;
          result += `<p>å½“å‰senderå€¼: ${JSON.stringify(firstMessage.sender)}</p>`;
          result = result.replace('class="success"', 'class="error"');
        }

        result += '</div>';
        resultDiv.innerHTML = result;

      } catch (error) {
        resultDiv.innerHTML = `<div class="error">
          <p>âŒ <strong>æµ‹è¯•å¤±è´¥</strong></p>
          <p>é”™è¯¯: ${error.message}</p>
        </div>`;
      }
    }

    function checkCurrentMessages() {
      const resultDiv = document.getElementById('testResult');
      resultDiv.style.display = 'block';

      // æ£€æŸ¥é¡µé¢ä¸Šæ˜¯å¦æœ‰"User X"è¿™æ ·çš„æ˜¾ç¤º
      const messageElements = document.querySelectorAll('[data-message-id]');
      const userPatternMatches = [];

      messageElements.forEach(el => {
        const text = el.textContent;
        const userMatches = text.match(/User \d+/g);
        if (userMatches) {
          userPatternMatches.push(...userMatches);
        }
      });

      if (userPatternMatches.length > 0) {
        resultDiv.innerHTML = `<div class="error">
          <p>âŒ <strong>å‘ç°é—®é¢˜</strong></p>
          <p>é¡µé¢ä»æ˜¾ç¤º: ${userPatternMatches.slice(0, 3).join(', ')}</p>
          <p>å»ºè®®æ£€æŸ¥åç«¯ä¿®å¤æ˜¯å¦ç”Ÿæ•ˆ</p>
        </div>`;
      } else {
        resultDiv.innerHTML = `<div class="success">
          <p>âœ… <strong>çœ‹èµ·æ¥ä¸é”™ï¼</strong></p>
          <p>æ²¡æœ‰å‘ç°"User X"æ¨¡å¼çš„æ˜¾ç¤º</p>
          <p>å»ºè®®è¿è¡ŒAPIæµ‹è¯•ç¡®è®¤åç«¯æ•°æ®</p>
        </div>`;
      }
    }

    function getChatIdFromURL() {
      const path = window.location.pathname;
      const match = path.match(/\/chat\/(\d+)/);
      return match ? match[1] : null;
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', () => {
      setTimeout(checkCurrentMessages, 1000);
    });
  </script>
</body>

</html>