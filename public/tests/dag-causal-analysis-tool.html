<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DAG Causal Analysis Tool</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #333;
    }

    .container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 30px;
      font-style: italic;
    }

    .analysis-section {
      background: #f8fafc;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #3182ce;
    }

    .call-chain {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .call-step {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid #cbd5e0;
      background: white;
      transition: all 0.3s ease;
    }

    .call-step.success {
      border-left-color: #38a169;
      background: #f0fff4;
    }

    .call-step.error {
      border-left-color: #e53e3e;
      background: #fed7d7;
    }

    .call-step.warning {
      border-left-color: #dd6b20;
      background: #fffaf0;
    }

    .call-step.analyzing {
      border-left-color: #3182ce;
      background: #ebf8ff;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .step-icon {
      font-size: 18px;
      margin-right: 12px;
      min-width: 25px;
    }

    .step-content {
      flex: 1;
    }

    .step-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .step-details {
      font-size: 13px;
      opacity: 0.8;
    }

    .step-result {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      margin-top: 5px;
    }

    .result-success {
      background: #c6f6d5;
      color: #22543d;
    }

    .result-error {
      background: #fed7d7;
      color: #742a2a;
    }

    .result-warning {
      background: #fef5e7;
      color: #744210;
    }

    .layer-analysis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .layer {
      background: white;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #e2e8f0;
    }

    .layer h4 {
      margin-top: 0;
      color: #2d3748;
      display: flex;
      align-items: center;
    }

    .layer h4::before {
      font-size: 20px;
      margin-right: 10px;
    }

    .network-layer h4::before {
      content: "ğŸŒ";
    }

    .api-layer h4::before {
      content: "ğŸ”—";
    }

    .business-layer h4::before {
      content: "ğŸ’¼";
    }

    .button {
      background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .button.secondary {
      background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
    }

    .button.danger {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
    }

    .results {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 500px;
      overflow-y: auto;
    }

    .info {
      background: #ebf8ff;
      color: #2a4365;
      border: 1px solid #90cdf4;
    }

    .success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .warning {
      background: #fffaf0;
      color: #744210;
      border: 1px solid #f6ad55;
    }

    .fix-strategy {
      background: #f0fff4;
      border: 2px solid #68d391;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .fix-step {
      display: flex;
      align-items: flex-start;
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #38a169;
    }

    .fix-number {
      background: #38a169;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .fix-content {
      flex: 1;
    }

    .fix-title {
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .fix-description {
      color: #4a5568;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .fix-code {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #2d3748;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .metric {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #3182ce;
    }

    .metric-label {
      font-size: 12px;
      color: #718096;
      margin-top: 5px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #48bb78, #38a169);
      width: 0%;
      transition: width 0.5s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”¬ DAGå› æœæ¨ç†åˆ†æå·¥å…·</h1>
    <p class="subtitle">æ·±åº¦åˆ†ææ–‡ä»¶ä¸Šä¼ å¤±è´¥çš„è°ƒç”¨é“¾å’Œæ ¹å› </p>

    <!-- é”™è¯¯è°ƒç”¨é“¾é‡æ„ -->
    <div class="analysis-section">
      <h3>ğŸ“‹ é”™è¯¯è°ƒç”¨é“¾é‡æ„</h3>
      <div class="call-chain">
        <div class="call-step" id="step-1">
          <div class="step-icon">ğŸ¯</div>
          <div class="step-content">
            <div class="step-title">MessageInput.vue:931 â†’ sendMessage()</div>
            <div class="step-details">ç”¨æˆ·è§¦å‘æ¶ˆæ¯å‘é€ï¼ŒåŒ…å«æ–‡ä»¶ä¸Šä¼ </div>
          </div>
        </div>

        <div class="call-step" id="step-2">
          <div class="step-icon">ğŸ“Š</div>
          <div class="step-content">
            <div class="step-title">fileUploadStore.js:426 â†’ uploadAll()</div>
            <div class="step-details">æ–‡ä»¶ä¸Šä¼ å­˜å‚¨ç®¡ç†å™¨å¤„ç†æ‰€æœ‰æ–‡ä»¶</div>
          </div>
        </div>

        <div class="call-step" id="step-3">
          <div class="step-icon">âš¡</div>
          <div class="step-content">
            <div class="step-title">Promise.allSettled() â†’ å¹¶å‘ä¸Šä¼ </div>
            <div class="step-details">å¹¶è¡Œå¤„ç†å¤šä¸ªæ–‡ä»¶ä¸Šä¼ è¯·æ±‚</div>
          </div>
        </div>

        <div class="call-step" id="step-4">
          <div class="step-icon">ğŸŒ</div>
          <div class="step-content">
            <div class="step-title">ChatService.uploadFile()</div>
            <div class="step-details">æ ¸å¿ƒæ–‡ä»¶ä¸Šä¼ æœåŠ¡å¤„ç†</div>
          </div>
        </div>

        <div class="call-step" id="step-5">
          <div class="step-icon">â¤ï¸</div>
          <div class="step-content">
            <div class="step-title">Network Health Check</div>
            <div class="step-details">fetch('/health') â†’ æ£€æŸ¥ç½‘ç»œè¿é€šæ€§</div>
          </div>
        </div>

        <div class="call-step" id="step-6">
          <div class="step-icon">ğŸ“¤</div>
          <div class="step-content">
            <div class="step-title">POST /files/single</div>
            <div class="step-details">å®é™…æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ (å¤±è´¥ç‚¹)</div>
          </div>
        </div>

        <div class="call-step" id="step-7">
          <div class="step-icon">ğŸ”„</div>
          <div class="step-content">
            <div class="step-title">Retry Mechanism</div>
            <div class="step-details">3æ¬¡é‡è¯•æœºåˆ¶ï¼Œå…¨éƒ¨å¤±è´¥</div>
          </div>
        </div>

        <div class="call-step" id="step-8">
          <div class="step-icon">âŒ</div>
          <div class="step-content">
            <div class="step-title">Final Network Error</div>
            <div class="step-details">æœ€ç»ˆç½‘ç»œé”™è¯¯ï¼Œé˜»å¡æ¶ˆæ¯å‘é€</div>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ†å±‚åˆ†æ -->
    <div class="analysis-section">
      <h3>ğŸ—ï¸ åˆ†å±‚æ ¹å› åˆ†æ</h3>
      <div class="layer-analysis">
        <div class="layer network-layer">
          <h4>ç½‘ç»œå±‚åˆ†æ</h4>
          <button class="button" onclick="analyzeNetworkLayer()">ğŸ” åˆ†æç½‘ç»œå±‚</button>
          <div id="network-results" class="results info" style="display: none;"></div>
        </div>

        <div class="layer api-layer">
          <h4>APIå±‚åˆ†æ</h4>
          <button class="button" onclick="analyzeAPILayer()">ğŸ”— åˆ†æAPIå±‚</button>
          <div id="api-results" class="results info" style="display: none;"></div>
        </div>

        <div class="layer business-layer">
          <h4>ä¸šåŠ¡å±‚åˆ†æ</h4>
          <button class="button" onclick="analyzeBusinessLayer()">ğŸ’¼ åˆ†æä¸šåŠ¡å±‚</button>
          <div id="business-results" class="results info" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- ç»†ç²’åº¦è¯Šæ–­ -->
    <div class="analysis-section">
      <h3>ğŸ”¬ ç»†ç²’åº¦è¯Šæ–­</h3>
      <button class="button" onclick="runDeepDiagnostic()">ğŸš€ è¿è¡Œæ·±åº¦è¯Šæ–­</button>
      <button class="button secondary" onclick="simulateUpload()">ğŸ“ æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ </button>
      <button class="button secondary" onclick="traceRequest()">ğŸ” è¿½è¸ªè¯·æ±‚è·¯å¾„</button>
      <div class="progress-bar" id="diagnostic-progress" style="display: none;">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div id="diagnostic-results" class="results info" style="display: none;"></div>
    </div>

    <!-- ä¿®å¤ç­–ç•¥ -->
    <div class="fix-strategy" id="fix-strategy" style="display: none;">
      <h3>ğŸ› ï¸ æ™ºèƒ½ä¿®å¤ç­–ç•¥</h3>
      <div id="fix-steps"></div>
      <button class="button" onclick="applyFixes()">âœ… åº”ç”¨ä¿®å¤</button>
      <button class="button secondary" onclick="previewFixes()">ğŸ‘ï¸ é¢„è§ˆä¿®å¤</button>
    </div>

    <!-- æŒ‡æ ‡ç›‘æ§ -->
    <div class="metrics-grid">
      <div class="metric">
        <div class="metric-value" id="requests-analyzed">0</div>
        <div class="metric-label">è¯·æ±‚åˆ†æ</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="errors-found">0</div>
        <div class="metric-label">å‘ç°é”™è¯¯</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="fixes-suggested">0</div>
        <div class="metric-label">å»ºè®®ä¿®å¤</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="success-rate">0%</div>
        <div class="metric-label">æˆåŠŸç‡é¢„æµ‹</div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    let analysisState = {
      requestsAnalyzed: 0,
      errorsFound: 0,
      fixesSuggested: 0,
      successRate: 0,
      currentLayer: null,
      diagnosticResults: {},
      suggestedFixes: []
    };

    // å·¥å…·å‡½æ•°
    function logMessage(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      container.style.display = 'block';
      container.className = `results ${type}`;
      container.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
      container.scrollTop = container.scrollHeight;
    }

    function clearResults(containerId) {
      const container = document.getElementById(containerId);
      container.textContent = '';
      container.style.display = 'none';
    }

    function updateStepStatus(stepId, status, result = '') {
      const step = document.getElementById(stepId);
      step.className = `call-step ${status}`;

      if (result) {
        let existingResult = step.querySelector('.step-result');
        if (existingResult) {
          existingResult.remove();
        }

        const resultDiv = document.createElement('div');
        resultDiv.className = `step-result result-${status}`;
        resultDiv.textContent = result;
        step.querySelector('.step-content').appendChild(resultDiv);
      }
    }

    function updateMetrics() {
      document.getElementById('requests-analyzed').textContent = analysisState.requestsAnalyzed;
      document.getElementById('errors-found').textContent = analysisState.errorsFound;
      document.getElementById('fixes-suggested').textContent = analysisState.fixesSuggested;
      document.getElementById('success-rate').textContent = `${analysisState.successRate}%`;
    }

    function updateProgress(percentage) {
      const progressBar = document.getElementById('diagnostic-progress');
      const progressFill = document.getElementById('progress-fill');
      progressBar.style.display = 'block';
      progressFill.style.width = `${percentage}%`;

      if (percentage >= 100) {
        setTimeout(() => {
          progressBar.style.display = 'none';
        }, 2000);
      }
    }

    // ç½‘ç»œå±‚åˆ†æ
    async function analyzeNetworkLayer() {
      clearResults('network-results');
      logMessage('network-results', 'ğŸŒ å¼€å§‹ç½‘ç»œå±‚åˆ†æ...', 'info');
      updateStepStatus('step-5', 'analyzing');
      updateStepStatus('step-6', 'analyzing');

      analysisState.requestsAnalyzed++;

      // 1. æ£€æŸ¥åŸºç¡€è¿é€šæ€§
      logMessage('network-results', '\n1. æ£€æŸ¥åŸºç¡€ç½‘ç»œè¿é€šæ€§...', 'info');
      try {
        const healthResponse = await fetch('/health', { method: 'HEAD' });
        if (healthResponse.ok) {
          logMessage('network-results', '   âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹å¯è¾¾', 'success');
          updateStepStatus('step-5', 'success', 'å¥åº·æ£€æŸ¥é€šè¿‡');
        } else {
          logMessage('network-results', `   âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${healthResponse.status}`, 'error');
          updateStepStatus('step-5', 'error', `å¥åº·æ£€æŸ¥å¤±è´¥: ${healthResponse.status}`);
          analysisState.errorsFound++;
        }
      } catch (error) {
        logMessage('network-results', `   âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
        updateStepStatus('step-5', 'error', 'ç½‘ç»œè¿æ¥å¼‚å¸¸');
        analysisState.errorsFound++;
      }

      // 2. æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹
      logMessage('network-results', '\n2. æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹...', 'info');
      try {
        const uploadResponse = await fetch('/api/files/single', {
          method: 'HEAD',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('auth_token') || 'test-token'}`
          }
        });

        if (uploadResponse.ok || uploadResponse.status === 401 || uploadResponse.status === 422) {
          logMessage('network-results', '   âœ… æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹å¯è¾¾', 'success');
          updateStepStatus('step-6', 'success', 'ç«¯ç‚¹å¯è¾¾');
        } else if (uploadResponse.status === 404) {
          logMessage('network-results', '   âŒ æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹ä¸å­˜åœ¨ (404)', 'error');
          updateStepStatus('step-6', 'error', 'ç«¯ç‚¹ä¸å­˜åœ¨ (404)');
          analysisState.errorsFound++;
        } else {
          logMessage('network-results', `   âš ï¸ ç«¯ç‚¹å“åº”å¼‚å¸¸: ${uploadResponse.status}`, 'warning');
          updateStepStatus('step-6', 'warning', `å¼‚å¸¸å“åº”: ${uploadResponse.status}`);
        }
      } catch (error) {
        logMessage('network-results', `   âŒ ç«¯ç‚¹è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        updateStepStatus('step-6', 'error', 'è¿æ¥å¤±è´¥');
        analysisState.errorsFound++;
      }

      // 3. ä»£ç†é…ç½®æ£€æŸ¥
      logMessage('network-results', '\n3. æ£€æŸ¥Viteä»£ç†é…ç½®...', 'info');
      try {
        // æ£€æŸ¥ä»£ç†æ˜¯å¦æ­£ç¡®è½¬å‘
        const directTest = await fetch('/api/files/single', { method: 'OPTIONS' });
        logMessage('network-results', `   ğŸ“Š ä»£ç†è½¬å‘çŠ¶æ€: ${directTest.status}`, 'info');

        // æ£€æŸ¥CORSå¤´éƒ¨
        const corsHeaders = directTest.headers.get('access-control-allow-origin');
        if (corsHeaders) {
          logMessage('network-results', '   âœ… CORSé…ç½®æ­£å¸¸', 'success');
        } else {
          logMessage('network-results', '   âš ï¸ CORSå¤´éƒ¨ç¼ºå¤±', 'warning');
        }
      } catch (error) {
        logMessage('network-results', `   âŒ ä»£ç†é…ç½®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
      }

      logMessage('network-results', '\nâœ… ç½‘ç»œå±‚åˆ†æå®Œæˆ', 'success');
      updateMetrics();
    }

    // APIå±‚åˆ†æ
    async function analyzeAPILayer() {
      clearResults('api-results');
      logMessage('api-results', 'ğŸ”— å¼€å§‹APIå±‚åˆ†æ...', 'info');

      analysisState.requestsAnalyzed++;

      // 1. æ£€æŸ¥è®¤è¯å¤´éƒ¨
      logMessage('api-results', '\n1. æ£€æŸ¥è®¤è¯é…ç½®...', 'info');
      const authToken = localStorage.getItem('auth_token');
      if (authToken) {
        logMessage('api-results', `   âœ… è®¤è¯ä»¤ç‰Œå­˜åœ¨: ${authToken.substring(0, 20)}...`, 'success');

        // éªŒè¯ä»¤ç‰Œæ ¼å¼
        if (authToken.length > 20) {
          logMessage('api-results', '   âœ… ä»¤ç‰Œæ ¼å¼åˆç†', 'success');
        } else {
          logMessage('api-results', '   âš ï¸ ä»¤ç‰Œé•¿åº¦å¼‚å¸¸', 'warning');
        }
      } else {
        logMessage('api-results', '   âŒ è®¤è¯ä»¤ç‰Œç¼ºå¤±', 'error');
        analysisState.errorsFound++;
      }

      // 2. æ£€æŸ¥APIåŸºç¡€é…ç½®
      logMessage('api-results', '\n2. æ£€æŸ¥APIåŸºç¡€é…ç½®...', 'info');
      try {
        // åŠ¨æ€å¯¼å…¥APIé…ç½®
        logMessage('api-results', '   ğŸ“Š API baseURL: /api', 'info');
        logMessage('api-results', '   ğŸ“Š é¢„æœŸè¯·æ±‚: POST /api/files/single', 'info');
        logMessage('api-results', '   ğŸ“Š ä»£ç†ç›®æ ‡: http://45.77.178.85:8080', 'info');
      } catch (error) {
        logMessage('api-results', `   âŒ APIé…ç½®è¯»å–å¤±è´¥: ${error.message}`, 'error');
      }

      // 3. æ£€æŸ¥FormDataæ ¼å¼
      logMessage('api-results', '\n3. æ¨¡æ‹ŸFormDataæ„å»º...', 'info');
      try {
        const testFile = new File(['test content'], 'test.png', { type: 'image/png' });
        const formData = new FormData();
        formData.append('file', testFile);

        logMessage('api-results', '   âœ… FormDataæ„å»ºæˆåŠŸ', 'success');
        logMessage('api-results', `   ğŸ“Š æ–‡ä»¶å: ${testFile.name}`, 'info');
        logMessage('api-results', `   ğŸ“Š æ–‡ä»¶ç±»å‹: ${testFile.type}`, 'info');
        logMessage('api-results', `   ğŸ“Š æ–‡ä»¶å¤§å°: ${testFile.size} bytes`, 'info');
      } catch (error) {
        logMessage('api-results', `   âŒ FormDataæ„å»ºå¤±è´¥: ${error.message}`, 'error');
        analysisState.errorsFound++;
      }

      // 4. æ£€æŸ¥è¯·æ±‚å¤´é…ç½®
      logMessage('api-results', '\n4. æ£€æŸ¥è¯·æ±‚å¤´é…ç½®...', 'info');
      const expectedHeaders = {
        'Authorization': authToken ? `Bearer ${authToken}` : 'Missing',
        'Content-Type': 'multipart/form-data (auto-set)',
        'Accept': 'application/json'
      };

      Object.entries(expectedHeaders).forEach(([key, value]) => {
        logMessage('api-results', `   ğŸ“Š ${key}: ${value}`, 'info');
      });

      logMessage('api-results', '\nâœ… APIå±‚åˆ†æå®Œæˆ', 'success');
      updateMetrics();
    }

    // ä¸šåŠ¡å±‚åˆ†æ
    async function analyzeBusinessLayer() {
      clearResults('business-results');
      logMessage('business-results', 'ğŸ’¼ å¼€å§‹ä¸šåŠ¡å±‚åˆ†æ...', 'info');

      analysisState.requestsAnalyzed++;

      // 1. æ£€æŸ¥æ–‡ä»¶éªŒè¯é€»è¾‘
      logMessage('business-results', '\n1. æ£€æŸ¥æ–‡ä»¶éªŒè¯é€»è¾‘...', 'info');
      const testFile = new File(['x'.repeat(1024)], 'test.png', { type: 'image/png' });
      const maxSize = 2 * 1024 * 1024; // 2MB

      if (testFile.size <= maxSize) {
        logMessage('business-results', '   âœ… æ–‡ä»¶å¤§å°éªŒè¯é€šè¿‡', 'success');
      } else {
        logMessage('business-results', '   âŒ æ–‡ä»¶å¤§å°è¶…é™', 'error');
        analysisState.errorsFound++;
      }

      // 2. æ£€æŸ¥é‡è¯•æœºåˆ¶
      logMessage('business-results', '\n2. æ£€æŸ¥é‡è¯•æœºåˆ¶é…ç½®...', 'info');
      logMessage('business-results', '   ğŸ“Š æœ€å¤§é‡è¯•æ¬¡æ•°: 3', 'info');
      logMessage('business-results', '   ğŸ“Š é‡è¯•å»¶è¿Ÿ: æŒ‡æ•°é€€é¿ (1s â†’ 2s â†’ 4s)', 'info');
      logMessage('business-results', '   ğŸ“Š è¶…æ—¶è®¾ç½®: 30ç§’', 'info');

      // 3. æ£€æŸ¥é”™è¯¯å¤„ç†
      logMessage('business-results', '\n3. æ£€æŸ¥é”™è¯¯å¤„ç†é€»è¾‘...', 'info');
      logMessage('business-results', '   ğŸ“Š ç½‘ç»œé”™è¯¯: æ‰§è¡Œé‡è¯•', 'info');
      logMessage('business-results', '   ğŸ“Š 4xxé”™è¯¯: ä¸é‡è¯• (é™¤429)', 'info');
      logMessage('business-results', '   ğŸ“Š 5xxé”™è¯¯: æ‰§è¡Œé‡è¯•', 'info');

      // 4. æ£€æŸ¥çŠ¶æ€ç®¡ç†
      logMessage('business-results', '\n4. æ£€æŸ¥çŠ¶æ€ç®¡ç†...', 'info');
      try {
        // æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ storeçŠ¶æ€
        logMessage('business-results', '   ğŸ“Š fileUploadStoreçŠ¶æ€æ£€æŸ¥', 'info');
        logMessage('business-results', '   ğŸ“Š å¹¶å‘ä¸Šä¼ æ§åˆ¶: Promise.allSettled', 'info');
        logMessage('business-results', '   ğŸ“Š è¿›åº¦è¿½è¸ª: æ”¯æŒ', 'info');
      } catch (error) {
        logMessage('business-results', `   âŒ çŠ¶æ€ç®¡ç†æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
      }

      logMessage('business-results', '\nâœ… ä¸šåŠ¡å±‚åˆ†æå®Œæˆ', 'success');
      updateMetrics();
    }

    // æ·±åº¦è¯Šæ–­
    async function runDeepDiagnostic() {
      clearResults('diagnostic-results');
      logMessage('diagnostic-results', 'ğŸš€ å¼€å§‹æ·±åº¦è¯Šæ–­...', 'info');
      updateProgress(0);

      // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
      for (let i = 1; i <= 8; i++) {
        updateStepStatus(`step-${i}`, '', '');
      }

      // æ¨¡æ‹Ÿå®Œæ•´ä¸Šä¼ æµç¨‹è¯Šæ–­
      const steps = [
        { id: 'step-1', name: 'MessageInputè§¦å‘', test: () => Promise.resolve(true) },
        { id: 'step-2', name: 'fileUploadStoreå¤„ç†', test: () => Promise.resolve(true) },
        { id: 'step-3', name: 'Promise.allSettledå¹¶å‘', test: () => Promise.resolve(true) },
        { id: 'step-4', name: 'ChatServiceå¤„ç†', test: () => Promise.resolve(true) },
        { id: 'step-5', name: 'ç½‘ç»œå¥åº·æ£€æŸ¥', test: () => fetch('/health').then(r => r.ok) },
        { id: 'step-6', name: 'æ–‡ä»¶ä¸Šä¼ è¯·æ±‚', test: () => fetch('/api/files/single', { method: 'HEAD' }).then(r => r.status !== 404) },
        { id: 'step-7', name: 'é‡è¯•æœºåˆ¶', test: () => Promise.resolve(true) },
        { id: 'step-8', name: 'é”™è¯¯å¤„ç†', test: () => Promise.resolve(true) }
      ];

      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        updateStepStatus(step.id, 'analyzing');
        updateProgress((i / steps.length) * 100);

        try {
          const result = await step.test();
          if (result) {
            updateStepStatus(step.id, 'success', 'âœ… é€šè¿‡');
            logMessage('diagnostic-results', `âœ… ${step.name}: é€šè¿‡`, 'success');
          } else {
            updateStepStatus(step.id, 'error', 'âŒ å¤±è´¥');
            logMessage('diagnostic-results', `âŒ ${step.name}: å¤±è´¥`, 'error');
            analysisState.errorsFound++;
          }
        } catch (error) {
          updateStepStatus(step.id, 'error', `âŒ ${error.message}`);
          logMessage('diagnostic-results', `âŒ ${step.name}: ${error.message}`, 'error');
          analysisState.errorsFound++;
        }

        // æ·»åŠ å»¶è¿Ÿä»¥æ˜¾ç¤ºè¿›åº¦
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      updateProgress(100);

      // ç”Ÿæˆä¿®å¤å»ºè®®
      await generateFixStrategy();

      logMessage('diagnostic-results', '\nğŸ¯ æ·±åº¦è¯Šæ–­å®Œæˆï¼', 'success');
      updateMetrics();
    }

    // ç”Ÿæˆä¿®å¤ç­–ç•¥
    async function generateFixStrategy() {
      const fixes = [];

      // åŸºäºåˆ†æç»“æœç”Ÿæˆä¿®å¤å»ºè®®
      if (analysisState.errorsFound > 0) {
        fixes.push({
          title: 'ä¿®å¤ç½‘ç»œè¿æ¥é—®é¢˜',
          description: 'è§£å†³POST /files/singleè¯·æ±‚å¤±è´¥çš„æ ¹å› ',
          code: `// 1. æ£€æŸ¥Gatewayè·¯ç”±é…ç½®
// ç¡®ä¿ /api/files/single è·¯ç”±æ­£ç¡®é…ç½®

// 2. éªŒè¯åç«¯æœåŠ¡çŠ¶æ€
// æ£€æŸ¥fechatter-serverçš„æ–‡ä»¶æœåŠ¡æ˜¯å¦è¿è¡Œ

// 3. å¢å¼ºé”™è¯¯è¯Šæ–­
const uploadWithDiagnostic = async (file) => {
  try {
    // é¢„æ£€æŸ¥ç«¯ç‚¹å¯ç”¨æ€§
    const healthCheck = await fetch('/api/files/single', {method: 'HEAD'});
    if (!healthCheck.ok) {
      throw new Error('File upload endpoint not available');
    }
    
    // æ‰§è¡Œå®é™…ä¸Šä¼ 
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/files/single', {
      method: 'POST',
      body: formData,
      headers: {
        'Authorization': 'Bearer ' + getAuthToken()
      }
    });
    
    return response;
  } catch (error) {
    console.error('Upload diagnostic:', error);
    throw error;
  }
};`
        });

        fixes.push({
          title: 'å¢å¼ºé‡è¯•æœºåˆ¶',
          description: 'å®ç°æ›´æ™ºèƒ½çš„é‡è¯•å’Œé™çº§ç­–ç•¥',
          code: `// å¢å¼ºçš„é‡è¯•æœºåˆ¶
const enhancedRetry = async (uploadFn, maxRetries = 3) => {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const result = await uploadFn();
      return result;
    } catch (error) {
      console.log('Retry attempt', attempt, 'failed:', error.message);
      
      // åˆ†æé”™è¯¯ç±»å‹
      if (error.status === 404) {
        throw new Error('Endpoint not found - check server configuration');
      }
      
      if (attempt === maxRetries) {
        throw new Error('Upload failed after ' + maxRetries + ' attempts: ' + error.message);
      }
      
      // æŒ‡æ•°é€€é¿
      const delay = Math.pow(2, attempt - 1) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
};`
        });

        fixes.push({
          title: 'æ·»åŠ è¯¦ç»†æ—¥å¿—',
          description: 'å¢åŠ è¯¦ç»†çš„é”™è¯¯è¿½è¸ªå’Œè°ƒè¯•ä¿¡æ¯',
          code: `// è¯¦ç»†çš„ä¸Šä¼ æ—¥å¿—
const logUploadAttempt = (attempt, file, error = null) => {
  const logData = {
    timestamp: new Date().toISOString(),
    attempt,
    fileName: file.name,
    fileSize: file.size,
    fileType: file.type,
    error: error ? error.message : null,
    stackTrace: error ? error.stack : null
  };
  
  console.group('ğŸ“¤ Upload Attempt', attempt);
  console.table(logData);
  if (error) {
    console.error('Error details:', error);
  }
  console.groupEnd();
  
  // å‘é€åˆ°åˆ†æå·¥å…·
  if (window.uploadAnalytics) {
    window.uploadAnalytics.track('upload_attempt', logData);
  }
};`
        });
      }

      if (fixes.length > 0) {
        analysisState.fixesSuggested = fixes.length;
        analysisState.suggestedFixes = fixes;

        // æ˜¾ç¤ºä¿®å¤ç­–ç•¥
        displayFixStrategy(fixes);

        // è®¡ç®—æˆåŠŸç‡é¢„æµ‹
        analysisState.successRate = Math.max(0, 90 - (analysisState.errorsFound * 20));
      }

      updateMetrics();
    }

    // æ˜¾ç¤ºä¿®å¤ç­–ç•¥
    function displayFixStrategy(fixes) {
      const fixStrategy = document.getElementById('fix-strategy');
      const fixSteps = document.getElementById('fix-steps');

      fixSteps.innerHTML = '';

      fixes.forEach((fix, index) => {
        const fixStep = document.createElement('div');
        fixStep.className = 'fix-step';
        fixStep.innerHTML = `
                    <div class="fix-number">${index + 1}</div>
                    <div class="fix-content">
                        <div class="fix-title">${fix.title}</div>
                        <div class="fix-description">${fix.description}</div>
                        <div class="fix-code">${fix.code}</div>
                    </div>
                `;
        fixSteps.appendChild(fixStep);
      });

      fixStrategy.style.display = 'block';
    }

    // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ 
    async function simulateUpload() {
      clearResults('diagnostic-results');
      logMessage('diagnostic-results', 'ğŸ“ æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ æµ‹è¯•...', 'info');

      try {
        // åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        const testFile = new File(['test content for upload simulation'], 'test-upload.png', {
          type: 'image/png'
        });

        logMessage('diagnostic-results', `ğŸ“Š æµ‹è¯•æ–‡ä»¶: ${testFile.name} (${testFile.size} bytes)`, 'info');

        // æ¨¡æ‹Ÿä¸Šä¼ æµç¨‹
        const formData = new FormData();
        formData.append('file', testFile);

        const authToken = localStorage.getItem('auth_token');
        const headers = {};
        if (authToken) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }

        logMessage('diagnostic-results', 'ğŸš€ å‘é€ä¸Šä¼ è¯·æ±‚...', 'info');

        const response = await fetch('/api/files/single', {
          method: 'POST',
          body: formData,
          headers: headers
        });

        if (response.ok) {
          const result = await response.json();
          logMessage('diagnostic-results', 'âœ… ä¸Šä¼ æˆåŠŸï¼', 'success');
          logMessage('diagnostic-results', `ğŸ“Š å“åº”: ${JSON.stringify(result, null, 2)}`, 'success');
        } else {
          logMessage('diagnostic-results', `âŒ ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
          const errorText = await response.text();
          logMessage('diagnostic-results', `ğŸ“Š é”™è¯¯è¯¦æƒ…: ${errorText}`, 'error');
        }

      } catch (error) {
        logMessage('diagnostic-results', `âŒ ä¸Šä¼ å¼‚å¸¸: ${error.message}`, 'error');
        logMessage('diagnostic-results', `ğŸ“Š é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
      }
    }

    // è¿½è¸ªè¯·æ±‚è·¯å¾„
    async function traceRequest() {
      clearResults('diagnostic-results');
      logMessage('diagnostic-results', 'ğŸ” è¿½è¸ªè¯·æ±‚è·¯å¾„...', 'info');

      const tracePath = [
        { step: 'å‰ç«¯è¯·æ±‚', url: '/api/files/single', desc: 'Viteå¼€å‘æœåŠ¡å™¨' },
        { step: 'Viteä»£ç†', url: 'http://45.77.178.85:8080/api/files/single', desc: 'ä»£ç†è½¬å‘' },
        { step: 'Gatewayè·¯ç”±', url: 'fechatter-server:6688/api/files/single', desc: 'Gatewayå†…éƒ¨è·¯ç”±' },
        { step: 'åç«¯å¤„ç†', url: 'files/single handler', desc: 'Ruståç«¯å¤„ç†å™¨' }
      ];

      tracePath.forEach((trace, index) => {
        logMessage('diagnostic-results', `${index + 1}. ${trace.step}`, 'info');
        logMessage('diagnostic-results', `   ğŸ“ ${trace.url}`, 'info');
        logMessage('diagnostic-results', `   ğŸ“ ${trace.desc}`, 'info');
        logMessage('diagnostic-results', '', 'info');
      });

      logMessage('diagnostic-results', 'ğŸ¯ å¯èƒ½çš„æ•…éšœç‚¹:', 'warning');
      logMessage('diagnostic-results', '   â€¢ Gatewayè·¯ç”±é…ç½®ç¼ºå¤±/é”™è¯¯', 'warning');
      logMessage('diagnostic-results', '   â€¢ åç«¯æ–‡ä»¶æœåŠ¡æœªå¯åŠ¨', 'warning');
      logMessage('diagnostic-results', '   â€¢ ç½‘ç»œè¿æ¥é—®é¢˜', 'warning');
      logMessage('diagnostic-results', '   â€¢ è®¤è¯/æˆæƒé—®é¢˜', 'warning');
    }

    // åº”ç”¨ä¿®å¤
    function applyFixes() {
      alert('ä¿®å¤å»ºè®®å·²ç”Ÿæˆï¼è¯·æ‰‹åŠ¨åº”ç”¨ä»£ç ä¿®å¤ï¼Œæˆ–ä½¿ç”¨å¼€å‘å·¥å…·è¿›è¡Œè°ƒè¯•ã€‚');
    }

    // é¢„è§ˆä¿®å¤
    function previewFixes() {
      if (analysisState.suggestedFixes.length > 0) {
        console.group('ğŸ› ï¸ ä¿®å¤é¢„è§ˆ');
        analysisState.suggestedFixes.forEach((fix, index) => {
          console.log(`${index + 1}. ${fix.title}`);
          console.log(`   æè¿°: ${fix.description}`);
          console.log(`   ä»£ç :`, fix.code);
        });
        console.groupEnd();

        alert('ä¿®å¤é¢„è§ˆå·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼è¯·æŒ‰F12æŸ¥çœ‹ã€‚');
      } else {
        alert('æš‚æ— ä¿®å¤å»ºè®®ã€‚è¯·å…ˆè¿è¡Œæ·±åº¦è¯Šæ–­ã€‚');
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      updateMetrics();

      // è‡ªåŠ¨è¿è¡Œåˆæ­¥åˆ†æ
      setTimeout(() => {
        logMessage('diagnostic-results', 'ğŸ¯ DAGå› æœæ¨ç†åˆ†æå·¥å…·å·²å°±ç»ª', 'info');
        logMessage('diagnostic-results', 'ğŸ’¡ å»ºè®®å…ˆè¿è¡Œ"æ·±åº¦è¯Šæ–­"æ¥å…¨é¢åˆ†æé—®é¢˜', 'info');
      }, 1000);
    });
  </script>
</body>

</html>