<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”— SSEç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸä¿®å¤éªŒè¯</title>
  <style>
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #2d3748;
      font-size: 2.2rem;
      margin-bottom: 10px;
    }

    .fix-summary {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .test-card {
      background: #f8fafc;
      border-radius: 10px;
      padding: 20px;
      border-left: 4px solid #3b82f6;
    }

    .btn {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
      transition: all 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn.success {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .btn.warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .btn.critical {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .status-panel {
      background: #1a202c;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Consolas', monospace;
      font-size: 0.9rem;
      margin: 20px 0;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-connected {
      background: #10b981;
    }

    .status-disconnected {
      background: #ef4444;
    }

    .status-pending {
      background: #f59e0b;
    }

    .lifecycle-stages {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
      padding: 20px;
      background: #f7fafc;
      border-radius: 10px;
    }

    .stage {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      min-width: 150px;
      transition: all 0.3s;
    }

    .stage.active {
      border-color: #3b82f6;
      background: #dbeafe;
    }

    .stage.success {
      border-color: #10b981;
      background: #ecfdf5;
    }

    .stage.error {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .metric-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: bold;
      color: #3b82f6;
    }

    .log-panel {
      background: #1a202c;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Consolas', monospace;
      font-size: 0.9rem;
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”— SSEç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸä¿®å¤éªŒè¯</h1>
      <p>éªŒè¯Chat.vueä¸­çš„ensureSSEListeners()å‡½æ•°æ˜¯å¦æ­£ç¡®ä¿®å¤äº†SSEçŠ¶æ€æ›´æ–°é—®é¢˜</p>
    </div>

    <div class="fix-summary">
      <h2>âœ… å·²å®æ–½çš„ä¿®å¤</h2>
      <p><strong>æ ¸å¿ƒä¿®å¤:</strong> åœ¨Chat.vueçš„onMountedå’Œroute watchä¸­æ·»åŠ äº†ensureSSEListeners()å‡½æ•°</p>
      <ul style="margin-left: 20px; margin-top: 10px;">
        <li><strong>é—®é¢˜è§£å†³:</strong> SSEç›‘å¬å™¨åœ¨é¡µé¢åˆ·æ–°/è·¯ç”±åˆ‡æ¢åä¸¢å¤±</li>
        <li><strong>ä¿®å¤æœºåˆ¶:</strong> è‡ªåŠ¨æ£€æµ‹å¹¶é‡æ–°æ³¨å†ŒSSEæ¶ˆæ¯ç›‘å¬å™¨</li>
        <li><strong>ç”Ÿå‘½å‘¨æœŸç®¡ç†:</strong> åœ¨ç»„ä»¶mountå’Œroute changeæ—¶éƒ½ä¼šéªŒè¯SSEçŠ¶æ€</li>
        <li><strong>å®¹é”™å¤„ç†:</strong> è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿ï¼Œç›‘å¬å™¨ä¸¢å¤±æ—¶è‡ªåŠ¨é‡æ–°æ³¨å†Œ</li>
      </ul>
    </div>

    <div class="test-grid">
      <div class="test-card">
        <h3>ğŸ” 1. SSEè¿æ¥çŠ¶æ€æ£€æŸ¥</h3>
        <p>æ£€æŸ¥MinimalSSEæœåŠ¡çš„è¿æ¥çŠ¶æ€å’Œå¥åº·åº¦</p>
        <button class="btn" onclick="checkSSEConnection()">æ£€æŸ¥SSEè¿æ¥</button>
      </div>

      <div class="test-card">
        <h3>ğŸ“¨ 2. æ¶ˆæ¯ç›‘å¬å™¨éªŒè¯</h3>
        <p>éªŒè¯messageäº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£ç¡®æ³¨å†Œ</p>
        <button class="btn" onclick="verifyMessageListeners()">éªŒè¯ç›‘å¬å™¨</button>
      </div>

      <div class="test-card">
        <h3>ğŸ”„ 3. ç”Ÿå‘½å‘¨æœŸæµ‹è¯•</h3>
        <p>æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°å’Œè·¯ç”±åˆ‡æ¢åœºæ™¯</p>
        <button class="btn warning" onclick="simulateLifecycleEvents()">æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸ</button>
      </div>

      <div class="test-card">
        <h3>âš¡ 4. å“åº”å¼éªŒè¯</h3>
        <p>æµ‹è¯•SSEäº‹ä»¶æ˜¯å¦èƒ½æ­£ç¡®è§¦å‘Vueå“åº”å¼æ›´æ–°</p>
        <button class="btn success" onclick="testReactivityChain()">æµ‹è¯•å“åº”å¼</button>
      </div>
    </div>

    <div class="lifecycle-stages" id="lifecycleStages">
      <div class="stage" id="stage1">1. ç»„ä»¶Mount</div>
      <div class="stage" id="stage2">2. SSEè¿æ¥æ£€æŸ¥</div>
      <div class="stage" id="stage3">3. ç›‘å¬å™¨éªŒè¯</div>
      <div class="stage" id="stage4">4. ç›‘å¬å™¨æ³¨å†Œ</div>
      <div class="stage" id="stage5">5. è·¯ç”±åˆ‡æ¢</div>
      <div class="stage" id="stage6">6. é‡æ–°éªŒè¯</div>
      <div class="stage" id="stage7">7. æ­£å¸¸å·¥ä½œ</div>
    </div>

    <div class="metrics-grid" id="metricsGrid">
      <div class="metric-card">
        <div class="metric-value" id="connectionStatus">-</div>
        <div>è¿æ¥çŠ¶æ€</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="listenerCount">-</div>
        <div>ç›‘å¬å™¨æ•°é‡</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="lastEventTime">-</div>
        <div>æœ€åäº‹ä»¶æ—¶é—´</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="successRate">-</div>
        <div>æˆåŠŸç‡</div>
      </div>
    </div>

    <div class="log-panel" id="logPanel">
      <strong>ğŸ” å®æ—¶éªŒè¯æ—¥å¿—</strong><br>
      <span style="color: #68d391;">[ç³»ç»Ÿ] SSEç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸä¿®å¤éªŒè¯å·¥å…·å·²åŠ è½½</span>
    </div>

    <div style="text-align: center; margin: 30px 0;">
      <button class="btn critical" onclick="runCompleteVerification()">ğŸš€ è¿è¡Œå®Œæ•´éªŒè¯</button>
      <button class="btn" onclick="forceSSEReconnection()">ğŸ”§ å¼ºåˆ¶SSEé‡è¿</button>
      <button class="btn success" onclick="window.open('http://localhost:5173/chat/2', '_blank')">ğŸ§ª æµ‹è¯•èŠå¤©ç•Œé¢</button>
    </div>
  </div>

  <script>
    let verificationInterval = null;
    let testResults = {
      connection: false,
      listeners: false,
      lifecycle: false,
      reactivity: false
    };

    function addLog(message, type = 'info') {
      const logPanel = document.getElementById('logPanel');
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: '#68d391',
        success: '#48bb78',
        warning: '#ed8936',
        error: '#f56565',
        debug: '#63b3ed'
      };

      logPanel.innerHTML += `<br><span style="color: ${colors[type]};">[${timestamp}] ${message}</span>`;
      logPanel.scrollTop = logPanel.scrollHeight;
    }

    function updateStage(stageId, status) {
      const stage = document.getElementById(stageId);
      if (stage) {
        stage.className = `stage ${status}`;
      }
    }

    function updateMetric(metricId, value) {
      const metric = document.getElementById(metricId);
      if (metric) {
        metric.textContent = value;
      }
    }

    function checkSSEConnection() {
      addLog('ğŸ” å¼€å§‹SSEè¿æ¥çŠ¶æ€æ£€æŸ¥...', 'info');
      updateStage('stage2', 'active');

      if (window.minimalSSE) {
        addLog('âœ… MinimalSSEæœåŠ¡å·²æ‰¾åˆ°', 'success');

        const status = window.minimalSSE.getStatus?.() || {};
        const isConnected = status.connected || false;

        updateMetric('connectionStatus', isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥');

        if (isConnected) {
          addLog('âœ… SSEè¿æ¥çŠ¶æ€: å·²è¿æ¥', 'success');
          updateStage('stage2', 'success');
          testResults.connection = true;

          // æ£€æŸ¥è¿æ¥è¯¦æƒ…
          addLog(`ğŸ“Š è¿æ¥è¯¦æƒ…: é‡è¯•æ¬¡æ•°=${status.retries || 0}`, 'info');

        } else {
          addLog('âŒ SSEè¿æ¥çŠ¶æ€: æœªè¿æ¥', 'error');
          updateStage('stage2', 'error');
          testResults.connection = false;

          addLog('ğŸ’¡ å»ºè®®: æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è°ƒç”¨ensureSSEListeners()', 'warning');
        }
      } else {
        addLog('âŒ MinimalSSEæœåŠ¡æœªæ‰¾åˆ°', 'error');
        updateStage('stage2', 'error');
        testResults.connection = false;
        updateMetric('connectionStatus', 'æœåŠ¡ç¼ºå¤±');
      }
    }

    function verifyMessageListeners() {
      addLog('ğŸ“¨ å¼€å§‹æ¶ˆæ¯ç›‘å¬å™¨éªŒè¯...', 'info');
      updateStage('stage3', 'active');

      if (window.minimalSSE && window.minimalSSE.listeners) {
        const listeners = window.minimalSSE.listeners;

        if (listeners.get) {
          const messageListeners = listeners.get('message') || [];
          const listenerCount = messageListeners.length;

          updateMetric('listenerCount', listenerCount);

          if (listenerCount > 0) {
            addLog(`âœ… æ‰¾åˆ°${listenerCount}ä¸ªæ¶ˆæ¯ç›‘å¬å™¨`, 'success');
            updateStage('stage3', 'success');
            testResults.listeners = true;

            // åˆ†æç›‘å¬å™¨è¯¦æƒ…
            messageListeners.forEach((listener, index) => {
              addLog(`  ç›‘å¬å™¨${index + 1}: ${typeof listener}`, 'debug');
            });

          } else {
            addLog('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯ç›‘å¬å™¨ï¼', 'warning');
            updateStage('stage3', 'error');
            testResults.listeners = false;

            addLog('ğŸ”§ å°è¯•è°ƒç”¨chatStore.setupSSEMessageListeners()...', 'info');

            // å°è¯•é€šè¿‡Chat Storeé‡æ–°è®¾ç½®ç›‘å¬å™¨
            if (window.app && window.app._context) {
              const pinia = window.app._context.provides?.[Symbol.for('pinia')];
              const chatStore = pinia?._s?.get('chat');

              if (chatStore && chatStore.setupSSEMessageListeners) {
                chatStore.setupSSEMessageListeners();
                addLog('ğŸ”„ å·²è°ƒç”¨setupSSEMessageListeners()', 'info');

                // é‡æ–°éªŒè¯
                setTimeout(() => {
                  const newListeners = listeners.get('message') || [];
                  if (newListeners.length > 0) {
                    addLog(`âœ… æˆåŠŸé‡æ–°æ³¨å†Œ${newListeners.length}ä¸ªç›‘å¬å™¨`, 'success');
                    updateStage('stage3', 'success');
                    testResults.listeners = true;
                    updateMetric('listenerCount', newListeners.length);
                  } else {
                    addLog('âŒ ç›‘å¬å™¨é‡æ–°æ³¨å†Œå¤±è´¥', 'error');
                  }
                }, 500);
              } else {
                addLog('âŒ æ— æ³•è®¿é—®chatStore.setupSSEMessageListeners', 'error');
              }
            }
          }
        } else {
          addLog('âŒ SSEç›‘å¬å™¨æ¥å£ä¸å¯ç”¨', 'error');
          updateStage('stage3', 'error');
          testResults.listeners = false;
        }
      } else {
        addLog('âŒ SSEç›‘å¬å™¨ç³»ç»Ÿä¸å¯ç”¨', 'error');
        updateStage('stage3', 'error');
        testResults.listeners = false;
      }
    }

    function simulateLifecycleEvents() {
      addLog('ğŸ”„ å¼€å§‹ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æ¨¡æ‹Ÿ...', 'info');
      updateStage('stage5', 'active');

      // æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°åœºæ™¯
      addLog('1. æ¨¡æ‹Ÿé¡µé¢åˆ·æ–° - æ£€æŸ¥ç›‘å¬å™¨æ˜¯å¦ä¸¢å¤±', 'info');

      // æ£€æŸ¥å½“å‰çŠ¶æ€
      const beforeListeners = window.minimalSSE?.listeners?.get('message')?.length || 0;
      addLog(`   åˆ·æ–°å‰ç›‘å¬å™¨æ•°é‡: ${beforeListeners}`, 'debug');

      // æ¨¡æ‹Ÿç›‘å¬å™¨æ¸…ç†ï¼ˆå®é™…é¡µé¢åˆ·æ–°ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼‰
      if (window.minimalSSE && window.minimalSSE.listeners) {
        // ä¸´æ—¶æ¸…é™¤ç›‘å¬å™¨æ¥æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°
        window.minimalSSE.listeners.set('message', []);
        addLog('   æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°: ç›‘å¬å™¨å·²æ¸…é™¤', 'warning');

        setTimeout(() => {
          addLog('2. æ¨¡æ‹ŸensureSSEListeners()è°ƒç”¨', 'info');

          // æ£€æŸ¥Chat Storeæ˜¯å¦æœ‰é‡æ–°æ³¨å†Œæœºåˆ¶
          if (window.app && window.app._context) {
            const pinia = window.app._context.provides?.[Symbol.for('pinia')];
            const chatStore = pinia?._s?.get('chat');

            if (chatStore && chatStore.setupSSEMessageListeners) {
              chatStore.setupSSEMessageListeners();
              addLog('   âœ… ensureSSEListeners()æ¨¡æ‹Ÿè°ƒç”¨å®Œæˆ', 'success');

              setTimeout(() => {
                const afterListeners = window.minimalSSE?.listeners?.get('message')?.length || 0;
                addLog(`   æ¢å¤åç›‘å¬å™¨æ•°é‡: ${afterListeners}`, 'debug');

                if (afterListeners > 0) {
                  addLog('âœ… ç”Ÿå‘½å‘¨æœŸæµ‹è¯•æˆåŠŸ: ç›‘å¬å™¨è‡ªåŠ¨æ¢å¤', 'success');
                  updateStage('stage5', 'success');
                  updateStage('stage6', 'success');
                  testResults.lifecycle = true;
                } else {
                  addLog('âŒ ç”Ÿå‘½å‘¨æœŸæµ‹è¯•å¤±è´¥: ç›‘å¬å™¨æœªæ¢å¤', 'error');
                  updateStage('stage5', 'error');
                  testResults.lifecycle = false;
                }
              }, 500);
            } else {
              addLog('âŒ æ— æ³•æ¨¡æ‹ŸensureSSEListenersè°ƒç”¨', 'error');
              updateStage('stage5', 'error');
            }
          }
        }, 1000);
      }
    }

    function testReactivityChain() {
      addLog('âš¡ å¼€å§‹å“åº”å¼é“¾æµ‹è¯•...', 'info');
      updateStage('stage7', 'active');

      // æ£€æŸ¥Vueåº”ç”¨å’Œstores
      if (window.app && window.app._context) {
        const pinia = window.app._context.provides?.[Symbol.for('pinia')];
        const chatStore = pinia?._s?.get('chat');

        if (chatStore) {
          addLog('âœ… ChatStoreå·²æ‰¾åˆ°', 'success');

          // æ£€æŸ¥UnifiedMessageService
          if (window.unifiedMessageService) {
            addLog('âœ… UnifiedMessageServiceå·²æ‰¾åˆ°', 'success');

            // æ¨¡æ‹Ÿæ¶ˆæ¯çŠ¶æ€æ›´æ–°
            const currentChatId = chatStore.currentChatId;
            if (currentChatId) {
              addLog(`ğŸ“Š å½“å‰èŠå¤©å®¤: ${currentChatId}`, 'info');

              const messages = window.unifiedMessageService.getMessagesForChat(currentChatId);
              if (messages) {
                const sentCount = messages.filter(m => m.status === 'sent').length;
                const deliveredCount = messages.filter(m => m.status === 'delivered').length;

                addLog(`ğŸ“ˆ æ¶ˆæ¯çŠ¶æ€ç»Ÿè®¡: ${sentCount}æ¡å¾…ç¡®è®¤, ${deliveredCount}æ¡å·²é€è¾¾`, 'info');

                if (sentCount === 0) {
                  addLog('âœ… å“åº”å¼é“¾æµ‹è¯•é€šè¿‡: æ²¡æœ‰å¡ä½çš„æ¶ˆæ¯', 'success');
                  updateStage('stage7', 'success');
                  testResults.reactivity = true;
                } else {
                  addLog(`âš ï¸ å‘ç°${sentCount}æ¡å¯èƒ½å¡ä½çš„æ¶ˆæ¯`, 'warning');
                  updateStage('stage7', 'error');
                  testResults.reactivity = false;
                }
              } else {
                addLog('ğŸ“­ å½“å‰èŠå¤©å®¤æ— æ¶ˆæ¯', 'info');
                updateStage('stage7', 'success');
                testResults.reactivity = true;
              }
            } else {
              addLog('âš ï¸ æ— å½“å‰èŠå¤©å®¤ID', 'warning');
            }
          } else {
            addLog('âŒ UnifiedMessageServiceæœªæ‰¾åˆ°', 'error');
            updateStage('stage7', 'error');
          }
        } else {
          addLog('âŒ ChatStoreæœªæ‰¾åˆ°', 'error');
          updateStage('stage7', 'error');
        }
      } else {
        addLog('âŒ Vueåº”ç”¨å®ä¾‹æœªæ‰¾åˆ°', 'error');
        updateStage('stage7', 'error');
      }
    }

    function runCompleteVerification() {
      addLog('ğŸš€ å¼€å§‹å®Œæ•´SSEç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸéªŒè¯...', 'success');

      // é‡ç½®æ‰€æœ‰é˜¶æ®µ
      for (let i = 1; i <= 7; i++) {
        updateStage(`stage${i}`, '');
      }

      // é‡ç½®æµ‹è¯•ç»“æœ
      Object.keys(testResults).forEach(key => testResults[key] = false);

      // é˜¶æ®µ1: ç»„ä»¶Mountæ¨¡æ‹Ÿ
      setTimeout(() => {
        updateStage('stage1', 'active');
        addLog('ğŸ“ é˜¶æ®µ1: æ¨¡æ‹Ÿç»„ä»¶Mount', 'info');
        setTimeout(() => updateStage('stage1', 'success'), 500);
      }, 500);

      // é˜¶æ®µ2-3: è¿æ¥å’Œç›‘å¬å™¨æ£€æŸ¥
      setTimeout(() => checkSSEConnection(), 1000);
      setTimeout(() => verifyMessageListeners(), 2000);

      // é˜¶æ®µ4: ç›‘å¬å™¨æ³¨å†Œ
      setTimeout(() => {
        updateStage('stage4', 'active');
        addLog('ğŸ“ é˜¶æ®µ4: ç›‘å¬å™¨æ³¨å†Œç¡®è®¤', 'info');
        if (testResults.listeners) {
          updateStage('stage4', 'success');
        } else {
          updateStage('stage4', 'error');
        }
      }, 3000);

      // é˜¶æ®µ5-6: ç”Ÿå‘½å‘¨æœŸæµ‹è¯•
      setTimeout(() => simulateLifecycleEvents(), 4000);

      // é˜¶æ®µ7: å“åº”å¼æµ‹è¯•
      setTimeout(() => testReactivityChain(), 6000);

      // æœ€ç»ˆæŠ¥å‘Š
      setTimeout(() => generateVerificationReport(), 7500);
    }

    function generateVerificationReport() {
      addLog('ğŸ“‹ ç”ŸæˆéªŒè¯æŠ¥å‘Š...', 'info');

      const passedTests = Object.values(testResults).filter(result => result === true).length;
      const totalTests = Object.keys(testResults).length;
      const successRate = Math.round((passedTests / totalTests) * 100);

      updateMetric('successRate', `${successRate}%`);

      addLog(`ğŸ“Š éªŒè¯ç»“æœ: ${passedTests}/${totalTests} æµ‹è¯•é€šè¿‡ (${successRate}%)`, 'info');

      if (successRate >= 75) {
        addLog('ğŸ‰ SSEç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸä¿®å¤éªŒè¯æˆåŠŸï¼', 'success');
        addLog('âœ… ensureSSEListeners()å‡½æ•°å·¥ä½œæ­£å¸¸', 'success');
        addLog('ğŸ’¡ ç°åœ¨å¯ä»¥æµ‹è¯•æ¶ˆæ¯å‘é€ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ç»¿è‰²å¯¹å·', 'success');
      } else {
        addLog('âš ï¸ éªŒè¯å‘ç°é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¿®å¤', 'warning');

        if (!testResults.connection) {
          addLog('ğŸ”§ å»ºè®®: æ£€æŸ¥SSEè¿æ¥é…ç½®', 'warning');
        }
        if (!testResults.listeners) {
          addLog('ğŸ”§ å»ºè®®: æ£€æŸ¥ç›‘å¬å™¨æ³¨å†Œé€»è¾‘', 'warning');
        }
        if (!testResults.lifecycle) {
          addLog('ğŸ”§ å»ºè®®: æ£€æŸ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†', 'warning');
        }
        if (!testResults.reactivity) {
          addLog('ğŸ”§ å»ºè®®: æ£€æŸ¥Vueå“åº”å¼é“¾', 'warning');
        }
      }
    }

    function forceSSEReconnection() {
      addLog('ğŸ”§ å¼ºåˆ¶SSEé‡è¿...', 'warning');

      if (window.minimalSSE && window.tokenManager) {
        // å…ˆæ–­å¼€è¿æ¥
        if (window.minimalSSE.disconnect) {
          window.minimalSSE.disconnect();
          addLog('ğŸ“´ å·²æ–­å¼€SSEè¿æ¥', 'info');
        }

        // ç­‰å¾…ä¸€ç§’åé‡è¿
        setTimeout(() => {
          const token = window.tokenManager.getAccessToken();
          if (token && window.minimalSSE.connect) {
            window.minimalSSE.connect(token);
            addLog('ğŸ”„ å·²å‘èµ·SSEé‡è¿', 'info');

            // é‡æ–°è®¾ç½®ç›‘å¬å™¨
            setTimeout(() => {
              if (window.app && window.app._context) {
                const pinia = window.app._context.provides?.[Symbol.for('pinia')];
                const chatStore = pinia?._s?.get('chat');

                if (chatStore && chatStore.setupSSEMessageListeners) {
                  chatStore.setupSSEMessageListeners();
                  addLog('âœ… å·²é‡æ–°è®¾ç½®SSEç›‘å¬å™¨', 'success');
                }
              }
            }, 1000);
          } else {
            addLog('âŒ æ— æ³•è·å–è®¿é—®ä»¤ç‰Œæˆ–é‡è¿æ–¹æ³•', 'error');
          }
        }, 1000);
      } else {
        addLog('âŒ SSEæœåŠ¡æˆ–ä»¤ç‰Œç®¡ç†å™¨ä¸å¯ç”¨', 'error');
      }
    }

    // è‡ªåŠ¨ç›‘æ§
    function startAutoMonitoring() {
      if (verificationInterval) return;

      verificationInterval = setInterval(() => {
        // æ›´æ–°è¿æ¥çŠ¶æ€
        if (window.minimalSSE) {
          const status = window.minimalSSE.getStatus?.() || {};
          updateMetric('connectionStatus', status.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥');

          const listeners = window.minimalSSE.listeners?.get('message') || [];
          updateMetric('listenerCount', listeners.length);
        }

        // æ›´æ–°æœ€åäº‹ä»¶æ—¶é—´
        const now = new Date().toLocaleTimeString();
        updateMetric('lastEventTime', now);
      }, 2000);
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      addLog('ğŸ”— SSEç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸä¿®å¤éªŒè¯å·¥å…·å·²åŠ è½½', 'success');
      addLog('è¿™ä¸ªå·¥å…·éªŒè¯Chat.vueä¸­çš„ensureSSEListeners()ä¿®å¤æ˜¯å¦æœ‰æ•ˆ', 'info');
      addLog('ç‚¹å‡»"è¿è¡Œå®Œæ•´éªŒè¯"å¼€å§‹æµ‹è¯•', 'info');

      startAutoMonitoring();
    });
  </script>
</body>

</html>