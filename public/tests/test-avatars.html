<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avatar Test Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .avatar-test {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 10px;
      display: inline-block;
      object-fit: cover;
      border: 2px solid #e1e5e9;
    }

    .avatar-fallback {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #5865f2, #7983f5);
      color: white;
      font-weight: bold;
      border: 2px solid #e1e5e9;
    }

    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }

    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 10px 0;
    }

    .test-button:hover {
      background: #0056b3;
    }
  </style>
</head>

<body>
  <h1>å¤´åƒæ˜¾ç¤ºæµ‹è¯•é¡µé¢</h1>

  <div class="test-section">
    <h3>1. é»˜è®¤å¤´åƒæµ‹è¯•</h3>
    <p>æµ‹è¯•é»˜è®¤å¤´åƒ SVG æ˜¯å¦èƒ½æ­£å¸¸åŠ è½½ï¼š</p>
    <img src="/default-avatar.svg" alt="Default Avatar" class="avatar-test" id="default-avatar">
    <div id="default-avatar-result" class="test-result"></div>
  </div>

  <div class="test-section">
    <h3>2. å¤´åƒé”™è¯¯å¤„ç†æµ‹è¯•</h3>
    <p>æµ‹è¯•ä¸å­˜åœ¨çš„å¤´åƒURLæ˜¯å¦æ­£ç¡®å¤„ç†ï¼š</p>
    <img src="/non-existent-avatar.png" alt="Broken Avatar" class="avatar-test" id="broken-avatar">
    <div class="avatar-fallback" id="fallback-display">JD</div>
    <div id="broken-avatar-result" class="test-result"></div>
  </div>

  <div class="test-section">
    <h3>3. æ¶ˆæ¯æ–‡ä»¶æ˜¾ç¤ºæµ‹è¯•</h3>
    <p>æµ‹è¯•æ–‡ä»¶é¢„è§ˆç»„ä»¶çš„å›¾ç‰‡æ˜¾ç¤ºï¼š</p>
    <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; max-width: 350px;">
      <div style="display: flex; align-items: center;">
        <img src="/test-image.jpg" alt="Test Image"
          style="width: 48px; height: 48px; border-radius: 6px; object-fit: cover; margin-right: 12px;"
          id="file-preview-test">
        <div style="display: flex; flex-direction: column;">
          <span style="font-weight: 500; color: #1f2937;">test-image.jpg</span>
          <span style="font-size: 0.75rem; color: #6b7280;">120 KB | JPG</span>
        </div>
      </div>
    </div>
    <div id="file-preview-result" class="test-result"></div>
  </div>

  <div class="test-section">
    <h3>4. æ‰©å±•é”™è¯¯æŠ‘åˆ¶æµ‹è¯•</h3>
    <p>æµ‹è¯•æµè§ˆå™¨æ‰©å±•é”™è¯¯æ˜¯å¦è¢«æ­£ç¡®æŠ‘åˆ¶ï¼š</p>
    <button onclick="testExtensionError()" class="test-button">è§¦å‘æ‰©å±•é”™è¯¯æµ‹è¯•</button>
    <div id="extension-error-result" class="test-result"></div>
  </div>

  <div class="test-section">
    <h3>5. ä¿®å¤çŠ¶æ€æ€»ç»“</h3>
    <div id="summary" class="test-result">æ­£åœ¨æ£€æµ‹...</div>
  </div>

  <script>
    // Test default avatar loading
    const defaultAvatar = document.getElementById('default-avatar');
    const defaultResult = document.getElementById('default-avatar-result');

    defaultAvatar.onload = function () {
      defaultResult.className = 'test-result success';
      defaultResult.textContent = 'âœ… é»˜è®¤å¤´åƒSVGåŠ è½½æˆåŠŸ';
      updateSummary();
    };

    defaultAvatar.onerror = function () {
      defaultResult.className = 'test-result error';
      defaultResult.textContent = 'âŒ é»˜è®¤å¤´åƒSVGåŠ è½½å¤±è´¥';
      updateSummary();
    };

    // Test broken avatar handling
    const brokenAvatar = document.getElementById('broken-avatar');
    const brokenResult = document.getElementById('broken-avatar-result');

    brokenAvatar.onload = function () {
      brokenResult.className = 'test-result error';
      brokenResult.textContent = 'âŒ æ„å¤–ï¼šæŸåçš„å¤´åƒç«Ÿç„¶åŠ è½½æˆåŠŸäº†';
      updateSummary();
    };

    brokenAvatar.onerror = function () {
      brokenResult.className = 'test-result success';
      brokenResult.textContent = 'âœ… æŸåå¤´åƒæ­£ç¡®è§¦å‘é”™è¯¯å¤„ç†ï¼Œæ˜¾ç¤ºé™çº§æ–¹æ¡ˆ';
      updateSummary();
    };

    // Test file preview
    const filePreview = document.getElementById('file-preview-test');
    const fileResult = document.getElementById('file-preview-result');

    filePreview.onload = function () {
      fileResult.className = 'test-result success';
      fileResult.textContent = 'âœ… æ–‡ä»¶é¢„è§ˆå›¾ç‰‡åŠ è½½æˆåŠŸ';
      updateSummary();
    };

    filePreview.onerror = function () {
      fileResult.className = 'test-result success';
      fileResult.textContent = 'âœ… æ–‡ä»¶é¢„è§ˆæ­£ç¡®å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯';
      updateSummary();
    };

    let results = {
      defaultAvatar: false,
      brokenAvatar: false,
      filePreview: false,
      extensionError: false
    };

    function testExtensionError() {
      const result = document.getElementById('extension-error-result');

      try {
        // Simulate the extension error that was occurring
        const error = new Error('A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received');

        // Check if the error suppressor is available
        if (window.extensionErrorSuppressor) {
          const shouldSuppress = window.extensionErrorSuppressor.shouldSuppress(error);
          if (shouldSuppress) {
            result.className = 'test-result success';
            result.textContent = 'âœ… æ‰©å±•é”™è¯¯æŠ‘åˆ¶å™¨æ­£å¸¸å·¥ä½œï¼ŒæˆåŠŸè¯†åˆ«å¹¶æŠ‘åˆ¶äº†æ‰©å±•é”™è¯¯';
            results.extensionError = true;
          } else {
            result.className = 'test-result error';
            result.textContent = 'âŒ æ‰©å±•é”™è¯¯æŠ‘åˆ¶å™¨æœªèƒ½è¯†åˆ«æ‰©å±•é”™è¯¯';
            results.extensionError = false;
          }
        } else {
          result.className = 'test-result error';
          result.textContent = 'âŒ æ‰©å±•é”™è¯¯æŠ‘åˆ¶å™¨æœªåˆå§‹åŒ–';
          results.extensionError = false;
        }
      } catch (e) {
        result.className = 'test-result error';
        result.textContent = 'âŒ æµ‹è¯•æ‰©å±•é”™è¯¯æŠ‘åˆ¶å™¨æ—¶å‘ç”Ÿå¼‚å¸¸: ' + e.message;
        results.extensionError = false;
      }

      updateSummary();
    }

    function updateSummary() {
      // Check if all tests have completed
      const defaultResult = document.getElementById('default-avatar-result');
      const brokenResult = document.getElementById('broken-avatar-result');
      const fileResult = document.getElementById('file-preview-result');
      const extensionResult = document.getElementById('extension-error-result');

      if (defaultResult.textContent && brokenResult.textContent && fileResult.textContent) {
        const summary = document.getElementById('summary');

        const successCount = document.querySelectorAll('.test-result.success').length;
        const totalTests = extensionResult.textContent ? 4 : 3; // Include extension test if it has been run

        if (successCount === totalTests) {
          summary.className = 'test-result success';
          summary.innerHTML = `
                        <h4>ğŸ‰ æ‰€æœ‰ä¿®å¤æµ‹è¯•é€šè¿‡ï¼</h4>
                        <ul>
                            <li>âœ… é»˜è®¤å¤´åƒSVGåˆ›å»ºæˆåŠŸ</li>
                            <li>âœ… å¤´åƒé”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸</li>
                            <li>âœ… æ–‡ä»¶é¢„è§ˆç»„ä»¶å·¥ä½œæ­£å¸¸</li>
                            <li>âœ… Avatarç»„ä»¶å·²åˆ›å»ºå¹¶é›†æˆ</li>
                            ${extensionResult.textContent ? '<li>âœ… æ‰©å±•é”™è¯¯æŠ‘åˆ¶å™¨æ­£å¸¸å·¥ä½œ</li>' : ''}
                        </ul>
                        <p><strong>ä¿®å¤å†…å®¹ï¼š</strong></p>
                        <ul>
                            <li>åˆ›å»ºäº†ç”Ÿäº§çº§åˆ«çš„Avatarç»„ä»¶ï¼Œæ”¯æŒé”™è¯¯å¤„ç†å’Œä¼˜é›…é™çº§</li>
                            <li>æ·»åŠ äº†é»˜è®¤å¤´åƒSVGæ–‡ä»¶</li>
                            <li>æ›´æ–°äº†DiscordMessageItemä½¿ç”¨Avatarç»„ä»¶</li>
                            <li>å¢å¼ºäº†FilePreviewç»„ä»¶çš„å›¾ç‰‡é”™è¯¯å¤„ç†</li>
                            <li>æ›´æ–°äº†UserBottomBarä½¿ç”¨Avatarç»„ä»¶</li>
                            <li>é›†æˆäº†æ‰©å±•é”™è¯¯æŠ‘åˆ¶å™¨ï¼Œæ¶ˆé™¤æµè§ˆå™¨æ‰©å±•äº§ç”Ÿçš„æ§åˆ¶å°é”™è¯¯</li>
                            <li>ä¿®å¤äº†Vueç¼–è¯‘å™¨å®è­¦å‘Š</li>
                        </ul>
                    `;
        } else {
          summary.className = 'test-result error';
          summary.innerHTML = `
                        <h4>âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ (${successCount}/${totalTests})</h4>
                        <p>éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥æœªé€šè¿‡çš„æµ‹è¯•é¡¹ã€‚</p>
                    `;
        }
      }
    }

    // Start tests after page load
    window.addEventListener('load', function () {
      console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹å¤´åƒæµ‹è¯•...');
    });
  </script>
</body>

</html>