<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Upload Response Debug Tool</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }

    .container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 30px;
      font-style: italic;
    }

    .debug-section {
      background: #f8fafc;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #3182ce;
    }

    .button {
      background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .results {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 500px;
      overflow-y: auto;
    }

    .info {
      background: #ebf8ff;
      color: #2a4365;
      border: 1px solid #90cdf4;
    }

    .success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .warning {
      background: #fffaf0;
      color: #744210;
      border: 1px solid #f6ad55;
    }

    .file-input {
      margin: 10px 0;
      padding: 10px;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
    }

    .response-viewer {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”¬ æ–‡ä»¶ä¸Šä¼ å“åº”è°ƒè¯•å·¥å…·</h1>
    <p class="subtitle">ä¸“é—¨è°ƒè¯•ChatService.ts:722è¡Œå“åº”è§£æå¤±è´¥é—®é¢˜</p>

    <div class="debug-section">
      <h3>ğŸ“ æµ‹è¯•æ–‡ä»¶é€‰æ‹©</h3>
      <div class="file-input" onclick="document.getElementById('file-input').click()">
        <input type="file" id="file-input" style="display: none;" onchange="handleFileSelect(event)">
        ğŸ“ ç‚¹å‡»é€‰æ‹©æµ‹è¯•æ–‡ä»¶
      </div>
      <div id="file-info" style="margin-top: 10px;"></div>
    </div>

    <div class="debug-section">
      <h3>ğŸ” é€æ­¥è°ƒè¯•æµ‹è¯•</h3>
      <button class="button" onclick="testStep1()">1ï¸âƒ£ æµ‹è¯•åŸå§‹è¯·æ±‚</button>
      <button class="button" onclick="testStep2()">2ï¸âƒ£ æµ‹è¯•axiosè°ƒç”¨</button>
      <button class="button" onclick="testStep3()">3ï¸âƒ£ æ¨¡æ‹ŸChatServiceé€»è¾‘</button>
      <button class="button" onclick="testStep4()">4ï¸âƒ£ å®Œæ•´æµç¨‹æµ‹è¯•</button>
      <div id="debug-results" class="results info" style="display: none;"></div>
    </div>

    <div class="debug-section">
      <h3>ğŸ“Š å“åº”è¯¦ç»†åˆ†æ</h3>
      <div id="response-analysis" style="display: none;">
        <h4>åŸå§‹å“åº”:</h4>
        <div id="raw-response" class="response-viewer"></div>
        <h4>è§£æçŠ¶æ€:</h4>
        <div id="parse-status" class="response-viewer"></div>
      </div>
    </div>

    <div class="debug-section">
      <h3>ğŸ› ï¸ ä¿®å¤ç­–ç•¥</h3>
      <div id="fix-strategy" style="display: none;"></div>
    </div>
  </div>

  <script>
    let selectedFile = null;
    let lastResponse = null;

    function log(message, type = 'info') {
      const container = document.getElementById('debug-results');
      container.style.display = 'block';
      container.className = `results ${type}`;
      container.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
      container.scrollTop = container.scrollHeight;
    }

    function clear() {
      document.getElementById('debug-results').textContent = '';
    }

    function handleFileSelect(event) {
      selectedFile = event.target.files[0];
      if (selectedFile) {
        document.getElementById('file-info').innerHTML = `
                    <strong>å·²é€‰æ‹©:</strong> ${selectedFile.name}<br>
                    <strong>å¤§å°:</strong> ${selectedFile.size} bytes<br>
                    <strong>ç±»å‹:</strong> ${selectedFile.type}
                `;
      }
    }

    // æ­¥éª¤1: æµ‹è¯•åŸå§‹è¯·æ±‚
    async function testStep1() {
      if (!selectedFile) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      clear();
      log('ğŸš€ æ­¥éª¤1: æµ‹è¯•åŸå§‹fetchè¯·æ±‚', 'info');

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        const authToken = localStorage.getItem('auth_token');
        const headers = {};
        if (authToken) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }

        log(`ğŸ“¤ å‘é€POST /api/files/singleè¯·æ±‚...`, 'info');
        log(`ğŸ“Š æ–‡ä»¶: ${selectedFile.name} (${selectedFile.size} bytes)`, 'info');
        log(`ğŸ“Š è®¤è¯: ${authToken ? 'å·²é…ç½®' : 'æœªé…ç½®'}`, 'info');

        const response = await fetch('/api/files/single', {
          method: 'POST',
          body: formData,
          headers: headers
        });

        log(`âœ… è¯·æ±‚å‘é€æˆåŠŸ`, 'success');
        log(`ğŸ“Š çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
        log(`ğŸ“Š Content-Type: ${response.headers.get('content-type')}`, 'info');

        // è¯»å–å“åº”
        const responseText = await response.text();
        log(`ğŸ“Š å“åº”é•¿åº¦: ${responseText.length} å­—ç¬¦`, 'info');

        // æ˜¾ç¤ºåŸå§‹å“åº”
        document.getElementById('raw-response').textContent = responseText;
        document.getElementById('response-analysis').style.display = 'block';

        lastResponse = {
          status: response.status,
          statusText: response.statusText,
          headers: Object.fromEntries(response.headers.entries()),
          text: responseText
        };

        // å°è¯•JSONè§£æ
        try {
          const jsonData = JSON.parse(responseText);
          log(`âœ… JSONè§£ææˆåŠŸ`, 'success');
          log(`ğŸ“Š æ•°æ®ç»“æ„: ${JSON.stringify(jsonData, null, 2)}`, 'success');

          lastResponse.json = jsonData;

        } catch (jsonError) {
          log(`âŒ JSONè§£æå¤±è´¥: ${jsonError.message}`, 'error');
          log(`ğŸ“Š è¿™å¯èƒ½æ˜¯é—®é¢˜æ ¹æºï¼`, 'error');
        }

      } catch (error) {
        log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ­¥éª¤2: æµ‹è¯•axiosè°ƒç”¨
    async function testStep2() {
      if (!selectedFile) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      clear();
      log('ğŸ”— æ­¥éª¤2: æµ‹è¯•axiosè°ƒç”¨ (æ¨¡æ‹ŸChatService)', 'info');

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        log(`ğŸ“¤ ä½¿ç”¨axioså‘é€è¯·æ±‚...`, 'info');

        // åŠ¨æ€å¯¼å…¥api.js
        const { default: api } = await import('/src/services/api.js');

        const response = await api.post('/files/single', formData, {
          headers: {
            'Content-Type': 'multipart/form-data',
          },
          timeout: 30000,
        });

        log(`âœ… Axiosè¯·æ±‚æˆåŠŸ`, 'success');
        log(`ğŸ“Š Status: ${response.status}`, 'success');
        log(`ğŸ“Š Response data:`, 'info');
        log(`${JSON.stringify(response.data, null, 2)}`, 'info');

        // åˆ†æaxioså“åº”ç»“æ„
        const parseStatus = {
          hasData: !!response.data,
          hasSuccess: response.data && 'success' in response.data,
          successValue: response.data && response.data.success,
          hasDataField: response.data && 'data' in response.data,
          dataValue: response.data && response.data.data
        };

        document.getElementById('parse-status').textContent = JSON.stringify(parseStatus, null, 2);

        log(`ğŸ“Š è§£æçŠ¶æ€æ£€æŸ¥:`, 'info');
        log(`   response.data: ${!!response.data}`, 'info');
        log(`   response.data.success: ${parseStatus.successValue}`, 'info');
        log(`   response.data.data: ${!!parseStatus.dataValue}`, 'info');

        lastResponse = response;

      } catch (error) {
        log(`âŒ Axiosè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
        if (error.response) {
          log(`ğŸ“Š é”™è¯¯çŠ¶æ€: ${error.response.status}`, 'error');
          log(`ğŸ“Š é”™è¯¯æ•°æ®: ${JSON.stringify(error.response.data, null, 2)}`, 'error');
        }
      }
    }

    // æ­¥éª¤3: æ¨¡æ‹ŸChatServiceé€»è¾‘
    async function testStep3() {
      if (!lastResponse) {
        alert('è¯·å…ˆè¿è¡Œæ­¥éª¤2');
        return;
      }

      clear();
      log('ğŸ”¬ æ­¥éª¤3: æ¨¡æ‹ŸChatService.uploadFileè§£æé€»è¾‘', 'info');

      try {
        const response = lastResponse;

        log(`ğŸ“Š å¼€å§‹æ¨¡æ‹ŸChatService.ts:722è¡Œé™„è¿‘çš„é€»è¾‘...`, 'info');
        log(`ğŸ“Š æ£€æŸ¥æ¡ä»¶: response.data.success && response.data.data`, 'info');

        // æ¨¡æ‹ŸChatServiceçš„æ£€æŸ¥é€»è¾‘
        log(`ğŸ“Š response.data.success = ${response.data.success}`, 'info');
        log(`ğŸ“Š response.data.data = ${JSON.stringify(response.data.data)}`, 'info');

        if (response.data.success && response.data.data) {
          const uploadData = response.data.data;
          log(`âœ… æ¡ä»¶æ£€æŸ¥é€šè¿‡`, 'success');
          log(`ğŸ“Š ä¸Šä¼ æ•°æ®: ${JSON.stringify(uploadData, null, 2)}`, 'success');

          // æ£€æŸ¥å¿…éœ€å­—æ®µ
          const requiredFields = ['id', 'filename', 'url', 'mime_type', 'size', 'created_at'];
          const missingFields = requiredFields.filter(field => !uploadData[field]);

          if (missingFields.length === 0) {
            // è½¬æ¢ä¸ºå‰ç«¯æœŸæœ›æ ¼å¼
            const result = {
              id: uploadData.id,
              filename: uploadData.filename,
              url: uploadData.url,
              mime_type: uploadData.mime_type,
              size: uploadData.size,
              created_at: uploadData.created_at
            };

            log(`âœ… è½¬æ¢æˆåŠŸ: ${JSON.stringify(result, null, 2)}`, 'success');
            log(`ğŸ‰ ChatServiceé€»è¾‘åº”è¯¥æ­£å¸¸å·¥ä½œ!`, 'success');

          } else {
            log(`âŒ ç¼ºå¤±å¿…éœ€å­—æ®µ: ${missingFields.join(', ')}`, 'error');
            generateFixStrategy('missing_fields', missingFields);
          }

        } else {
          log(`âŒ æ¡ä»¶æ£€æŸ¥å¤±è´¥ - è¿™å°±æ˜¯722è¡ŒæŠ›å‡ºé”™è¯¯çš„åŸå› !`, 'error');
          log(`ğŸ“Š å¤±è´¥åŸå› åˆ†æ:`, 'error');

          if (!response.data.success) {
            log(`   â€¢ response.data.success = ${response.data.success} (åº”è¯¥ä¸ºtrue)`, 'error');
          }
          if (!response.data.data) {
            log(`   â€¢ response.data.data = ${response.data.data} (åº”è¯¥ä¸ºå¯¹è±¡)`, 'error');
          }

          // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
          if (response.data.error) {
            log(`ğŸ“Š é”™è¯¯ä¿¡æ¯: ${JSON.stringify(response.data.error)}`, 'error');
            log(`âŒ è¿™ä¸ªé”™è¯¯ä¼šåœ¨722è¡Œè¢«æŠ›å‡º: "${response.data.error.message || 'File upload failed'}"`, 'error');
          } else {
            log(`âŒ åœ¨722è¡Œä¼šæŠ›å‡ºé»˜è®¤é”™è¯¯: "File upload failed"`, 'error');
          }

          generateFixStrategy('response_format', response.data);
        }

      } catch (error) {
        log(`âŒ æ¨¡æ‹Ÿé€»è¾‘å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ­¥éª¤4: å®Œæ•´æµç¨‹æµ‹è¯•
    async function testStep4() {
      if (!selectedFile) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      clear();
      log('ğŸ”„ æ­¥éª¤4: å®Œæ•´æµç¨‹æµ‹è¯• (æ¨¡æ‹ŸçœŸå®ä¸Šä¼ )', 'info');

      try {
        // å®Œå…¨æ¨¡æ‹ŸChatService.uploadFileçš„é€»è¾‘
        const formData = new FormData();
        formData.append('file', selectedFile);

        const uploadConfig = {
          maxRetries: 3,
          retryDelay: 1000,
          timeout: 30000,
          maxFileSize: 2 * 1024 * 1024
        };

        // æ–‡ä»¶å¤§å°æ£€æŸ¥
        if (selectedFile.size > uploadConfig.maxFileSize) {
          log(`âŒ æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥: ${selectedFile.size} > ${uploadConfig.maxFileSize}`, 'error');
          return;
        }

        log(`âœ… æ–‡ä»¶å¤§å°æ£€æŸ¥é€šè¿‡`, 'success');

        // ç½‘ç»œå¥åº·æ£€æŸ¥
        log(`ğŸ” æ‰§è¡Œç½‘ç»œå¥åº·æ£€æŸ¥...`, 'info');
        try {
          const healthResponse = await fetch('/health', { method: 'GET' });
          if (healthResponse.ok) {
            log(`âœ… ç½‘ç»œå¥åº·æ£€æŸ¥é€šè¿‡`, 'success');
          } else {
            log(`âš ï¸ ç½‘ç»œå¥åº·æ£€æŸ¥è­¦å‘Š: ${healthResponse.status}`, 'warning');
          }
        } catch (healthError) {
          log(`âŒ ç½‘ç»œå¥åº·æ£€æŸ¥å¤±è´¥: ${healthError.message}`, 'error');
        }

        // æ‰§è¡Œä¸Šä¼ 
        log(`ğŸ“¤ æ‰§è¡Œå®é™…ä¸Šä¼ ...`, 'info');

        const { default: api } = await import('/src/services/api.js');

        const response = await api.post('/files/single', formData, {
          headers: {
            'Content-Type': 'multipart/form-data',
          },
          timeout: uploadConfig.timeout,
        });

        // å®Œå…¨æŒ‰ç…§ChatServiceé€»è¾‘å¤„ç†å“åº”
        if (response.data.success && response.data.data) {
          const uploadData = response.data.data;
          log(`âœ… ä¸Šä¼ æˆåŠŸ: ${selectedFile.name} -> ${uploadData.url}`, 'success');

          const result = {
            id: uploadData.id,
            filename: uploadData.filename,
            url: uploadData.url,
            mime_type: uploadData.mime_type,
            size: uploadData.size,
            created_at: uploadData.created_at
          };

          log(`ğŸ‰ å®Œæ•´æµç¨‹æˆåŠŸ! è¿”å›æ•°æ®:`, 'success');
          log(`${JSON.stringify(result, null, 2)}`, 'success');

        } else {
          log(`âŒ ä¸Šä¼ å¤±è´¥ - è¿™é‡Œä¼šæŠ›å‡ºé”™è¯¯!`, 'error');
          const errorMessage = response.data.error?.message || 'File upload failed';
          log(`ğŸ“Š é”™è¯¯ä¿¡æ¯: ${errorMessage}`, 'error');
          log(`ğŸ“Š è¿™å°±æ˜¯ChatService.ts:722è¡ŒæŠ›å‡ºçš„é”™è¯¯!`, 'error');

          generateFixStrategy('upload_failed', {
            response: response.data,
            error: errorMessage
          });
        }

      } catch (error) {
        log(`âŒ å®Œæ•´æµç¨‹å¤±è´¥: ${error.message}`, 'error');

        // åˆ†æé”™è¯¯ç±»å‹
        if (!error.response) {
          log(`ğŸ“Š è¿™æ˜¯ç½‘ç»œé”™è¯¯`, 'error');
        } else {
          log(`ğŸ“Š è¿™æ˜¯æœåŠ¡å™¨é”™è¯¯: ${error.response.status}`, 'error');
          log(`ğŸ“Š é”™è¯¯æ•°æ®: ${JSON.stringify(error.response.data, null, 2)}`, 'error');
        }
      }
    }

    // ç”Ÿæˆä¿®å¤ç­–ç•¥
    function generateFixStrategy(problemType, data) {
      const fixSection = document.getElementById('fix-strategy');
      let fixContent = '';

      switch (problemType) {
        case 'response_format':
          fixContent = `
                        <h4>ğŸ”§ å“åº”æ ¼å¼é—®é¢˜ä¿®å¤ç­–ç•¥</h4>
                        <p><strong>é—®é¢˜:</strong> åç«¯å“åº”æ ¼å¼ä¸ç¬¦åˆå‰ç«¯æœŸæœ›</p>
                        <p><strong>å½“å‰å“åº”:</strong> <code>${JSON.stringify(data, null, 2)}</code></p>
                        <p><strong>ä¿®å¤æ–¹æ¡ˆ:</strong></p>
                        <ol>
                            <li>æ£€æŸ¥åç«¯APIæ˜¯å¦æ­£ç¡®è¿”å› <code>{ success: true, data: {...} }</code> æ ¼å¼</li>
                            <li>æˆ–è€…ä¿®æ”¹å‰ç«¯è§£æé€»è¾‘ä»¥é€‚åº”å®é™…å“åº”æ ¼å¼</li>
                            <li>ç¡®è®¤Gatewayè·¯ç”±æ­£ç¡®è½¬å‘åˆ°æ–‡ä»¶æœåŠ¡</li>
                        </ol>
                        <pre>
// ä¸´æ—¶ä¿®å¤ - åœ¨ChatService.tsä¸­æ·»åŠ å…¼å®¹æ€§æ£€æŸ¥
if (response.data) {
    // æ£€æŸ¥æ–°æ ¼å¼
    if (response.data.success && response.data.data) {
        return response.data.data;
    }
    // æ£€æŸ¥æ—§æ ¼å¼æˆ–ç›´æ¥è¿”å›æ ¼å¼
    if (response.data.url) {
        return response.data;
    }
}
                        </pre>
                    `;
          break;

        case 'missing_fields':
          fixContent = `
                        <h4>ğŸ”§ ç¼ºå¤±å­—æ®µé—®é¢˜ä¿®å¤ç­–ç•¥</h4>
                        <p><strong>é—®é¢˜:</strong> å“åº”æ•°æ®ç¼ºå¤±å¿…éœ€å­—æ®µ: ${data.join(', ')}</p>
                        <p><strong>ä¿®å¤æ–¹æ¡ˆ:</strong></p>
                        <ol>
                            <li>æ£€æŸ¥åç«¯æ–‡ä»¶æœåŠ¡æ˜¯å¦æ­£ç¡®è®¾ç½®æ‰€æœ‰å­—æ®µ</li>
                            <li>ä¸ºç¼ºå¤±å­—æ®µæä¾›é»˜è®¤å€¼</li>
                            <li>æ›´æ–°æ•°æ®åº“schemaç¡®ä¿å­—æ®µå­˜åœ¨</li>
                        </ol>
                    `;
          break;

        case 'upload_failed':
          fixContent = `
                        <h4>ğŸ”§ ä¸Šä¼ å¤±è´¥ä¿®å¤ç­–ç•¥</h4>
                        <p><strong>é—®é¢˜:</strong> ${data.error}</p>
                        <p><strong>åç«¯å“åº”:</strong> <code>${JSON.stringify(data.response, null, 2)}</code></p>
                        <p><strong>ä¿®å¤æ–¹æ¡ˆ:</strong></p>
                        <ol>
                            <li>æ£€æŸ¥åç«¯æ–‡ä»¶æœåŠ¡æ—¥å¿—</li>
                            <li>éªŒè¯æ–‡ä»¶å­˜å‚¨é…ç½®</li>
                            <li>ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸</li>
                            <li>æ£€æŸ¥æ–‡ä»¶æƒé™å’Œç£ç›˜ç©ºé—´</li>
                        </ol>
                    `;
          break;
      }

      fixSection.innerHTML = fixContent;
      fixSection.style.display = 'block';
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      log('ğŸ¯ æ–‡ä»¶ä¸Šä¼ å“åº”è°ƒè¯•å·¥å…·å·²å°±ç»ª', 'info');
      log('ğŸ’¡ è¯·é€‰æ‹©æ–‡ä»¶å¹¶æŒ‰é¡ºåºè¿è¡Œæµ‹è¯•æ­¥éª¤', 'info');
    });
  </script>
</body>

</html>