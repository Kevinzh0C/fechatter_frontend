<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ–¼ï¸ å›¾ç‰‡æ˜¾ç¤ºé—®é¢˜è¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .content {
      padding: 30px;
    }

    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #007bff;
    }

    .diagnostic-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e9ecef;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .results {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-family: monospace;
      font-size: 0.875rem;
      white-space: pre-wrap;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
    }

    .status-success {
      color: #28a745;
      font-weight: bold;
    }

    .status-warning {
      color: #ffc107;
      font-weight: bold;
    }

    .status-error {
      color: #dc3545;
      font-weight: bold;
    }

    .status-info {
      color: #17a2b8;
      font-weight: bold;
    }

    .file-preview {
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      background: white;
    }

    .auto-refresh {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 25px;
      font-size: 0.875rem;
    }
  </style>
</head>

<body>
  <div class="auto-refresh" id="autoRefresh">
    ğŸ” å®æ—¶ç›‘æ§ä¸­...
  </div>

  <div class="container">
    <div class="header">
      <h1>ğŸ–¼ï¸ å›¾ç‰‡æ˜¾ç¤ºé—®é¢˜è¯Šæ–­</h1>
      <p>ä¸“é—¨æ£€æŸ¥ä¸ºä»€ä¹ˆå›¾ç‰‡ä¸æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºæ–‡ä»¶hashçš„é—®é¢˜</p>
    </div>

    <div class="content">
      <!-- å¿«é€Ÿé—®é¢˜è¯Šæ–­ -->
      <div class="section">
        <h2>ğŸ¯ å¿«é€Ÿé—®é¢˜è¯Šæ–­</h2>

        <div class="diagnostic-card">
          <h3>é—®é¢˜æè¿°</h3>
          <p>æ¶ˆæ¯æ˜¾ç¤º: <code>âœ… 60c155658fcb1ef14145b5c9e359a571c504b8e1a7449d0</code></p>
          <p>æœŸæœ›æ˜¾ç¤º: å›¾ç‰‡ç¼©ç•¥å›¾</p>
          <p>âœ… SSEé€è¾¾çŠ¶æ€æ­£å¸¸ï¼ˆç»¿è‰²å¯¹å·æ˜¾ç¤ºï¼‰</p>
          <p>âŒ å›¾ç‰‡æœªæ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæ–‡ä»¶hashï¼‰</p>
        </div>

        <div class="diagnostic-card">
          <h3>å¯èƒ½åŸå› </h3>
          <ul>
            <li>æ¶ˆæ¯çš„ <code>files</code> å­—æ®µä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯</li>
            <li>DiscordMessageItem æ–‡ä»¶æ˜¾ç¤ºæ¨¡æ¿æœªè§¦å‘</li>
            <li>æ–‡ä»¶ç±»å‹æ£€æµ‹å¤±è´¥</li>
            <li>CSS éšè—äº†å›¾ç‰‡å…ƒç´ </li>
            <li>æ–‡ä»¶URLæ ¼å¼é—®é¢˜</li>
          </ul>
        </div>
      </div>

      <!-- è¯¦ç»†æ£€æŸ¥ -->
      <div class="section">
        <h2>ğŸ” è¯¦ç»†æ£€æŸ¥æ­¥éª¤</h2>

        <div class="diagnostic-card">
          <h3>1. æ£€æŸ¥æœ€æ–°æ¶ˆæ¯æ•°æ®ç»“æ„</h3>
          <button class="btn" onclick="checkLatestMessage()">æ£€æŸ¥æ¶ˆæ¯æ•°æ®</button>
          <div id="messageDataResults" class="results"></div>
        </div>

        <div class="diagnostic-card">
          <h3>2. æ£€æŸ¥DOMå…ƒç´ ç»“æ„</h3>
          <button class="btn" onclick="checkDOMStructure()">æ£€æŸ¥DOM</button>
          <div id="domStructureResults" class="results"></div>
        </div>

        <div class="diagnostic-card">
          <h3>3. æ£€æŸ¥æ–‡ä»¶æ˜¾ç¤ºé€»è¾‘</h3>
          <button class="btn" onclick="checkFileDisplayLogic()">æ£€æŸ¥æ˜¾ç¤ºé€»è¾‘</button>
          <div id="fileLogicResults" class="results"></div>
        </div>

        <div class="diagnostic-card">
          <h3>4. æ£€æŸ¥CSSæ ·å¼</h3>
          <button class="btn" onclick="checkCSSStyles()">æ£€æŸ¥æ ·å¼</button>
          <div id="cssResults" class="results"></div>
        </div>
      </div>

      <!-- ä¿®å¤å·¥å…· -->
      <div class="section">
        <h2>ğŸ”§ ä¿®å¤å·¥å…·</h2>

        <div class="diagnostic-card">
          <h3>å¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡</h3>
          <button class="btn" onclick="forceDisplayImages()">å¼ºåˆ¶æ˜¾ç¤º</button>
          <div id="forceDisplayResults" class="results"></div>
        </div>

        <div class="diagnostic-card">
          <h3>æ³¨å…¥æµ‹è¯•å›¾ç‰‡</h3>
          <button class="btn" onclick="injectTestImage()">æ³¨å…¥æµ‹è¯•</button>
          <div id="testImageResults" class="results"></div>
        </div>

        <div class="diagnostic-card">
          <h3>ä¿®å¤æ¶ˆæ¯æ•°æ®</h3>
          <button class="btn" onclick="fixMessageData()">ä¿®å¤æ•°æ®</button>
          <div id="fixDataResults" class="results"></div>
        </div>
      </div>

      <!-- å®æ—¶ç›‘æ§ -->
      <div class="section">
        <h2>ğŸ“Š å®æ—¶ç›‘æ§æ•°æ®</h2>
        <div id="liveMonitoring" class="results"></div>
      </div>
    </div>
  </div>

  <script>
    let monitoringData = {};

    // 1. æ£€æŸ¥æœ€æ–°æ¶ˆæ¯æ•°æ®ç»“æ„
    function checkLatestMessage() {
      const results = document.getElementById('messageDataResults');
      results.textContent = 'æ­£åœ¨æ£€æŸ¥æœ€æ–°æ¶ˆæ¯æ•°æ®...\n\n';

      try {
        // æ–¹æ³•1: ä»DOMè·å–æ¶ˆæ¯å…ƒç´ 
        const messageElements = document.querySelectorAll('[data-message-id]');
        const latestMessageElement = messageElements[messageElements.length - 1];

        if (latestMessageElement) {
          const messageId = latestMessageElement.getAttribute('data-message-id');
          results.textContent += `âœ… æ‰¾åˆ°æœ€æ–°æ¶ˆæ¯å…ƒç´ : ID=${messageId}\n`;

          // æ£€æŸ¥æ¶ˆæ¯å†…å®¹
          const contentElement = latestMessageElement.querySelector('.content-wrapper, .message-content');
          if (contentElement) {
            results.textContent += `ğŸ“ æ¶ˆæ¯å†…å®¹: ${contentElement.textContent.substring(0, 100)}...\n`;
          }

          // æ£€æŸ¥æ–‡ä»¶å®¹å™¨
          const fileContainer = latestMessageElement.querySelector('.message-files');
          results.textContent += `ğŸ“ æ–‡ä»¶å®¹å™¨å­˜åœ¨: ${!!fileContainer}\n`;

          if (fileContainer) {
            const fileElements = fileContainer.querySelectorAll('.file-attachment');
            results.textContent += `ğŸ“ æ–‡ä»¶é™„ä»¶æ•°é‡: ${fileElements.length}\n`;

            fileElements.forEach((file, index) => {
              const img = file.querySelector('img');
              const fileName = file.querySelector('.file-name');
              results.textContent += `  æ–‡ä»¶ ${index + 1}:\n`;
              results.textContent += `    - å›¾ç‰‡å…ƒç´ : ${!!img}\n`;
              results.textContent += `    - æ–‡ä»¶å: ${fileName ? fileName.textContent : 'æœªæ‰¾åˆ°'}\n`;
              if (img) {
                results.textContent += `    - å›¾ç‰‡æº: ${img.src}\n`;
                results.textContent += `    - å›¾ç‰‡åŠ è½½: ${img.complete}\n`;
              }
            });
          }
        } else {
          results.textContent += 'âŒ æœªæ‰¾åˆ°æ¶ˆæ¯å…ƒç´ \n';
        }

        // æ–¹æ³•2: ä»å…¨å±€çŠ¶æ€è·å–
        if (window.chatStore || window.$nuxt || window.Vue) {
          results.textContent += '\nğŸ” å°è¯•ä»å…¨å±€çŠ¶æ€è·å–æ¶ˆæ¯æ•°æ®...\n';

          // å°è¯•å„ç§å¯èƒ½çš„å…¨å±€çŠ¶æ€
          const possibleStores = [
            'window.chatStore',
            'window.$nuxt.$store',
            'window.Vue?.$store',
            'window.app?.$store'
          ];

          possibleStores.forEach(storePath => {
            try {
              const store = eval(storePath);
              if (store && store.messages) {
                const messages = store.messages;
                const latestMessage = messages[messages.length - 1];
                results.textContent += `âœ… ä» ${storePath} è·å–åˆ° ${messages.length} æ¡æ¶ˆæ¯\n`;

                if (latestMessage) {
                  results.textContent += `ğŸ“‹ æœ€æ–°æ¶ˆæ¯æ•°æ®:\n`;
                  results.textContent += `  - ID: ${latestMessage.id || latestMessage.temp_id}\n`;
                  results.textContent += `  - å†…å®¹: ${(latestMessage.content || '').substring(0, 50)}\n`;
                  results.textContent += `  - æ–‡ä»¶æ•°ç»„: ${JSON.stringify(latestMessage.files || [], null, 2)}\n`;
                  results.textContent += `  - çŠ¶æ€: ${latestMessage.status}\n`;
                }
              }
            } catch (e) {
              // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
            }
          });
        }

        // æ–¹æ³•3: æ£€æŸ¥localStorage
        const chatData = localStorage.getItem('chat-messages') || localStorage.getItem('messages');
        if (chatData) {
          try {
            const parsed = JSON.parse(chatData);
            results.textContent += `\nğŸ’¾ localStorageä¸­æ‰¾åˆ°èŠå¤©æ•°æ®\n`;
            results.textContent += `ğŸ“Š æ•°æ®ç»“æ„: ${JSON.stringify(parsed, null, 2).substring(0, 200)}...\n`;
          } catch (e) {
            results.textContent += `\nâŒ localStorageæ•°æ®è§£æå¤±è´¥: ${e.message}\n`;
          }
        }

      } catch (error) {
        results.textContent += `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
        console.error('Message check error:', error);
      }
    }

    // 2. æ£€æŸ¥DOMç»“æ„
    function checkDOMStructure() {
      const results = document.getElementById('domStructureResults');
      results.textContent = 'æ­£åœ¨æ£€æŸ¥DOMç»“æ„...\n\n';

      try {
        // æ£€æŸ¥æ¶ˆæ¯å®¹å™¨
        const messageContainers = document.querySelectorAll('.message-list, .messages-container, .chat-messages, .simple-message-list');
        results.textContent += `ğŸ“¦ æ¶ˆæ¯å®¹å™¨æ•°é‡: ${messageContainers.length}\n`;

        messageContainers.forEach((container, index) => {
          const messages = container.querySelectorAll('[data-message-id]');
          results.textContent += `  å®¹å™¨ ${index + 1}: ${messages.length} æ¡æ¶ˆæ¯\n`;
        });

        // æ£€æŸ¥æœ€æ–°çš„å‡ æ¡æ¶ˆæ¯
        const allMessages = document.querySelectorAll('[data-message-id]');
        results.textContent += `\nğŸ“¨ æ€»æ¶ˆæ¯æ•°é‡: ${allMessages.length}\n`;

        // æ£€æŸ¥æœ€æ–°çš„3æ¡æ¶ˆæ¯
        const recentMessages = Array.from(allMessages).slice(-3);
        results.textContent += `\nğŸ” æœ€æ–°3æ¡æ¶ˆæ¯è¯¦æƒ…:\n`;

        recentMessages.forEach((msg, index) => {
          const id = msg.getAttribute('data-message-id');
          const hasFiles = !!msg.querySelector('.message-files');
          const fileCount = msg.querySelectorAll('.file-attachment').length;
          const imageCount = msg.querySelectorAll('.attachment-image, img').length;

          results.textContent += `  æ¶ˆæ¯ ${index + 1} (ID: ${id}):\n`;
          results.textContent += `    - æœ‰æ–‡ä»¶å®¹å™¨: ${hasFiles}\n`;
          results.textContent += `    - æ–‡ä»¶é™„ä»¶æ•°: ${fileCount}\n`;
          results.textContent += `    - å›¾ç‰‡æ•°é‡: ${imageCount}\n`;

          // æ£€æŸ¥æ¶ˆæ¯å†…å®¹
          const content = msg.querySelector('.content-wrapper, .message-content');
          if (content) {
            const text = content.textContent.trim();
            results.textContent += `    - å†…å®¹: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"\n`;

            // ç‰¹åˆ«æ£€æŸ¥æ˜¯å¦åªæ˜¾ç¤ºhash
            if (/^[a-f0-9]{40}$/.test(text.trim())) {
              results.textContent += `    âš ï¸ æ£€æµ‹åˆ°æ–‡ä»¶hashæ˜¾ç¤º: ${text}\n`;
            }
          }
        });

        // æ£€æŸ¥å…³é”®CSSç±»
        const importantClasses = [
          '.message-files',
          '.file-attachment',
          '.attachment-image',
          '.image-attachment',
          '.generic-file-attachment'
        ];

        results.textContent += `\nğŸ¨ CSSç±»æ£€æŸ¥:\n`;
        importantClasses.forEach(className => {
          const elements = document.querySelectorAll(className);
          results.textContent += `  ${className}: ${elements.length} ä¸ªå…ƒç´ \n`;

          if (elements.length > 0) {
            const style = window.getComputedStyle(elements[0]);
            results.textContent += `    display: ${style.display}, visibility: ${style.visibility}\n`;
          }
        });

      } catch (error) {
        results.textContent += `âŒ DOMæ£€æŸ¥å¤±è´¥: ${error.message}\n`;
        console.error('DOM check error:', error);
      }
    }

    // 3. æ£€æŸ¥æ–‡ä»¶æ˜¾ç¤ºé€»è¾‘
    function checkFileDisplayLogic() {
      const results = document.getElementById('fileLogicResults');
      results.textContent = 'æ­£åœ¨æ£€æŸ¥æ–‡ä»¶æ˜¾ç¤ºé€»è¾‘...\n\n';

      try {
        // æ£€æŸ¥Vueç»„ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½
        const vueElements = document.querySelectorAll('[data-v-]');
        results.textContent += `ğŸ”§ Vueç»„ä»¶å…ƒç´ æ•°é‡: ${vueElements.length}\n`;

        // æ£€æŸ¥æ˜¯å¦æœ‰DiscordMessageItemç»„ä»¶
        const messageItems = document.querySelectorAll('.message-item, .discord-message-item');
        results.textContent += `ğŸ’¬ æ¶ˆæ¯ç»„ä»¶æ•°é‡: ${messageItems.length}\n`;

        // æ¨¡æ‹Ÿæ–‡ä»¶ç±»å‹æ£€æµ‹å‡½æ•°
        const testImageFile = {
          file_name: 'test.png',
          filename: 'test.png',
          mime_type: 'image/png',
          file_url: 'http://example.com/test.png'
        };

        results.textContent += `\nğŸ§ª æµ‹è¯•æ–‡ä»¶ç±»å‹æ£€æµ‹:\n`;
        results.textContent += `æµ‹è¯•æ–‡ä»¶: ${JSON.stringify(testImageFile, null, 2)}\n`;

        // æ¨¡æ‹ŸisImageFileå‡½æ•°
        function testIsImageFile(file) {
          const mimeType = file.mime_type || file.type || '';
          const fileName = file.file_name || file.filename || file.name || '';

          const isMimeImage = mimeType.startsWith('image/');
          const isExtensionImage = /\.(jpg|jpeg|png|gif|webp|svg|bmp|ico|heic|heif)$/i.test(fileName);

          results.textContent += `  MIMEç±»å‹æ£€æŸ¥: ${mimeType} -> ${isMimeImage}\n`;
          results.textContent += `  æ‰©å±•åæ£€æŸ¥: ${fileName} -> ${isExtensionImage}\n`;

          return isMimeImage || isExtensionImage;
        }

        const isImage = testIsImageFile(testImageFile);
        results.textContent += `  æœ€ç»ˆç»“æœ: ${isImage ? 'âœ… æ˜¯å›¾ç‰‡' : 'âŒ ä¸æ˜¯å›¾ç‰‡'}\n`;

        // æ£€æŸ¥å®é™…çš„æ¶ˆæ¯æ•°æ®
        const fileElements = document.querySelectorAll('.file-attachment');
        if (fileElements.length > 0) {
          results.textContent += `\nğŸ“ å®é™…æ–‡ä»¶å…ƒç´ åˆ†æ:\n`;

          fileElements.forEach((elem, index) => {
            const isImageElement = elem.classList.contains('image-attachment') || elem.querySelector('.image-attachment');
            const isGenericElement = elem.classList.contains('generic-file-attachment');
            const hasImage = !!elem.querySelector('img');

            results.textContent += `  æ–‡ä»¶ ${index + 1}:\n`;
            results.textContent += `    - å›¾ç‰‡é™„ä»¶ç±»: ${isImageElement}\n`;
            results.textContent += `    - é€šç”¨æ–‡ä»¶ç±»: ${isGenericElement}\n`;
            results.textContent += `    - åŒ…å«imgæ ‡ç­¾: ${hasImage}\n`;

            if (hasImage) {
              const img = elem.querySelector('img');
              results.textContent += `    - å›¾ç‰‡æº: ${img.src}\n`;
              results.textContent += `    - å›¾ç‰‡çŠ¶æ€: ${img.complete ? 'å·²åŠ è½½' : 'åŠ è½½ä¸­'}\n`;
            }
          });
        }

        // æ£€æŸ¥templateæ¡ä»¶
        results.textContent += `\nğŸ” Templateæ¡ä»¶æ£€æŸ¥:\n`;
        const messagesWithFiles = document.querySelectorAll('[data-message-id]');
        messagesWithFiles.forEach((msg, index) => {
          const messageId = msg.getAttribute('data-message-id');
          const hasFileContainer = !!msg.querySelector('.message-files');
          const fileContainer = msg.querySelector('.message-files');

          if (hasFileContainer) {
            const display = window.getComputedStyle(fileContainer).display;
            const visibility = window.getComputedStyle(fileContainer).visibility;

            results.textContent += `  æ¶ˆæ¯ ${messageId}:\n`;
            results.textContent += `    - æ–‡ä»¶å®¹å™¨æ˜¾ç¤º: ${display}\n`;
            results.textContent += `    - æ–‡ä»¶å®¹å™¨å¯è§æ€§: ${visibility}\n`;
          }
        });

      } catch (error) {
        results.textContent += `âŒ é€»è¾‘æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
        console.error('Logic check error:', error);
      }
    }

    // 4. æ£€æŸ¥CSSæ ·å¼
    function checkCSSStyles() {
      const results = document.getElementById('cssResults');
      results.textContent = 'æ­£åœ¨æ£€æŸ¥CSSæ ·å¼é—®é¢˜...\n\n';

      try {
        // æ£€æŸ¥æ–‡ä»¶ç›¸å…³çš„CSSç±»
        const styleClasses = [
          '.message-files',
          '.file-attachment',
          '.image-attachment',
          '.attachment-image',
          '.generic-file-attachment'
        ];

        results.textContent += 'ğŸ¨ CSSæ ·å¼æ£€æŸ¥:\n';

        styleClasses.forEach(className => {
          const elements = document.querySelectorAll(className);

          if (elements.length > 0) {
            const element = elements[0];
            const style = window.getComputedStyle(element);

            results.textContent += `\n${className} (${elements.length}ä¸ªå…ƒç´ ):\n`;
            results.textContent += `  display: ${style.display}\n`;
            results.textContent += `  visibility: ${style.visibility}\n`;
            results.textContent += `  opacity: ${style.opacity}\n`;
            results.textContent += `  position: ${style.position}\n`;
            results.textContent += `  width: ${style.width}\n`;
            results.textContent += `  height: ${style.height}\n`;
            results.textContent += `  max-width: ${style.maxWidth}\n`;
            results.textContent += `  max-height: ${style.maxHeight}\n`;
            results.textContent += `  overflow: ${style.overflow}\n`;

            // æ£€æŸ¥æ˜¯å¦è¢«éšè—
            const isHidden = style.display === 'none' ||
              style.visibility === 'hidden' ||
              parseFloat(style.opacity) === 0 ||
              style.width === '0px' ||
              style.height === '0px';

            if (isHidden) {
              results.textContent += `  âš ï¸ å…ƒç´ è¢«éšè—ï¼\n`;
            }
          } else {
            results.textContent += `\n${className}: æœªæ‰¾åˆ°å…ƒç´ \n`;
          }
        });

        // æ£€æŸ¥å¯èƒ½çš„æ ·å¼å†²çª
        results.textContent += '\nğŸ” æ ·å¼å†²çªæ£€æŸ¥:\n';

        const fileContainers = document.querySelectorAll('.message-files');
        fileContainers.forEach((container, index) => {
          const parentStyles = window.getComputedStyle(container.parentElement);
          const containerStyles = window.getComputedStyle(container);

          results.textContent += `æ–‡ä»¶å®¹å™¨ ${index + 1}:\n`;
          results.textContent += `  çˆ¶å…ƒç´ overflow: ${parentStyles.overflow}\n`;
          results.textContent += `  å®¹å™¨position: ${containerStyles.position}\n`;
          results.textContent += `  å®¹å™¨z-index: ${containerStyles.zIndex}\n`;
        });

        // æ£€æŸ¥å›¾ç‰‡ç‰¹å®šæ ·å¼
        const images = document.querySelectorAll('.attachment-image, .file-attachment img');
        if (images.length > 0) {
          results.textContent += '\nğŸ“¸ å›¾ç‰‡æ ·å¼æ£€æŸ¥:\n';

          images.forEach((img, index) => {
            const style = window.getComputedStyle(img);
            results.textContent += `  å›¾ç‰‡ ${index + 1}:\n`;
            results.textContent += `    src: ${img.src}\n`;
            results.textContent += `    display: ${style.display}\n`;
            results.textContent += `    width: ${style.width}\n`;
            results.textContent += `    height: ${style.height}\n`;
            results.textContent += `    object-fit: ${style.objectFit}\n`;
            results.textContent += `    border: ${style.border}\n`;
            results.textContent += `    border-radius: ${style.borderRadius}\n`;

            // æ£€æŸ¥å›¾ç‰‡åŠ è½½çŠ¶æ€
            results.textContent += `    complete: ${img.complete}\n`;
            results.textContent += `    naturalWidth: ${img.naturalWidth}\n`;
            results.textContent += `    naturalHeight: ${img.naturalHeight}\n`;
          });
        }

      } catch (error) {
        results.textContent += `âŒ CSSæ£€æŸ¥å¤±è´¥: ${error.message}\n`;
        console.error('CSS check error:', error);
      }
    }

    // ä¿®å¤å·¥å…· - å¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡
    function forceDisplayImages() {
      const results = document.getElementById('forceDisplayResults');
      results.textContent = 'æ­£åœ¨å¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡...\n\n';

      try {
        let fixed = 0;

        // 1. æ˜¾ç¤ºæ‰€æœ‰éšè—çš„æ–‡ä»¶å®¹å™¨
        const hiddenContainers = document.querySelectorAll('.message-files[style*="display: none"], .message-files[style*="visibility: hidden"]');
        hiddenContainers.forEach(container => {
          container.style.display = 'flex';
          container.style.visibility = 'visible';
          container.style.opacity = '1';
          fixed++;
        });
        results.textContent += `âœ… æ˜¾ç¤ºäº† ${hiddenContainers.length} ä¸ªéšè—çš„æ–‡ä»¶å®¹å™¨\n`;

        // 2. å¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡å…ƒç´ 
        const hiddenImages = document.querySelectorAll('img[style*="display: none"], .attachment-image[style*="display: none"]');
        hiddenImages.forEach(img => {
          img.style.display = '';
          img.style.visibility = 'visible';
          img.style.opacity = '1';
          fixed++;
        });
        results.textContent += `âœ… æ˜¾ç¤ºäº† ${hiddenImages.length} ä¸ªéšè—çš„å›¾ç‰‡\n`;

        // 3. ä¿®å¤CSSç±»é—®é¢˜
        const fileAttachments = document.querySelectorAll('.file-attachment');
        fileAttachments.forEach(attachment => {
          if (!attachment.querySelector('img') && !attachment.classList.contains('generic-file-attachment')) {
            // å¯èƒ½æ˜¯åº”è¯¥æ˜¾ç¤ºå›¾ç‰‡ä½†æ²¡æœ‰æ˜¾ç¤ºçš„
            results.textContent += `âš ï¸ å‘ç°å¯èƒ½ç¼ºå°‘å›¾ç‰‡çš„æ–‡ä»¶é™„ä»¶\n`;
          }
        });

        results.textContent += `\nâœ… æ€»å…±ä¿®å¤äº† ${fixed} ä¸ªæ˜¾ç¤ºé—®é¢˜\n`;

        if (fixed === 0) {
          results.textContent += 'ğŸ” æ²¡æœ‰å‘ç°æ˜æ˜¾çš„éšè—å…ƒç´ ï¼Œé—®é¢˜å¯èƒ½åœ¨æ•°æ®å±‚é¢\n';
        }

      } catch (error) {
        results.textContent += `âŒ å¼ºåˆ¶æ˜¾ç¤ºå¤±è´¥: ${error.message}\n`;
        console.error('Force display error:', error);
      }
    }

    // æ³¨å…¥æµ‹è¯•å›¾ç‰‡
    function injectTestImage() {
      const results = document.getElementById('testImageResults');
      results.textContent = 'æ­£åœ¨æ³¨å…¥æµ‹è¯•å›¾ç‰‡...\n\n';

      try {
        // æ‰¾åˆ°æœ€æ–°çš„æ¶ˆæ¯
        const messages = document.querySelectorAll('[data-message-id]');
        const latestMessage = messages[messages.length - 1];

        if (!latestMessage) {
          results.textContent += 'âŒ æœªæ‰¾åˆ°æ¶ˆæ¯å…ƒç´ \n';
          return;
        }

        const messageId = latestMessage.getAttribute('data-message-id');
        results.textContent += `ğŸ¯ ç›®æ ‡æ¶ˆæ¯: ${messageId}\n`;

        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ–‡ä»¶å®¹å™¨
        let fileContainer = latestMessage.querySelector('.message-files');

        if (!fileContainer) {
          // åˆ›å»ºæ–‡ä»¶å®¹å™¨
          fileContainer = document.createElement('div');
          fileContainer.className = 'message-files';
          fileContainer.style.marginTop = '0.75rem';
          fileContainer.style.display = 'flex';
          fileContainer.style.flexDirection = 'column';
          fileContainer.style.gap = '0.5rem';

          // æ’å…¥åˆ°å†…å®¹åé¢
          const contentWrapper = latestMessage.querySelector('.content-wrapper, .message-content');
          if (contentWrapper) {
            contentWrapper.parentNode.insertBefore(fileContainer, contentWrapper.nextSibling);
          } else {
            latestMessage.appendChild(fileContainer);
          }

          results.textContent += 'âœ… åˆ›å»ºäº†æ–‡ä»¶å®¹å™¨\n';
        }

        // åˆ›å»ºæµ‹è¯•å›¾ç‰‡é™„ä»¶
        const testImageAttachment = document.createElement('div');
        testImageAttachment.className = 'file-attachment';
        testImageAttachment.innerHTML = `
                    <div class="image-attachment" style="position: relative; max-width: 400px; max-height: 300px; overflow: hidden; border-radius: 8px; cursor: pointer;">
                        <img src="https://via.placeholder.com/300x200/007bff/ffffff?text=Test+Image" 
                             alt="æµ‹è¯•å›¾ç‰‡" 
                             class="attachment-image"
                             style="width: 100%; height: auto; max-height: 300px; object-fit: cover; transition: transform 0.2s ease;" 
                             loading="lazy" />
                        <div class="image-overlay" style="position: absolute; top: 0; right: 0; padding: 8px; opacity: 0; transition: opacity 0.2s ease;">
                            <button class="download-btn" style="background: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 6px; padding: 6px; cursor: pointer;" title="Download">
                                â¬‡ï¸
                            </button>
                        </div>
                    </div>
                `;

        fileContainer.appendChild(testImageAttachment);

        results.textContent += 'âœ… æ³¨å…¥äº†æµ‹è¯•å›¾ç‰‡\n';
        results.textContent += 'ğŸ–¼ï¸ æµ‹è¯•å›¾ç‰‡åº”è¯¥æ˜¾ç¤ºåœ¨æœ€æ–°æ¶ˆæ¯ä¸­\n';

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        const testImg = testImageAttachment.querySelector('img');
        testImg.addEventListener('click', () => {
          alert('æµ‹è¯•å›¾ç‰‡ç‚¹å‡»äº‹ä»¶æ­£å¸¸å·¥ä½œï¼');
        });

        results.textContent += 'âœ… æ·»åŠ äº†ç‚¹å‡»äº‹ä»¶\n';

      } catch (error) {
        results.textContent += `âŒ æ³¨å…¥å¤±è´¥: ${error.message}\n`;
        console.error('Inject test image error:', error);
      }
    }

    // ä¿®å¤æ¶ˆæ¯æ•°æ®
    function fixMessageData() {
      const results = document.getElementById('fixDataResults');
      results.textContent = 'æ­£åœ¨ä¿®å¤æ¶ˆæ¯æ•°æ®...\n\n';

      try {
        // æŸ¥æ‰¾åªæ˜¾ç¤ºhashçš„æ¶ˆæ¯
        const messages = document.querySelectorAll('[data-message-id]');

        messages.forEach((msg, index) => {
          const messageId = msg.getAttribute('data-message-id');
          const content = msg.querySelector('.content-wrapper, .message-content');

          if (content) {
            const text = content.textContent.trim();

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶hashæ ¼å¼
            if (/^[a-f0-9]{40}$/.test(text)) {
              results.textContent += `ğŸ” å‘ç°hashæ¶ˆæ¯: ${messageId} - ${text}\n`;

              // å°è¯•æ„é€ æ–‡ä»¶æ•°æ®
              const fileHash = text;
              const fileUrl = `/files/${fileHash}.png`; // å‡è®¾æ˜¯PNGæ ¼å¼

              // åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶å®¹å™¨
              let fileContainer = msg.querySelector('.message-files');
              if (!fileContainer) {
                fileContainer = document.createElement('div');
                fileContainer.className = 'message-files';
                fileContainer.style.cssText = 'margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem;';
                content.parentNode.insertBefore(fileContainer, content.nextSibling);
              }

              // åˆ›å»ºå›¾ç‰‡é™„ä»¶
              const imageAttachment = document.createElement('div');
              imageAttachment.className = 'file-attachment';
              imageAttachment.innerHTML = `
                                <div class="image-attachment" style="position: relative; max-width: 400px; max-height: 300px; overflow: hidden; border-radius: 8px; cursor: pointer;">
                                    <img src="${fileUrl}" 
                                         alt="ä¸Šä¼ çš„å›¾ç‰‡" 
                                         class="attachment-image"
                                         style="width: 100%; height: auto; max-height: 300px; object-fit: cover;" 
                                         onerror="this.parentElement.innerHTML='<div style=\"padding: 20px; text-align: center; color: #666;\">ğŸ“¸ å›¾ç‰‡åŠ è½½å¤±è´¥<br/>${fileHash}</div>'"
                                         loading="lazy" />
                                </div>
                            `;

              fileContainer.appendChild(imageAttachment);

              // éšè—åŸå§‹hashæ–‡æœ¬
              content.style.display = 'none';

              results.textContent += `âœ… ä¸ºæ¶ˆæ¯ ${messageId} åˆ›å»ºäº†å›¾ç‰‡æ˜¾ç¤º\n`;
              results.textContent += `ğŸ“¸ å›¾ç‰‡URL: ${fileUrl}\n`;
            }
          }
        });

        results.textContent += '\nâœ… æ•°æ®ä¿®å¤å®Œæˆ\n';

      } catch (error) {
        results.textContent += `âŒ æ•°æ®ä¿®å¤å¤±è´¥: ${error.message}\n`;
        console.error('Fix message data error:', error);
      }
    }

    // å®æ—¶ç›‘æ§
    function updateLiveMonitoring() {
      const monitoring = document.getElementById('liveMonitoring');
      const timestamp = new Date().toLocaleTimeString();

      const messageCount = document.querySelectorAll('[data-message-id]').length;
      const fileContainerCount = document.querySelectorAll('.message-files').length;
      const imageCount = document.querySelectorAll('.attachment-image, .file-attachment img').length;
      const hashMessages = Array.from(document.querySelectorAll('.content-wrapper, .message-content'))
        .filter(el => /^[a-f0-9]{40}$/.test(el.textContent.trim())).length;

      monitoring.textContent = `[${timestamp}] å®æ—¶çŠ¶æ€:\n`;
      monitoring.textContent += `ğŸ“¨ æ¶ˆæ¯æ€»æ•°: ${messageCount}\n`;
      monitoring.textContent += `ğŸ“ æ–‡ä»¶å®¹å™¨: ${fileContainerCount}\n`;
      monitoring.textContent += `ğŸ–¼ï¸ å›¾ç‰‡å…ƒç´ : ${imageCount}\n`;
      monitoring.textContent += `#ï¸âƒ£ Hashæ¶ˆæ¯: ${hashMessages}\n`;

      if (hashMessages > 0) {
        monitoring.textContent += `\nâš ï¸ æ£€æµ‹åˆ° ${hashMessages} æ¡åªæ˜¾ç¤ºhashçš„æ¶ˆæ¯ï¼Œéœ€è¦ä¿®å¤ï¼\n`;
      }
    }

    // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      updateLiveMonitoring();
      setInterval(updateLiveMonitoring, 3000); // æ¯3ç§’æ›´æ–°ä¸€æ¬¡
    });

    // è‡ªåŠ¨æ£€æŸ¥
    setTimeout(() => {
      checkLatestMessage();
    }, 2000);
  </script>
</body>

</html>