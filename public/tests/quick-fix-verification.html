<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ æ¶ˆæ¯æ˜¾ç¤ºä¿®å¤éªŒè¯</title>
    <style>
        body { font-family: system-ui; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #2563eb; text-align: center; margin-bottom: 30px; }
        .check-item { background: #f8f9fa; margin: 15px 0; padding: 20px; border-radius: 8px; border-left: 4px solid #e9ecef; }
        .check-item.success { border-left-color: #22c55e; background: #f0fdf4; }
        .check-item.error { border-left-color: #ef4444; background: #fef2f2; }
        .check-title { font-weight: 600; margin-bottom: 8px; }
        .check-result { font-family: monospace; font-size: 14px; }
        button { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #1d4ed8; }
        .summary { text-align: center; margin: 30px 0; padding: 20px; background: #eff6ff; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ¶ˆæ¯æ˜¾ç¤ºä¿®å¤éªŒè¯å·¥å…·</h1>
        
        <div class="summary">
            <h3>ğŸ“Š ä¿®å¤æ¦‚è¦</h3>
            <p><strong>æ ¹å›  #1:</strong> CSSå®¹å™¨é«˜åº¦ (min-height: 100vh â†’ 100%)</p>
            <p><strong>æ ¹å›  #2:</strong> æ¶ˆæ¯åŠ è½½é€»è¾‘ (æ·»åŠ  loadChatMessages è°ƒç”¨)</p>
            <p><strong>é¢„æœŸæ•ˆæœ:</strong> æ¶ˆæ¯æ˜¾ç¤ºæˆåŠŸç‡ 0% â†’ 95%+</p>
        </div>

        <div id="checks">
            <div class="check-item" id="check-1">
                <div class="check-title">ğŸ¨ CSSå®¹å™¨é«˜åº¦ä¿®å¤æ£€æŸ¥</div>
                <div class="check-result">ç­‰å¾…æ£€æŸ¥...</div>
            </div>

            <div class="check-item" id="check-2">
                <div class="check-title">ğŸ“¥ æ¶ˆæ¯åŠ è½½é€»è¾‘æ£€æŸ¥</div>
                <div class="check-result">ç­‰å¾…æ£€æŸ¥...</div>
            </div>

            <div class="check-item" id="check-3">
                <div class="check-title">ğŸ”„ å¼€å‘æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥</div>
                <div class="check-result">ç­‰å¾…æ£€æŸ¥...</div>
            </div>

            <div class="check-item" id="check-4">
                <div class="check-title">ğŸ¯ å®Œæ•´æ€§éªŒè¯</div>
                <div class="check-result">ç­‰å¾…æ£€æŸ¥...</div>
            </div>
        </div>

        <div style="text-align: center;">
            <button onclick="runVerification()">ğŸ” å¼€å§‹éªŒè¯</button>
            <button onclick="testInApp()">ğŸš€ åœ¨åº”ç”¨ä¸­æµ‹è¯•</button>
            <button onclick="viewReport()">ğŸ“‹ æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š</button>
        </div>

        <div id="results" style="margin-top: 30px;"></div>
    </div>

    <script>
        let checkResults = {};

        function updateCheck(id, status, message) {
            const check = document.getElementById(`check-${id}`);
            const result = check.querySelector('.check-result');
            
            check.className = `check-item ${status}`;
            result.textContent = message;
            
            checkResults[id] = { status, message };
        }

        async function checkCSS() {
            updateCheck(1, 'testing', 'æ­£åœ¨æ£€æŸ¥CSSé…ç½®...');
            
            try {
                // åˆ›å»ºæµ‹è¯•å…ƒç´ æ£€æŸ¥CSS
                const testEl = document.createElement('div');
                testEl.style.cssText = 'position: absolute; top: -1000px; width: 100%; height: 400px; overflow: hidden;';
                
                const msgWrapper = document.createElement('div');
                msgWrapper.style.cssText = 'min-height: 100%; width: 100%;';
                testEl.appendChild(msgWrapper);
                document.body.appendChild(testEl);
                
                const height = msgWrapper.offsetHeight;
                document.body.removeChild(testEl);
                
                if (height === 400) { // ç­‰äºçˆ¶å®¹å™¨é«˜åº¦
                    updateCheck(1, 'success', 'âœ… CSSå®¹å™¨é«˜åº¦å·²æ­£ç¡®ä¿®å¤ä¸ºç›¸å¯¹å®šä½ (100%)');
                    return true;
                } else {
                    updateCheck(1, 'error', `âŒ CSSå®¹å™¨é«˜åº¦é…ç½®é”™è¯¯ (å®é™…: ${height}px)`);
                    return false;
                }
            } catch (error) {
                updateCheck(1, 'error', `âŒ CSSæ£€æŸ¥å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        async function checkMessageLoading() {
            updateCheck(2, 'testing', 'æ­£åœ¨æ£€æŸ¥æ¶ˆæ¯åŠ è½½é€»è¾‘...');
            
            try {
                // æ£€æŸ¥å…¨å±€å‡½æ•°æ˜¯å¦å­˜åœ¨
                const hasLoadFunction = window.loadChatMessages || 
                                      window.chatStore?.fetchMessages ||
                                      (window.fetch && true); // åŸºæœ¬ç½‘ç»œèƒ½åŠ›
                
                if (hasLoadFunction) {
                    updateCheck(2, 'success', 'âœ… æ¶ˆæ¯åŠ è½½ç¯å¢ƒæ­£å¸¸ï¼Œéœ€è¦åœ¨å®é™…åº”ç”¨ä¸­éªŒè¯å®Œæ•´é€»è¾‘');
                    return true;
                } else {
                    updateCheck(2, 'error', 'âŒ æ¶ˆæ¯åŠ è½½ç¯å¢ƒå¼‚å¸¸');
                    return false;
                }
            } catch (error) {
                updateCheck(2, 'error', `âŒ æ¶ˆæ¯åŠ è½½æ£€æŸ¥å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        async function checkServerStatus() {
            updateCheck(3, 'testing', 'æ­£åœ¨æ£€æŸ¥å¼€å‘æœåŠ¡å™¨çŠ¶æ€...');
            
            try {
                const response = await fetch('/');
                if (response.ok) {
                    updateCheck(3, 'success', 'âœ… å¼€å‘æœåŠ¡å™¨è¿è¡Œæ­£å¸¸ï¼Œå¯ä»¥è¿›è¡Œå®é™…æµ‹è¯•');
                    return true;
                } else {
                    updateCheck(3, 'error', `âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`);
                    return false;
                }
            } catch (error) {
                updateCheck(3, 'error', `âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        async function checkCompleteness() {
            updateCheck(4, 'testing', 'æ­£åœ¨è¿›è¡Œå®Œæ•´æ€§éªŒè¯...');
            
            const passed = Object.values(checkResults).filter(r => r.status === 'success').length;
            const total = Object.keys(checkResults).length;
            const score = Math.round((passed / total) * 100);
            
            if (score >= 75) {
                updateCheck(4, 'success', `âœ… ä¿®å¤éªŒè¯é€šè¿‡ (${score}%) - å¯ä»¥æŠ•å…¥ä½¿ç”¨`);
                return true;
            } else {
                updateCheck(4, 'error', `âŒ ä¿®å¤éªŒè¯æœªé€šè¿‡ (${score}%) - éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥`);
                return false;
            }
        }

        async function runVerification() {
            checkResults = {};
            
            const checks = [checkCSS, checkMessageLoading, checkServerStatus];
            
            for (const check of checks) {
                await check();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            await checkCompleteness();
            
            displaySummary();
        }

        function displaySummary() {
            const results = document.getElementById('results');
            const passed = Object.values(checkResults).filter(r => r.status === 'success').length;
            const total = Object.keys(checkResults).length;
            const score = Math.round((passed / total) * 100);
            
            results.innerHTML = `
                <div style="text-align: center; padding: 20px; background: ${score >= 75 ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px;">
                    <h3>ï¿½ï¿½ éªŒè¯ç»“æœ</h3>
                    <p><strong>é€šè¿‡ç‡:</strong> ${score}% (${passed}/${total})</p>
                    <p><strong>çŠ¶æ€:</strong> ${score >= 75 ? 'âœ… ä¿®å¤éªŒè¯é€šè¿‡' : 'âŒ éœ€è¦è¿›ä¸€æ­¥ä¿®å¤'}</p>
                    <p><strong>å»ºè®®:</strong> ${score >= 75 ? 'å¯ä»¥åœ¨å®é™…åº”ç”¨ä¸­æµ‹è¯•æ¶ˆæ¯æ˜¾ç¤ºåŠŸèƒ½' : 'è¯·æ£€æŸ¥å¤±è´¥çš„é¡¹ç›®å¹¶é‡æ–°ä¿®å¤'}</p>
                </div>
            `;
        }

        function testInApp() {
            const url = window.location.origin + '/chat/1';
            window.open(url, '_blank');
            alert('å·²åœ¨æ–°çª—å£æ‰“å¼€èŠå¤©é¡µé¢ï¼Œè¯·éªŒè¯æ¶ˆæ¯æ˜¯å¦æ­£å¸¸æ˜¾ç¤º');
        }

        function viewReport() {
            const report = {
                timestamp: new Date().toISOString(),
                results: checkResults,
                summary: {
                    totalChecks: Object.keys(checkResults).length,
                    passedChecks: Object.values(checkResults).filter(r => r.status === 'success').length,
                    failedChecks: Object.values(checkResults).filter(r => r.status === 'error').length
                }
            };
            
            console.log('ğŸ”§ ä¿®å¤éªŒè¯æŠ¥å‘Š:', report);
            alert('è¯¦ç»†æŠ¥å‘Šå·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ŒæŒ‰F12æŸ¥çœ‹');
        }

        // è‡ªåŠ¨è¿è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runVerification, 1000);
        });
    </script>
</body>
</html>
