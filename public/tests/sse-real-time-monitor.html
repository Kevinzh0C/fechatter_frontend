<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” SSE Real-Time Monitor</title>
  <style>
    body {
      font-family: 'SF Pro Display', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .monitor-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .monitor-panel {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid #007bff;
    }

    .log-container {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.4;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
    }

    .log-info {
      color: #7dd3fc;
    }

    .log-success {
      color: #86efac;
    }

    .log-warning {
      color: #fde047;
    }

    .log-error {
      color: #fca5a5;
    }

    .log-sse {
      color: #c084fc;
      background: rgba(192, 132, 252, 0.1);
    }

    .log-backend {
      color: #60a5fa;
      background: rgba(96, 165, 250, 0.1);
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-connected {
      background: #28a745;
    }

    .status-disconnected {
      background: #dc3545;
    }

    .status-connecting {
      background: #ffc107;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      border: 1px solid #e9ecef;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .stat-label {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ” SSE Real-Time Monitor</h1>
      <p>å‰åç«¯SSEäº‹ä»¶å®æ—¶ç›‘æ§å¯¹æ¯”åˆ†æ</p>
    </div>

    <div class="control-panel">
      <button class="btn btn-success" onclick="startMonitoring()">ğŸš€ å¼€å§‹ç›‘æ§</button>
      <button class="btn btn-warning" onclick="stopMonitoring()">â¹ï¸ åœæ­¢ç›‘æ§</button>
      <button class="btn btn-primary" onclick="sendTestMessage()">ğŸ“¨ å‘é€æµ‹è¯•æ¶ˆæ¯</button>
      <button class="btn btn-danger" onclick="clearAllLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="frontendEvents">0</div>
        <div class="stat-label">å‰ç«¯æ¥æ”¶äº‹ä»¶</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="backendEvents">0</div>
        <div class="stat-label">åç«¯å¤„ç†äº‹ä»¶</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="matchedEvents">0</div>
        <div class="stat-label">åŒ¹é…äº‹ä»¶</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="connectionTime">0s</div>
        <div class="stat-label">è¿æ¥æ—¶é•¿</div>
      </div>
    </div>

    <div class="monitor-grid">
      <div class="monitor-panel">
        <h3>
          <span class="status-indicator" id="frontendStatus"></span>
          å‰ç«¯SSEæ¥æ”¶
        </h3>
        <div class="log-container" id="frontendLog"></div>
      </div>

      <div class="monitor-panel">
        <h3>
          <span class="status-indicator" id="backendStatus"></span>
          åç«¯SSEå¹¿æ’­
        </h3>
        <div class="log-container" id="backendLog"></div>
      </div>
    </div>

    <div class="monitor-panel">
      <h3>ğŸ”„ äº‹ä»¶åŒ¹é…åˆ†æ</h3>
      <div class="log-container" id="matchingLog"></div>
    </div>
  </div>

  <script>
    let eventSource = null;
    let monitoringInterval = null;
    let startTime = null;
    let frontendEventCount = 0;
    let backendEventCount = 0;
    let matchedEventCount = 0;

    // è·å–è®¤è¯Token
    function getAuthToken() {
      return localStorage.getItem('auth_token') ||
        localStorage.getItem('fechatter_auth_token') ||
        "eyJ0eXAiOiJKV1QiLCJhbGciOiJFZERTQSJ9.eyJzdWIiOiIyIiwiZXhwIjoxNzUwODQxNDc1LCJpYXQiOjE3NTA4Mzk2NzUsImF1ZCI6ImZlY2hhdHRlci13ZWIiLCJpc3MiOiJmZWNoYXR0ZXItc2VydmVyIiwidXNlciI6eyJpZCI6Miwid29ya3NwYWNlX2lkIjoyLCJmdWxsbmFtZSI6IlN1cGVyIFVzZXIiLCJlbWFpbCI6InN1cGVyQHRlc3QuY29tIiwic3RhdHVzIjoiQWN0aXZlIiwiY3JlYXRlZF9hdCI6IjIwMjUtMDYtMTRUMDg6MDU6MDEuOTA2NDMyWiJ9fQ.QtnJLzU17iebL2BA_pA2zWO_Ez3ntmL7HjB6spNeCEDInwJWuM2xH9Ix72LzZ1nR2DS4Gdi-v1u4Mc0gOwBCAw";
    }

    // æ—¥å¿—è®°å½•å‡½æ•°
    function logToPanel(panelId, message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const panel = document.getElementById(panelId);
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `[${timestamp}] ${message}`;
      panel.appendChild(entry);
      panel.scrollTop = panel.scrollHeight;
    }

    function updateStatus(elementId, status) {
      const element = document.getElementById(elementId);
      element.className = `status-indicator status-${status}`;
    }

    function updateStats() {
      document.getElementById('frontendEvents').textContent = frontendEventCount;
      document.getElementById('backendEvents').textContent = backendEventCount;
      document.getElementById('matchedEvents').textContent = matchedEventCount;

      if (startTime) {
        const duration = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('connectionTime').textContent = `${duration}s`;
      }
    }

    // å‰ç«¯SSEç›‘æ§
    function startFrontendMonitoring() {
      const token = getAuthToken();
      if (!token) {
        logToPanel('frontendLog', 'âŒ æ— æ³•è·å–è®¤è¯Token', 'error');
        return;
      }

      const sseUrl = `/events?access_token=${token}`;
      logToPanel('frontendLog', `ğŸ”— è¿æ¥SSE: ${sseUrl}`, 'info');
      updateStatus('frontendStatus', 'connecting');

      eventSource = new EventSource(sseUrl);

      eventSource.onopen = function (event) {
        logToPanel('frontendLog', 'âœ… å‰ç«¯SSEè¿æ¥æˆåŠŸ', 'success');
        updateStatus('frontendStatus', 'connected');
      };

      eventSource.onmessage = function (event) {
        frontendEventCount++;
        try {
          const data = JSON.parse(event.data);
          logToPanel('frontendLog', `ğŸ“¨ æ”¶åˆ°SSEäº‹ä»¶: ${JSON.stringify(data)}`, 'sse');

          // åˆ†æäº‹ä»¶åŒ¹é…
          analyzeEventMatching(data, 'frontend');
        } catch (error) {
          logToPanel('frontendLog', `âŒ SSEæ•°æ®è§£æå¤±è´¥: ${error.message}`, 'error');
        }
        updateStats();
      };

      eventSource.onerror = function (event) {
        logToPanel('frontendLog', `âŒ å‰ç«¯SSEè¿æ¥é”™è¯¯: ${event.type}`, 'error');
        updateStatus('frontendStatus', 'disconnected');
      };
    }

    // åç«¯æ—¥å¿—ç›‘æ§ (æ¨¡æ‹Ÿ)
    function startBackendMonitoring() {
      updateStatus('backendStatus', 'connected');
      logToPanel('backendLog', 'âœ… åç«¯ç›‘æ§å·²å¯åŠ¨', 'success');
      logToPanel('backendLog', 'ğŸ“„ åŸºäºå®é™…è¿œç¨‹æ—¥å¿—:', 'info');
      logToPanel('backendLog', 'ğŸ‘¤ User 2 connected to SSE', 'backend');
      logToPanel('backendLog', 'âœ… User 2 registered to 13 chats', 'backend');
    }

    // äº‹ä»¶åŒ¹é…åˆ†æ
    function analyzeEventMatching(data, source) {
      if (data.type === 'new_message' || data.type === 'NewMessage') {
        matchedEventCount++;
        logToPanel('matchingLog', `âœ… [${source}] æ¶ˆæ¯äº‹ä»¶åŒ¹é…: ID=${data.id}, Chat=${data.chat_id}`, 'success');
      } else if (data.type === 'message_delivered' || data.type === 'MessageDelivered') {
        matchedEventCount++;
        logToPanel('matchingLog', `âœ… [${source}] ç¡®è®¤äº‹ä»¶åŒ¹é…: MessageID=${data.message_id}`, 'success');
      } else {
        logToPanel('matchingLog', `â“ [${source}] æœªçŸ¥äº‹ä»¶ç±»å‹: ${data.type}`, 'warning');
      }
    }

    // å‘é€æµ‹è¯•æ¶ˆæ¯
    async function sendTestMessage() {
      const token = getAuthToken();
      if (!token) {
        logToPanel('matchingLog', 'âŒ æ— æ³•å‘é€æµ‹è¯•æ¶ˆæ¯ï¼šç¼ºå°‘Token', 'error');
        return;
      }

      const testContent = `SSEç›‘æ§æµ‹è¯• - ${new Date().toLocaleTimeString()}`;

      try {
        logToPanel('matchingLog', `ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯: "${testContent}"`, 'info');

        // ç”Ÿæˆæ ‡å‡†UUID
        const generateUUID = () => {
          if (typeof crypto !== 'undefined' && crypto.randomUUID) {
            return crypto.randomUUID();
          }
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        };

        const response = await fetch('/api/chat/2/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            content: testContent,
            idempotency_key: generateUUID() // âœ… ä½¿ç”¨æ ‡å‡†UUID
          })
        });

        if (response.ok) {
          const result = await response.json();
          logToPanel('matchingLog', `âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ: ID=${result.data?.id || result.id}`, 'success');

          // æ¨¡æ‹Ÿåç«¯æ—¥å¿—
          setTimeout(() => {
            backendEventCount++;
            logToPanel('backendLog', `ğŸ“¨ [NOTIFY] Processing message event: ${testContent}`, 'backend');
            logToPanel('backendLog', `âš¡ [NOTIFY] Processing realtime event from: fechatter.realtime.chat.2`, 'backend');
            updateStats();
          }, 100);
        } else {
          const errorText = await response.text();
          logToPanel('matchingLog', `âŒ æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥: ${response.status} - ${errorText}`, 'error');
        }

      } catch (error) {
        logToPanel('matchingLog', `âŒ å‘é€æµ‹è¯•æ¶ˆæ¯å‡ºé”™: ${error.message}`, 'error');
      }
    }

    // å¼€å§‹ç›‘æ§
    function startMonitoring() {
      startTime = Date.now();
      frontendEventCount = 0;
      backendEventCount = 0;
      matchedEventCount = 0;

      startFrontendMonitoring();
      startBackendMonitoring();

      // å®šæ—¶æ›´æ–°è¿æ¥æ—¶é•¿
      monitoringInterval = setInterval(updateStats, 1000);

      logToPanel('matchingLog', 'ğŸš€ SSEå®æ—¶ç›‘æ§å·²å¯åŠ¨', 'success');
    }

    // åœæ­¢ç›‘æ§
    function stopMonitoring() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }

      if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
      }

      updateStatus('frontendStatus', 'disconnected');
      updateStatus('backendStatus', 'disconnected');

      logToPanel('matchingLog', 'â¹ï¸ SSEç›‘æ§å·²åœæ­¢', 'warning');
    }

    // æ¸…ç©ºæ‰€æœ‰æ—¥å¿—
    function clearAllLogs() {
      ['frontendLog', 'backendLog', 'matchingLog'].forEach(id => {
        document.getElementById(id).innerHTML = '';
      });
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
      logToPanel('matchingLog', 'ğŸ” SSEå®æ—¶ç›‘æ§å·¥å…·å·²åŠ è½½', 'info');
      updateStatus('frontendStatus', 'disconnected');
      updateStatus('backendStatus', 'disconnected');
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', () => {
      stopMonitoring();
    });
  </script>
</body>

</html>