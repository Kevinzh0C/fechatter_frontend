<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Raw SSE Monitor</title>
  <style>
    body {
      font-family: monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      margin: 20px;
    }

    .header {
      background: #0d7377;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .controls {
      background: #2d2d30;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    .event-log {
      background: #0c0c0c;
      border: 1px solid #404040;
      border-radius: 8px;
      padding: 15px;
      height: 500px;
      overflow-y: auto;
      font-size: 12px;
    }

    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      margin: 5px;
      font-weight: bold;
    }

    .connected {
      background: #4caf50;
      color: white;
    }

    .disconnected {
      background: #f44336;
      color: white;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>ğŸ” Raw SSE Event Monitor</h1>
    <p>ç›´æ¥ç›‘æ§ä»æœåŠ¡å™¨å‘é€çš„æ‰€æœ‰SSEäº‹ä»¶</p>
  </div>

  <div class="controls">
    <span>è¿æ¥çŠ¶æ€ï¼š</span>
    <span id="connectionStatus" class="status disconnected">æ–­å¼€è¿æ¥</span>
    <button onclick="connect()">ğŸ”— è¿æ¥</button>
    <button onclick="disconnect()">âŒ æ–­å¼€</button>
    <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
    <button onclick="sendTestMessage()">ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯</button>
  </div>

  <div class="event-log" id="eventLog">
    <div>[ç³»ç»Ÿ] åŸå§‹SSEç›‘æ§å™¨å·²å¯åŠ¨ï¼Œç­‰å¾…è¿æ¥...</div>
  </div>

  <script>
    let eventSource = null;
    let eventCount = 0;

    function log(message, data = null) {
      const eventLog = document.getElementById('eventLog');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.innerHTML = `[${timestamp}] ${message}${data ? '<br><pre>' + data + '</pre>' : ''}`;
      eventLog.appendChild(entry);
      eventLog.scrollTop = eventLog.scrollHeight;
    }

    function getToken() {
      return localStorage.getItem('auth_token') ||
        window.__PINIA__?.state?.value?.auth?.token ||
        window.tokenManager?.getAccessToken();
    }

    function connect() {
      const token = getToken();
      if (!token) {
        log('âŒ æ— æ³•è·å–è®¤è¯token');
        return;
      }

      if (eventSource) disconnect();

      const url = `/events?access_token=${encodeURIComponent(token)}`;
      log(`ğŸ”— è¿æ¥SSE: ${url}`);

      eventSource = new EventSource(url);

      eventSource.onopen = function (event) {
        document.getElementById('connectionStatus').className = 'status connected';
        document.getElementById('connectionStatus').textContent = 'å·²è¿æ¥';
        log('âœ… SSEè¿æ¥å·²å»ºç«‹');
      };

      eventSource.onmessage = function (event) {
        eventCount++;
        log(`ğŸ“¨ [${eventCount}] æ”¶åˆ°SSEäº‹ä»¶`, `åŸå§‹æ•°æ®: ${event.data}`);

        try {
          const data = JSON.parse(event.data);
          log(`âœ… è§£ææˆåŠŸ`, `ç±»å‹: ${data.type || 'æœªçŸ¥'}\nå®Œæ•´æ•°æ®: ${JSON.stringify(data, null, 2)}`);

          if (data.type === 'NewMessage' || data.type === 'new_message') {
            log(`ğŸ¯ å‘ç°NewMessageäº‹ä»¶!`,
              `æ¶ˆæ¯ID: ${data.id || data.message_id}\n` +
              `å‘é€è€…: ${data.sender_id}\n` +
              `å†…å®¹: ${data.content || data.message}`);
          }
        } catch (e) {
          log(`âŒ è§£æå¤±è´¥: ${e.message}`, event.data);
        }
      };

      eventSource.onerror = function (event) {
        document.getElementById('connectionStatus').className = 'status disconnected';
        document.getElementById('connectionStatus').textContent = 'è¿æ¥é”™è¯¯';
        log(`âŒ SSEè¿æ¥é”™è¯¯`, `ReadyState: ${eventSource?.readyState}`);
      };
    }

    function disconnect() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      document.getElementById('connectionStatus').className = 'status disconnected';
      document.getElementById('connectionStatus').textContent = 'æ–­å¼€è¿æ¥';
      log('ğŸ”Œ SSEè¿æ¥å·²æ–­å¼€');
    }

    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
      eventCount = 0;
    }

    function sendTestMessage() {
      log('ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯...');
      if (window.chatStore && window.chatStore.sendMessage) {
        const testMsg = `Raw SSE Test ${Date.now()}`;
        window.chatStore.sendMessage(testMsg)
          .then(result => log(`âœ… æ¶ˆæ¯å‘é€æˆåŠŸ: ${result.message?.id}`))
          .catch(error => log(`âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${error.message}`));
      } else {
        log('âŒ ChatStoreä¸å¯ç”¨');
      }
    }

    // è‡ªåŠ¨è¿æ¥
    setTimeout(() => {
      if (getToken()) connect();
    }, 1000);
  </script>
</body>

</html>