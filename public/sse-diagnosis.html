<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SSEè¿æ¥è¯Šæ–­</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .btn { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #005999; }
        .log { background: #2d2d2d; padding: 15px; border-radius: 5px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>ğŸ”¬ SSEè¿æ¥è¯Šæ–­å·¥å…·</h1>
    
    <div>
        <button class="btn" onclick="checkAuth()">ğŸ” æ£€æŸ¥è®¤è¯</button>
        <button class="btn" onclick="checkSSE()">ğŸ“¡ æ£€æŸ¥SSEçŠ¶æ€</button>
        <button class="btn" onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
        <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        function log(message, type = "info") {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById("log");
            const className = type === "error" ? "error" : type === "success" ? "success" : type === "warning" ? "warning" : "";
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[SSEè¯Šæ–­] ${message}`);
        }
        
        function clearLog() {
            document.getElementById("log").innerHTML = "";
        }
        
        function checkAuth() {
            log("ğŸ” æ£€æŸ¥è®¤è¯çŠ¶æ€...", "info");
            
            const tokenKeys = ["auth_token", "fechatter_auth_token", "access_token"];
            let foundToken = null;
            
            for (const key of tokenKeys) {
                const token = localStorage.getItem(key);
                if (token) {
                    foundToken = token;
                    log(`âœ… æ‰¾åˆ°Token: ${key} (${token.length}å­—ç¬¦)`, "success");
                    break;
                }
            }
            
            if (!foundToken) {
                log("âŒ æœªæ‰¾åˆ°ä»»ä½•Token", "error");
            }
            
            try {
                const authUser = localStorage.getItem("auth_user");
                if (authUser) {
                    const userInfo = JSON.parse(authUser);
                    log(`âœ… ç”¨æˆ·ä¿¡æ¯: ID=${userInfo.id}, å·¥ä½œåŒº=${userInfo.workspace_id}`, "success");
                } else {
                    log("âŒ ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±", "error");
                }
            } catch (error) {
                log(`âŒ ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥: ${error.message}`, "error");
            }
            
            if (window.authStore || (window.__pinia_stores__ && window.__pinia_stores__.auth)) {
                const authStore = window.authStore || window.__pinia_stores__.auth();
                log(`ğŸ“Š AuthStore: è®¤è¯=${authStore.isAuthenticated}, Token=${!!authStore.token}`, "info");
            }
        }
        
        function checkSSE() {
            log("ğŸ“¡ æ£€æŸ¥SSEçŠ¶æ€...", "info");
            
            if (window.minimalSSE) {
                log("âœ… MinimalSSEæœåŠ¡å­˜åœ¨", "success");
                
                try {
                    const status = window.minimalSSE.getStatus();
                    if (status.connected) {
                        log(`âœ… SSEå·²è¿æ¥ (é‡è¯•:${status.retries})`, "success");
                    } else {
                        log(`âŒ SSEæœªè¿æ¥ (é‡è¯•:${status.retries})`, "error");
                    }
                    
                    const listeners = window.minimalSSE.listeners;
                    if (listeners && listeners.size > 0) {
                        let total = 0;
                        for (const callbacks of listeners.values()) {
                            total += callbacks.length;
                        }
                        log(`ğŸ“¨ SSEç›‘å¬å™¨: ${total}ä¸ª`, total > 0 ? "success" : "warning");
                    } else {
                        log("âš ï¸ æ²¡æœ‰SSEç›‘å¬å™¨", "warning");
                    }
                } catch (error) {
                    log(`âŒ SSEçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, "error");
                }
            } else {
                log("âŒ MinimalSSEæœåŠ¡ä¸å­˜åœ¨", "error");
            }
        }
        
        async function testConnection() {
            log("ğŸ”— æµ‹è¯•SSEè¿æ¥...", "info");
            
            const token = localStorage.getItem("auth_token") || 
                         localStorage.getItem("fechatter_auth_token") ||
                         localStorage.getItem("access_token");
            
            if (!token) {
                log("âŒ æ— æ³•æµ‹è¯•ï¼šç¼ºå°‘Token", "error");
                return;
            }
            
            try {
                const sseUrl = `/events?access_token=${token}`;
                log(`ğŸ”— è¿æ¥: ${sseUrl.substring(0, 50)}...`, "info");
                
                const eventSource = new EventSource(sseUrl);
                
                eventSource.onopen = function() {
                    log("âœ… æ‰‹åŠ¨SSEè¿æ¥æˆåŠŸï¼", "success");
                };
                
                eventSource.onmessage = function(event) {
                    log(`ğŸ“¨ æ”¶åˆ°SSEæ¶ˆæ¯: ${event.data}`, "success");
                };
                
                eventSource.onerror = function() {
                    log(`âŒ SSEè¿æ¥é”™è¯¯: ReadyState=${eventSource.readyState}`, "error");
                };
                
                setTimeout(() => {
                    eventSource.close();
                    log("ï¿½ï¿½ æµ‹è¯•è¿æ¥å·²å…³é—­", "info");
                }, 10000);
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
            }
        }
        
        window.addEventListener("load", () => {
            log("ğŸ”¬ SSEè¯Šæ–­å·¥å…·å·²åŠ è½½", "info");
            log("ğŸ“‹ è¯·å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€ï¼Œç„¶åæ£€æŸ¥SSEçŠ¶æ€", "info");
        });
    </script>
</body>
</html>
