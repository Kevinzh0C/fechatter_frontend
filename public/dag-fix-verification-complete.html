<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DAG Complete Fix Verification</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }

    .container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 30px;
      font-style: italic;
    }

    .fix-summary {
      background: #f0fff4;
      border: 2px solid #68d391;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .fix-item {
      display: flex;
      align-items: center;
      margin: 10px 0;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #38a169;
    }

    .fix-icon {
      font-size: 20px;
      margin-right: 15px;
      min-width: 30px;
    }

    .test-section {
      background: #f8fafc;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #3182ce;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .test-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .test-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .button {
      background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
      width: 100%;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .button.success {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    }

    .button.warning {
      background: linear-gradient(135deg, #dd6b20 0%, #c05621 100%);
    }

    .results {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }

    .info {
      background: #ebf8ff;
      color: #2a4365;
      border: 1px solid #90cdf4;
    }

    .success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .warning {
      background: #fffaf0;
      color: #744210;
      border: 1px solid #f6ad55;
    }

    .file-input {
      margin: 15px 0;
      padding: 15px;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-input:hover {
      border-color: #3182ce;
      background: #f7fafc;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .metric {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #3182ce;
    }

    .metric-label {
      font-size: 12px;
      color: #718096;
      margin-top: 5px;
    }

    .dag-flow {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .flow-step {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .flow-step.success {
      background: #f0fff4;
      border-left: 4px solid #38a169;
    }

    .flow-step.error {
      background: #fed7d7;
      border-left: 4px solid #e53e3e;
    }

    .flow-step.testing {
      background: #ebf8ff;
      border-left: 4px solid #3182ce;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .step-icon {
      font-size: 18px;
      margin-right: 12px;
      min-width: 25px;
    }

    .step-content {
      flex: 1;
    }

    .step-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .step-details {
      font-size: 13px;
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”¬ DAGå®Œæ•´ä¿®å¤éªŒè¯å·¥å…·</h1>
    <p class="subtitle">éªŒè¯å¢å¼ºå“åº”è§£æé€»è¾‘çš„å®Œæ•´ä¿®å¤æ•ˆæœ</p>

    <!-- ä¿®å¤æ€»ç»“ -->
    <div class="fix-summary">
      <h3>âœ… å·²åº”ç”¨çš„DAGä¿®å¤</h3>

      <div class="fix-item">
        <div class="fix-icon">ğŸ”§</div>
        <div>
          <strong>å¢å¼ºå“åº”è§£æé€»è¾‘</strong><br>
          <small>ChatService.ts:722è¡Œ - å¢åŠ è¯¦ç»†çš„å“åº”æ ¼å¼åˆ†æå’Œå…¼å®¹æ€§å¤„ç†</small>
        </div>
      </div>

      <div class="fix-item">
        <div class="fix-icon">ğŸ”</div>
        <div>
          <strong>è¯¦ç»†é”™è¯¯è¯Šæ–­</strong><br>
          <small>å¼€å‘ç¯å¢ƒä¸‹æä¾›å®Œæ•´çš„å“åº”ç»“æ„åˆ†æå’Œè°ƒè¯•ä¿¡æ¯</small>
        </div>
      </div>

      <div class="fix-item">
        <div class="fix-icon">ğŸ›¡ï¸</div>
        <div>
          <strong>å¤šæ ¼å¼å…¼å®¹æ€§</strong><br>
          <small>æ”¯æŒæ ‡å‡†æ ¼å¼å’Œç›´æ¥è¿”å›æ ¼å¼ï¼Œæé«˜åç«¯å…¼å®¹æ€§</small>
        </div>
      </div>

      <div class="fix-item">
        <div class="fix-icon">âš¡</div>
        <div>
          <strong>ç½‘ç»œå¥åº·æ£€æŸ¥ä¼˜åŒ–</strong><br>
          <small>ä½¿ç”¨fetch('/health')é¿å…/apiå‰ç¼€é—®é¢˜</small>
        </div>
      </div>
    </div>

    <!-- DAGæµç¨‹çŠ¶æ€ -->
    <div class="dag-flow">
      <h3>ğŸ“Š ä¿®å¤åçš„DAGæµç¨‹</h3>
      <div class="flow-step" id="dag-step-1">
        <div class="step-icon">ğŸ¯</div>
        <div class="step-content">
          <div class="step-title">MessageInput.vue â†’ sendMessage()</div>
          <div class="step-details">ç”¨æˆ·è§¦å‘æ¶ˆæ¯å‘é€</div>
        </div>
      </div>

      <div class="flow-step" id="dag-step-2">
        <div class="step-icon">ğŸ“Š</div>
        <div class="step-content">
          <div class="step-title">fileUploadStore.js â†’ uploadAll()</div>
          <div class="step-details">æ–‡ä»¶ä¸Šä¼ ç®¡ç†å™¨å¤„ç†</div>
        </div>
      </div>

      <div class="flow-step" id="dag-step-3">
        <div class="step-icon">ğŸŒ</div>
        <div class="step-content">
          <div class="step-title">ChatService.uploadFile() - å¢å¼ºç‰ˆ</div>
          <div class="step-details">åº”ç”¨äº†æ–°çš„å“åº”è§£æé€»è¾‘</div>
        </div>
      </div>

      <div class="flow-step" id="dag-step-4">
        <div class="step-icon">â¤ï¸</div>
        <div class="step-content">
          <div class="step-title">Network Health Check - å·²ä¿®å¤</div>
          <div class="step-details">ä½¿ç”¨fetch('/health')æ­£ç¡®æ£€æŸ¥</div>
        </div>
      </div>

      <div class="flow-step" id="dag-step-5">
        <div class="step-icon">ğŸ“¤</div>
        <div class="step-content">
          <div class="step-title">POST /files/single</div>
          <div class="step-details">å®é™…æ–‡ä»¶ä¸Šä¼ è¯·æ±‚</div>
        </div>
      </div>

      <div class="flow-step" id="dag-step-6">
        <div class="step-icon">ğŸ”</div>
        <div class="step-content">
          <div class="step-title">Enhanced Response Parsing</div>
          <div class="step-details">æ–°çš„æ™ºèƒ½å“åº”è§£æå’Œé”™è¯¯åˆ†æ</div>
        </div>
      </div>

      <div class="flow-step" id="dag-step-7">
        <div class="step-icon">âœ…</div>
        <div class="step-content">
          <div class="step-title">Upload Success</div>
          <div class="step-details">æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œè¿”å›URL</div>
        </div>
      </div>
    </div>

    <!-- æµ‹è¯•å¥—ä»¶ -->
    <div class="test-grid">
      <div class="test-card">
        <h4>ğŸ” å“åº”æ ¼å¼å…¼å®¹æ€§æµ‹è¯•</h4>
        <p>æµ‹è¯•æ–°çš„å“åº”è§£æé€»è¾‘å¯¹ä¸åŒæ ¼å¼çš„å…¼å®¹æ€§</p>
        <button class="button" onclick="testResponseCompatibility()">è¿è¡Œå…¼å®¹æ€§æµ‹è¯•</button>
        <div id="compatibility-results" class="results"></div>
      </div>

      <div class="test-card">
        <h4>ğŸ›¡ï¸ é”™è¯¯è¯Šæ–­åŠŸèƒ½æµ‹è¯•</h4>
        <p>æµ‹è¯•å¢å¼ºçš„é”™è¯¯åˆ†æå’Œè°ƒè¯•ä¿¡æ¯è¾“å‡º</p>
        <button class="button" onclick="testErrorDiagnostics()">æµ‹è¯•é”™è¯¯è¯Šæ–­</button>
        <div id="diagnostics-results" class="results"></div>
      </div>

      <div class="test-card">
        <h4>ğŸ“ å®é™…æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h4>
        <div class="file-input" onclick="document.getElementById('file-input').click()">
          <input type="file" id="file-input" style="display: none;" onchange="handleFileUpload(event)">
          ğŸ“ é€‰æ‹©æ–‡ä»¶æµ‹è¯•å®Œæ•´æµç¨‹
        </div>
        <button class="button success" onclick="testCompleteUpload()">æµ‹è¯•å®Œæ•´ä¸Šä¼ </button>
        <div id="upload-results" class="results"></div>
      </div>

      <div class="test-card">
        <h4>âš¡ æ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•</h4>
        <p>æµ‹è¯•ä¿®å¤åçš„æ€§èƒ½è¡¨ç°å’Œç¨³å®šæ€§</p>
        <button class="button warning" onclick="testPerformance()">æ€§èƒ½æµ‹è¯•</button>
        <div id="performance-results" class="results"></div>
      </div>
    </div>

    <!-- æŒ‡æ ‡ä»ªè¡¨æ¿ -->
    <div class="metrics">
      <div class="metric">
        <div class="metric-value" id="tests-run">0</div>
        <div class="metric-label">æµ‹è¯•æ‰§è¡Œ</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="success-rate">100%</div>
        <div class="metric-label">æˆåŠŸç‡</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="response-time">0ms</div>
        <div class="metric-label">å¹³å‡å“åº”æ—¶é—´</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="errors-caught">0</div>
        <div class="metric-label">æ•è·é”™è¯¯</div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    let testMetrics = {
      testsRun: 0,
      successfulTests: 0,
      responseTimes: [],
      errorsCaught: 0
    };

    let selectedFile = null;

    // å·¥å…·å‡½æ•°
    function log(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      container.style.display = 'block';
      container.className = `results ${type}`;
      container.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
      container.scrollTop = container.scrollHeight;
    }

    function clear(containerId) {
      document.getElementById(containerId).textContent = '';
    }

    function updateDAGStep(stepId, status, details = '') {
      const step = document.getElementById(stepId);
      step.className = `flow-step ${status}`;
      if (details) {
        const detailsEl = step.querySelector('.step-details');
        detailsEl.textContent = details;
      }
    }

    function updateMetrics() {
      document.getElementById('tests-run').textContent = testMetrics.testsRun;
      const successRate = testMetrics.testsRun > 0
        ? Math.round((testMetrics.successfulTests / testMetrics.testsRun) * 100)
        : 100;
      document.getElementById('success-rate').textContent = `${successRate}%`;

      const avgResponseTime = testMetrics.responseTimes.length > 0
        ? Math.round(testMetrics.responseTimes.reduce((a, b) => a + b, 0) / testMetrics.responseTimes.length)
        : 0;
      document.getElementById('response-time').textContent = `${avgResponseTime}ms`;
      document.getElementById('errors-caught').textContent = testMetrics.errorsCaught;
    }

    // å“åº”æ ¼å¼å…¼å®¹æ€§æµ‹è¯•
    async function testResponseCompatibility() {
      clear('compatibility-results');
      log('compatibility-results', 'ğŸ” æµ‹è¯•å“åº”æ ¼å¼å…¼å®¹æ€§...', 'info');
      testMetrics.testsRun++;

      try {
        // æ¨¡æ‹Ÿä¸åŒçš„å“åº”æ ¼å¼
        const testCases = [
          {
            name: 'æ ‡å‡†æ ¼å¼',
            response: {
              data: {
                success: true,
                data: {
                  id: 1,
                  filename: 'test.txt',
                  url: '/uploads/test.txt',
                  mime_type: 'text/plain',
                  size: 100,
                  created_at: new Date().toISOString()
                }
              }
            }
          },
          {
            name: 'ç›´æ¥è¿”å›æ ¼å¼',
            response: {
              data: {
                id: 1,
                filename: 'test.txt',
                url: '/uploads/test.txt',
                mime_type: 'text/plain',
                size: 100,
                created_at: new Date().toISOString()
              }
            }
          },
          {
            name: 'é”™è¯¯æ ¼å¼',
            response: {
              data: {
                success: false,
                error: {
                  message: 'Upload failed'
                }
              }
            }
          },
          {
            name: 'ç©ºå“åº”',
            response: {}
          }
        ];

        for (const testCase of testCases) {
          log('compatibility-results', `\næµ‹è¯•: ${testCase.name}`, 'info');

          try {
            // æ¨¡æ‹Ÿæ–°çš„è§£æé€»è¾‘
            const result = simulateEnhancedParsing(testCase.response);
            if (result) {
              log('compatibility-results', `âœ… ${testCase.name}: è§£ææˆåŠŸ`, 'success');
              log('compatibility-results', `   ç»“æœ: ${JSON.stringify(result, null, 2)}`, 'success');
            } else {
              log('compatibility-results', `âŒ ${testCase.name}: è§£æå¤±è´¥`, 'error');
            }
          } catch (error) {
            log('compatibility-results', `âŒ ${testCase.name}: ${error.message}`, 'error');
            testMetrics.errorsCaught++;
          }
        }

        testMetrics.successfulTests++;
        log('compatibility-results', '\nğŸ‰ å…¼å®¹æ€§æµ‹è¯•å®Œæˆ', 'success');

      } catch (error) {
        log('compatibility-results', `âŒ å…¼å®¹æ€§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }

      updateMetrics();
    }

    // æ¨¡æ‹Ÿå¢å¼ºçš„è§£æé€»è¾‘
    function simulateEnhancedParsing(response) {
      if (response.data) {
        // æ£€æŸ¥æ ‡å‡†æ ¼å¼
        if (response.data.success && response.data.data) {
          return {
            id: response.data.data.id,
            filename: response.data.data.filename,
            url: response.data.data.url,
            mime_type: response.data.data.mime_type,
            size: response.data.data.size,
            created_at: response.data.data.created_at
          };
        }

        // æ£€æŸ¥ç›´æ¥è¿”å›æ ¼å¼
        else if (response.data.url && response.data.filename) {
          return {
            id: response.data.id || Date.now(),
            filename: response.data.filename,
            url: response.data.url,
            mime_type: response.data.mime_type || 'application/octet-stream',
            size: response.data.size || 0,
            created_at: response.data.created_at || new Date().toISOString()
          };
        }

        // é”™è¯¯æƒ…å†µ
        else {
          const errorMessage = response.data.error?.message || 'File upload failed';
          throw new Error(errorMessage);
        }
      } else {
        throw new Error('Server returned no data');
      }
    }

    // é”™è¯¯è¯Šæ–­åŠŸèƒ½æµ‹è¯•
    async function testErrorDiagnostics() {
      clear('diagnostics-results');
      log('diagnostics-results', 'ğŸ›¡ï¸ æµ‹è¯•é”™è¯¯è¯Šæ–­åŠŸèƒ½...', 'info');
      testMetrics.testsRun++;

      try {
        // æ¨¡æ‹Ÿå„ç§é”™è¯¯æƒ…å†µå¹¶æµ‹è¯•è¯Šæ–­è¾“å‡º
        const errorCases = [
          {
            name: 'ç¼ºå¤±successå­—æ®µ',
            response: { data: { message: 'some data' } },
            expectedDiagnosis: 'successå­—æ®µç¼ºå¤±'
          },
          {
            name: 'successä¸ºfalse',
            response: { data: { success: false, error: { message: 'Test error' } } },
            expectedDiagnosis: 'successå­—æ®µä¸ºfalse'
          },
          {
            name: 'ç¼ºå¤±dataå­—æ®µ',
            response: { data: { success: true } },
            expectedDiagnosis: 'dataå­—æ®µç¼ºå¤±'
          },
          {
            name: 'å®Œå…¨ç©ºå“åº”',
            response: {},
            expectedDiagnosis: 'æ— å“åº”æ•°æ®'
          }
        ];

        for (const errorCase of errorCases) {
          log('diagnostics-results', `\nè¯Šæ–­æµ‹è¯•: ${errorCase.name}`, 'info');

          try {
            simulateEnhancedParsing(errorCase.response);
            log('diagnostics-results', `âš ï¸ é¢„æœŸé”™è¯¯ä½†è§£ææˆåŠŸ`, 'warning');
          } catch (error) {
            log('diagnostics-results', `âœ… é”™è¯¯æ­£ç¡®æ•è·: ${error.message}`, 'success');

            // æ£€æŸ¥æ˜¯å¦åŒ…å«è¯Šæ–­ä¿¡æ¯
            if (error.message.includes('Response analysis')) {
              log('diagnostics-results', `âœ… åŒ…å«è¯¦ç»†è¯Šæ–­ä¿¡æ¯`, 'success');
            } else {
              log('diagnostics-results', `ğŸ“Š åŸºç¡€é”™è¯¯ä¿¡æ¯`, 'info');
            }

            testMetrics.errorsCaught++;
          }
        }

        testMetrics.successfulTests++;
        log('diagnostics-results', '\nğŸ‰ é”™è¯¯è¯Šæ–­æµ‹è¯•å®Œæˆ', 'success');

      } catch (error) {
        log('diagnostics-results', `âŒ è¯Šæ–­æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }

      updateMetrics();
    }

    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    function handleFileUpload(event) {
      selectedFile = event.target.files[0];
      if (selectedFile) {
        log('upload-results', `ğŸ“ å·²é€‰æ‹©æ–‡ä»¶: ${selectedFile.name} (${selectedFile.size} bytes)`, 'info');
      }
    }

    // å®Œæ•´ä¸Šä¼ æµ‹è¯•
    async function testCompleteUpload() {
      if (!selectedFile) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      clear('upload-results');
      log('upload-results', 'ğŸ“ æµ‹è¯•å®Œæ•´ä¸Šä¼ æµç¨‹...', 'info');
      testMetrics.testsRun++;

      // æ›´æ–°DAGæµç¨‹çŠ¶æ€
      updateDAGStep('dag-step-1', 'testing', 'æ‰§è¡Œä¸­...');

      try {
        const startTime = Date.now();

        // æ­¥éª¤1: æ–‡ä»¶éªŒè¯
        updateDAGStep('dag-step-1', 'success', 'æ–‡ä»¶é€‰æ‹©å®Œæˆ');
        updateDAGStep('dag-step-2', 'testing', 'ä¸Šä¼ ç®¡ç†å™¨å¤„ç†ä¸­...');

        log('upload-results', '1ï¸âƒ£ æ–‡ä»¶éªŒè¯é€šè¿‡', 'success');

        // æ­¥éª¤2: ç½‘ç»œå¥åº·æ£€æŸ¥
        updateDAGStep('dag-step-2', 'success', 'ç®¡ç†å™¨å¤„ç†å®Œæˆ');
        updateDAGStep('dag-step-4', 'testing', 'å¥åº·æ£€æŸ¥ä¸­...');

        log('upload-results', '2ï¸âƒ£ æ‰§è¡Œç½‘ç»œå¥åº·æ£€æŸ¥...', 'info');

        try {
          const healthResponse = await fetch('/health', { method: 'GET' });
          if (healthResponse.ok) {
            log('upload-results', 'âœ… ç½‘ç»œå¥åº·æ£€æŸ¥é€šè¿‡', 'success');
            updateDAGStep('dag-step-4', 'success', 'å¥åº·æ£€æŸ¥é€šè¿‡');
          } else {
            log('upload-results', `âš ï¸ å¥åº·æ£€æŸ¥è­¦å‘Š: ${healthResponse.status}`, 'warning');
            updateDAGStep('dag-step-4', 'error', `å¥åº·æ£€æŸ¥å¤±è´¥: ${healthResponse.status}`);
          }
        } catch (healthError) {
          log('upload-results', `âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${healthError.message}`, 'error');
          updateDAGStep('dag-step-4', 'error', 'å¥åº·æ£€æŸ¥å¤±è´¥');
        }

        // æ­¥éª¤3: å®é™…ä¸Šä¼ 
        updateDAGStep('dag-step-5', 'testing', 'ä¸Šä¼ ä¸­...');
        log('upload-results', '3ï¸âƒ£ æ‰§è¡Œæ–‡ä»¶ä¸Šä¼ ...', 'info');

        const formData = new FormData();
        formData.append('file', selectedFile);

        const authToken = localStorage.getItem('auth_token');
        const headers = {};
        if (authToken) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }

        const uploadResponse = await fetch('/api/files/single', {
          method: 'POST',
          body: formData,
          headers: headers
        });

        const responseTime = Date.now() - startTime;
        testMetrics.responseTimes.push(responseTime);

        updateDAGStep('dag-step-5', 'success', `ä¸Šä¼ å®Œæˆ (${responseTime}ms)`);
        updateDAGStep('dag-step-6', 'testing', 'è§£æå“åº”ä¸­...');

        log('upload-results', `ğŸ“Š ä¸Šä¼ å“åº”: ${uploadResponse.status} (${responseTime}ms)`, 'info');

        // æ­¥éª¤4: å“åº”è§£æ (ä½¿ç”¨æ–°é€»è¾‘)
        if (uploadResponse.ok) {
          const responseData = await uploadResponse.json();
          log('upload-results', '4ï¸âƒ£ ä½¿ç”¨å¢å¼ºè§£æé€»è¾‘...', 'info');

          try {
            const result = simulateEnhancedParsing({ data: responseData });
            updateDAGStep('dag-step-6', 'success', 'å“åº”è§£ææˆåŠŸ');
            updateDAGStep('dag-step-7', 'success', 'ä¸Šä¼ æˆåŠŸ');

            log('upload-results', 'âœ… è§£ææˆåŠŸï¼', 'success');
            log('upload-results', `ğŸ“Š ç»“æœ: ${JSON.stringify(result, null, 2)}`, 'success');

            testMetrics.successfulTests++;

          } catch (parseError) {
            updateDAGStep('dag-step-6', 'error', 'è§£æå¤±è´¥');
            log('upload-results', `âŒ è§£æå¤±è´¥: ${parseError.message}`, 'error');
            testMetrics.errorsCaught++;
          }
        } else {
          updateDAGStep('dag-step-5', 'error', `HTTPé”™è¯¯: ${uploadResponse.status}`);
          log('upload-results', `âŒ ä¸Šä¼ å¤±è´¥: ${uploadResponse.status}`, 'error');
        }

      } catch (error) {
        log('upload-results', `âŒ å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        updateDAGStep('dag-step-7', 'error', 'æµ‹è¯•å¤±è´¥');
      }

      updateMetrics();
    }

    // æ€§èƒ½æµ‹è¯•
    async function testPerformance() {
      clear('performance-results');
      log('performance-results', 'âš¡ è¿è¡Œæ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•...', 'info');
      testMetrics.testsRun++;

      try {
        // æµ‹è¯•å“åº”è§£ææ€§èƒ½
        log('performance-results', 'ğŸ” æµ‹è¯•è§£ææ€§èƒ½...', 'info');

        const iterations = 1000;
        const testResponse = {
          data: {
            success: true,
            data: {
              id: 1,
              filename: 'test.txt',
              url: '/uploads/test.txt',
              mime_type: 'text/plain',
              size: 100,
              created_at: new Date().toISOString()
            }
          }
        };

        const startTime = Date.now();

        for (let i = 0; i < iterations; i++) {
          simulateEnhancedParsing(testResponse);
        }

        const endTime = Date.now();
        const totalTime = endTime - startTime;
        const avgTime = totalTime / iterations;

        log('performance-results', `âœ… è§£ææ€§èƒ½æµ‹è¯•å®Œæˆ`, 'success');
        log('performance-results', `ğŸ“Š ${iterations}æ¬¡è¿­ä»£ï¼Œæ€»æ—¶é—´: ${totalTime}ms`, 'success');
        log('performance-results', `ğŸ“Š å¹³å‡è§£ææ—¶é—´: ${avgTime.toFixed(3)}ms`, 'success');

        // æµ‹è¯•é”™è¯¯å¤„ç†æ€§èƒ½
        log('performance-results', '\nğŸ›¡ï¸ æµ‹è¯•é”™è¯¯å¤„ç†æ€§èƒ½...', 'info');

        const errorResponse = { data: { success: false, error: { message: 'Test error' } } };
        const errorStartTime = Date.now();

        let errorsCaught = 0;
        for (let i = 0; i < 100; i++) {
          try {
            simulateEnhancedParsing(errorResponse);
          } catch (error) {
            errorsCaught++;
          }
        }

        const errorEndTime = Date.now();
        const errorTotalTime = errorEndTime - errorStartTime;

        log('performance-results', `âœ… é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ`, 'success');
        log('performance-results', `ğŸ“Š æ•è·é”™è¯¯: ${errorsCaught}/100`, 'success');
        log('performance-results', `ğŸ“Š é”™è¯¯å¤„ç†æ—¶é—´: ${errorTotalTime}ms`, 'success');

        testMetrics.successfulTests++;

      } catch (error) {
        log('performance-results', `âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }

      updateMetrics();
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      updateMetrics();

      // è‡ªåŠ¨æ›´æ–°DAGçŠ¶æ€æ˜¾ç¤º
      setTimeout(() => {
        for (let i = 1; i <= 7; i++) {
          updateDAGStep(`dag-step-${i}`, 'success', 'å°±ç»ª');
        }
      }, 1000);

      log('upload-results', 'ğŸ¯ DAGå®Œæ•´ä¿®å¤éªŒè¯å·¥å…·å·²å°±ç»ª', 'info');
      log('upload-results', 'âœ… å·²åº”ç”¨å¢å¼ºå“åº”è§£æé€»è¾‘ä¿®å¤', 'success');
      log('upload-results', 'ğŸ’¡ å»ºè®®ä¾æ¬¡è¿è¡Œå„é¡¹æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ', 'info');
    });
  </script>
</body>

</html>