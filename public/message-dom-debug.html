<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¶ˆæ¯DOMè°ƒè¯•å·¥å…·</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }

    .debug-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .debug-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .debug-item {
      margin: 8px 0;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .error {
      background: #ffe6e6;
      color: #d32f2f;
    }

    .success {
      background: #e8f5e8;
      color: #388e3c;
    }

    .warning {
      background: #fff3cd;
      color: #f57c00;
    }

    .info {
      background: #e3f2fd;
      color: #1976d2;
    }

    button {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background: #5b21b6;
    }

    .dom-tree {
      background: #1a1a1a;
      color: #00ff00;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="debug-panel">
    <div class="debug-title">ğŸ” æ¶ˆæ¯DOMç»“æ„è°ƒè¯•å·¥å…·</div>

    <button onclick="analyzeMessageDOM()">åˆ†ææ¶ˆæ¯DOMç»“æ„</button>
    <button onclick="analyzeVisibility()">æ£€æŸ¥å¯è§æ€§é—®é¢˜</button>
    <button onclick="analyzeCSSStyles()">åˆ†æCSSæ ·å¼</button>
    <button onclick="analyzeVueComponents()">æ£€æŸ¥Vueç»„ä»¶çŠ¶æ€</button>
    <button onclick="fullDiagnostics()">å®Œæ•´è¯Šæ–­</button>
  </div>

  <div class="debug-panel">
    <div class="debug-title">ğŸ“Š è¯Šæ–­ç»“æœ</div>
    <div id="results"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `debug-item ${type}`;
      div.innerHTML = message;
      results.appendChild(div);
    }

    function clear() {
      document.getElementById('results').innerHTML = '';
    }

    function analyzeMessageDOM() {
      clear();
      log('ğŸ” å¼€å§‹åˆ†ææ¶ˆæ¯DOMç»“æ„...', 'info');

      // æŸ¥æ‰¾ä¸»è¦å®¹å™¨
      const messageList = document.querySelector('.simple-message-list');
      const messagesWrapper = document.querySelector('.messages-wrapper');
      const messageWrappers = document.querySelectorAll('.message-wrapper');
      const timeSessionDividers = document.querySelectorAll('time-session-divider, .time-session-divider');

      log(`ğŸ“¦ ç®€å•æ¶ˆæ¯åˆ—è¡¨å®¹å™¨: ${messageList ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°'}`, messageList ? 'success' : 'error');

      if (messageList) {
        log(`   å®¹å™¨å°ºå¯¸: ${messageList.offsetWidth}Ã—${messageList.offsetHeight}px`, 'info');
        log(`   æ»šåŠ¨çŠ¶æ€: scrollTop=${messageList.scrollTop}, scrollHeight=${messageList.scrollHeight}`, 'info');
        log(`   CSS classes: ${Array.from(messageList.classList).join(', ') || 'æ— '}`, 'info');
      }

      log(`ğŸ“¦ æ¶ˆæ¯åŒ…è£…å™¨å®¹å™¨: ${messagesWrapper ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°'}`, messagesWrapper ? 'success' : 'error');

      if (messagesWrapper) {
        log(`   å®¹å™¨å°ºå¯¸: ${messagesWrapper.offsetWidth}Ã—${messagesWrapper.offsetHeight}px`, 'info');
        log(`   å­å…ƒç´ æ•°é‡: ${messagesWrapper.children.length}`, 'info');
        log(`   CSS classes: ${Array.from(messagesWrapper.classList).join(', ') || 'æ— '}`, 'info');

        // åˆ†æå­å…ƒç´ ç±»å‹
        const children = Array.from(messagesWrapper.children);
        const childTypes = {};
        children.forEach(child => {
          const type = child.tagName.toLowerCase();
          childTypes[type] = (childTypes[type] || 0) + 1;
        });
        log(`   å­å…ƒç´ ç±»å‹åˆ†å¸ƒ: ${JSON.stringify(childTypes)}`, 'info');
      }

      log(`ğŸ“ æ¶ˆæ¯å®¹å™¨ (.message-wrapper): ${messageWrappers.length} ä¸ª`, messageWrappers.length > 0 ? 'success' : 'warning');
      log(`ğŸ“… æ—¶é—´åˆ†å‰²çº¿: ${timeSessionDividers.length} ä¸ª`, timeSessionDividers.length > 0 ? 'success' : 'warning');

      // åˆ†ææ¯ä¸ªæ¶ˆæ¯å®¹å™¨
      if (messageWrappers.length > 0) {
        log(`ğŸ” åˆ†æå‰5ä¸ªæ¶ˆæ¯å®¹å™¨:`, 'info');
        Array.from(messageWrappers).slice(0, 5).forEach((wrapper, index) => {
          const messageId = wrapper.dataset.messageId || 'æœªçŸ¥';
          const messageItem = wrapper.querySelector('.message-item');
          const messageContent = wrapper.querySelector('.message-content');

          log(`   æ¶ˆæ¯${index + 1} (ID: ${messageId}):`, 'info');
          log(`     å°ºå¯¸: ${wrapper.offsetWidth}Ã—${wrapper.offsetHeight}px`, 'info');
          log(`     å¯è§æ€§: ${wrapper.offsetParent !== null ? 'å¯è§' : 'ä¸å¯è§'}`, wrapper.offsetParent !== null ? 'success' : 'error');
          log(`     MessageItem: ${messageItem ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, messageItem ? 'success' : 'error');
          log(`     å†…å®¹åŒºåŸŸ: ${messageContent ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, messageContent ? 'success' : 'error');

          if (messageItem) {
            log(`     MessageItemå°ºå¯¸: ${messageItem.offsetWidth}Ã—${messageItem.offsetHeight}px`, 'info');
          }
        });
      }
    }

    function analyzeVisibility() {
      clear();
      log('ğŸ‘ï¸ å¼€å§‹æ£€æŸ¥å¯è§æ€§é—®é¢˜...', 'info');

      const messageWrappers = document.querySelectorAll('.message-wrapper');
      const viewport = {
        width: window.innerWidth,
        height: window.innerHeight
      };

      log(`ğŸ–¥ï¸ è§†å£å°ºå¯¸: ${viewport.width}Ã—${viewport.height}px`, 'info');

      if (messageWrappers.length === 0) {
        log('âŒ æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨', 'error');
        return;
      }

      let visibleCount = 0;
      let hiddenCount = 0;
      let zeroSizeCount = 0;

      messageWrappers.forEach((wrapper, index) => {
        const rect = wrapper.getBoundingClientRect();
        const isVisible = rect.width > 0 && rect.height > 0 && rect.bottom > 0 && rect.top < viewport.height;
        const hasZeroSize = rect.width === 0 || rect.height === 0;

        if (hasZeroSize) {
          zeroSizeCount++;
        } else if (isVisible) {
          visibleCount++;
        } else {
          hiddenCount++;
        }

        if (index < 5) { // åªæ˜¾ç¤ºå‰5ä¸ªçš„è¯¦ç»†ä¿¡æ¯
          const messageId = wrapper.dataset.messageId || 'æœªçŸ¥';
          log(`æ¶ˆæ¯${index + 1} (ID: ${messageId}):`, 'info');
          log(`  ä½ç½®: top=${rect.top.toFixed(1)}, left=${rect.left.toFixed(1)}`, 'info');
          log(`  å°ºå¯¸: ${rect.width.toFixed(1)}Ã—${rect.height.toFixed(1)}px`, 'info');
          log(`  çŠ¶æ€: ${hasZeroSize ? 'é›¶å°ºå¯¸' : (isVisible ? 'å¯è§' : 'ä¸å¯è§')}`,
            hasZeroSize ? 'error' : (isVisible ? 'success' : 'warning'));
        }
      });

      log(`ğŸ“Š å¯è§æ€§ç»Ÿè®¡:`, 'info');
      log(`  âœ… å¯è§: ${visibleCount} ä¸ª`, visibleCount > 0 ? 'success' : 'warning');
      log(`  âš ï¸ ä¸å¯è§: ${hiddenCount} ä¸ª`, hiddenCount === 0 ? 'success' : 'warning');
      log(`  âŒ é›¶å°ºå¯¸: ${zeroSizeCount} ä¸ª`, zeroSizeCount === 0 ? 'success' : 'error');
    }

    function analyzeCSSStyles() {
      clear();
      log('ğŸ¨ å¼€å§‹åˆ†æCSSæ ·å¼...', 'info');

      const messagesWrapper = document.querySelector('.messages-wrapper');
      const messageWrappers = document.querySelectorAll('.message-wrapper');

      if (messagesWrapper) {
        const styles = getComputedStyle(messagesWrapper);
        log('ğŸ“¦ .messages-wrapper å…³é”®æ ·å¼:', 'info');
        log(`  display: ${styles.display}`, 'info');
        log(`  width: ${styles.width}`, 'info');
        log(`  height: ${styles.height}`, 'info');
        log(`  min-height: ${styles.minHeight}`, 'info');
        log(`  overflow: ${styles.overflow}`, 'info');
        log(`  position: ${styles.position}`, 'info');
        log(`  visibility: ${styles.visibility}`, 'info');
        log(`  opacity: ${styles.opacity}`, 'info');
      }

      if (messageWrappers.length > 0) {
        const firstWrapper = messageWrappers[0];
        const styles = getComputedStyle(firstWrapper);
        log('ğŸ“ .message-wrapper å…³é”®æ ·å¼ (ç¬¬ä¸€ä¸ª):', 'info');
        log(`  display: ${styles.display}`, 'info');
        log(`  width: ${styles.width}`, 'info');
        log(`  height: ${styles.height}`, 'info');
        log(`  margin: ${styles.margin}`, 'info');
        log(`  padding: ${styles.padding}`, 'info');
        log(`  position: ${styles.position}`, 'info');
        log(`  visibility: ${styles.visibility}`, 'info');
        log(`  opacity: ${styles.opacity}`, 'info');

        const messageItem = firstWrapper.querySelector('.message-item');
        if (messageItem) {
          const itemStyles = getComputedStyle(messageItem);
          log('ğŸ’¬ .message-item å…³é”®æ ·å¼ (ç¬¬ä¸€ä¸ª):', 'info');
          log(`  display: ${itemStyles.display}`, 'info');
          log(`  width: ${itemStyles.width}`, 'info');
          log(`  height: ${itemStyles.height}`, 'info');
          log(`  visibility: ${itemStyles.visibility}`, 'info');
          log(`  opacity: ${itemStyles.opacity}`, 'info');
        }
      }
    }

    function analyzeVueComponents() {
      clear();
      log('âš¡ å¼€å§‹æ£€æŸ¥Vueç»„ä»¶çŠ¶æ€...', 'info');

      const messageList = document.querySelector('.simple-message-list');

      if (messageList && messageList.__vueParentComponent) {
        const component = messageList.__vueParentComponent;
        const setupState = component.setupState || {};

        log('ğŸ”§ Vueç»„ä»¶çŠ¶æ€:', 'info');

        if (setupState.enhancedMessages) {
          const enhanced = setupState.enhancedMessages;
          log(`  enhancedMessages: ${enhanced.length} é¡¹`, enhanced.length > 0 ? 'success' : 'warning');

          if (enhanced.length > 0) {
            const messageCount = enhanced.filter(item => !item.type || (item.type !== 'date-divider' && item.type !== 'session-divider')).length;
            const dividerCount = enhanced.filter(item => item.type === 'date-divider' || item.type === 'session-divider').length;

            log(`    æ¶ˆæ¯æ•°é‡: ${messageCount}`, messageCount > 0 ? 'success' : 'warning');
            log(`    åˆ†å‰²çº¿æ•°é‡: ${dividerCount}`, 'info');

            // åˆ†æå‰3ä¸ªé¡¹ç›®
            enhanced.slice(0, 3).forEach((item, index) => {
              log(`    é¡¹ç›®${index + 1}: type=${item.type || 'æœªè®¾ç½®'}, id=${item.id}`, 'info');
            });
          }
        }

        if (setupState.memoizedMessages) {
          log(`  memoizedMessages: ${setupState.memoizedMessages.length} é¡¹`, 'info');
        }

        if (setupState.messageGroupingState) {
          const groupingState = setupState.messageGroupingState;
          log(`  messageGroupingState:`, 'info');
          log(`    groupedMessages: ${groupingState.groupedMessages?.length || 0}`, 'info');
          log(`    sessions: ${groupingState.sessions?.length || 0}`, 'info');
          log(`    dividers: ${groupingState.dividers?.length || 0}`, 'info');
          log(`    lastProcessedCount: ${groupingState.lastProcessedCount || 0}`, 'info');
        }
      } else {
        log('âŒ æ— æ³•è®¿é—®Vueç»„ä»¶å®ä¾‹', 'error');
      }
    }

    function fullDiagnostics() {
      clear();
      log('ğŸ” å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');

      setTimeout(() => {
        analyzeMessageDOM();
        setTimeout(() => {
          analyzeVisibility();
          setTimeout(() => {
            analyzeCSSStyles();
            setTimeout(() => {
              analyzeVueComponents();

              // æœ€ç»ˆåˆ†æ
              setTimeout(() => {
                log('ğŸ¯ è¯Šæ–­æ€»ç»“:', 'info');

                const messageWrappers = document.querySelectorAll('.message-wrapper');
                const visibleWrappers = Array.from(messageWrappers).filter(w => w.offsetParent !== null);
                const dividers = document.querySelectorAll('time-session-divider, .time-session-divider');

                if (messageWrappers.length === 0) {
                  log('ğŸš¨ æ ¹æœ¬é—®é¢˜ï¼šæ²¡æœ‰æ¶ˆæ¯å®¹å™¨è¢«æ¸²æŸ“', 'error');
                } else if (visibleWrappers.length === 0) {
                  log('ğŸš¨ æ ¹æœ¬é—®é¢˜ï¼šæ¶ˆæ¯å®¹å™¨å­˜åœ¨ä½†éƒ½ä¸å¯è§', 'error');
                } else if (dividers.length > 0 && visibleWrappers.length > 0) {
                  log('âœ… æ¶ˆæ¯å’Œåˆ†å‰²çº¿éƒ½æ­£å¸¸æ¸²æŸ“', 'success');
                } else {
                  log('âš ï¸ éƒ¨åˆ†æ¸²æŸ“é—®é¢˜éœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥', 'warning');
                }
              }, 100);
            }, 100);
          }, 100);
        }, 100);
      }, 100);
    }

    // è‡ªåŠ¨è¿è¡Œå®Œæ•´è¯Šæ–­
    window.addEventListener('load', () => {
      setTimeout(fullDiagnostics, 1000);
    });
  </script>
</body>

</html>