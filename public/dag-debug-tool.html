<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” MessageInput â†” FilePreview DAG Debug</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .dag-flow {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .flow-step {
      display: flex;
      align-items: center;
      margin: 15px 0;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #4299e1;
    }

    .step-number {
      background: #4299e1;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
    }

    .problem-section {
      background: #fed7d7;
      border: 1px solid #f56565;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .solution-section {
      background: #c6f6d5;
      border: 1px solid #48bb78;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .code-block {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      overflow-x: auto;
      margin: 10px 0;
    }

    .highlight {
      background: #fef5e7;
      padding: 2px 6px;
      border-radius: 3px;
      color: #744210;
      font-weight: 500;
    }

    .test-btn {
      background: #4299e1;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.2s;
    }

    .test-btn:hover {
      background: #3182ce;
      transform: translateY(-1px);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ” MessageInput â†” FilePreview DAG è°ƒè¯•å·¥å…·</h1>
      <p>æ·±åº¦åˆ†æç»„ä»¶äº¤äº’æµç¨‹ï¼Œç²¾ç¡®å®šä½ç¼©ç•¥å›¾æ˜¾ç¤ºé—®é¢˜</p>
    </div>

    <div class="dag-flow">
      <h3>ğŸ“Š å®Œæ•´çš„å‡½æ•°è°ƒç”¨DAGæµç¨‹</h3>

      <div class="flow-step">
        <div class="step-number">1</div>
        <div>
          <strong>ç”¨æˆ·ç‚¹å‡»æ–‡ä»¶æŒ‰é’®</strong><br>
          <code>triggerFileUpload() â†’ fileInput.value.click()</code>
        </div>
      </div>

      <div class="flow-step">
        <div class="step-number">2</div>
        <div>
          <strong>æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘</strong><br>
          <code>handleFileSelect(event) â†’ event.target.files[0]</code>
        </div>
      </div>

      <div class="flow-step">
        <div class="step-number">3</div>
        <div>
          <strong>çŠ¶æ€æ›´æ–° (å…³é”®æ­¥éª¤)</strong><br>
          <code>selectedFile.value = newFile</code><br>
          <code>showFilePreview.value = true</code><br>
          <code>formatMode.value = 'file'</code>
        </div>
      </div>

      <div class="flow-step">
        <div class="step-number">4</div>
        <div>
          <strong>æ¨¡æ¿æ¡ä»¶æ£€æŸ¥</strong><br>
          <code>v-if="formatMode === 'file' && selectedFile"</code>
        </div>
      </div>

      <div class="flow-step">
        <div class="step-number">5</div>
        <div>
          <strong>FilePreviewç»„ä»¶æ¸²æŸ“</strong><br>
          <code>&lt;FilePreview :file="selectedFile" /&gt;</code>
        </div>
      </div>

      <div class="flow-step">
        <div class="step-number">6</div>
        <div>
          <strong>FilePreview.onMounted()</strong><br>
          <code>URL.createObjectURL(props.file)</code><br>
          <code>localPreviewUrl.value = blobUrl</code>
        </div>
      </div>

      <div class="flow-step">
        <div class="step-number">7</div>
        <div>
          <strong>ç¼©ç•¥å›¾æ˜¾ç¤º</strong><br>
          <code>&lt;img :src="getFilePreviewUrl()" /&gt;</code>
        </div>
      </div>
    </div>

    <div class="problem-section">
      <h3>âŒ å¯èƒ½çš„æ–­ç‚¹åˆ†æ</h3>
      <ol>
        <li><strong>æ­¥éª¤1å¤±è´¥:</strong> <span class="highlight">fileInput.value</span> ä¸º null</li>
        <li><strong>æ­¥éª¤2å¤±è´¥:</strong> <span class="highlight">handleFileSelect</span> æœªè§¦å‘</li>
        <li><strong>æ­¥éª¤3å¤±è´¥:</strong> çŠ¶æ€æ›´æ–°é€»è¾‘æœ‰é—®é¢˜</li>
        <li><strong>æ­¥éª¤4å¤±è´¥:</strong> æ¨¡æ¿æ¡ä»¶ä¸æ»¡è¶³</li>
        <li><strong>æ­¥éª¤5å¤±è´¥:</strong> FilePreviewç»„ä»¶æœªæ­£ç¡®å¯¼å…¥</li>
        <li><strong>æ­¥éª¤6å¤±è´¥:</strong> props.file ä¸ºç©ºæˆ–æ— æ•ˆ</li>
      </ol>
    </div>

    <div class="solution-section">
      <h3>ğŸ”§ å®æ—¶è°ƒè¯•ä»£ç </h3>
      <p>å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°MessageInput.vueçš„handleFileSelectå‡½æ•°ä¸­:</p>
      <div class="code-block">
        const handleFileSelect = (event) => {
        console.log('ğŸ” [DEBUG] handleFileSelect triggered');
        console.log('ğŸ” [DEBUG] event:', event);
        console.log('ğŸ” [DEBUG] event.target.files:', event.target.files);

        const selectedFiles = Array.from(event.target.files);
        console.log('ğŸ” [DEBUG] selectedFiles:', selectedFiles);

        if (selectedFiles.length === 0) {
        console.warn('âš ï¸ [DEBUG] No files selected');
        return;
        }

        const newSelectedFile = selectedFiles[0];
        console.log('ğŸ” [DEBUG] newSelectedFile:', newSelectedFile);
        console.log('ğŸ” [DEBUG] File name:', newSelectedFile.name);
        console.log('ğŸ” [DEBUG] File size:', newSelectedFile.size);
        console.log('ğŸ” [DEBUG] File type:', newSelectedFile.type);

        // çŠ¶æ€æ›´æ–°å‰
        console.log('ğŸ” [DEBUG] Before state update:');
        console.log(' - selectedFile.value:', selectedFile.value);
        console.log(' - showFilePreview.value:', showFilePreview.value);
        console.log(' - formatMode.value:', formatMode.value);

        // æ‰§è¡ŒçŠ¶æ€æ›´æ–°
        selectedFile.value = newSelectedFile;
        uploadedFileUrl.value = null;
        formatMode.value = 'file';
        showFilePreview.value = true;
        showPreview.value = true;

        // çŠ¶æ€æ›´æ–°å
        console.log('ğŸ” [DEBUG] After state update:');
        console.log(' - selectedFile.value:', selectedFile.value);
        console.log(' - showFilePreview.value:', showFilePreview.value);
        console.log(' - formatMode.value:', formatMode.value);

        // æ£€æŸ¥æ¨¡æ¿æ¡ä»¶
        nextTick(() => {
        console.log('ğŸ” [DEBUG] In nextTick:');
        console.log(' - formatMode === "file":', formatMode.value === 'file');
        console.log(' - selectedFile exists:', !!selectedFile.value);
        console.log(' - Template condition should pass:',
        formatMode.value === 'file' && !!selectedFile.value);

        // æ£€æŸ¥FilePreviewå…ƒç´ æ˜¯å¦å­˜åœ¨
        const filePreviewEl = document.querySelector('[class*="file-preview"]');
        console.log('ğŸ” [DEBUG] FilePreview element found:', !!filePreviewEl);
        if (filePreviewEl) {
        console.log('ğŸ” [DEBUG] FilePreview element:', filePreviewEl);
        }
        });

        emit('preview-state-change', true);
        event.target.value = '';
        };</div>
    </div>

    <div class="solution-section">
      <h3>ğŸ”§ æ¨¡æ¿æ¡ä»¶æ£€æŸ¥</h3>
      <p>æ£€æŸ¥MessageInput.vueæ¨¡æ¿ä¸­çš„æ¡ä»¶é€»è¾‘:</p>
      <div class="code-block">
        &lt;!-- ğŸ” æ£€æŸ¥è¿™ä¸ªæ¡ä»¶æ˜¯å¦æ­£ç¡® --&gt;
        &lt;div v-else-if="formatMode === 'file'" class="file-preview"&gt;
        &lt;div class="file-upload-area" v-if="!selectedFile"&gt;
        &lt;!-- ç©ºçŠ¶æ€æ˜¾ç¤º --&gt;
        &lt;/div&gt;
        &lt;!-- ğŸ¯ å…³é”®: FilePreviewç»„ä»¶æ¡ä»¶ --&gt;
        &lt;FilePreview v-else :file="selectedFile"
        @file-uploaded="handleFileUploaded"
        @upload-error="handleFileUploadError"
        @file-removed="handleFileRemoved"
        @trigger-upload="triggerFileUpload" /&gt;
        &lt;/div&gt;</div>
    </div>

    <div class="solution-section">
      <h3>ğŸ”§ å¯èƒ½çš„ä¿®å¤æ–¹æ¡ˆ</h3>

      <h4>ä¿®å¤1: ç®€åŒ–æ¡ä»¶é€»è¾‘</h4>
      <div class="code-block">
        &lt;!-- ğŸ”§ ç®€åŒ–ç‰ˆæœ¬ --&gt;
        &lt;div v-if="formatMode === 'file' && selectedFile" class="file-preview-container"&gt;
        &lt;FilePreview :file="selectedFile"
        @file-uploaded="handleFileUploaded"
        @upload-error="handleFileUploadError"
        @file-removed="handleFileRemoved" /&gt;
        &lt;/div&gt;</div>

      <h4>ä¿®å¤2: æ·»åŠ è°ƒè¯•ä¿¡æ¯</h4>
      <div class="code-block">
        &lt;!-- ğŸ”§ æ·»åŠ è°ƒè¯•æ˜¾ç¤º --&gt;
        &lt;div v-if="formatMode === 'file'" class="debug-info"&gt;
        &lt;p&gt;formatMode: {{ formatMode }}&lt;/p&gt;
        &lt;p&gt;selectedFile: {{ selectedFile ? selectedFile.name : 'null' }}&lt;/p&gt;
        &lt;p&gt;showFilePreview: {{ showFilePreview }}&lt;/p&gt;
        &lt;/div&gt;</div>

      <h4>ä¿®å¤3: æ£€æŸ¥ç»„ä»¶å¯¼å…¥</h4>
      <div class="code-block">
        // ğŸ”§ ç¡®è®¤FilePreviewæ­£ç¡®å¯¼å…¥
        import FilePreview from './MessageInput/FilePreview.vue';

        // åœ¨componentsä¸­æ³¨å†Œ
        export default {
        components: {
        FilePreview
        }
        // ...
        }</div>
    </div>

    <div>
      <h3>ğŸ§ª å®æ—¶æµ‹è¯•å·¥å…·</h3>
      <button class="test-btn" onclick="checkFileInput()">æ£€æŸ¥æ–‡ä»¶è¾“å…¥æ¡†</button>
      <button class="test-btn" onclick="checkStates()">æ£€æŸ¥çŠ¶æ€å€¼</button>
      <button class="test-btn" onclick="checkFilePreview()">æ£€æŸ¥FilePreviewç»„ä»¶</button>
      <button class="test-btn" onclick="simulateFileSelect()">æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©</button>
    </div>

    <div id="testResults" style="margin-top: 20px;"></div>
  </div>

  <script>
    function checkFileInput() {
      console.log('ğŸ§ª æ£€æŸ¥æ–‡ä»¶è¾“å…¥æ¡†...');
      const fileInputs = document.querySelectorAll('input[type="file"]');
      const results = document.getElementById('testResults');

      if (fileInputs.length === 0) {
        results.innerHTML = '<div class="problem-section"><strong>âŒ æœªæ‰¾åˆ°æ–‡ä»¶è¾“å…¥æ¡†</strong></div>';
        console.error('âŒ No file input found');
        return;
      }

      console.log(`âœ… æ‰¾åˆ° ${fileInputs.length} ä¸ªæ–‡ä»¶è¾“å…¥æ¡†`);
      fileInputs.forEach((input, index) => {
        console.log(`æ–‡ä»¶è¾“å…¥æ¡† ${index}:`, input);
        console.log(`- æ˜¾ç¤ºçŠ¶æ€:`, input.style.display);
        console.log(`- acceptå±æ€§:`, input.accept);
      });

      results.innerHTML = `<div class="solution-section"><strong>âœ… æ‰¾åˆ° ${fileInputs.length} ä¸ªæ–‡ä»¶è¾“å…¥æ¡†</strong><br>æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</div>`;
    }

    function checkStates() {
      console.log('ğŸ§ª å°è¯•æ£€æŸ¥VueçŠ¶æ€...');

      // å°è¯•ä¸åŒæ–¹æ³•è®¿é—®Vueå®ä¾‹
      const messageInputEl = document.querySelector('.message-input') ||
        document.querySelector('[class*="message-input"]') ||
        document.querySelector('[data-component="MessageInput"]');

      if (messageInputEl) {
        console.log('æ‰¾åˆ°MessageInputå…ƒç´ :', messageInputEl);

        // å°è¯•è®¿é—®Vueå®ä¾‹
        const vueInstance = messageInputEl.__vue__ ||
          messageInputEl._vnode?.component?.proxy ||
          messageInputEl.__vueParentComponent?.proxy;

        if (vueInstance) {
          console.log('Vueå®ä¾‹:', vueInstance);
          console.log('çŠ¶æ€æ£€æŸ¥:');
          console.log('- selectedFile:', vueInstance.selectedFile);
          console.log('- showFilePreview:', vueInstance.showFilePreview);
          console.log('- formatMode:', vueInstance.formatMode);
        } else {
          console.warn('æ— æ³•è®¿é—®Vueå®ä¾‹');
        }
      } else {
        console.error('æœªæ‰¾åˆ°MessageInputå…ƒç´ ');
      }
    }

    function checkFilePreview() {
      console.log('ğŸ§ª æ£€æŸ¥FilePreviewç»„ä»¶...');
      const filePreviewEls = document.querySelectorAll('[class*="file-preview"]');
      console.log(`æ‰¾åˆ° ${filePreviewEls.length} ä¸ªFilePreviewç›¸å…³å…ƒç´ `);

      filePreviewEls.forEach((el, index) => {
        console.log(`FilePreviewå…ƒç´  ${index}:`, el);
        console.log(`- å¯è§æ€§:`, el.offsetParent !== null);
        console.log(`- è®¡ç®—æ ·å¼æ˜¾ç¤º:`, getComputedStyle(el).display);
      });
    }

    function simulateFileSelect() {
      console.log('ğŸ§ª æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©...');
      const fileInput = document.querySelector('input[type="file"]');
      if (fileInput) {
        console.log('è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†...');
        fileInput.click();
      } else {
        console.error('æœªæ‰¾åˆ°æ–‡ä»¶è¾“å…¥æ¡†');
      }
    }

    console.log('ğŸ” DAGè°ƒè¯•å·¥å…·å·²åŠ è½½');
    console.log('ğŸ’¡ ä½¿ç”¨ä¸Šæ–¹æŒ‰é’®è¿›è¡Œå®æ—¶è°ƒè¯•');
    console.log('ğŸ¯ é‡ç‚¹æ£€æŸ¥: æ–‡ä»¶é€‰æ‹© â†’ çŠ¶æ€æ›´æ–° â†’ ç»„ä»¶æ¸²æŸ“ â†’ ç¼©ç•¥å›¾æ˜¾ç¤º');
  </script>
</body>

</html>