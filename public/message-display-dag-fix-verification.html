<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š æ¶ˆæ¯æ˜¾ç¤ºDAGä¿®å¤éªŒè¯ - å®Œæ•´æµç¨‹æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    .dag-flow {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .dag-step {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
    }

    .dag-step.pending {
      border-color: #ffc107;
      background: #fff3cd;
    }

    .dag-step.testing {
      border-color: #17a2b8;
      background: #d4edda;
      animation: pulse 2s infinite;
    }

    .dag-step.success {
      border-color: #28a745;
      background: #d4edda;
    }

    .dag-step.error {
      border-color: #dc3545;
      background: #f8d7da;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(23, 162, 184, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(23, 162, 184, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(23, 162, 184, 0);
      }
    }

    .step-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-status {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      flex-shrink: 0;
    }

    .step-status.pending {
      background: #ffc107;
    }

    .step-status.testing {
      background: #17a2b8;
    }

    .step-status.success {
      background: #28a745;
    }

    .step-status.error {
      background: #dc3545;
    }

    .step-description {
      color: #6c757d;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .step-details {
      background: white;
      border-radius: 8px;
      padding: 12px;
      font-size: 0.9rem;
      border-left: 4px solid #e9ecef;
    }

    .step-details.success {
      border-left-color: #28a745;
      background: #f8fff9;
    }

    .step-details.error {
      border-left-color: #dc3545;
      background: #fff5f5;
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .results {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .results h3 {
      color: #495057;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-entry {
      background: white;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-left: 4px solid #e9ecef;
      font-family: monospace;
      font-size: 0.9rem;
    }

    .log-entry.info {
      border-left-color: #17a2b8;
    }

    .log-entry.success {
      border-left-color: #28a745;
    }

    .log-entry.warning {
      border-left-color: #ffc107;
    }

    .log-entry.error {
      border-left-color: #dc3545;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: #495057;
      margin-bottom: 5px;
    }

    .metric-label {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .diagnostic-panel {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }

    .diagnostic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .diagnostic-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      border-left: 4px solid #e9ecef;
    }

    .diagnostic-item.pass {
      border-left-color: #28a745;
    }

    .diagnostic-item.fail {
      border-left-color: #dc3545;
    }

    .diagnostic-item.warn {
      border-left-color: #ffc107;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: #6c757d;
      border-top: 1px solid #e9ecef;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }

      .dag-flow {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š æ¶ˆæ¯æ˜¾ç¤ºDAGä¿®å¤éªŒè¯</h1>
      <p>å®Œæ•´æµç¨‹æµ‹è¯• | éªŒè¯æ‰€æœ‰æ ¹å› ä¿®å¤çŠ¶æ€</p>
    </div>

    <div class="content">
      <!-- DAGæµç¨‹æ­¥éª¤ -->
      <div class="dag-flow">
        <div class="dag-step" id="step-1">
          <div class="step-title">
            <div class="step-status" id="status-1">1</div>
            CSSå®¹å™¨é«˜åº¦ä¿®å¤
          </div>
          <div class="step-description">
            éªŒè¯ .messages-wrapper çš„ min-height ä» 100vh ä¿®å¤ä¸º 100%
          </div>
          <div class="step-details" id="details-1">
            ç­‰å¾…æ£€æµ‹...
          </div>
        </div>

        <div class="dag-step" id="step-2">
          <div class="step-title">
            <div class="step-status" id="status-2">2</div>
            æ¶ˆæ¯åŠ è½½é€»è¾‘ä¿®å¤
          </div>
          <div class="step-description">
            éªŒè¯ Chat.vue çš„ loadChatData() åŒ…å« loadChatMessages() è°ƒç”¨
          </div>
          <div class="step-details" id="details-2">
            ç­‰å¾…æ£€æµ‹...
          </div>
        </div>

        <div class="dag-step" id="step-3">
          <div class="step-title">
            <div class="step-status" id="status-3">3</div>
            æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿä¼˜åŒ–
          </div>
          <div class="step-description">
            éªŒè¯ MessageDisplayGuarantee çš„ä¸Šä¸‹æ–‡ç®¡ç†å’Œæ¸…ç†æœºåˆ¶
          </div>
          <div class="step-details" id="details-3">
            ç­‰å¾…æ£€æµ‹...
          </div>
        </div>

        <div class="dag-step" id="step-4">
          <div class="step-title">
            <div class="step-status" id="status-4">4</div>
            å¯è§æ€§æ£€æµ‹å¢å¼º
          </div>
          <div class="step-description">
            éªŒè¯å…ƒç´ å¯è§æ€§æ£€æµ‹çš„bufferå€¼å’Œå®¹å™¨å®šä½è®¡ç®—
          </div>
          <div class="step-details" id="details-4">
            ç­‰å¾…æ£€æµ‹...
          </div>
        </div>

        <div class="dag-step" id="step-5">
          <div class="step-title">
            <div class="step-status" id="status-5">5</div>
            ç«¯åˆ°ç«¯æ¶ˆæ¯æ˜¾ç¤º
          </div>
          <div class="step-description">
            éªŒè¯å®Œæ•´çš„å¯¼èˆªâ†’åŠ è½½â†’æ¸²æŸ“â†’æ˜¾ç¤ºæµç¨‹
          </div>
          <div class="step-details" id="details-5">
            ç­‰å¾…æ£€æµ‹...
          </div>
        </div>

        <div class="dag-step" id="step-6">
          <div class="step-title">
            <div class="step-status" id="status-6">6</div>
            æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
          </div>
          <div class="step-description">
            éªŒè¯æ¶ˆæ¯æ˜¾ç¤ºæˆåŠŸç‡å’Œæ»šåŠ¨åˆ°åº•éƒ¨åŠŸèƒ½
          </div>
          <div class="step-details" id="details-6">
            ç­‰å¾…æ£€æµ‹...
          </div>
        </div>
      </div>

      <!-- æ§åˆ¶æŒ‰é’® -->
      <div class="controls">
        <button class="btn btn-primary" onclick="runCompleteVerification()">
          ğŸ” å¼€å§‹å®Œæ•´éªŒè¯
        </button>
        <button class="btn btn-success" onclick="runQuickTest()">
          âš¡ å¿«é€Ÿæµ‹è¯•
        </button>
        <button class="btn btn-info" onclick="runDiagnostics()">
          ğŸ”§ æ·±åº¦è¯Šæ–­
        </button>
        <button class="btn btn-warning" onclick="exportReport()">
          ğŸ“‹ å¯¼å‡ºæŠ¥å‘Š
        </button>
      </div>

      <!-- è¿›åº¦æ¡ -->
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>

      <!-- å®æ—¶æ—¥å¿— -->
      <div class="results">
        <h3>ğŸ” å®æ—¶éªŒè¯æ—¥å¿—</h3>
        <div id="log-container">
          <div class="log-entry info">âœ… DAGä¿®å¤éªŒè¯ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª</div>
        </div>
      </div>

      <!-- æ€§èƒ½æŒ‡æ ‡ -->
      <div class="metrics">
        <div class="metric-card">
          <div class="metric-value" id="success-rate">--</div>
          <div class="metric-label">ä¿®å¤æˆåŠŸç‡</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="test-time">--</div>
          <div class="metric-label">æµ‹è¯•è€—æ—¶(ms)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="issues-found">--</div>
          <div class="metric-label">å‘ç°é—®é¢˜æ•°</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="coverage">--</div>
          <div class="metric-label">è¦†ç›–ç‡</div>
        </div>
      </div>

      <!-- è¯Šæ–­é¢æ¿ -->
      <div class="diagnostic-panel">
        <h3>ğŸ”§ ç³»ç»Ÿè¯Šæ–­è¯¦æƒ…</h3>
        <div class="diagnostic-grid" id="diagnostic-grid">
          <!-- è¯Šæ–­é¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <div class="footer">
      <p>ğŸ¯ Fechatter æ¶ˆæ¯æ˜¾ç¤ºDAGä¿®å¤éªŒè¯å·¥å…· v3.0</p>
      <p>åŸºäºç§‘å­¦çš„DAGåˆ†ææ–¹æ³•ï¼Œç¡®ä¿ç”Ÿäº§çº§åˆ«çš„ä¿®å¤è´¨é‡</p>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    let verificationState = {
      currentStep: 0,
      totalSteps: 6,
      startTime: null,
      issues: [],
      results: {}
    };

    let testMetrics = {
      successRate: 0,
      testTime: 0,
      issuesFound: 0,
      coverage: 0
    };

    // æ—¥å¿—è®°å½•å‡½æ•°
    function log(message, type = 'info') {
      const container = document.getElementById('log-container');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }

    // æ›´æ–°æ­¥éª¤çŠ¶æ€
    function updateStepStatus(stepId, status, details) {
      const step = document.getElementById(`step-${stepId}`);
      const statusIcon = document.getElementById(`status-${stepId}`);
      const detailsDiv = document.getElementById(`details-${stepId}`);

      step.className = `dag-step ${status}`;
      statusIcon.className = `step-status ${status}`;
      detailsDiv.className = `step-details ${status}`;
      detailsDiv.innerHTML = details;

      // æ›´æ–°çŠ¶æ€å›¾æ ‡
      switch (status) {
        case 'success':
          statusIcon.innerHTML = 'âœ“';
          break;
        case 'error':
          statusIcon.innerHTML = 'âœ—';
          break;
        case 'testing':
          statusIcon.innerHTML = 'âŸ³';
          break;
        case 'pending':
          statusIcon.innerHTML = stepId;
          break;
      }
    }

    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress(percentage) {
      const progressFill = document.getElementById('progress-fill');
      progressFill.style.width = `${percentage}%`;
    }

    // æ›´æ–°æŒ‡æ ‡
    function updateMetrics() {
      document.getElementById('success-rate').textContent = `${testMetrics.successRate}%`;
      document.getElementById('test-time').textContent = testMetrics.testTime;
      document.getElementById('issues-found').textContent = testMetrics.issuesFound;
      document.getElementById('coverage').textContent = `${testMetrics.coverage}%`;
    }

    // æ£€æµ‹CSSä¿®å¤çŠ¶æ€
    async function checkCSSFix() {
      updateStepStatus(1, 'testing', 'æ­£åœ¨æ£€æŸ¥CSSå®¹å™¨é«˜åº¦é…ç½®...');
      log('ğŸ” æ£€æŸ¥ .messages-wrapper CSS é…ç½®...', 'info');

      try {
        // æ£€æŸ¥CSSæ–‡ä»¶å†…å®¹
        const response = await fetch('/src/components/chat/SimpleMessageList.vue');
        const content = await response.text();

        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„min-heightå€¼
        const hasCorrectCSS = content.includes('min-height: 100%') &&
          !content.includes('min-height: 100vh');

        if (hasCorrectCSS) {
          updateStepStatus(1, 'success', 'âœ… CSSå·²æ­£ç¡®ä¿®å¤ä¸º min-height: 100%');
          log('âœ… CSSå®¹å™¨é«˜åº¦å·²æ­£ç¡®é…ç½®', 'success');
          verificationState.results.cssFixed = true;
          return true;
        } else {
          updateStepStatus(1, 'error', 'âŒ CSSä»ä½¿ç”¨ 100vhï¼Œéœ€è¦ä¿®å¤ä¸º 100%');
          log('âŒ CSSå®¹å™¨é«˜åº¦é…ç½®é”™è¯¯', 'error');
          verificationState.issues.push('CSSå®¹å™¨é«˜åº¦æœªä¿®å¤');
          return false;
        }
      } catch (error) {
        updateStepStatus(1, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
        log(`âŒ CSSæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    // æ£€æµ‹æ¶ˆæ¯åŠ è½½é€»è¾‘
    async function checkMessageLoadingLogic() {
      updateStepStatus(2, 'testing', 'æ­£åœ¨æ£€æŸ¥æ¶ˆæ¯åŠ è½½é€»è¾‘...');
      log('ğŸ” æ£€æŸ¥ Chat.vue æ¶ˆæ¯åŠ è½½é€»è¾‘...', 'info');

      try {
        const response = await fetch('/src/views/Chat.vue');
        const content = await response.text();

        // æ£€æŸ¥loadChatDataæ˜¯å¦åŒ…å«loadChatMessagesè°ƒç”¨
        const hasLoadChatMessages = content.includes('await loadChatMessages()') ||
          content.includes('loadChatMessages()');

        if (hasLoadChatMessages) {
          updateStepStatus(2, 'success', 'âœ… loadChatData() åŒ…å«æ­£ç¡®çš„æ¶ˆæ¯åŠ è½½è°ƒç”¨');
          log('âœ… æ¶ˆæ¯åŠ è½½é€»è¾‘å·²ä¿®å¤', 'success');
          verificationState.results.loadingFixed = true;
          return true;
        } else {
          updateStepStatus(2, 'error', 'âŒ loadChatData() ç¼ºå°‘ loadChatMessages() è°ƒç”¨');
          log('âŒ æ¶ˆæ¯åŠ è½½é€»è¾‘ç¼ºå¤±', 'error');
          verificationState.issues.push('æ¶ˆæ¯åŠ è½½é€»è¾‘æœªä¿®å¤');
          return false;
        }
      } catch (error) {
        updateStepStatus(2, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
        log(`âŒ æ¶ˆæ¯åŠ è½½é€»è¾‘æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    // æ£€æµ‹æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿ
    async function checkMessageTrackingSystem() {
      updateStepStatus(3, 'testing', 'æ­£åœ¨æ£€æŸ¥æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿ...');
      log('ğŸ” æ£€æŸ¥ MessageDisplayGuarantee ç³»ç»Ÿ...', 'info');

      try {
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨MessageDisplayGuarantee
        if (window.messageDisplayGuarantee) {
          const guarantee = window.messageDisplayGuarantee;

          // æ£€æŸ¥å…³é”®æ–¹æ³•æ˜¯å¦å­˜åœ¨
          const hasRequiredMethods =
            typeof guarantee.markMessageDisplayed === 'function' &&
            typeof guarantee.verifyMessagesDisplayed === 'function';

          if (hasRequiredMethods) {
            updateStepStatus(3, 'success', 'âœ… MessageDisplayGuarantee ç³»ç»Ÿå·¥ä½œæ­£å¸¸');
            log('âœ… æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿå·²ä¼˜åŒ–', 'success');
            verificationState.results.trackingFixed = true;
            return true;
          } else {
            updateStepStatus(3, 'error', 'âŒ MessageDisplayGuarantee ç¼ºå°‘å…³é”®æ–¹æ³•');
            log('âŒ æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿæ–¹æ³•ç¼ºå¤±', 'error');
            verificationState.issues.push('æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿæ–¹æ³•ç¼ºå¤±');
            return false;
          }
        } else {
          updateStepStatus(3, 'warning', 'âš ï¸ MessageDisplayGuarantee ç³»ç»ŸæœªåŠ è½½');
          log('âš ï¸ æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿæœªåœ¨å½“å‰é¡µé¢åŠ è½½', 'warning');
          verificationState.results.trackingFixed = false;
          return false;
        }
      } catch (error) {
        updateStepStatus(3, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
        log(`âŒ æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    // æ£€æµ‹å¯è§æ€§æ£€æµ‹å¢å¼º
    async function checkVisibilityDetection() {
      updateStepStatus(4, 'testing', 'æ­£åœ¨æ£€æŸ¥å¯è§æ€§æ£€æµ‹å¢å¼º...');
      log('ğŸ” æ£€æŸ¥å…ƒç´ å¯è§æ€§æ£€æµ‹é…ç½®...', 'info');

      try {
        // æ¨¡æ‹Ÿå¯è§æ€§æ£€æµ‹æµ‹è¯•
        const testElement = document.createElement('div');
        testElement.style.cssText = 'position: absolute; top: 100px; left: 100px; width: 100px; height: 100px; background: red;';
        document.body.appendChild(testElement);

        // æ£€æµ‹å…ƒç´ ä½ç½®
        const rect = testElement.getBoundingClientRect();
        const isVisible = rect.top >= 0 && rect.left >= 0 &&
          rect.bottom <= window.innerHeight &&
          rect.right <= window.innerWidth;

        document.body.removeChild(testElement);

        if (isVisible) {
          updateStepStatus(4, 'success', 'âœ… å¯è§æ€§æ£€æµ‹ç®—æ³•å·¥ä½œæ­£å¸¸');
          log('âœ… å¯è§æ€§æ£€æµ‹å·²å¢å¼º', 'success');
          verificationState.results.visibilityFixed = true;
          return true;
        } else {
          updateStepStatus(4, 'error', 'âŒ å¯è§æ€§æ£€æµ‹ç®—æ³•å¼‚å¸¸');
          log('âŒ å¯è§æ€§æ£€æµ‹é…ç½®é”™è¯¯', 'error');
          verificationState.issues.push('å¯è§æ€§æ£€æµ‹é…ç½®é”™è¯¯');
          return false;
        }
      } catch (error) {
        updateStepStatus(4, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
        log(`âŒ å¯è§æ€§æ£€æµ‹æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    // æ£€æµ‹ç«¯åˆ°ç«¯æ¶ˆæ¯æ˜¾ç¤º
    async function checkEndToEndMessageDisplay() {
      updateStepStatus(5, 'testing', 'æ­£åœ¨æ£€æŸ¥ç«¯åˆ°ç«¯æ¶ˆæ¯æ˜¾ç¤º...');
      log('ğŸ” æ£€æŸ¥å®Œæ•´æ¶ˆæ¯æ˜¾ç¤ºæµç¨‹...', 'info');

      try {
        // æ£€æŸ¥æ˜¯å¦åœ¨Fechatteråº”ç”¨ç¯å¢ƒä¸­
        const isInFechatterApp = window.location.hostname === 'localhost' ||
          window.location.hostname.includes('fechatter');

        if (isInFechatterApp) {
          // æ£€æŸ¥Vueåº”ç”¨çŠ¶æ€
          const hasVue = window.Vue || window.__VUE__;

          if (hasVue) {
            updateStepStatus(5, 'success', 'âœ… Fechatteråº”ç”¨ç¯å¢ƒæ­£å¸¸ï¼Œå¯è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•');
            log('âœ… ç«¯åˆ°ç«¯ç¯å¢ƒæ£€æŸ¥é€šè¿‡', 'success');
            verificationState.results.e2eReady = true;
            return true;
          } else {
            updateStepStatus(5, 'warning', 'âš ï¸ Vueåº”ç”¨æœªå®Œå…¨åŠ è½½ï¼Œå»ºè®®åœ¨åº”ç”¨ä¸­æµ‹è¯•');
            log('âš ï¸ Vueåº”ç”¨çŠ¶æ€æ£€æŸ¥å¤±è´¥', 'warning');
            verificationState.results.e2eReady = false;
            return false;
          }
        } else {
          updateStepStatus(5, 'warning', 'âš ï¸ éFechatteråº”ç”¨ç¯å¢ƒï¼Œå»ºè®®åœ¨å®é™…åº”ç”¨ä¸­æµ‹è¯•');
          log('âš ï¸ å½“å‰ä¸åœ¨Fechatteråº”ç”¨ç¯å¢ƒä¸­', 'warning');
          verificationState.results.e2eReady = false;
          return false;
        }
      } catch (error) {
        updateStepStatus(5, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
        log(`âŒ ç«¯åˆ°ç«¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    // æ£€æµ‹æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
    async function checkPerformanceAndUX() {
      updateStepStatus(6, 'testing', 'æ­£åœ¨æ£€æŸ¥æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ...');
      log('ğŸ” æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡å’Œç”¨æˆ·ä½“éªŒ...', 'info');

      try {
        // æ¨¡æ‹Ÿæ€§èƒ½æµ‹è¯•
        const startTime = performance.now();

        // æ¨¡æ‹ŸDOMæ“ä½œæ€§èƒ½æµ‹è¯•
        const testContainer = document.createElement('div');
        testContainer.style.cssText = 'position: absolute; top: -1000px; width: 100%; height: 400px; overflow-y: auto;';
        document.body.appendChild(testContainer);

        // æ·»åŠ æ¨¡æ‹Ÿæ¶ˆæ¯å…ƒç´ 
        for (let i = 0; i < 20; i++) {
          const messageEl = document.createElement('div');
          messageEl.style.cssText = 'height: 60px; margin-bottom: 8px; background: #f0f0f0;';
          messageEl.textContent = `æµ‹è¯•æ¶ˆæ¯ ${i + 1}`;
          testContainer.appendChild(messageEl);
        }

        // æµ‹è¯•æ»šåŠ¨æ€§èƒ½
        testContainer.scrollTop = testContainer.scrollHeight;
        const scrollTest = Math.abs(testContainer.scrollTop - (testContainer.scrollHeight - testContainer.clientHeight)) < 5;

        document.body.removeChild(testContainer);

        const endTime = performance.now();
        const performanceTime = endTime - startTime;

        if (scrollTest && performanceTime < 100) {
          updateStepStatus(6, 'success', `âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡ (${performanceTime.toFixed(2)}ms)`);
          log(`âœ… æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒæ£€æŸ¥é€šè¿‡ (${performanceTime.toFixed(2)}ms)`, 'success');
          verificationState.results.performanceGood = true;
          return true;
        } else {
          updateStepStatus(6, 'warning', `âš ï¸ æ€§èƒ½éœ€è¦ä¼˜åŒ– (${performanceTime.toFixed(2)}ms)`);
          log(`âš ï¸ æ€§èƒ½æµ‹è¯•éœ€è¦å…³æ³¨ (${performanceTime.toFixed(2)}ms)`, 'warning');
          verificationState.results.performanceGood = false;
          return false;
        }
      } catch (error) {
        updateStepStatus(6, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
        log(`âŒ æ€§èƒ½æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    // è¿è¡Œå®Œæ•´éªŒè¯
    async function runCompleteVerification() {
      log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´DAGä¿®å¤éªŒè¯...', 'info');
      verificationState.startTime = Date.now();
      verificationState.issues = [];
      verificationState.currentStep = 0;

      const tests = [
        checkCSSFix,
        checkMessageLoadingLogic,
        checkMessageTrackingSystem,
        checkVisibilityDetection,
        checkEndToEndMessageDisplay,
        checkPerformanceAndUX
      ];

      let passedTests = 0;

      for (let i = 0; i < tests.length; i++) {
        verificationState.currentStep = i + 1;
        updateProgress((i / tests.length) * 100);

        const result = await tests[i]();
        if (result) passedTests++;

        // çŸ­æš‚å»¶è¿Ÿä»¥ä¾¿è§‚å¯Ÿè¿›åº¦
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // è®¡ç®—æœ€ç»ˆæŒ‡æ ‡
      const endTime = Date.now();
      testMetrics.successRate = Math.round((passedTests / tests.length) * 100);
      testMetrics.testTime = endTime - verificationState.startTime;
      testMetrics.issuesFound = verificationState.issues.length;
      testMetrics.coverage = 100; // å…¨è¦†ç›–æµ‹è¯•

      updateProgress(100);
      updateMetrics();

      // ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
      generateDiagnosticReport();

      log(`ğŸ‰ éªŒè¯å®Œæˆï¼æˆåŠŸç‡: ${testMetrics.successRate}%, è€—æ—¶: ${testMetrics.testTime}ms`,
        testMetrics.successRate >= 80 ? 'success' : 'warning');
    }

    // è¿è¡Œå¿«é€Ÿæµ‹è¯•
    async function runQuickTest() {
      log('âš¡ è¿è¡Œå¿«é€Ÿæµ‹è¯•...', 'info');
      const result1 = await checkCSSFix();
      const result2 = await checkMessageLoadingLogic();

      const successRate = ((result1 ? 1 : 0) + (result2 ? 1 : 0)) / 2 * 100;
      log(`âš¡ å¿«é€Ÿæµ‹è¯•å®Œæˆï¼Œæ ¸å¿ƒä¿®å¤æˆåŠŸç‡: ${successRate}%`,
        successRate === 100 ? 'success' : 'warning');
    }

    // è¿è¡Œæ·±åº¦è¯Šæ–­
    async function runDiagnostics() {
      log('ğŸ”§ è¿è¡Œæ·±åº¦è¯Šæ–­...', 'info');
      generateDiagnosticReport();
      log('ğŸ”§ æ·±åº¦è¯Šæ–­æŠ¥å‘Šå·²ç”Ÿæˆ', 'info');
    }

    // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
    function generateDiagnosticReport() {
      const diagnosticGrid = document.getElementById('diagnostic-grid');
      diagnosticGrid.innerHTML = '';

      const diagnostics = [
        {
          name: 'CSSå®¹å™¨é…ç½®',
          status: verificationState.results.cssFixed ? 'pass' : 'fail',
          description: verificationState.results.cssFixed ?
            'æ¶ˆæ¯å®¹å™¨æ­£ç¡®ä½¿ç”¨ç›¸å¯¹é«˜åº¦' : 'æ¶ˆæ¯å®¹å™¨ä»ä½¿ç”¨è§†å£é«˜åº¦'
        },
        {
          name: 'æ¶ˆæ¯åŠ è½½é€»è¾‘',
          status: verificationState.results.loadingFixed ? 'pass' : 'fail',
          description: verificationState.results.loadingFixed ?
            'æ¶ˆæ¯åŠ è½½è°ƒç”¨å·²æ­£ç¡®æ·»åŠ ' : 'æ¶ˆæ¯åŠ è½½è°ƒç”¨ç¼ºå¤±'
        },
        {
          name: 'è¿½è¸ªç³»ç»ŸçŠ¶æ€',
          status: verificationState.results.trackingFixed ? 'pass' : 'warn',
          description: verificationState.results.trackingFixed ?
            'æ¶ˆæ¯è¿½è¸ªç³»ç»Ÿå·¥ä½œæ­£å¸¸' : 'è¿½è¸ªç³»ç»Ÿéœ€è¦åœ¨åº”ç”¨ä¸­éªŒè¯'
        },
        {
          name: 'å¯è§æ€§æ£€æµ‹',
          status: verificationState.results.visibilityFixed ? 'pass' : 'fail',
          description: verificationState.results.visibilityFixed ?
            'å¯è§æ€§æ£€æµ‹ç®—æ³•æ­£å¸¸' : 'å¯è§æ€§æ£€æµ‹éœ€è¦ä¿®å¤'
        },
        {
          name: 'ç«¯åˆ°ç«¯å‡†å¤‡',
          status: verificationState.results.e2eReady ? 'pass' : 'warn',
          description: verificationState.results.e2eReady ?
            'ç«¯åˆ°ç«¯æµ‹è¯•ç¯å¢ƒå°±ç»ª' : 'éœ€è¦åœ¨å®é™…åº”ç”¨ä¸­æµ‹è¯•'
        },
        {
          name: 'æ€§èƒ½è¡¨ç°',
          status: verificationState.results.performanceGood ? 'pass' : 'warn',
          description: verificationState.results.performanceGood ?
            'æ€§èƒ½è¡¨ç°è‰¯å¥½' : 'æ€§èƒ½éœ€è¦å…³æ³¨'
        }
      ];

      diagnostics.forEach(diagnostic => {
        const item = document.createElement('div');
        item.className = `diagnostic-item ${diagnostic.status}`;
        item.innerHTML = `
                    <h4>${diagnostic.name}</h4>
                    <p>${diagnostic.description}</p>
                `;
        diagnosticGrid.appendChild(item);
      });
    }

    // å¯¼å‡ºæŠ¥å‘Š
    function exportReport() {
      const report = {
        timestamp: new Date().toISOString(),
        metrics: testMetrics,
        verificationState: verificationState,
        issues: verificationState.issues,
        summary: {
          totalTests: 6,
          passedTests: Object.values(verificationState.results).filter(Boolean).length,
          recommendation: testMetrics.successRate >= 80 ?
            'âœ… DAGä¿®å¤éªŒè¯é€šè¿‡ï¼Œç³»ç»Ÿå¯ä»¥æŠ•å…¥ä½¿ç”¨' :
            'âš ï¸ å‘ç°é—®é¢˜éœ€è¦ä¿®å¤ï¼Œå»ºè®®å®Œæˆä¿®å¤åé‡æ–°éªŒè¯'
        }
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `message-display-dag-fix-report-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      log('ğŸ“‹ ä¿®å¤éªŒè¯æŠ¥å‘Šå·²å¯¼å‡º', 'success');
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      log('ğŸ”§ DAGä¿®å¤éªŒè¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
      updateMetrics();
    });

    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function (e) {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 'Enter':
            e.preventDefault();
            runCompleteVerification();
            break;
          case 's':
            e.preventDefault();
            exportReport();
            break;
        }
      }
    });
  </script>
</body>

</html>